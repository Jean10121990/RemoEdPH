<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payroll Management - RemoEdPH Admin</title>
    <link rel="stylesheet" href="modern-styles.css">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f6fbff; }
        .remoed-main { display: flex; min-height: calc(100vh - 70px); }
        .remoed-sidebar { width: 220px; background: #fff; box-shadow: 2px 0 8px rgba(0,0,0,0.05); padding: 32px 0 0 0; display: flex; flex-direction: column; }
        .remoed-logo { display: flex; align-items: center; gap: 14px; }
        .remoed-logo img { height: 48px; }
        .remoed-title { font-size: 1.7rem; font-weight: 700; color: #667eea; letter-spacing: 1px; }
        .remoed-user { display: flex; align-items: center; gap: 10px; }
        .remoed-avatar { width: 72px; height: 72px; border-radius: 50%; background: #667eea; color: #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 2.2rem; }
        .remoed-username { color: #667eea; font-weight: 600; }
        .remoed-menu { list-style: none; padding: 0; margin: 0; }
        .remoed-menu li { padding: 14px 32px; color: #667eea; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 12px; border-left: 4px solid transparent; transition: all 0.2s; }
        .remoed-menu li.active, .remoed-menu li:hover { background: linear-gradient(90deg, #667eea 0%, #5a67d8 100%); border-left: 4px solid #667eea; color: white; transform: translateX(4px); }
        .remoed-menu svg { width: 20px; height: 20px; }
        .remoed-content { flex: 1; padding: 12px 16px; }
        .remoed-section { background: #fff; border-radius: 12px; box-shadow: 0 4px 24px rgba(28,167,231,0.07); padding: 12px; margin-bottom: 12px; }
        .remoed-section-title { font-size: 1rem; font-weight: 700; color: #1ca7e7; margin-bottom: 10px; letter-spacing: 0.5px; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; color: #333; font-size: 0.85rem; }
        .form-group input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.85rem; }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem; margin-right: 8px; }
        .btn-primary { background: #1ca7e7; color: #fff; }
        .btn-success { background: #27ae60; color: #fff; }
        .btn-danger { background: #e74c3c; color: #fff; }
        .payroll-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .payroll-table th, .payroll-table td { padding: 6px 8px; text-align: left; border-bottom: 1px solid #e0e6ed; font-size: 0.85rem; }
        .payroll-table th { background: #f8f9fa; font-weight: 600; color: #1ca7e7; }
        @media (max-width: 900px) {
            .remoed-main { flex-direction: column; }
            .remoed-sidebar { width: 100%; flex-direction: row; box-shadow: none; border-bottom: 1px solid #e0e6ed; }
            .remoed-menu li { padding: 12px 10px; font-size: 0.97rem; }
            .remoed-content { padding: 18px 6px; }
        }
    </style>
</head>
<body>
    <div class="remoed-main">
        <nav class="remoed-sidebar">
            <div class="remoed-logo" style="height:100px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px; padding-top:5px;">
                <img src="remoed-logo.png" alt="RemoEdPH Logo" style="height:40px; width:auto; display:inline-block; vertical-align:middle;">
                <span class="remoed-title" style="font-size:1.3rem; font-weight:700; color:#667eea; letter-spacing:1px;">RemoEdPH</span>
                <div style="font-size: 0.75rem; color: #666;">Admin Portal</div>
            </div>
            <div class="remoed-user" style="display:flex; flex-direction:column; align-items:center; margin-bottom:24px;">
                <div class="remoed-avatar" id="remoed-avatar">
                    <span id="avatar-text">A</span>
                </div>
                <span class="remoed-username" id="remoed-username">Admin</span>
            </div>
            <ul class="remoed-menu">
                <li onclick="window.location.href='admin-dashboard.html'"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="4"/></svg>Dashboard</li>
                <li onclick="window.location.href='admin-users.html'"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/></svg>User Management</li>
                <li onclick="window.location.href='admin-announcements.html'"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/></svg>Announcements</li>
                <li class="active"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 10c-4.41 0-8-1.79-8-4V6c0-2.21 3.59-4 8-4s8 1.79 8 4v8c0 2.21-3.59 4-8 4z"/></svg>Payroll Management</li>
                <li onclick="window.location.href='admin-reports.html'"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>Reports</li>
                <li onclick="window.location.href='admin-issue-management.html'"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>Issue Management</li>
                <li onclick="window.location.href='admin-lessons-library.html'"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>Lesson Library</li>
                <li onclick="window.location.href='admin-settings.html'"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>Settings</li>
                <li id="logout-nav" style="margin-top:auto; color:#e74c3c; cursor:pointer;"><svg fill="none" stroke="#e74c3c" stroke-width="2" viewBox="0 0 24 24"><path d="M17 16l4-4m0 0l-4-4m4 4H7"/><path d="M3 12a9 9 0 0118 0 9 9 0 01-18 0z"/></svg>Logout</li>
            </ul>
        </nav>
        <div class="remoed-content">
            <div class="remoed-section">
                <div class="remoed-section-title">Global Rate Settings</div>
                
                <div class="form-group">
                    <label for="global-rate">25 Minutes Rate (PHP)</label>
                    <input type="number" id="global-rate" placeholder="100" min="0" step="0.01">
                </div>
                
                <button class="btn btn-success" onclick="saveGlobalRate()">üíæ Save Rate</button>
                <div id="rate-status" style="margin-top: 10px; font-weight: 600;"></div>
            </div>
            
            <div class="remoed-section">
                <div class="remoed-section-title">Weekly Salary Disbursement</div>
                
                <!-- Week Navigation Controls -->
                <div style="margin-bottom: 20px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="previousWeek()" style="padding: 8px 16px; font-size: 14px;">
                        ‚Üê Previous Week
                    </button>
                    
                    <div style="text-align: center; flex: 1; min-width: 200px;">
                        <strong>Selected Week:</strong> <span id="current-week-display">Loading...</span>
                    </div>
                    
                    <button class="btn btn-primary" onclick="nextWeek()" style="padding: 8px 16px; font-size: 14px;">
                        Next Week ‚Üí
                    </button>
                    
                    <button class="btn btn-success" onclick="goToCurrentWeek()" style="padding: 8px 16px; font-size: 14px; background: #28a745;">
                        üìÖ Current Week
                    </button>
                </div>
                
                <button class="btn btn-success" onclick="loadTeachersSalaries()">Load Teachers</button>
                <button class="btn btn-danger" id="dispense-btn" onclick="dispenseAllSalaries()" style="display: none;">Dispense All Salaries</button>
                
                <div id="disbursement-status" style="margin-top: 10px; font-weight: 600;"></div>
                
                <div id="teachers-list-container" style="margin-top: 20px; display: none;">
                    <h3 style="color: #1ca7e7; margin-bottom: 15px;">Teachers Weekly Salaries</h3>
                    <div id="teachers-list">
                        <!-- Teachers will be loaded here -->
                    </div>
                </div>
            </div>
            
            <div class="remoed-section">
                <div class="remoed-section-title">Payment History Management</div>
                
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <label for="teacher-filter" style="font-weight: 600; color: #333;">Filter by Teacher:</label>
                        <select id="teacher-filter" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; min-width: 200px;">
                            <option value="">All Teachers</option>
                        </select>
                        
                        <label for="status-filter" style="font-weight: 600; color: #333;">Filter by Status:</label>
                        <select id="status-filter" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
                            <option value="">All Status</option>
                            <option value="Success">Paid</option>
                            <option value="Pending">Pending</option>
                        </select>
                        
                        <button class="btn btn-primary" onclick="loadPaymentHistory()">üîç Load Records</button>
                        <button class="btn btn-success" onclick="exportPaymentHistory()">üìä Export CSV</button>
                    </div>
                </div>
                
                <div id="payment-history-container" style="margin-top: 20px; display: none;">
                    <h3 style="color: #1ca7e7; margin-bottom: 15px;">Payment Records</h3>
                    <div id="payment-history-list">
                        <!-- Payment records will be loaded here -->
                    </div>
                </div>
                
                <div id="payment-history-status" style="margin-top: 10px; font-weight: 600;"></div>
            </div>
        </div>
    </div>

    <script>
        // Role-based access control
        const userType = localStorage.getItem('userType');
        if (userType !== 'admin') {
            alert('Access denied. This page is for administrators only.');
            window.location.href = 'index.html';
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const username = localStorage.getItem('adminUsername');
            
            if (username) {
                document.getElementById('remoed-username').textContent = username;
                document.getElementById('avatar-text').textContent = username[0].toUpperCase();
            }
            
            // Load current global rate
            loadGlobalRate();
            
            // Display current week
            displayCurrentWeek();
            
            // Load teacher list for filter
            loadTeacherFilterOptions();
        });

        document.getElementById('logout-nav').onclick = function() {
            localStorage.clear();
            window.location.href = 'admin-login.html';
        };

        // Global variable to track selected week
        let selectedWeekStart = null;

        function displayCurrentWeek() {
            if (!selectedWeekStart) {
                // Initialize with current week
                const now = new Date();
                const monday = new Date(now);
                monday.setDate(now.getDate() - now.getDay() + 1);
                selectedWeekStart = monday;
            }
            
            const monday = selectedWeekStart;
            const friday = new Date(monday);
            friday.setDate(monday.getDate() + 4);
            
            const weekDisplay = `${monday.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${friday.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
            document.getElementById('current-week-display').textContent = weekDisplay;
        }

        function previousWeek() {
            if (!selectedWeekStart) {
                selectedWeekStart = new Date();
                selectedWeekStart.setDate(selectedWeekStart.getDate() - selectedWeekStart.getDay() + 1);
            }
            
            selectedWeekStart.setDate(selectedWeekStart.getDate() - 7);
            displayCurrentWeek();
            
            // Reload teachers if they were already loaded
            if (document.getElementById('teachers-list-container').style.display !== 'none') {
                loadTeachersSalaries();
            }
        }

        function nextWeek() {
            if (!selectedWeekStart) {
                selectedWeekStart = new Date();
                selectedWeekStart.setDate(selectedWeekStart.getDate() - selectedWeekStart.getDay() + 1);
            }
            
            selectedWeekStart.setDate(selectedWeekStart.getDate() + 7);
            displayCurrentWeek();
            
            // Reload teachers if they were already loaded
            if (document.getElementById('teachers-list-container').style.display !== 'none') {
                loadTeachersSalaries();
            }
        }

        function goToCurrentWeek() {
            const now = new Date();
            const monday = new Date(now);
            monday.setDate(now.getDate() - now.getDay() + 1);
            selectedWeekStart = monday;
            displayCurrentWeek();
            
            // Reload teachers if they were already loaded
            if (document.getElementById('teachers-list-container').style.display !== 'none') {
                loadTeachersSalaries();
            }
        }

        async function loadGlobalRate() {
            try {
                const response = await fetch('/api/admin/global-rate');
                const data = await response.json();
                if (data.success) {
                    document.getElementById('global-rate').value = data.rate || 100;
                }
            } catch (error) {
                console.error('Error loading global rate:', error);
            }
        }



        async function saveGlobalRate() {
            const newRate = parseFloat(document.getElementById('global-rate').value);
            
            if (isNaN(newRate) || newRate < 0) {
                alert('Please enter a valid rate (positive number)');
                return;
            }
            
            try {
                // First update the global rate and all teachers
                const updateResponse = await fetch('/api/admin/update-global-rate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rate: newRate })
                });
                
                const updateData = await updateResponse.json();
                
                if (!updateData.success) {
                    alert(updateData.message || 'Failed to update rate');
                    return;
                }
                
                // Then save to database
                const saveResponse = await fetch('/api/admin/save-global-rate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rate: newRate })
                });
                
                const saveData = await saveResponse.json();
                
                if (saveData.success) {
                    document.getElementById('rate-status').textContent = `Rate updated and saved successfully! ${updateData.updatedTeachers} teachers affected. Rate: ‚Ç±${newRate}`;
                    document.getElementById('rate-status').style.color = '#27ae60';
                    
                    setTimeout(() => {
                        document.getElementById('rate-status').textContent = '';
                    }, 3000);
                } else {
                    alert(saveData.message || 'Failed to save rate to database');
                }
            } catch (error) {
                console.error('Error saving rate:', error);
                alert('Error saving rate. Please try again.');
            }
        }

        async function loadTeachersSalaries() {
            try {
                // Get the selected week start date
                if (!selectedWeekStart) {
                    // Initialize with current week if not set
                    const now = new Date();
                    const monday = new Date(now);
                    monday.setDate(now.getDate() - now.getDay() + 1);
                    selectedWeekStart = monday;
                }
                
                // Format the week start date for the API
                const weekStart = selectedWeekStart.toISOString().split('T')[0];
                
                const response = await fetch(`/api/admin/teachers-weekly-salaries?week=${weekStart}`);
                const data = await response.json();
                
                if (data.success) {
                    displayTeachersList(data.teachers);
                    document.getElementById('teachers-list-container').style.display = 'block';
                    document.getElementById('dispense-btn').style.display = 'inline-block';
                    
                    // Check if any teachers have been paid
                    const paidTeachers = data.teachers.filter(teacher => teacher.paymentStatus === 'Paid');
                    if (paidTeachers.length > 0) {
                        document.getElementById('dispense-btn').disabled = true;
                        document.getElementById('dispense-btn').textContent = 'Salaries Dispersed';
                        document.getElementById('dispense-btn').style.background = '#95a5a6';
                    } else {
                        document.getElementById('dispense-btn').disabled = false;
                        document.getElementById('dispense-btn').textContent = 'Dispense All Salaries';
                        document.getElementById('dispense-btn').style.background = '#e74c3c';
                    }
                    
                    document.getElementById('disbursement-status').textContent = `Loaded ${data.teachers.length} teachers`;
                    document.getElementById('disbursement-status').style.color = '#27ae60';
                    
                    setTimeout(() => {
                        document.getElementById('disbursement-status').textContent = '';
                    }, 3000);
                } else {
                    alert('Error loading teachers: ' + data.message);
                }
            } catch (error) {
                console.error('Error loading teachers:', error);
                alert('Error loading teachers. Please try again.');
            }
        }

        function displayTeachersList(teachers) {
            const container = document.getElementById('teachers-list');
            
            if (teachers.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888;">No teachers found</p>';
                return;
            }
            
            const tableHTML = `
                <table class="payroll-table">
                    <thead>
                        <tr>
                            <th>Teacher Account</th>
                            <th>Completed Classes</th>
                            <th>Student Absent</th>
                            <th>Rate per Class</th>
                            <th>Base Fee</th>
                            <th>Student Absent Fee</th>
                            <th>Deductions</th>
                            <th>Net Payable</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${teachers.map(teacher => {
                            const statusText = teacher.paymentStatus === 'Paid' ? '‚úì Paid' : 'Pending';
                            const statusColor = teacher.paymentStatus === 'Paid' ? '#27ae60' : '#888';
                            const totalDeductions = (teacher.lateDeductions || 0) + (teacher.teacherAbsentDeductions || 0);
                            
                            return `
                                <tr>
                                    <td>${teacher.email}</td>
                                    <td>${teacher.completedClasses}</td>
                                    <td>${teacher.studentAbsentClasses || 0}</td>
                                    <td>‚Ç±${teacher.rate.toFixed(2)}</td>
                                    <td>‚Ç±${teacher.baseWeeklyFee.toFixed(2)}</td>
                                    <td>‚Ç±${teacher.studentAbsentPayment.toFixed(2)}</td>
                                    <td style="color: #e74c3c;">-‚Ç±${totalDeductions.toFixed(2)}</td>
                                    <td style="font-weight: 600; color: #27ae60;">‚Ç±${teacher.weeklySalary.toFixed(2)}</td>
                                    <td style="color: ${statusColor}; font-weight: 600;">${statusText}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
        }

        async function dispenseAllSalaries() {
            if (!confirm('Are you sure you want to dispense salaries to all teachers? This action cannot be undone.')) {
                return;
            }
            
            try {
                // Get the selected week start date
                if (!selectedWeekStart) {
                    // Initialize with current week if not set
                    const now = new Date();
                    const monday = new Date(now);
                    monday.setDate(now.getDate() - now.getDay() + 1);
                    selectedWeekStart = monday;
                }
                
                // Format the week start date for the API
                const weekStart = selectedWeekStart.toISOString().split('T')[0];
                
                const response = await fetch('/api/admin/dispense-salaries', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ week: weekStart })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('disbursement-status').textContent = `Successfully dispensed salaries to ${data.dispensedTeachers.length} teachers!`;
                    document.getElementById('disbursement-status').style.color = '#27ae60';
                    
                    // Disable the dispense button
                    document.getElementById('dispense-btn').disabled = true;
                    document.getElementById('dispense-btn').textContent = 'Salaries Dispersed';
                    document.getElementById('dispense-btn').style.background = '#95a5a6';
                    
                    // Reload the teachers list
                    setTimeout(() => {
                        loadTeachersSalaries();
                    }, 1000);
                    
                    setTimeout(() => {
                        document.getElementById('disbursement-status').textContent = '';
                    }, 5000);
                } else {
                    alert('Error dispensing salaries: ' + data.message);
                }
            } catch (error) {
                console.error('Error dispensing salaries:', error);
                alert('Error dispensing salaries. Please try again.');
            }
        }

        // Payment History Management Functions
        async function loadTeacherFilterOptions() {
            try {
                console.log('üîç Loading teacher filter options...');
                
                const response = await fetch('/api/admin/teachers-list');
                console.log('üîç Teachers list response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('üîç Teachers list data:', data);
                
                if (data.success) {
                    const teacherFilter = document.getElementById('teacher-filter');
                    teacherFilter.innerHTML = '<option value="">All Teachers</option>';
                    
                    data.teachers.forEach(teacher => {
                        const option = document.createElement('option');
                        option.value = teacher.email;
                        option.textContent = teacher.email;
                        teacherFilter.appendChild(option);
                    });
                    
                    console.log(`‚úÖ Loaded ${data.teachers.length} teachers for filter dropdown`);
                } else {
                    console.error('‚ùå Failed to load teachers list:', data.message);
                }
            } catch (error) {
                console.error('‚ùå Error loading teacher filter options:', error);
            }
        }

        async function loadPaymentHistory() {
            try {
                console.log('üîç Loading payment history...');
                
                const teacherFilter = document.getElementById('teacher-filter').value;
                const statusFilter = document.getElementById('status-filter').value;
                
                let url = '/api/admin/payment-history';
                const params = new URLSearchParams();
                
                if (teacherFilter) params.append('teacherEmail', teacherFilter);
                if (statusFilter) params.append('status', statusFilter);
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }
                
                console.log('üîç Making request to:', url);
                
                const response = await fetch(url);
                console.log('üîç Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('üîç Response data:', data);
                
                if (data.success) {
                    displayPaymentHistory(data.payments);
                    document.getElementById('payment-history-container').style.display = 'block';
                    document.getElementById('payment-history-status').textContent = `Loaded ${data.payments.length} payment records`;
                    document.getElementById('payment-history-status').style.color = '#27ae60';
                    
                    setTimeout(() => {
                        document.getElementById('payment-history-status').textContent = '';
                    }, 3000);
                } else {
                    const errorMessage = data.message || 'Unknown error occurred';
                    console.error('‚ùå API Error:', errorMessage);
                    alert('Error loading payment history: ' + errorMessage);
                }
            } catch (error) {
                console.error('‚ùå Error loading payment history:', error);
                alert('Error loading payment history: ' + error.message);
            }
        }

        function displayPaymentHistory(payments) {
            const container = document.getElementById('payment-history-list');
            
            if (payments.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888;">No payment records found</p>';
                return;
            }
            
            const tableHTML = `
                <table class="payroll-table">
                    <thead>
                        <tr>
                            <th>Teacher</th>
                            <th>Period</th>
                            <th>Issue Date</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${payments.map(payment => {
                            const statusText = payment.status === 'Success' ? '‚úÖ Paid' : '‚è≥ Pending';
                            const statusColor = payment.status === 'Success' ? '#27ae60' : '#f39c12';
                            
                            return `
                                <tr>
                                    <td>${payment.teacherEmail || 'N/A'}</td>
                                    <td>${payment.period || payment.duration || 'N/A'}</td>
                                    <td>${payment.issueDate ? new Date(payment.issueDate).toLocaleDateString('en-US', { 
                                        month: 'short', 
                                        day: 'numeric', 
                                        year: 'numeric' 
                                    }) : 'N/A'}</td>
                                    <td style="font-weight: 600; color: #e74c3c;">‚Ç±${(payment.amount || 0).toFixed(2)}</td>
                                    <td style="color: ${statusColor}; font-weight: 600;">${statusText}</td>
                                    <td>
                                        <button class="btn btn-primary" style="padding: 4px 8px; font-size: 12px; margin-right: 5px;" onclick="editPayment('${payment._id}')">‚úèÔ∏è Edit</button>
                                        <button class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;" onclick="deletePayment('${payment._id}')">üóëÔ∏è Delete</button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
        }

        async function editPayment(paymentId) {
            try {
                // First, get the payment details
                const response = await fetch(`/api/admin/payment/${paymentId}`);
                const data = await response.json();
                
                if (!data.success) {
                    alert('Error loading payment details: ' + data.message);
                    return;
                }
                
                const payment = data.payment;
                
                // Create edit form
                const newAmount = prompt(`Edit payment amount for ${payment.teacherEmail || 'Teacher'} (Period: ${payment.period || payment.duration || 'N/A'})\n\nCurrent amount: ‚Ç±${(payment.amount || 0).toFixed(2)}\n\nEnter new amount:`, (payment.amount || 0).toFixed(2));
                
                if (newAmount === null) return; // User cancelled
                
                const amount = parseFloat(newAmount);
                if (isNaN(amount) || amount < 0) {
                    alert('Please enter a valid amount (positive number)');
                    return;
                }
                
                // Update the payment
                const updateResponse = await fetch(`/api/admin/payment/${paymentId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: amount })
                });
                
                const updateData = await updateResponse.json();
                
                if (updateData.success) {
                    alert(`Payment updated successfully!\nNew amount: ‚Ç±${amount.toFixed(2)}`);
                    loadPaymentHistory(); // Reload the list
                } else {
                    alert('Error updating payment: ' + updateData.message);
                }
            } catch (error) {
                console.error('Error editing payment:', error);
                alert('Error editing payment. Please try again.');
            }
        }

        async function deletePayment(paymentId) {
            if (!confirm('Are you sure you want to delete this payment record? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/payment/${paymentId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Payment record deleted successfully!');
                    loadPaymentHistory(); // Reload the list
                } else {
                    alert('Error deleting payment: ' + data.message);
                }
            } catch (error) {
                console.error('Error deleting payment:', error);
                alert('Error deleting payment. Please try again.');
            }
        }

        async function exportPaymentHistory() {
            try {
                const teacherFilter = document.getElementById('teacher-filter').value;
                const statusFilter = document.getElementById('status-filter').value;
                
                let url = '/api/admin/payment-history/export';
                const params = new URLSearchParams();
                
                if (teacherFilter) params.append('teacherEmail', teacherFilter);
                if (statusFilter) params.append('status', statusFilter);
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }
                
                const response = await fetch(url);
                const blob = await response.blob();
                
                // Create download link
                const url2 = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url2;
                a.download = `payment_history_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url2);
                document.body.removeChild(a);
                
                document.getElementById('payment-history-status').textContent = 'Payment history exported successfully!';
                document.getElementById('payment-history-status').style.color = '#27ae60';
                
                setTimeout(() => {
                    document.getElementById('payment-history-status').textContent = '';
                }, 3000);
            } catch (error) {
                console.error('Error exporting payment history:', error);
                alert('Error exporting payment history. Please try again.');
            }
        }
    </script>
</body>
</html> 