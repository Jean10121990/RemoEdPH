<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ûï Book a Class - RemoEdPH</title>
    <link rel="stylesheet" href="modern-styles.css">
    <link rel="stylesheet" href="child-friendly-styles.css">
    <style>
        body { 
            font-family: 'Comic Sans MS', 'Chalkboard SE', 'Trebuchet MS', 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #FFF0F5 0%, #E8F8F5 50%, #FFF9E6 100%);
            background-attachment: fixed;
            margin: 0;
            padding: 0;
        }
        .remoed-main { 
            display: flex; 
            min-height: 100vh; 
        }
        .remoed-sidebar { 
            width: 260px; 
            min-width: 260px;
            background: linear-gradient(180deg, #ffffff 0%, #f8fbff 100%); 
            box-shadow: 4px 0 20px rgba(102, 126, 234, 0.1); 
            padding: 0; 
            display: flex; 
            flex-direction: column; 
            align-items: stretch;
            position: fixed;
            height: 100vh;
            z-index: 100;
            border-right: 1px solid rgba(102, 126, 234, 0.1);
        }
        .remoed-logo { 
            display: flex; 
            align-items: center; 
            gap: 14px; 
        }
        .remoed-logo img { 
            height: 48px; 
        }
        .remoed-title { 
            font-size: 1.7rem; 
            font-weight: 700; 
            color: #667eea; 
            letter-spacing: 1px; 
        }
        .remoed-user { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        .remoed-avatar { 
            width: 72px; 
            height: 72px; 
            border-radius: 50%; 
            background: #667eea; 
            color: #fff; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: bold; 
            font-size: 2.2rem; 
        }
        .remoed-username { 
            color: #667eea; 
            font-weight: 600; 
        }
        .remoed-menu { 
            list-style: none; 
            padding: 0; 
            margin: 0; 
        }
        .remoed-menu li { 
            padding: 14px 32px; 
            color: #667eea; 
            font-weight: 500; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            border-left: 4px solid transparent; 
            transition: background 0.2s, border-color 0.2s; 
        }
        .remoed-menu li.active, .remoed-menu li:hover { 
            background: linear-gradient(90deg, #667eea 0%, #5a67d8 100%); 
            border-left: 4px solid #667eea; 
            color: white; 
            transform: translateX(4px);
            transition: all 0.3s ease;
        }
        .remoed-menu svg { 
            width: 20px; 
            height: 20px; 
            stroke: currentColor;
        }
        .remoed-content { 
            flex: 1; 
            padding: 20px 32px 20px 32px;
            min-width: 0;
            background: #f6fbff;
            min-height: 100vh;
            box-sizing: border-box;
            margin-left: 260px;
            max-width: calc(100vw - 260px);
            display: flex;
            flex-direction: column;
        }
        
        .content-scrollable {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        .main-layout {
            margin-top: 0;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        .calendar-section {
            width: 100%;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        /* Calendar Styles */
        .header {
            margin-bottom: 8px;
        }
        .header h1 {
            color: #667eea;
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0 0 8px 0;
        }
        .header-info {
            margin-bottom: 8px;
        }
        .info-item {
            margin-bottom: 4px;
        }
        .quota {
            font-size: 0.85rem;
            color: #495057;
            font-weight: 500;
        }
        .week-navigation {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .nav-btn {
            background: linear-gradient(135deg, #ffe85a, #f4d03f);
            color: #333;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(255, 232, 90, 0.3);
            height: 32px;
            min-width: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .nav-btn:hover {
            background: linear-gradient(135deg, #f4d03f, #f1c40f);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 232, 90, 0.4);
        }
        .nav-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .week-display {
            font-weight: 600;
            color: #333;
            min-width: 100px;
            text-align: center;
            font-size: 0.85rem;
        }
        .current-week-btn, .current-week {
            background: linear-gradient(135deg, #28a745, #1e7e34) !important;
            color: white;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3) !important;
        }
        .current-week-btn:hover, .current-week:hover {
            background: linear-gradient(135deg, #1e7e34, #155724) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4) !important;
        }
        .action-buttons {
            display: flex;
            gap: 12px;
        }
        .submit-btn {
            background: linear-gradient(135deg, #667eea, #5a67d8);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            height: 40px;
            min-width: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .submit-btn:hover {
            background: linear-gradient(135deg, #5a67d8, #4c51bf);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .back-btn {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(108, 117, 125, 0.3);
            height: 32px;
            min-width: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .back-btn:hover {
            background: linear-gradient(135deg, #5a6268, #495057);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.4);
        }
        
        /* Weekly Grid */
        .weekly-grid {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(28, 167, 231, 0.1);
            overflow: auto;
            max-height: calc(100vh - 120px);
            min-height: calc(100vh - 120px);
            max-width: 100%;
            box-sizing: border-box;
            border: 1px solid rgba(28, 167, 231, 0.1);
        }
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
        }
        .time-column {
            width: 100px;
            min-width: 100px;
            padding: 12px;
            background: linear-gradient(135deg, #667eea, #5a67d8);
            color: white;
            font-weight: 600;
            text-align: center;
            position: sticky;
            left: 0;
            z-index: 5;
            border-right: 2px solid rgba(255,255,255,0.2);
        }
        .grid-header {
            display: grid;
            grid-template-columns: 100px repeat(7, 1fr);
            background: linear-gradient(135deg, #667eea, #5a67d8);
            color: white;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            border-radius: 12px 12px 0 0;
        }
        .grid-header > div {
            padding: 12px 6px;
            text-align: center;
            border-right: 1px solid rgba(255,255,255,0.2);
            font-size: 0.9rem;
        }
        .grid-header > div:last-child {
            border-right: none;
        }
        .time-slot {
            display: grid;
            grid-template-columns: 100px repeat(7, 1fr);
            border-bottom: 1px solid #e0e6ed;
        }
        .time-slot:last-child {
            border-bottom: none;
        }
        .time-label {
            padding: 12px;
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: 1px solid #e0e6ed;
            font-size: 0.85rem;
        }
        .slot-cell {
            padding: 12px 6px;
            border-right: 1px solid #e0e6ed;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .slot-cell:last-child {
            border-right: none;
        }
        .slot-cell.available {
            background: #e8f5e8;
            color: #28a745;
            font-weight: bold;
            font-size: 0.8rem;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .slot-cell.available:hover {
            background: #d4edda;
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }
        .slot-cell.selected {
            background: #1ca7e7;
            color: white;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(28, 167, 231, 0.4);
            font-weight: bold;
        }
        .slot-cell.unavailable {
            background: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }
        .slot-cell.past {
            background: #f8f9fa;
            color: #adb5bd;
            cursor: not-allowed;
            font-size: 0.7rem;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .slot-cell.booked {
            background: #f8d7da;
            color: #721c24;
            cursor: not-allowed;
            font-weight: bold;
            font-size: 0.8rem;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Booking Modal */
        .booking-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        .booking-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .booking-modal-content {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #f1f5f9;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1a202c;
            margin: 0;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-close:hover {
            background: #f1f5f9;
            color: #1a202c;
        }
        
        .booking-panel {
            background: #fff;
            border-radius: 12px;
            padding: 0;
            border: none;
            position: static;
        }
        .booking-panel h3 {
            color: #667eea;
            margin-bottom: 12px;
            font-size: 1.2rem;
        }
        .form-group {
            margin-bottom: 12px;
        }
        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #e0e6ed;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        .form-group input.error, .form-group select.error {
            border-color: #dc3545;
            background-color: #fff5f5;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
        }
        .form-group input.error:focus, .form-group select.error:focus {
            border-color: #dc3545;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.2);
        }
        .form-group .error-message {
            color: #dc3545;
            font-size: 0.8rem;
            margin-top: 4px;
            display: none;
        }
        .form-group .error-message.show {
            display: block;
        }
        .selected-slots {
            margin-bottom: 16px;
            max-height: 250px;
            overflow-y: auto;
            border: 2px solid #1ca7e7;
            border-radius: 8px;
            padding: 12px;
            background: #f0f8ff;
        }
        .selected-slot {
            background: #e3f2fd;
            border: 1px solid #1ca7e7;
            border-radius: 6px;
            padding: 10px 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(28, 167, 231, 0.1);
        }
        .selected-slot:last-child {
            margin-bottom: 0;
        }
        .selected-slot:hover {
            background: #bbdefb;
            transform: translateX(2px);
        }
        .selected-slot-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .selected-slot-time {
            font-weight: bold;
            color: #1976d2;
        }
        .selected-slot-date {
            font-size: 0.75rem;
            color: #666;
        }
        .selected-slots-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #dee2e6;
        }
        .selected-slots-count {
            font-weight: bold;
            color: #667eea;
            font-size: 0.9rem;
        }
        .clear-all-slots {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: background 0.2s;
        }
        .clear-all-slots:hover {
            background: #c82333;
        }
        .remove-slot {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 3px 6px;
            cursor: pointer;
            font-size: 0.75rem;
        }
        .remove-slot:hover {
            background: #c82333;
        }
        .book-btn {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }
        .book-btn:hover {
            background: linear-gradient(135deg, #1e7e34, #155724);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }
        .book-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .booking-summary {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }
        .booking-summary h4 {
            margin: 0 0 8px 0;
            color: #667eea;
            font-size: 0.9rem;
        }
        .booking-summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 0.85rem;
        }
        .booking-summary-item:last-child {
            margin-bottom: 0;
        }
        .booking-summary-label {
            color: #666;
        }
        .booking-summary-value {
            font-weight: bold;
            color: #333;
        }
        .message {
            margin-top: 12px;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-size: 0.9rem;
        }
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .hidden {
            display: none;
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(100px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-100px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .floating-slot-item {
            background: #e3f2fd;
            border: 1px solid #1ca7e7;
            border-radius: 4px;
            padding: 6px 10px;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }
        
        .floating-slot-item:last-child {
            margin-bottom: 0;
        }
        
        .floating-slot-item:hover {
            background: #bbdefb;
        }
        
        .floating-slot-time {
            font-weight: bold;
            color: #1976d2;
        }
        
        .floating-slot-date {
            font-size: 0.75rem;
            color: #666;
        }
        
        .floating-slot-remove {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 6px;
            cursor: pointer;
            font-size: 0.7rem;
            transition: background 0.2s;
        }
        
        .floating-slot-remove:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <div class="remoed-main">
        <nav class="remoed-sidebar">
            <div class="remoed-logo" style="height:100px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px; padding-top:24px;">
                <img src="remoed-logo.png" alt="RemoEdPH Logo" style="height:50px; width:auto; display:inline-block; vertical-align:middle; filter: drop-shadow(0 2px 4px rgba(28, 167, 231, 0.3));">
                <span class="remoed-title" style="font-size:1.4rem; font-weight:800; color:#1CA7E7; letter-spacing:1px; text-shadow: 2px 2px 4px rgba(28, 167, 231, 0.2);">RemoEdPH</span>
                <div style="font-size: 0.75rem; color: #666;">Student Portal</div>
            </div>
            <div class="remoed-user" style="display:flex; flex-direction:column; align-items:center; margin-bottom:24px;">
                <div class="remoed-avatar" id="sidebar-avatar" style="position: relative; overflow: hidden; width: 3rem; height: 3rem;"> 
                    <img id="profile-image" class="avatar-img" src="" alt="Profile" style="display: none;">
                    <span id="avatar-text" class="avatar-text">S</span>
                </div>
                <span class="remoed-username" id="sidebar-email">student@remoedph.com</span>
            </div>
            <ul class="remoed-menu">
                <li onclick="window.location.href='student-dashboard.html'">üè† <span>My Home</span></li>
                <li onclick="window.location.href='student-class-table.html'">üìÖ <span>My Schedule</span></li>
                <li class="active">‚ûï <span>Book a Class</span></li>
                <li onclick="window.location.href='student-booking-history.html'">üìú <span>My Classes</span></li>
                <li onclick="window.location.href='student-games-activities.html'">üéÆ <span>Play & Learn</span></li>
                <li onclick="window.location.href='student-profile.html'">üë§ <span>My Profile</span></li>
                <li onclick="window.location.href='student-assessment.html'">üéØ <span>My Level</span></li>
                <li id="logout-nav" style="margin-top:auto; color:#e74c3c; cursor:pointer;">üö™ <span>Exit</span></li>
            </ul>
        </nav>
        <div class="remoed-content">
            <div style="flex-shrink: 0;">
                <div class="header">
                    <h1 style="font-size: 2rem; font-weight: 800; color: #1CA7E7; text-shadow: 2px 2px 4px rgba(28, 167, 231, 0.2); display: flex; align-items: center; gap: 12px;">
                        <span>üìöüì∂</span>
                        <span>‚ûï Book a Fun Class! üìö</span>
                    </h1>
                </div>

                <div class="header-info">
                <div class="info-item">
                    <span class="quota" id="available-slots-info">Select a time slot to book a class</span>
                </div>
                
                <!-- Combined Navigation and Action Buttons Row -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; flex-wrap: wrap; gap: 8px;">
                    <!-- Week Navigation -->
                    <div class="week-navigation" style="display: flex; align-items: center; gap: 8px;">
                        <button class="nav-btn" id="prev-week">‚Üê Prev</button>
                        <span class="week-display" id="week-display">Loading...</span>
                        <button class="nav-btn" id="next-week">Next ‚Üí</button>
                        <button class="nav-btn current-week-btn" id="current-week">Today</button>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="action-buttons" style="display: flex; gap: 8px;">
                        <button id="back-to-schedule-btn" class="back-btn" onclick="window.location.href='student-class-table.html'" style="padding: 6px 12px; font-size: 0.8rem; height: 32px;">View Schedule</button>
                    </div>
                </div>
            </div>

            <!-- Slot Legend -->
            <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 6px 10px; border-radius: 8px; margin-bottom: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.08);">
                <div style="display: flex; align-items: center; flex-wrap: nowrap; gap: 6px; font-size: 0.7rem; overflow-x: auto; padding-bottom: 2px;">
                    <div style="display: flex; align-items: center; gap: 3px; padding: 2px 5px; background: rgba(255,255,255,0.7); border-radius: 3px; border: 1px solid rgba(0,0,0,0.05); white-space: nowrap; min-width: fit-content;">
                        <div style="width: 12px; height: 12px; background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%); border-radius: 2px; border: 1px solid #28a745; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #28a745; font-size: 7px;">‚úì</div>
                        <span style="font-weight: 500; color: #495057; font-size: 0.7rem;">Available</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 3px; padding: 2px 5px; background: rgba(255,255,255,0.7); border-radius: 3px; border: 1px solid rgba(0,0,0,0.05); white-space: nowrap; min-width: fit-content;">
                        <div style="width: 12px; height: 12px; background: linear-gradient(135deg, #1ca7e7 0%, #0d8bd9 100%); border-radius: 2px; border: 1px solid #0d8bd9; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 7px;">‚úì</div>
                        <span style="font-weight: 500; color: #495057; font-size: 0.7rem;">Selected</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 3px; padding: 2px 5px; background: rgba(255,255,255,0.7); border-radius: 3px; border: 1px solid rgba(0,0,0,0.05); white-space: nowrap; min-width: fit-content;">
                        <div style="width: 12px; height: 12px; background: linear-gradient(135deg, #ff6b6b 0%, #dc3545 100%); border-radius: 2px; border: 1px solid #dc3545; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 5px;">üîí</div>
                        <span style="font-weight: 500; color: #495057; font-size: 0.7rem;">Booked</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 3px; padding: 2px 5px; background: rgba(255,255,255,0.7); border-radius: 3px; border: 1px solid rgba(0,0,0,0.05); white-space: nowrap; min-width: fit-content;">
                        <div style="width: 12px; height: 12px; background: linear-gradient(135deg, #6c757d 0%, #495057 100%); border-radius: 2px; border: 1px solid #495057; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 5px;">‚è∞</div>
                        <span style="font-weight: 500; color: #495057; font-size: 0.7rem;">Past</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 3px; padding: 2px 5px; background: rgba(255,255,255,0.7); border-radius: 3px; border: 1px solid rgba(0,0,0,0.05); white-space: nowrap; min-width: fit-content;">
                        <div style="width: 12px; height: 12px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 2px; border: 1px solid #6c757d; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #6c757d; font-size: 7px;">‚Äî</div>
                        <span style="font-weight: 500; color: #495057; font-size: 0.7rem;">Unavailable</span>
                    </div>
                </div>
                </div>
            </div>

            <div class="weekly-grid" id="weekly-grid" style="flex: 1; min-height: 0;">
                <table class="schedule-table">
                    <thead>
                        <tr id="day-headers-row">
                            <th class="time-column">Time</th>
                        </tr>
                    </thead>
                    <tbody id="time-slots-grid">
                        <!-- Grid will be generated by JavaScript -->
                    </tbody>
                </table>
            </div>
                
                <!-- Booking Modal -->
                <div class="booking-modal" id="booking-modal">
                    <div class="booking-modal-content">
                        <div class="modal-header">
                            <h2 class="modal-title">Booking Details</h2>
                            <button class="modal-close" onclick="closeBookingModal()">&times;</button>
                        </div>
                        
                        <div class="booking-panel" id="booking-panel">
                            <!-- Selected Class Section - Always Visible -->
                            <div class="selected-slots" id="selected-slots" style="margin-bottom: 20px;">
                                <div class="selected-slots-header" id="selected-slots-header">
                                    <span class="selected-slots-count" id="selected-slots-count">No class selected</span>
                                    <button type="button" class="clear-all-slots" onclick="clearAllSlots()" style="display: none;">Clear</button>
                                </div>
                                <div id="selected-slots-list">
                                    <div style="text-align: center; color: #666; font-style: italic; padding: 20px;">Click on an available time slot (green cells) to select it.</div>
                                </div>
                            </div>
                            
                            <!-- Booking Summary - Always Visible -->
                            <div class="booking-summary" id="booking-summary" style="display: none;">
                                <h4>üìã Selected Class</h4>
                                <div class="booking-summary-item">
                                    <span class="booking-summary-label">Date:</span>
                                    <span class="booking-summary-value" id="summary-date">-</span>
                                </div>
                                <div class="booking-summary-item">
                                    <span class="booking-summary-label">Time:</span>
                                    <span class="booking-summary-value" id="summary-time">-</span>
                                </div>
                            </div>
                            
                            <!-- Visual Separator -->
                            <div style="border-top: 2px solid #e0e6ed; margin: 20px 0; padding-top: 20px;">
                                <h3 style="color: #667eea; margin-bottom: 15px; font-size: 1.1rem;">üìù Booking Details</h3>
                            </div>
                            
                            <form id="booking-form">
                                <div class="form-group">
                                    <label for="student-level">Student Level <span style="color: #dc3545;">*</span></label>
                                    <select id="student-level" required onchange="clearFieldError('student-level'); loadLessonsForLevel();">
                                        <option value="">Select level</option>
                                        <option value="nursery">Nursery</option>
                                        <option value="kinder">Kinder</option>
                                        <option value="preparatory">Preparatory</option>
                                    </select>
                                    <div class="error-message" id="student-level-error"></div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="lesson">Lesson <span style="color: #dc3545;">*</span></label>
                                    <select id="lesson" required disabled onchange="clearFieldError('lesson');">
                                        <option value="">Select level first</option>
                                    </select>
                                    <div class="error-message" id="lesson-error"></div>
                                    <small style="color: #666; font-size: 0.8rem; margin-top: 4px; display: block;">Select your level above to see available lessons</small>
                                </div>
                                
                                <button type="submit" class="book-btn" id="book-btn">
                                    <span id="book-btn-text">Book Class</span>
                                </button>
                            </form>
                            
                            <div id="booking-message" class="message hidden"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/luxon@3.5.0/build/global/luxon.min.js"></script>
    <script src="timezone-utils.js"></script>
    <script>
        // Role-based access control
        const userType = localStorage.getItem('userType');
        const token = localStorage.getItem('token');
        
        if (userType !== 'student') {
            alert('Access denied. This page is for students only.');
            window.location.href = 'index.html';
        }
        
        if (!token) {
            alert('Please log in to access this page.');
            window.location.href = 'student-login.html';
        }
        
        // Timezone alignment utility (uses detected/selected timezone)
        let userTimezone = (window.TimezoneUtils && TimezoneUtils.getDetectedZone()) || 'UTC';
        
        function getLocalDateString(date) {
            // Format a JS Date as yyyy-MM-dd in the user's timezone
            const { DateTime } = luxon;
            return DateTime.fromJSDate(date, { zone: userTimezone }).toFormat('yyyy-LL-dd');
        }
        
        function initTimezoneControl() {
            const container = document.createElement('div');
            container.style.display = 'flex';
            container.style.alignItems = 'center';
            container.style.gap = '8px';
            container.style.margin = '8px 0';
            
            const label = document.createElement('span');
            label.textContent = 'Timezone:';
            label.style.fontWeight = '600';
            label.style.color = '#374151';
            container.appendChild(label);
            
            const select = document.createElement('select');
            select.id = 'timezone-select';
            select.style.padding = '6px 10px';
            select.style.borderRadius = '6px';
            select.style.border = '1px solid #d1d5db';
            select.style.minWidth = '200px';
            
            const zones = (window.TimezoneUtils && TimezoneUtils.listTimezones()) || ['UTC'];
            zones.forEach(z => {
                const opt = document.createElement('option');
                opt.value = z;
                opt.textContent = z;
                select.appendChild(opt);
            });
            // Add detected zone if not in list
            if (!zones.includes(userTimezone)) {
                const opt = document.createElement('option');
                opt.value = userTimezone;
                opt.textContent = `${userTimezone} (detected)`;
                select.appendChild(opt);
            }
            select.value = userTimezone;
            select.onchange = () => {
                userTimezone = select.value || 'UTC';
                console.log('üåê Timezone changed to:', userTimezone);
                // Regenerate grid with new timezone
                updateWeekDisplay();
                generateWeeklyGrid();
            };
            
            container.appendChild(select);
            
            const host = document.getElementById('week-display');
            if (host && host.parentElement) {
                host.parentElement.appendChild(container);
            } else {
                document.body.prepend(container);
            }
        }
        
        // Get "now" in Philippine time so users in other timezones (e.g., US) still see PH slots
        function getManilaNow() {
            return new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Manila' }));
        }
        
        // Build a Date in Philippine time for a given date/time string
        function getManilaDate(dateStr, timeStr = '00:00') {
            return new Date(`${dateStr}T${timeStr}:00+08:00`);
        }
        
        function getWeekStartDate(date) {
            // Get Monday of the week containing the given date in the user's timezone
            const { DateTime } = luxon;
            const dt = DateTime.fromJSDate(date, { zone: userTimezone });
            const monday = dt.startOf('week').plus({ days: 1 }); // Luxon week starts Sunday; add 1 to get Monday
            return monday.toJSDate();
        }
        
        // Set sidebar avatar and email
        const username = localStorage.getItem('remoedUsername') || 'Student';
        const studentId = localStorage.getItem('studentId');

        // Set fallback initials into the avatar-text element (do not overwrite the container)
        const avatarTextEl = document.getElementById('avatar-text');
        if (avatarTextEl) avatarTextEl.textContent = username[0].toUpperCase();
        const sidebarEmailEl = document.getElementById('sidebar-email');
        if (sidebarEmailEl) sidebarEmailEl.textContent = username;
        
        // Load profile picture if available
        if (studentId) {
            loadProfilePicture(studentId);
        }
        
        // Logout functionality
        document.getElementById('logout-nav').onclick = function() {
            localStorage.clear();
            window.location.href = 'student-login.html';
        };
        
        // Set to current week to see today's slots
        let currentWeek = new Date();
        console.log('üîç Student booking - Current date:', new Date().toISOString());
        console.log('üîç Student booking - Current week object:', currentWeek.toISOString());
        let selectedSlots = new Map(); // Map to store selected slots: key = "date-time", value = {date, time, teacher}
        let availableSlots = new Map(); // Map to store available slots data
        let bookedSlots = new Map(); // Map to store booked slots data
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOM loaded, starting initialization...');
            
            try {
                // Validate token first
                validateToken().then(() => {
                    console.log('‚úÖ Token validated, initializing components...');
                    initTimezoneControl();
                    updateWeekDisplay();
                    generateWeeklyGrid();
                    setupEventListeners();
                    setupModalEventListeners();
                }).catch((error) => {
                    console.error('‚ùå Token validation failed:', error);
                    
                    // Check if it's a real token issue or just a server problem
                    if (error.message.includes('Token invalid') || error.message.includes('No token found')) {
                        // Real token issue - redirect to login
                        alert('Session expired. Please log in again.');
                        localStorage.clear();
                        window.location.href = 'student-login.html';
                    } else {
                        // Server issue - continue with basic functionality
                        console.warn('‚ö†Ô∏è Server issue detected, continuing with basic functionality');
                        initTimezoneControl();
                        updateWeekDisplay();
                        generateWeeklyGrid();
                        setupEventListeners();
                        setupModalEventListeners();
                        
                        // Show a warning to the user
                        const grid = document.getElementById('weekly-grid');
                        if (grid) {
                            grid.innerHTML = `
                                <div style="text-align: center; padding: 50px; color: #666;">
                                    <h3>‚ö†Ô∏è Limited Functionality</h3>
                                    <p>We're experiencing some connection issues with our servers.</p>
                                    <p>You can still view the calendar, but booking functionality may be limited.</p>
                                    <p>Please try refreshing the page or check back later.</p>
                                    <button onclick="location.reload()" style="background: #1ca7e7; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-top: 10px;">
                                        üîÑ Refresh Page
                                    </button>
                                </div>
                            `;
                        }
                    }
                });
            } catch (error) {
                console.error('‚ùå Initialization error:', error);
                // Show error message to user
                const grid = document.getElementById('weekly-grid');
                if (grid) {
                    grid.innerHTML = `
                        <div style="text-align: center; padding: 50px; color: #666;">
                            <h3>‚ö†Ô∏è Error Loading Calendar</h3>
                            <p>There was an error loading the booking calendar. Please refresh the page or try again later.</p>
                            <button onclick="location.reload()" style="background: #1ca7e7; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-top: 10px;">
                                üîÑ Refresh Page
                            </button>
                        </div>
                    `;
                }
            }
        });
        
        // Validate token with backend
        async function validateToken() {
            const token = localStorage.getItem('token');
            if (!token) {
                throw new Error('No token found');
            }
            
            try {
                console.log('üîç Validating token...');
                
                // Add timeout to prevent hanging
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout
                
                const response = await fetch('/api/student/profile', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                console.log('üîç Token validation response status:', response.status);
                
                if (response.status === 401) {
                    throw new Error('Token invalid or expired');
                }
                
                if (!response.ok) {
                    // If it's not a 401, it might be a server issue, not a token issue
                    console.warn('‚ö†Ô∏è Server returned non-200 status, but continuing with basic functionality');
                    return true; // Continue anyway
                }
                
                console.log('‚úÖ Token validation successful');
                return true;
            } catch (error) {
                console.error('‚ùå Token validation failed:', error.message);
                
                // If it's a network error, server unavailable, or timeout, continue with basic functionality
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError') || error.name === 'AbortError') {
                    console.warn('‚ö†Ô∏è Network error or timeout during token validation, continuing with basic functionality');
                    return true; // Continue anyway
                }
                
                // Only throw for actual token issues
                if (error.message.includes('Token invalid') || error.message.includes('No token found')) {
                    throw error;
                }
                
                // For other errors, continue with basic functionality
                console.warn('‚ö†Ô∏è Token validation error, but continuing with basic functionality');
                return true;
            }
        }
        
        function setupEventListeners() {
            // Week navigation buttons
            const prevWeekBtn = document.getElementById('prev-week');
            const nextWeekBtn = document.getElementById('next-week');
            const currentWeekBtn = document.getElementById('current-week');
            const bookingForm = document.getElementById('booking-form');
            
            if (prevWeekBtn) {
                prevWeekBtn.addEventListener('click', () => {
                    currentWeek.setDate(currentWeek.getDate() - 7);
                    updateWeekDisplay();
                    generateWeeklyGrid();
                });
            }
            
            if (nextWeekBtn) {
                nextWeekBtn.addEventListener('click', () => {
                    currentWeek.setDate(currentWeek.getDate() + 7);
                    updateWeekDisplay();
                    generateWeeklyGrid();
                });
            }
            
            if (currentWeekBtn) {
                currentWeekBtn.addEventListener('click', () => {
                    currentWeek = new Date();
                    updateWeekDisplay();
                    generateWeeklyGrid();
                });
            }
            
            if (bookingForm) {
                bookingForm.addEventListener('submit', handleBooking);
            }
            
            // These buttons don't exist in the current HTML structure
            // The floating panels handle booking functionality instead
            
            // Floating panel event listeners are now handled in setupFloatingPanelListeners()
            // This prevents duplicate event listeners
        }
        
        // Luxon helper (with native fallback for timezone-safe weekday names)
        function createDateTime(jsDate, timeZone) {
            const Lux = window.luxon && window.luxon.DateTime;
            if (Lux) return Lux.fromJSDate(jsDate, { zone: timeZone });
            const d = new Date(jsDate);
            return {
                _d: d,
                weekday: ((d.getDay() + 6) % 7) + 1, // ISO: Monday=1 ... Sunday=7
                plus: ({ days = 0 } = {}) => createDateTime(new Date(d.getTime() + days * 86400000), timeZone),
                minus: ({ days = 0 } = {}) => createDateTime(new Date(d.getTime() - days * 86400000), timeZone),
                toFormat: (fmt) => {
                    if (fmt === 'ccc') return d.toLocaleDateString(undefined, { weekday: 'short' });
                    if (fmt === 'LLLL d') return d.toLocaleDateString(undefined, { month: 'long', day: 'numeric' });
                    if (fmt === 'ccc LLLL d') {
                        return `${d.toLocaleDateString(undefined, { weekday: 'short' })} ${d.toLocaleDateString(undefined, { month: 'long' })} ${d.getDate()}`;
                    }
                    return d.toLocaleDateString();
                },
                toISODate: () => d.toISOString().split('T')[0]
            };
        }

        function updateWeekDisplay() {
            const weekStart = getWeekStartDate(currentWeek);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            
            const display = document.getElementById('week-display');
            display.textContent = `${weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
            
            // Remove the previous week button restriction - allow navigation to past weeks
            const prevBtn = document.getElementById('prev-week');
            prevBtn.disabled = false;
            
            // Debug: Log the week being displayed
            console.log('üîç Week display - Week start:', getLocalDateString(weekStart));
            console.log('üîç Week display - Week end:', getLocalDateString(weekEnd));
        }
        
        function generateWeeklyGrid() {
            console.log('üîç Generating weekly grid...');
            
            const grid = document.getElementById('weekly-grid');
            if (!grid) {
                console.error('‚ùå Weekly grid element not found!');
                return;
            }
            
            // Show loading state
            grid.innerHTML = `
                <div style="text-align: center; padding: 50px; color: #666;">
                    <div style="font-size: 2rem; margin-bottom: 15px;">‚è≥</div>
                    <h3>Loading Calendar...</h3>
                    <p>Please wait while we load the available time slots.</p>
                </div>
            `;
            
            const weekStart = getWeekStartDate(currentWeek);
            console.log('üîç Week start date:', weekStart.toISOString());
            
            let html = '<div class="grid-header">';
            html += '<div>Time</div>';
            
            const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
            const weekStartLuxon = createDateTime(weekStart, timeZone);

            for (let i = 0; i < 7; i++) {
                const day = weekStartLuxon.plus({ days: i });
                html += `<div>${day.toFormat('ccc LLLL d')}</div>`;
            }
            html += '</div>';
            
            // Generate time slots from 01:00 to 24:00 (30-minute intervals) - 24-hour format
            const times = [];
            for (let hour = 1; hour < 24; hour++) {
                for (let minute = 0; minute < 60; minute += 30) {
                    const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    times.push({ value: timeStr });
                }
            }
            
            times.forEach(timeObj => {
                html += '<div class="time-slot">';
                html += `<div class="time-label">${timeObj.value}</div>`;
                
                for (let i = 0; i < 7; i++) {
                    const date = new Date(weekStart);
                    date.setDate(weekStart.getDate() + i);
                    const dateStr = getLocalDateString(date); // Use consistent date formatting
                    const slotKey = `${dateStr}-${timeObj.value}`;
                    
                const { DateTime } = luxon;
                const now = DateTime.now().setZone(userTimezone);
                const slotLocal = DateTime.fromISO(`${dateStr}T${timeObj.value}`, { zone: userTimezone });
                const isPast = slotLocal <= now;
                    
                    const isSelected = selectedSlots.has(slotKey);
                    
                    let className = 'slot-cell';
                    if (isPast) {
                        className += ' past';
                    } else if (isSelected) {
                        className += ' selected';
                    } else {
                        className += ' unavailable'; // Start as unavailable, will be updated by loadAvailableSlots
                    }
                    
                    html += `<div class="slot-cell ${className}" data-date="${dateStr}" data-time="${timeObj.value}" onclick="toggleSlot('${dateStr}', '${timeObj.value}')">`;
                    if (isSelected) {
                        html += '‚úì';
                    }
                    html += '</div>';
                }
                html += '</div>';
            });
            
            try {
                grid.innerHTML = html;
                console.log('‚úÖ Weekly grid generated successfully');
                loadAvailableSlots();
            } catch (error) {
                console.error('‚ùå Error generating weekly grid:', error);
                grid.innerHTML = `
                    <div style="text-align: center; padding: 50px; color: #666;">
                        <h3>‚ö†Ô∏è Error Loading Calendar</h3>
                        <p>There was an error generating the booking calendar. Please refresh the page.</p>
                        <button onclick="location.reload()" style="background: #1ca7e7; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-top: 10px;">
                            üîÑ Refresh Page
                        </button>
                    </div>
                `;
            }
        }
        
        async function loadAvailableSlots() {
            console.log('üîç Student booking - loadAvailableSlots() called');
            
            try {
                const weekStart = getWeekStartDate(currentWeek);
                const weekString = getLocalDateString(weekStart); // Use consistent date formatting
                
                const token = localStorage.getItem('token');
                console.log('üîç Student booking - Token exists:', !!token);
                console.log('üîç Loading available slots for week:', weekString);
                
                // Get all available slots for this week (no specific teacher filter for students)
                const response = await fetch(`/api/teacher/slots?week=${weekString}&tz=${encodeURIComponent(userTimezone)}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        console.log('‚ùå Unauthorized - token may be expired');
                        alert('Session expired. Please log in again.');
                        localStorage.clear();
                        window.location.href = 'student-login.html';
                        return;
                    }
                    const errorText = await response.text();
                    console.error('‚ùå Failed to load available slots:', response.status, errorText);
                    
                    // Show error message to user
                    const grid = document.getElementById('weekly-grid');
                    if (grid) {
                        grid.innerHTML = `
                            <div style="text-align: center; padding: 50px; color: #666;">
                                <h3>‚ö†Ô∏è Unable to Load Available Slots</h3>
                                <p>We couldn't load the available time slots. This might be due to:</p>
                                <ul style="text-align: left; display: inline-block; margin: 15px 0;">
                                    <li>No teachers have opened their schedules yet</li>
                                    <li>Network connection issues</li>
                                    <li>Server temporarily unavailable</li>
                                </ul>
                                <p>Please try refreshing the page or check back later.</p>
                                <button onclick="location.reload()" style="background: #1ca7e7; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-top: 10px;">
                                    üîÑ Refresh Page
                                </button>
                            </div>
                        `;
                    }
                    return;
                }
                
                const data = await response.json();
                console.log('üîç Student booking - API response:', data);
                
                availableSlots.clear();
                bookedSlots.clear();
                
                const tz = userTimezone || 'UTC';
                const toKey = (utcIso, fallbackDate, fallbackTime, fallbackZone) => {
                    try {
                        const parts = TimezoneUtils.utcToLocalParts(utcIso, tz);
                        return { key: `${parts.date}-${parts.time}`, local: parts };
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Failed UTC->local conversion, falling back:', e.message);
                        const localDate = fallbackDate || '1970-01-01';
                        const localTime = fallbackTime || '00:00';
                        return { key: `${localDate}-${localTime}`, local: { date: localDate, time: localTime, label: `${localDate} ${localTime}`, zone: fallbackZone || 'UTC' } };
                    }
                };
                
                if (Array.isArray(data.slots)) {
                    console.log('üîç Student booking - Processing', data.slots.length, 'slots from API');
                    data.slots.forEach(slot => {
                        if (slot.available !== true) return;
                        let utc = slot.dateTimeUtc || null;
                        if (!utc && slot.date && slot.time) {
                            try {
                                utc = TimezoneUtils.toUtcIso(slot.date, slot.time, slot.teacherLocalZone || 'Asia/Manila');
                            } catch (e) {
                                console.warn('‚ö†Ô∏è Could not derive UTC for slot:', slot, e.message);
                            }
                        }
                        if (!utc) return;
                        const { key, local } = toKey(utc, slot.date, slot.time, slot.teacherLocalZone);
                        availableSlots.set(key, {
                            ...slot,
                            utc,
                            localDate: local.date,
                            localTime: local.time,
                            localLabel: local.label,
                            clientTz: tz
                        });
                    });
                } else {
                    console.log('üîç Student booking - No slots found in API response');
                }
                
                if (Array.isArray(data.bookings)) {
                    data.bookings.forEach(booking => {
                        let utc = booking.dateTimeUtc || null;
                        if (!utc && booking.date && booking.time) {
                            try {
                                utc = TimezoneUtils.toUtcIso(booking.date, booking.time, booking.teacherLocalZone || booking.studentLocalZone || 'Asia/Manila');
                            } catch (e) {
                                console.warn('‚ö†Ô∏è Could not derive UTC for booking:', booking, e.message);
                            }
                        }
                        if (!utc) return;
                        const { key } = toKey(utc, booking.date, booking.time, booking.teacherLocalZone);
                        bookedSlots.set(key, true);
                    });
                }

                console.log('üîç Student booking - Total available slots after processing:', availableSlots.size);
                
                // If no available slots found, show a message
                if (availableSlots.size === 0) {
                    const grid = document.getElementById('weekly-grid');
                    if (grid) {
                        grid.innerHTML = `
                            <div style="text-align: center; padding: 50px; color: #666;">
                                <div style="font-size: 2rem; margin-bottom: 15px;">üìÖ</div>
                                <h3>No Available Classes</h3>
                                <p>There are currently no available time slots for booking.</p>
                                <p>This might be because:</p>
                                <ul style="text-align: left; display: inline-block; margin: 15px 0;">
                                    <li>Teachers haven't opened their schedules yet</li>
                                    <li>All available slots have been booked</li>
                                    <li>It's outside of booking hours</li>
                                </ul>
                                <p>Please check back later or try a different week.</p>
                                <button onclick="location.reload()" style="background: #1ca7e7; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-top: 10px;">
                                    üîÑ Refresh Page
                                </button>
                            </div>
                        `;
                    }
                    return;
                }
                

                updateSlotDisplay();
                console.log('‚úÖ Available slots loaded successfully');
            } catch (error) {
                console.error('‚ùå Error loading available slots:', error);
                // Show error message to user
                const grid = document.getElementById('weekly-grid');
                if (grid) {
                    grid.innerHTML = `
                        <div style="text-align: center; padding: 50px; color: #666;">
                            <h3>‚ö†Ô∏è Error Loading Available Slots</h3>
                            <p>There was an error loading available time slots. Please refresh the page or try again later.</p>
                            <p style="font-size: 0.9rem; color: #999;">Error: ${error.message}</p>
                            <button onclick="location.reload()" style="background: #1ca7e7; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-top: 10px;">
                                üîÑ Refresh Page
                            </button>
                        </div>
                    `;
                }
            }
        }
        
        function updateSlotDisplay() {
            
            let availableCount = 0;
            const availableSlotsArray = Array.from(availableSlots.keys());
            
            console.log('üîç updateSlotDisplay - Available slots:', availableSlotsArray);
            console.log('üîç updateSlotDisplay - Booked slots:', Array.from(bookedSlots.keys()));
            
            // First, mark all slots as unavailable (grey)
            document.querySelectorAll('.slot-cell').forEach(cell => {
                const date = cell.getAttribute('data-date');
                const time = cell.getAttribute('data-time');
                const slotKey = `${date}-${time}`;
                
                // Debug specific slots we know should be available
                if (slotKey === '2025-08-25-10:30' || slotKey === '2025-08-25-11:00') {
                    console.log(`üîç Debug slot ${slotKey}:`, {
                        date,
                        time,
                        slotKey,
                        isAvailable: availableSlotsArray.includes(slotKey),
                        isBooked: bookedSlots.has(slotKey)
                    });
                }
                
                const { DateTime } = luxon;
                const now = DateTime.now().setZone(userTimezone);
                const slotLocal = DateTime.fromISO(`${date}T${time}`, { zone: userTimezone });
                const isPast = slotLocal <= now;
                
                if (isPast) {
                    cell.classList.remove('available', 'unavailable', 'booked');
                    cell.classList.add('past');
                    cell.textContent = 'Past';
                    cell.style.cursor = 'not-allowed';
                    // Remove click handler for past slots
                    cell.onclick = null;

                } else if (bookedSlots.has(slotKey)) {
                    // Slot is booked (red) - show as booked
                    cell.classList.remove('available', 'unavailable', 'past');
                    cell.classList.add('booked');
                    cell.textContent = 'Booked';
                    cell.style.cursor = 'not-allowed';
                    cell.style.fontWeight = 'bold';
                    cell.style.fontSize = '0.8rem';
                    cell.style.color = '#dc3545';
                    // Remove click handler for booked slots
                    cell.onclick = null;

                } else if (availableSlotsArray.includes(slotKey)) {
                    // Slot is available (green) - only if it actually exists in database
                    cell.classList.remove('unavailable', 'past', 'booked');
                    cell.classList.add('available');
                    cell.textContent = 'Book Now';
                    cell.style.cursor = 'pointer';
                    cell.style.fontWeight = 'bold';
                    cell.style.fontSize = '0.8rem';
                    cell.style.color = '#28a745';
                    // Ensure click handler is set for available slots
                    cell.onclick = () => toggleSlot(date, time);
                    availableCount++;
                } else {
                    // Slot is not available (grey) - this includes slots that don't exist
                    cell.classList.remove('available', 'unavailable', 'past');
                    cell.classList.add('unavailable');
                    cell.textContent = '';
                    cell.style.cursor = 'not-allowed';
                    // Remove click handler for unavailable slots
                    cell.onclick = null;

                }
            });
            
            console.log('üîç updateSlotDisplay - Final available count:', availableCount);
            console.log('üîç updateSlotDisplay - Available slots found:', availableSlotsArray);

        }
        
        function toggleSlot(date, time) {
            const slotKey = `${date}-${time}`;
            const cell = document.querySelector(`[data-date="${date}"][data-time="${time}"]`);
            
            // Check if slot is available (not past) using user's timezone
            const { DateTime } = luxon;
            const now = DateTime.now().setZone(userTimezone);
            const slotLocal = DateTime.fromISO(`${date}T${time}`, { zone: userTimezone });
            const isPast = slotLocal <= now;
            
            const isAvailable = availableSlots.has(slotKey);
            const isBooked = bookedSlots.has(slotKey);
            
            console.log(`Toggling slot: ${date} ${time}`);
            console.log(`  - Slot key: ${slotKey}`);
            console.log(`  - Current date: ${currentDate}, Current time: ${currentTime}`);
            console.log(`  - Is past date: ${isPast}`);
            console.log(`  - Is time passed today: ${isTimePassed}`);
            console.log(`  - Is available: ${isAvailable}`);
            console.log(`  - Is booked: ${isBooked}`);
            console.log(`  - Available slots:`, Array.from(availableSlots.keys()));
            console.log(`  - Booked slots:`, Array.from(bookedSlots.keys()));
            
            if (isPast) {
                showMessage('Cannot book past time slots.', 'error');
                return;
            }
            
            if (isTimePassed) {
                showMessage(`Cannot book ${time} slot as the time has already passed.`, 'error');
                return;
            }
            
            if (isBooked) {
                showMessage('This time slot is already booked. Please select an available slot (green cells only).', 'error');
                return;
            }
            
            if (!isAvailable) {
                showMessage('This time slot is not available for booking. Please select an open slot (green cells only).', 'error');
                return;
            }
            
            if (selectedSlots.has(slotKey)) {
                // Remove slot
                selectedSlots.delete(slotKey);
                cell.classList.remove('selected');
                cell.textContent = '';
            } else {
                // SINGLE BOOKING: Clear any previous selection first
                if (selectedSlots.size > 0) {
                    // Deselect previous slot
                    const previousSlotKey = Array.from(selectedSlots.keys())[0];
                    selectedSlots.delete(previousSlotKey);
                    const [prevDate, prevTime] = previousSlotKey.split('-');
                    const prevCell = document.querySelector(`[data-date="${prevDate}"][data-time="${prevTime}"]`);
                    if (prevCell) {
                        prevCell.classList.remove('selected');
                        prevCell.textContent = '';
                        // Restore original display
                        if (availableSlots.has(previousSlotKey)) {
                            prevCell.classList.add('available');
                            prevCell.textContent = 'Book Now';
                        }
                    }
                }
                
                // Add slot with teacher information
                const availableSlot = availableSlots.get(slotKey);
                if (availableSlot) {
                    // Validate that teacherId exists
                    if (!availableSlot.teacherId) {
                        console.error('‚ùå Available slot missing teacherId:', availableSlot);
                        showMessage('Error: This slot is missing teacher information. Please refresh the page and try again.', 'error');
                        return;
                    }
                    
                    console.log('üîç Selecting slot:', { date, time, teacherId: availableSlot.teacherId });
                    selectedSlots.set(slotKey, { 
                        date: availableSlot.localDate || date, 
                        time: availableSlot.localTime || time, 
                        utc: availableSlot.utc,
                        teacherId: availableSlot.teacherId // use the teacher ID from the slot data
                    });
                    cell.classList.add('selected');
                    cell.textContent = '‚úì';
                    
                    // Auto-open booking modal for single booking
                    showBookingModal();
                } else {
                    console.error('‚ùå Slot not found in availableSlots:', slotKey);
                    showMessage('This slot is no longer available. Please refresh the page.', 'error');
                }
            }
            
            updateBookingPanel();
            
            // Show modal only when user explicitly wants to book (not on every selection)
            // The modal will be shown when clicking a "Book Now" button or similar
        }
        
        // Modal functions
        function showBookingModal() {
            const modal = document.getElementById('booking-modal');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }
        
        function closeBookingModal() {
            const modal = document.getElementById('booking-modal');
            modal.classList.remove('show');
            document.body.style.overflow = ''; // Restore scrolling
            
            // Reset form but keep selected slots
            document.getElementById('booking-form').reset();
            
            // Clear all field errors when closing modal
            clearAllFieldErrors();
        }
        
        function clearAllSelections() {
            // Clear selected slots and reset form
            selectedSlots.clear();
            document.getElementById('booking-form').reset();
            updateBookingPanel();
            
            // Clear selected cells
            document.querySelectorAll('.slot-cell.selected').forEach(cell => {
                cell.classList.remove('selected');
                cell.textContent = '';
            });
        }
        
        // Close modal when clicking outside
        function setupModalEventListeners() {
            const modal = document.getElementById('booking-modal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeBookingModal();
                    }
                });
            }
            
            // Ensure floating panel event listeners are set up
            setupFloatingPanelListeners();
        }
        
        function setupFloatingPanelListeners() {
            // SINGLE BOOKING: Floating panels removed - no listeners needed
        }
        
        function updateBookingPanel() {
            const slotsContainer = document.getElementById('selected-slots-list');
            const headerContainer = document.getElementById('selected-slots-header');
            const countElement = document.getElementById('selected-slots-count');
            
            // Update floating panels
            updateFloatingPanels();
            
            if (selectedSlots.size === 0) {
                // Show empty state in modal
                headerContainer.style.display = 'flex';
                countElement.textContent = 'No class selected';
                slotsContainer.innerHTML = '<div style="text-align: center; color: #666; font-style: italic; padding: 20px;">Click on an available time slot (green cells) to select it.</div>';
                return;
            }
            
            // SINGLE BOOKING: Show single selection
            headerContainer.style.display = 'flex';
            countElement.textContent = '1 class selected';
            
            // Update button text
            const bookBtnText = document.getElementById('book-btn-text');
            const bookBtnCount = document.getElementById('book-btn-count');
            if (bookBtnText) {
                bookBtnText.textContent = 'Book Class';
            }
            if (bookBtnCount) {
                bookBtnCount.textContent = '';
            }
            
            // Update booking summary
            updateBookingSummary();
            
            slotsContainer.innerHTML = '';
            
            // SINGLE BOOKING: Show only the selected slot
            const [key, slot] = Array.from(selectedSlots.entries())[0];
            const slotDiv = document.createElement('div');
            slotDiv.className = 'selected-slot';
            
            const date = new Date(slot.date);
            const [hour, minute] = slot.time.split(':');
            const timeDisplay = `${hour.padStart(2, '0')}:${minute.padStart(2, '0')}`;
            
            slotDiv.innerHTML = `
                <div class="selected-slot-info">
                    <div class="selected-slot-time">${timeDisplay}</div>
                    <div class="selected-slot-date">${date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' })}</div>
                </div>
                <button type="button" class="remove-slot" onclick="removeSlot('${key}')" title="Remove this class">√ó</button>
            `;
            
            slotsContainer.appendChild(slotDiv);
        }
        
        function removeSlot(slotKey) {
            selectedSlots.delete(slotKey);
            const [date, time] = slotKey.split('-');
            const cell = document.querySelector(`[data-date="${date}"][data-time="${time}"]`);
            if (cell) {
                cell.classList.remove('selected');
                cell.textContent = '';
            }
            updateBookingPanel();
            
            // Close modal if no slots are selected
            if (selectedSlots.size === 0) {
                closeBookingModal();
            }
        }
        
        function clearAllSlots() {
            if (confirm('Are you sure you want to clear all selected classes?')) {
                clearAllSelections();
                closeBookingModal();
            }
        }
        
        function updateFloatingPanels() {
            // SINGLE BOOKING: Floating panels removed - not needed for single booking
            // Modal handles all booking UI
        }
        
        function updateBookingSummary() {
            const summaryContainer = document.getElementById('booking-summary');
            const dateElement = document.getElementById('summary-date');
            const timeElement = document.getElementById('summary-time');
            
            if (selectedSlots.size === 0) {
                summaryContainer.style.display = 'none';
                return;
            }
            
            // SINGLE BOOKING: Show single slot info
            const slot = Array.from(selectedSlots.values())[0];
            const date = new Date(slot.date);
            
            summaryContainer.style.display = 'block';
            dateElement.textContent = date.toLocaleDateString('en-US', { 
                weekday: 'short', 
                month: 'short', 
                day: 'numeric',
                year: 'numeric'
            });
            timeElement.textContent = slot.time;
        }
        
        // Clear field error highlighting
        function clearFieldError(fieldId) {
            const field = document.getElementById(fieldId);
            const errorMsg = document.getElementById(fieldId + '-error');
            if (field) {
                field.classList.remove('error');
            }
            if (errorMsg) {
                errorMsg.classList.remove('show');
                errorMsg.textContent = '';
            }
        }
        
        // Highlight missing field with error
        function highlightFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const errorMsg = document.getElementById(fieldId + '-error');
            
            if (field) {
                field.classList.add('error');
                // Scroll to field if needed
                field.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            if (errorMsg) {
                errorMsg.textContent = message;
                errorMsg.classList.add('show');
            }
        }
        
        // Clear all field errors
        function clearAllFieldErrors() {
            clearFieldError('student-level');
            clearFieldError('lesson');
        }
        
        async function handleBooking(e) {
            e.preventDefault();
            
            // Clear previous errors
            clearAllFieldErrors();
            
            // SINGLE BOOKING: Only allow one slot
            if (selectedSlots.size === 0) {
                showMessage('Please select a time slot to book.', 'error');
                return;
            }
            
            if (selectedSlots.size > 1) {
                showMessage('Please select only one time slot at a time.', 'error');
                return;
            }
            
            // Get field values with trimming
            const lessonSelectEl = document.getElementById('lesson');
            const studentLevelEl = document.getElementById('student-level');
            
            const lessonId = lessonSelectEl ? lessonSelectEl.value.trim() : '';
            const studentLevel = studentLevelEl ? studentLevelEl.value.trim() : '';
            
            // Get detailed info about selected option
            let selectedOptionInfo = null;
            if (lessonSelectEl && lessonSelectEl.selectedIndex >= 0) {
                const selectedOption = lessonSelectEl.options[lessonSelectEl.selectedIndex];
                selectedOptionInfo = {
                    index: lessonSelectEl.selectedIndex,
                    value: selectedOption ? selectedOption.value : 'N/A',
                    text: selectedOption ? selectedOption.textContent : 'N/A',
                    hasValue: selectedOption ? (selectedOption.value && selectedOption.value.trim() !== '') : false
                };
            }
            
            console.log('üîç Field values read:', {
                lessonId: lessonId || 'EMPTY',
                studentLevel: studentLevel || 'EMPTY',
                lessonSelectExists: !!lessonSelectEl,
                studentLevelSelectExists: !!studentLevelEl,
                lessonSelectDisabled: lessonSelectEl ? lessonSelectEl.disabled : 'N/A',
                lessonSelectSelectedIndex: lessonSelectEl ? lessonSelectEl.selectedIndex : 'N/A',
                lessonSelectOptionsLength: lessonSelectEl ? lessonSelectEl.options.length : 'N/A',
                selectedOptionInfo: selectedOptionInfo
            });
            
            // Validate and highlight missing fields
            let hasErrors = false;
            
            if (!studentLevel || studentLevel === '') {
                console.log('‚ùå studentLevel is empty or invalid');
                highlightFieldError('student-level', 'Please select your student level');
                hasErrors = true;
            }
            
            if (!lessonId || lessonId === '') {
                console.log('‚ùå lessonId is empty or invalid');
                highlightFieldError('lesson', 'Please select a lesson');
                hasErrors = true;
            }
            
            if (hasErrors) {
                console.log('‚ùå Validation failed - has errors:', hasErrors);
                showMessage('Please fill in all required fields marked with *', 'error');
                return;
            }
            
            console.log('‚úÖ All fields validated successfully');
            
            // Get lesson title from selected option (reuse lessonSelectEl from above)
            let lessonTitle = '';
            
            if (lessonSelectEl && lessonSelectEl.options && lessonSelectEl.selectedIndex >= 0) {
                const selectedOption = lessonSelectEl.options[lessonSelectEl.selectedIndex];
                lessonTitle = selectedOption ? selectedOption.text.trim() : '';
                console.log('üîç Lesson title from select:', {
                    selectedIndex: lessonSelectEl.selectedIndex,
                    optionText: lessonTitle,
                    optionValue: selectedOption ? selectedOption.value : 'N/A'
                });
            }
            
            // If lessonTitle is empty or just whitespace, try to use lessonId as fallback
            if (!lessonTitle || lessonTitle === '' || lessonTitle === '-- Select a lesson --' || lessonTitle === 'Select level first') {
                lessonTitle = lessonId ? `Lesson ${lessonId}` : 'Lesson';
                console.log('üîç Using fallback lesson title:', lessonTitle);
            }
            
            const finalLessonTitle = lessonTitle ? lessonTitle.trim() : '';
            
            console.log('üîç Final values before booking:', {
                lessonId: lessonId || 'EMPTY',
                studentLevel: studentLevel || 'EMPTY',
                finalLessonTitle: finalLessonTitle || 'EMPTY',
                lessonSelectValue: lessonSelectEl ? lessonSelectEl.value : 'N/A',
                studentLevelSelectValue: studentLevelEl ? studentLevelEl.value : 'N/A',
                lessonSelectSelectedIndex: lessonSelectEl ? lessonSelectEl.selectedIndex : 'N/A'
            });
            
            const bookBtn = document.getElementById('book-btn');
            const bookBtnText = document.getElementById('book-btn-text');
            bookBtn.disabled = true;
            bookBtnText.textContent = 'Booking...';
            
            const token = localStorage.getItem('token');
            
            // Get the single selected slot
            const slot = Array.from(selectedSlots.values())[0];
            
            console.log('üîç Booking request:', {
                slot,
                lessonId: lessonId,
                lessonTitle: finalLessonTitle,
                studentLevel: studentLevel,
                rawValues: {
                    lessonIdRaw: lessonSelectEl ? lessonSelectEl.value : 'N/A',
                    studentLevelRaw: studentLevelEl ? studentLevelEl.value : 'N/A'
                }
            });
            console.log('üîç Using token:', token ? 'Token exists' : 'No token');
            
            // Validate slot
            if (!slot.teacherId || !slot.date || !slot.time || !slot.utc) {
                console.error('‚ùå Slot validation failed:', slot);
                showMessage(`Error: Selected slot is missing required information (teacherId: ${slot.teacherId ? 'OK' : 'MISSING'}, date: ${slot.date ? 'OK' : 'MISSING'}, time: ${slot.time ? 'OK' : 'MISSING'}, utc: ${slot.utc ? 'OK' : 'MISSING'}). Please refresh and try again.`, 'error');
                bookBtn.disabled = false;
                bookBtnText.textContent = 'Book Class';
                return;
            }
            
            // Additional validation with trimmed values (values already trimmed above)
            if (!lessonId || !studentLevel || !finalLessonTitle) {
                console.log('‚ùå Additional validation failed:', {
                    lessonId: lessonId || 'EMPTY',
                    studentLevel: studentLevel || 'EMPTY',
                    lessonTitle: finalLessonTitle || 'EMPTY'
                });
                // Highlight missing fields
                if (!studentLevel) {
                    highlightFieldError('student-level', 'Please select your student level');
                }
                if (!lessonId) {
                    highlightFieldError('lesson', 'Please select a lesson');
                }
                showMessage('Error: Please select both your level and a lesson before booking.', 'error');
                bookBtn.disabled = false;
                bookBtnText.textContent = 'Book Class';
                return;
            }
            
            try {
                // Book single slot - use trimmed values
                const requestBody = {
                    teacherId: slot.teacherId,
                    date: slot.date, // legacy
                    time: slot.time, // legacy
                    dateTimeUtc: slot.utc,
                    timezone: userTimezone,
                    lesson: finalLessonTitle,
                    lessonId: lessonId,
                    studentLevel: studentLevel
                };
                
                console.log('üîç Sending booking request:', requestBody);
                console.log('üîç Request body fields:', {
                    teacherId: requestBody.teacherId ? '‚úì' : '‚úó MISSING',
                    date: requestBody.date ? '‚úì' : '‚úó MISSING',
                    time: requestBody.time ? '‚úì' : '‚úó MISSING',
                    lesson: requestBody.lesson ? '‚úì' : '‚úó MISSING',
                    lessonId: requestBody.lessonId ? '‚úì' : '‚úó MISSING',
                    studentLevel: requestBody.studentLevel ? '‚úì' : '‚úó MISSING'
                });
                
                const response = await fetch('/api/teacher/book-class', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(requestBody)
                });
                
                console.log('üîç Server response status:', response.status, response.statusText);
                
                const result = await response.json();
                console.log('üîç Server response:', result);
                
                if (!response.ok) {
                    const errorMsg = result.error || result.message || 'Booking failed';
                    const errorDetails = result.details || {};
                    
                    // Highlight missing fields based on server response
                    if (errorMsg.includes('Missing required fields') || result.missingFields) {
                        const missingFields = result.missingFields || [];
                        
                        // Check which fields are missing and highlight them
                        if (missingFields.includes('studentLevel') || !errorDetails.studentLevel) {
                            highlightFieldError('student-level', 'Student level is required');
                        }
                        if (missingFields.includes('lesson') || !errorDetails.lesson) {
                            highlightFieldError('lesson', 'Lesson selection is required');
                        }
                        
                        // Also check if slot fields are missing
                        if (missingFields.includes('teacherId') || missingFields.includes('date') || missingFields.includes('time')) {
                            showMessage('Selected time slot is invalid. Please select a different slot.', 'error');
                            // Clear selection
                            selectedSlots.clear();
                            updateBookingPanel();
                        }
                    }
                    
                    const errorDetailsStr = result.details ? ` (Details: ${JSON.stringify(result.details)})` : '';
                    throw new Error(errorMsg + errorDetailsStr);
                }
                
                showMessage(`‚úÖ Booking successful! You have booked 1 class. You will receive a confirmation email shortly.`, 'success');
                
                // Close modal and clear selections after successful booking
                closeBookingModal();
                clearAllSelections();
                
                // Refresh the grid to show updated availability
                generateWeeklyGrid();
                
            } catch (error) {
                console.error('‚ùå Booking error:', error);
                
                // Parse error message to highlight specific fields
                const errorMessage = error.message || 'Unknown error occurred. Please check that all fields are filled correctly.';
                
                // Check for common missing field patterns
                if (errorMessage.includes('studentLevel') || errorMessage.includes('student level')) {
                    highlightFieldError('student-level', 'Student level is required');
                }
                if (errorMessage.includes('lesson') && !errorMessage.includes('lessonId')) {
                    highlightFieldError('lesson', 'Lesson selection is required');
                }
                if (errorMessage.includes('teacherId') || errorMessage.includes('date') || errorMessage.includes('time')) {
                    showMessage('Selected time slot is invalid. Please select a different slot.', 'error');
                    selectedSlots.clear();
                    updateBookingPanel();
                }
                
                showMessage('Error booking class: ' + errorMessage, 'error');
            } finally {
                bookBtn.disabled = false;
                bookBtnText.textContent = 'Book Class';
            }
        }
        
        function showMessage(text, type) {
            const messageDiv = document.getElementById('booking-message');
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
            messageDiv.classList.remove('hidden');
            
            setTimeout(() => {
                messageDiv.classList.add('hidden');
            }, 5000);
        }
        
        // Load profile picture from backend
        async function loadProfilePicture(studentId) {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    console.log('üîç No token found for profile picture - using avatar text');
                    ensureAvatarTextVisible();
                    return;
                }
                
                const username = localStorage.getItem('remoedUsername') || 'Student';
                console.log('üîç Loading profile picture for studentId:', studentId);
                console.log('üîç Username from localStorage:', username);
                
                // Try multiple API endpoints
                let profileData = null;
                let response = null;
                
                // First try: /api/student/profile
                try {
                    console.log('üîç Trying /api/student/profile endpoint...');
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000);
                    
                    response = await fetch(`/api/student/profile`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Cache-Control': 'no-cache',
                            'Pragma': 'no-cache'
                        },
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (response.ok) {
                        profileData = await response.json();
                        console.log('‚úÖ Profile data received from /api/student/profile:', profileData);
                    } else {
                        console.log('‚ùå /api/student/profile failed with status:', response.status);
                    }
                } catch (error) {
                    console.log('‚ùå Error with /api/student/profile:', error.message);
                }
                
                // Second try: /api/students/profile (alternative endpoint)
                if (!profileData && response && response.status !== 200) {
                    try {
                        console.log('üîç Trying /api/students/profile endpoint...');
                        const controller2 = new AbortController();
                        const timeoutId2 = setTimeout(() => controller2.abort(), 5000);
                        
                        response = await fetch(`/api/students/profile`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Cache-Control': 'no-cache',
                                'Pragma': 'no-cache'
                            },
                            signal: controller2.signal
                        });
                        
                        clearTimeout(timeoutId2);
                        
                        if (response.ok) {
                            profileData = await response.json();
                            console.log('‚úÖ Profile data received from /api/students/profile:', profileData);
                        }
                    } catch (error) {
                        console.log('‚ùå Error with /api/students/profile:', error.message);
                    }
                }
                
                // Third try: Direct student lookup by ID
                if (!profileData && studentId) {
                    try {
                        console.log('üîç Trying direct student lookup by ID...');
                        const controller3 = new AbortController();
                        const timeoutId3 = setTimeout(() => controller3.abort(), 5000);
                        
                        response = await fetch(`/api/students/${studentId}`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Cache-Control': 'no-cache',
                                'Pragma': 'no-cache'
                            },
                            signal: controller3.signal
                        });
                        
                        clearTimeout(timeoutId3);
                        
                        if (response.ok) {
                            profileData = await response.json();
                            console.log('‚úÖ Profile data received from direct lookup:', profileData);
                        }
                    } catch (error) {
                        console.log('‚ùå Error with direct student lookup:', error.message);
                    }
                }
                
                // Process the profile data
                if (profileData) {
                    // Handle different response structures
                    let profile;
                    if (profileData.profile) {
                        profile = profileData.profile;
                    } else if (profileData.student) {
                        profile = profileData.student;
                    } else {
                        profile = profileData;
                    }
                    
                    console.log('üîç Final profile data for picture:', profile);
                    
                    if (profile.profilePicture && profile.profilePicture.trim() !== '') {
                        // Use the shared helper to set avatar image/text
                        setAvatar({
                            imageUrl: profile.profilePicture,
                            displayName: username,
                            imgSelector: '#profile-image',
                            textSelector: '#avatar-text'
                        });
                    } else {
                        console.log('‚ÑπÔ∏è No profile picture found in data - using avatar text');
                        setAvatar({
                            imageUrl: '',
                            displayName: username,
                            imgSelector: '#profile-image',
                            textSelector: '#avatar-text'
                        });
                    }
                } else if (response && response.status === 401) {
                    console.log('‚ùå Unauthorized - token may be expired, redirecting to login');
                    alert('Session expired. Please log in again.');
                    localStorage.clear();
                    window.location.href = 'student-login.html';
                    return;
                } else {
                    console.log('‚ùå All API attempts failed - using avatar text');
                    ensureAvatarTextVisible();
                }
            } catch (error) {
                console.error('‚ùå Error loading profile picture:', error);
                if (error.name === 'AbortError') {
                    console.log('‚ö†Ô∏è Profile picture request timed out - using avatar text');
                }
                ensureAvatarTextVisible();
            }
        }
        
        // Helper function to ensure avatar text is visible
        function ensureAvatarTextVisible() {
            const profileImage = document.getElementById('profile-image');
            const avatarText = document.getElementById('avatar-text');
            if (profileImage && avatarText) {
                profileImage.style.display = 'none';
                avatarText.style.display = 'block';
            }
        }
        

        // Load lessons for selected level
        async function loadLessonsForLevel() {
            const levelSelect = document.getElementById('student-level');
            const lessonSelect = document.getElementById('lesson');
            const selectedLevel = levelSelect.value;
            
            // Clear and disable lesson dropdown
            lessonSelect.innerHTML = '<option value="">Loading lessons...</option>';
            lessonSelect.disabled = true;
            
            if (!selectedLevel) {
                lessonSelect.innerHTML = '<option value="">Select level first</option>';
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('Not authenticated');
                }
                
                // Get curricula for the selected level
                const curriculaRes = await fetch(`/api/lessons/curricula?token=${encodeURIComponent(token)}`, {
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!curriculaRes.ok) {
                    throw new Error('Failed to load curricula');
                }
                
                const curricula = await curriculaRes.json();
                
                // Filter curricula by level
                const relevantCurricula = curricula.filter(c => 
                    c.level === selectedLevel || c.level === 'all'
                );
                
                if (relevantCurricula.length === 0) {
                    lessonSelect.innerHTML = '<option value="">No lessons available for this level</option>';
                    return;
                }
                
                // Load lessons from all relevant curricula
                let allLessons = [];
                for (const curriculum of relevantCurricula) {
                    try {
                        const lessonsRes = await fetch(`/api/lessons/curriculum/${curriculum._id}/lessons?token=${encodeURIComponent(token)}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (lessonsRes.ok) {
                            const lessons = await lessonsRes.json();
                            allLessons.push(...lessons.map(l => ({
                                ...l,
                                curriculumTitle: curriculum.title
                            })));
                        }
                    } catch (e) {
                        console.error('Error loading lessons for curriculum:', e);
                    }
                }
                
                // Populate lesson dropdown
                if (allLessons.length === 0) {
                    lessonSelect.innerHTML = '<option value="">No lessons available for this level</option>';
                } else {
                    lessonSelect.innerHTML = '<option value="">Select a lesson</option>';
                    allLessons.forEach(lesson => {
                        const option = document.createElement('option');
                        
                        // Ensure we have a valid _id
                        if (!lesson._id) {
                            console.error('‚ö†Ô∏è Lesson missing _id:', lesson);
                            return; // Skip this lesson
                        }
                        
                        option.value = lesson._id.toString(); // Ensure it's a string
                        option.textContent = `Lesson ${lesson.lessonNumber || '?'}: ${lesson.title || 'Untitled'}`;
                        option.title = lesson.description || lesson.title || '';
                        
                        console.log('üìö Created lesson option:', {
                            value: option.value,
                            text: option.textContent,
                            lessonId: lesson._id,
                            lessonNumber: lesson.lessonNumber,
                            title: lesson.title
                        });
                        
                        lessonSelect.appendChild(option);
                    });
                    lessonSelect.disabled = false;
                    
                    console.log('‚úÖ Populated lesson dropdown with', allLessons.length, 'lessons');
                }
            } catch (error) {
                console.error('Error loading lessons:', error);
                lessonSelect.innerHTML = '<option value="">Error loading lessons</option>';
                showMessage('Error loading lessons. Please try again.', 'error');
            }
        }
    </script>
    <script src="avatar-helper.js"></script>
</body>
</html>
