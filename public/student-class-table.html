<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' 'unsafe-eval'; object-src 'none';">
  <title>Class Schedule - RemoEdPH</title>
      <link rel="stylesheet" href="modern-styles.css">
    <link rel="stylesheet" href="child-friendly-styles.css">
  <style>
    body { 
      font-family: 'Comic Sans MS', 'Chalkboard SE', 'Trebuchet MS', 'Segoe UI', sans-serif; 
      background: linear-gradient(135deg, #FFF0F5 0%, #E8F8F5 50%, #FFF9E6 100%);
      background-attachment: fixed;
      margin: 0;
      padding: 0;
    }
    .remoed-main { 
      display: flex; 
      min-height: 100vh; 
    }
    .remoed-sidebar { 
      width: 260px; 
      min-width: 260px;
      background: linear-gradient(180deg, #ffffff 0%, #f8fbff 100%); 
      box-shadow: 4px 0 20px rgba(102, 126, 234, 0.1); 
      padding: 0; 
      display: flex; 
      flex-direction: column; 
      align-items: stretch;
      position: fixed;
      height: 100vh;
      z-index: 100;
      border-right: 1px solid rgba(102, 126, 234, 0.1);
    }
    .remoed-logo { 
      display: flex; 
      align-items: center; 
      gap: 14px; 
    }
    .remoed-logo img { 
      height: 48px; 
    }
    .remoed-title { 
      font-size: 1.7rem; 
      font-weight: 700; 
      color: #667eea; 
      letter-spacing: 1px; 
    }
    .remoed-user { 
      display: flex; 
      align-items: center; 
      gap: 10px; 
    }
    .remoed-avatar { 
      width: 72px; 
      height: 72px; 
      border-radius: 50%; 
      background: #667eea; 
      color: #fff; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-weight: bold; 
      font-size: 2.2rem; 
    }
    .remoed-username { 
      color: #667eea; 
      font-weight: 600; 
    }
    .remoed-menu { 
      list-style: none; 
      padding: 0; 
      margin: 0; 
    }
    .remoed-menu li { 
      padding: 14px 32px; 
      color: #667eea; 
      font-weight: 500; 
      cursor: pointer; 
      display: flex; 
      align-items: center; 
      gap: 12px; 
      border-left: 4px solid transparent; 
      transition: background 0.2s, border-color 0.2s; 
    }
    .remoed-menu li.active, .remoed-menu li:hover { 
      background: linear-gradient(90deg, #667eea 0%, #5a67d8 100%); 
      border-left: 4px solid #667eea; 
      color: white; 
      transform: translateX(4px);
      transition: all 0.3s ease;
    }
    .remoed-menu svg { 
      width: 20px; 
      height: 20px; 
      stroke: currentColor;
    }
    .remoed-content {
      flex: 1;
      padding: 36px 20px 36px 20px;
      min-width: 0;
      background: #f6fbff;
      min-height: 100vh;
      box-sizing: border-box;
      margin-left: 260px;
      max-width: calc(100vw - 260px);
      overflow-x: auto;
    }
    
    .header {
      margin-bottom: 24px;
    }
    
    .header h1 {
      color: #667eea;
      font-size: 1.75rem;
      font-weight: 700;
      margin: 0 0 24px 0;
    }
    
    .header-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .week-navigation {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .nav-btn {
      background: linear-gradient(135deg, #ffe85a, #f4d03f);
      color: #333;
      border: none;
      padding: 10px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(255, 232, 90, 0.3);
    }
    
    .nav-btn:hover {
      background: linear-gradient(135deg, #f4d03f, #f1c40f);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 232, 90, 0.4);
    }
    
    .nav-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .week-display {
      font-weight: 600;
      color: #333;
      min-width: 120px;
      text-align: center;
    }
    
    .current-week-btn {
      background: linear-gradient(135deg, #28a745, #1e7e34) !important;
      color: white;
      box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3) !important;
    }
    
    .current-week-btn:hover {
      background: linear-gradient(135deg, #1e7e34, #155724) !important;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4) !important;
    }
    
    .weekly-grid {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(28, 167, 231, 0.1);
      overflow: auto;
      max-height: calc(100vh - 180px);
      min-height: calc(100vh - 180px);
      border: 1px solid rgba(28, 167, 231, 0.1);
    }
    
    .schedule-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      margin: 0;
    }
    
    .schedule-table th,
    .schedule-table td {
      border: 1px solid #e0e6ed;
      padding: 12px 8px;
      text-align: center;
      vertical-align: middle;
    }
    
    .schedule-table th {
      background: linear-gradient(135deg, #667eea, #5a67d8);
      font-weight: 600;
      color: white;
      position: sticky;
      top: 0;
      z-index: 5;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .time-column {
      width: 80px;
      position: sticky;
      left: 0;
      background: #f8f9fa;
      z-index: 3;
    }
    
    .day-column {
      width: calc((100% - 80px) / 7);
      line-height: 1.2;
      padding: 8px 4px;
    }
    
    .day-column br {
      margin: 2px 0;
    }
    
    .time-slot {
      font-size: 0.9rem;
      color: #666;
      min-height: 40px;
    }
    
    .time-slot.booked {
      background: #f8d7da;
      color: #721c24;
      font-weight: 600;
    }
    
    .time-slot.unavailable {
      background: #f5f5f5;
      color: #999;
      background-image: repeating-linear-gradient(
        45deg,
        transparent,
        transparent 2px,
        #e0e0e0 2px,
        #e0e0e0 4px
      );
    }
    
    .time-slot.past {
      background: #f8f9fa;
      color: #6c757d;
      cursor: pointer;
      font-size: 0.8rem;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .time-slot.feedback-submitted {
      background: #28a745;
      color: white;
      cursor: pointer;
      font-size: 0.8rem;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    
    .time-slot.feedback-submitted:hover {
      background: #218838;
    }
    
    .time-slot.feedback-needed {
      background: #ffc107;
      color: #000;
      cursor: pointer;
      font-size: 0.8rem;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    
    .time-slot.feedback-needed:hover {
      background: #ffb300;
    }
    

    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 260px;
      background: #fff;
      height: 100vh;
      box-shadow: 2px 0 12px rgba(28,167,231,0.06);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 32px 0 0 0;
      z-index: 1000;
    }
    .sidebar-logo {
      width: 48px;
      height: 48px;
      object-fit: contain;
      margin-bottom: 12px;
    }
    .sidebar-title {
      font-size: 1.4rem;
      font-weight: 700;
      color: #1ca7e7;
      margin-bottom: 24px;
      letter-spacing: 1px;
      text-align: center;
    }
    .sidebar-avatar {
      background: #1ca7e7;
      color: #fff;
      font-weight: 700;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      margin-bottom: 8px;
    }
    .sidebar-email {
      font-size: 0.95rem;
      color: #1ca7e7;
      font-weight: 500;
      text-align: center;
      margin-bottom: 32px;
      word-break: break-all;
      padding: 0 16px;
    }
    .sidebar-nav {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    .sidebar-link {
      width: 100%;
      padding: 12px 0;
      text-align: left;
      color: #1ca7e7;
      font-weight: 500;
      text-decoration: none;
      background: transparent;
      transition: background 0.2s, color 0.2s;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      position: relative;
    }
    .sidebar-link.active {
      background: #f8f9fa;
      color: #1ca7e7;
      font-weight: 600;
    }
    .sidebar-link.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      width: 4px;
      height: 100%;
      background: #ffd700;
    }
    .sidebar-link:hover:not(.logout) {
      background: #f0f8ff;
    }
    .sidebar-link.logout {
      color: #e74c3c;
      margin-top: 16px;
    }
    .sidebar-link.logout:hover {
      background: #fdf2f2;
    }
    .sidebar-icon {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .main-content {
      margin-left: 260px;
      padding: 24px 32px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background: #f6fbff;
    }
    
    .main-content .header {
      flex-shrink: 0;
      margin-bottom: 16px;
    }
    
    .main-content .weekly-grid {
      flex: 1;
      min-height: 0;
    }
    .class-table-container {
      max-width: 1200px;
      margin: 40px auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.08);
      padding: 32px 24px;
    }
    .class-table-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; }
    .class-table-title { font-size: 1.5rem; font-weight: 600; color: #3a7afe; }
    .class-table-nav { display: flex; gap: 12px; }
    .class-table-nav button { background: #f4f6fb; border: none; border-radius: 5px; padding: 0.5rem 1.2rem; font-size: 1rem; cursor: pointer; color: #3a7afe; transition: background 0.2s; }
    .class-table-nav button.active, .class-table-nav button:hover { background: #3a7afe; color: #fff; }
    .view-btn { background: #f4f6fb; border: 1px solid #e0e6ed; border-radius: 5px; padding: 0.5rem 1rem; margin: 0 3px; cursor: pointer; transition: all 0.2s; }
    .view-btn.active { background: #3a7afe; color: white; border-color: #3a7afe; }
    .view-btn:hover { background: #e3f2fd; }
    .view-btn.active:hover { background: #2d5bb8; }
    .class-table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      min-width: 900px;
      border-radius: 8px;
      overflow: hidden;
      table-layout: fixed;
    }
    .class-table th, .class-table td {
      padding: 5px 2px;
      text-align: center;
      border: 1px solid #e0e6ed;
      font-size: 0.93rem;
    }
    .class-table th {
      background: #f4f6fb;
      font-weight: 600;
      color: #3a7afe;
      padding: 8px 2px;
      border-bottom: 2px solid #e0e6ed;
    }
    .class-table td.booked {
      background: #1ca7e7;
      color: #fff;
      font-weight: 600;
      border: 2px solid #1ca7e7;
    }
    .class-table td.open {
      background: #eaf7ff;
      color: #1ca7e7;
      cursor: pointer;
    }
    .class-table td.cancelled { background: #f8d7da; color: #721c24; }
    .class-table td.time-label {
      background: #f8f9fa;
      font-weight: 500;
      color: #333;
      border-right: 2px solid #e0e6ed;
    }
    .class-table td.time-label:hover { background: #e0e6ed; }
    .class-table-scroll {
      overflow-x: auto;
      max-height: 75vh;
      min-height: 200px;
      overflow-y: auto;
      border: 1px solid #e0e6ed;
      border-radius: 8px;
      margin-bottom: 4px;
    }
    /* Simple 2-column layout for day view */
    .class-table.day-view { width: 100%; table-layout: fixed; }
    .class-table.day-view th:nth-child(1) { width: 80px; }
    .class-table.day-view td:nth-child(1) { width: 80px; }
    .class-table.day-view th:nth-child(2) { width: calc(100% - 80px); }
    .class-table.day-view td:nth-child(2) { width: calc(100% - 80px); }
    .message { margin: 18px 0; text-align: center; font-size: 1.1rem; padding: 12px; border-radius: 6px; }
    .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .message.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    @media (max-width: 1200px) { .class-table-container { width: 98%; padding: 6px 6px; } }
    @media (max-width: 900px) { .class-table-container { width: 99%; padding: 4px 4px; } }
    @media (max-height: 800px) { .class-table-container { margin: 2px auto; padding: 4px 4px; min-height: 85vh; } .class-table-scroll { max-height: 65vh; } }
    .remoed-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #fff;
      padding: 12px 32px 12px 32px;
      border-radius: 14px 14px 0 0;
      box-shadow: 0 2px 8px rgba(28,167,231,0.04);
      margin-bottom: 18px;
    }
    .remoed-logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .remoed-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1ca7e7;
      letter-spacing: 1px;
    }
    .remoed-user {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .remoed-avatar {
      background: #1ca7e7;
      color: #fff;
      font-weight: 700;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
    }
    .remoed-username {
      font-size: 1rem;
      color: #1ca7e7;
      font-weight: 500;
    }
    .remoed-card {
      width: 320px;
      margin: 24px auto 32px auto;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(28,167,231,0.08);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 32px 16px 28px 16px;
    }
    .remoed-card-logo {
      width: 64px;
      height: 64px;
      object-fit: contain;
      margin-bottom: 10px;
    }
    .remoed-card-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1ca7e7;
      margin-bottom: 16px;
      letter-spacing: 1px;
      text-align: center;
    }
    .remoed-card-avatar {
      background: #1ca7e7;
      color: #fff;
      font-weight: 700;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      margin-bottom: 10px;
    }
    .remoed-card-email {
      font-size: 1.08rem;
      color: #1ca7e7;
      font-weight: 500;
      text-align: center;
      margin-bottom: 0;
    }
    /* Modern Modal Styles */
    .remoed-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.5);
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }
    
    .remoed-modal.show {
      display: flex;
    }
    
    .remoed-modal-content {
      background: #ffffff;
      border-radius: 1rem;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      animation: remoedModalFadeIn 0.3s ease-out;
      display: flex;
      flex-direction: column;
    }
    
    @keyframes remoedModalFadeIn {
      from { 
        transform: scale(0.95) translateY(-10px); 
        opacity: 0; 
      }
      to { 
        transform: scale(1) translateY(0); 
        opacity: 1; 
      }
    }
    
    .remoed-modal-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 1rem 1rem 0 0;
    }
    
    .remoed-modal-title {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.25rem;
      font-weight: 600;
    }
    
    .remoed-modal-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 2rem;
      height: 2rem;
      border-radius: 0.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    
    .remoed-modal-close:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }
    
    .remoed-modal-body {
      padding: 1.5rem;
      overflow-y: auto;
      flex: 1;
    }
    
    .remoed-modal-footer {
      padding: 1.5rem;
      border-top: 1px solid #e2e8f0;
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
      background: #f8fafc;
    }

    /* Generic modal styles for class info / cancellation */
    .modal {
      display: none; /* Shown via JS */
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.5);
      align-items: center;
      justify-content: center;
    }
    
    .modal.show {
      display: flex;
    }

    .modal .modal-content {
      background: #ffffff;
      border-radius: 0.75rem;
      width: 90%;
      max-width: 420px;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      display: flex;
      flex-direction: column;
      margin: auto;
      position: relative;
    }

    .modal .modal-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal .modal-body {
      padding: 1.25rem 1.5rem;
    }

    .modal .modal-actions {
      padding: 1rem 1.5rem;
      border-top: 1px solid #e2e8f0;
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      background: #f8fafc;
    }

    .modal .detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    .modal .detail-row label {
      font-weight: 600;
      color: #374151;
      margin-right: 0.5rem;
    }
    
    /* Class Details Card */
    .remoed-feedback-class-details {
      background: #f8fafc;
      border-radius: 0.75rem;
      padding: 1.25rem;
      margin-bottom: 1.5rem;
      border: 1px solid #e2e8f0;
    }
    
    .remoed-feedback-detail-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .remoed-feedback-detail-item:last-child {
      border-bottom: none;
    }
    
    .remoed-feedback-detail-label {
      font-weight: 600;
      color: #374151;
      font-size: 0.875rem;
    }
    
    .remoed-feedback-detail-value {
      color: #6b7280;
      font-size: 0.875rem;
      text-align: right;
    }
    
    /* Feedback Sections */
    .remoed-feedback-section {
      margin-bottom: 2rem;
    }
    
    .remoed-feedback-section-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: #1a202c;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    /* Rating Container */
    .remoed-rating-container {
      text-align: center;
      padding: 1.5rem;
      background: #f8fafc;
      border-radius: 0.75rem;
      border: 1px solid #e2e8f0;
    }
    
    .remoed-stars {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    
    .remoed-star {
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 2rem;
      color: #d1d5db;
      padding: 0.25rem;
      border-radius: 0.5rem;
    }
    
    .remoed-star:hover {
      color: #fbbf24;
      transform: scale(1.1);
      text-shadow: 0 0 8px rgba(251, 191, 36, 0.4);
    }
    
    .remoed-star.active {
      color: #f59e0b !important;
      transform: scale(1.05);
      text-shadow: 0 0 10px rgba(245, 158, 11, 0.6);
    }
    
    .remoed-rating-text {
      font-size: 0.875rem;
      color: #6b7280;
      font-weight: 500;
    }
    
    /* Character Count */
    .remoed-char-count {
      text-align: right;
      font-size: 0.75rem;
      color: #9ca3af;
      margin-top: 0.5rem;
    }
    
    /* Issue Grid */
    .remoed-issue-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }
    
    .remoed-checkbox-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      cursor: pointer;
      padding: 0.75rem;
      border-radius: 0.5rem;
      border: 1px solid #e2e8f0;
      background: #ffffff;
      transition: all 0.2s ease;
    }
    
    .remoed-checkbox-item:hover {
      background: #f8fafc;
      border-color: #cbd5e1;
    }
    
    .remoed-checkbox-item input[type="checkbox"] {
      display: none;
    }
    
    .remoed-checkbox-custom {
      width: 1.25rem;
      height: 1.25rem;
      border: 2px solid #d1d5db;
      border-radius: 0.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      background: #ffffff;
    }
    
    .remoed-checkbox-item input[type="checkbox"]:checked + .remoed-checkbox-custom {
      background: #667eea;
      border-color: #667eea;
    }
    
    .remoed-checkbox-icon {
      color: #ffffff;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    
    .remoed-checkbox-item input[type="checkbox"]:checked + .remoed-checkbox-custom .remoed-checkbox-icon {
      opacity: 1;
    }
    
    .remoed-checkbox-label {
      font-size: 0.875rem;
      color: #374151;
      font-weight: 500;
    }
    
    /* Legacy button styles for compatibility */
    .btn-secondary {
      background: #6c757d;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
    }
    .btn-secondary:hover {
      background: #5a6268;
    }
    .btn-join {
      background: #28a745;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
    }
    .btn-join:hover {
      background: #218838;
    }
    .btn-join:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    .btn-cancel {
      background: #dc3545;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
    }
    .btn-cancel:hover {
      background: #c82333;
    }
    .btn-danger {
      background: #dc3545;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
    }
    .btn-danger:hover {
      background: #c82333;
    }
    .cancellation-details {
      margin-top: 15px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 6px;
      border: 1px solid #e0e6ed;
    }
    .form-group {
      margin-top: 10px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #333;
    }
    .form-group textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 0.9rem;
      resize: vertical;
    }
         .char-count {
       font-size: 0.8rem;
       color: #666;
       margin-top: 5px;
       text-align: right;
     }
     
     
  </style>
</head>
<body>
  <div class="remoed-main">
    <nav class="remoed-sidebar">
      <div class="remoed-logo" style="height:100px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px; padding-top:24px;">
        <img src="remoed-logo.png" alt="RemoEdPH Logo" style="height:40px; width:auto; display:inline-block; vertical-align:middle;">
        <span class="remoed-title" style="font-size:1.4rem; font-weight:800; color:#1CA7E7; letter-spacing:1px; text-shadow: 2px 2px 4px rgba(28, 167, 231, 0.2);">RemoEdPH</span>
        <div style="font-size: 0.75rem; color: #666;">Student Portal</div>
      </div>
      <div class="remoed-user" style="display:flex; flex-direction:column; align-items:center; margin-bottom:24px;">
        <div class="remoed-avatar" id="sidebar-avatar" style="position: relative; overflow: hidden; width: 3rem; height: 3rem;">
          <img id="profile-image" class="avatar-img" src="" alt="Profile" style="display: none;">
          <span id="avatar-text" class="avatar-text">K</span>
        </div>
        <span class="remoed-username" id="sidebar-email" style="color:#667eea;">kjbflores@remoedph.com</span>
      </div>
                  <ul class="remoed-menu">
                <li onclick="window.location.href='student-dashboard.html'">üè† <span>My Home</span></li>
                <li class="active">üìÖ <span>My Schedule</span></li>
                <li onclick="window.location.href='student-book.html'">‚ûï <span>Book a Class</span></li>
                <li onclick="window.location.href='student-booking-history.html'">üìú <span>My Classes</span></li>
                <li onclick="window.location.href='student-games-activities.html'">üéÆ <span>Play & Learn</span></li>
                <li onclick="window.location.href='student-profile.html'">üë§ <span>My Profile</span></li>
                <li onclick="window.location.href='student-assessment.html'">üéØ <span>My Level</span></li>
                <li id="logout-nav" style="margin-top:auto; color:#e74c3c; cursor:pointer;">
                  <svg fill="none" stroke="#e74c3c" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M17 16l4-4m0 0l-4-4m4 4H7"/>
                    <path d="M3 12a9 9 0 0118 0 9 9 0 01-18 0z"/>
                  </svg>Logout
                </li>
            </ul>
    </nav>
  <div class="remoed-content">
    <div class="header">
      <h1 style="font-size: 2rem; font-weight: 800; color: #1CA7E7; text-shadow: 2px 2px 4px rgba(28, 167, 231, 0.2); display: flex; align-items: center; gap: 12px;">
        <span>üìöüì∂</span>
        <span>üìÖ My Schedule</span>
      </h1>
      <div class="header-controls">
        <div class="week-navigation">
          <button id="prev-week" class="nav-btn">‚Üê Previous Week</button>
          <span id="week-display" class="week-display">Current Week</span>
          <button id="next-week" class="nav-btn">Next Week ‚Üí</button>
          <button id="current-week" class="nav-btn current-week-btn">Today</button>
        </div>
      </div>
    </div>

    <!-- Booking Indicators Legend -->
    <div class="booking-legend" style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #e8f4fd 100%); border-radius: 12px; border: 1px solid rgba(28, 167, 231, 0.1); box-shadow: 0 4px 16px rgba(28, 167, 231, 0.05);">
      <div style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem; flex-wrap: nowrap; overflow-x: auto;">
        <h3 style="margin: 0; color: #667eea; font-size: 1.1rem; font-weight: 600;">üìä Schedule Indicators:</h3>
        <div style="display: flex; align-items: center; gap: 4px; white-space: nowrap; flex-shrink: 0;">
          <span style="display: inline-block; width: 18px; height: 18px; background: #f8d7da; color: #721c24; text-align: center; font-weight: bold; border-radius: 3px; font-size: 0.75rem; line-height: 18px;">B</span>
          <span style="white-space: nowrap;">Booked</span>
        </div>
        <div style="display: flex; align-items: center; gap: 4px; white-space: nowrap; flex-shrink: 0;">
          <span style="display: inline-block; width: 18px; height: 18px; background: #28a745; color: white; text-align: center; font-weight: bold; border-radius: 3px; font-size: 0.75rem; line-height: 18px;">‚úì</span>
          <span style="white-space: nowrap;">Feedback Submitted</span>
        </div>
        <div style="display: flex; align-items: center; gap: 4px; white-space: nowrap; flex-shrink: 0;">
          <span style="display: inline-block; width: 18px; height: 18px; background: #ffc107; color: #000; text-align: center; font-weight: bold; border-radius: 3px; font-size: 0.75rem; line-height: 18px;">!</span>
          <span style="white-space: nowrap;">Feedback Pending</span>
        </div>
        <div style="display: flex; align-items: center; gap: 4px; white-space: nowrap; flex-shrink: 0;">
          <span style="display: inline-block; width: 18px; height: 18px; background: #6c757d; color: white; text-align: center; font-weight: bold; border-radius: 3px; font-size: 0.75rem; line-height: 18px;">‚è∞</span>
          <span style="white-space: nowrap;">Past</span>
        </div>
      </div>
    </div>

    <div class="weekly-grid">
      <table class="schedule-table">
        <thead>
          <tr id="day-headers-row">
            <th class="time-column">Time</th>
            <!-- Day headers will be dynamically added here by JavaScript -->
          </tr>
        </thead>
        <tbody id="time-slots-grid">
        </tbody>
      </table>
    </div>
  </div>
  <!-- Booking Details Modal -->
  <div id="booking-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25); z-index:2000; align-items:center; justify-content:center;">
    <div style="background:#fff; border-radius:12px; max-width:350px; width:90vw; margin:auto; box-shadow:0 4px 24px rgba(28,167,231,0.13); padding:28px 22px 18px 22px; position:relative;">
      <button id="close-booking-modal" style="position:absolute; top:10px; right:14px; background:none; border:none; font-size:1.3rem; color:#888; cursor:pointer;">&times;</button>
      <div style="font-size:1.2rem; font-weight:700; color:#667eea; margin-bottom:10px;">Class Details</div>
      <div style="margin-bottom:8px;"><span style="font-weight:600; color:#667eea;">Teacher:</span> <span id="modal-teacher"></span></div>
      <div style="margin-bottom:8px;"><span style="font-weight:600; color:#667eea;">Lesson:</span> <span id="modal-lesson"></span></div>
      <div style="margin-bottom:8px;"><span style="font-weight:600; color:#667eea;">Level:</span> <span id="modal-level"></span></div>
      <div style="margin-bottom:8px;"><span style="font-weight:600; color:#667eea;">Date:</span> <span id="modal-date"></span></div>
      <div style="margin-bottom:8px;"><span style="font-weight:600; color:#667eea;">Time:</span> <span id="modal-time"></span></div>
    </div>
  </div>
  <!-- Class Info Modal -->
  <div id="booking-info-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Class Information</h2>
        <span class="close" id="close-booking-info-modal">&times;</span>
      </div>
      <div class="modal-body">
        <div class="class-details">
          <div class="detail-row">
            <label>Date:</label>
            <span id="info-class-date"></span>
          </div>
          <div class="detail-row">
            <label>Time:</label>
            <span id="info-class-time"></span>
          </div>
          <div class="detail-row">
            <label>Teacher:</label>
            <span id="info-class-teacher"></span>
          </div>
          <div class="detail-row">
            <label>Level:</label>
            <span id="info-class-level"></span>
          </div>
          <div class="detail-row">
            <label>Lesson:</label>
            <span id="info-class-lesson"></span>
          </div>
          <div class="detail-row">
            <label>Classroom ID:</label>
            <span id="info-classroom-id" style="font-weight: bold; color: #667eea;"></span>
          </div>
          <div class="detail-row">
            <label>Join Classroom:</label>
            <button class="btn-join" id="join-classroom-btn">Enter Live Classroom</button>
          </div>
          <div class="detail-row" id="preview-lesson-row" style="display: none;">
            <label>Preview Video:</label>
            <button class="btn-join" id="preview-lesson-btn" style="background: #17a2b8;">Preview Video</button>
          </div>
          <div class="detail-row" id="cancel-booking-row" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e0e6ed;">
            <label>Actions:</label>
            <button class="btn-cancel" id="cancel-booking-btn" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;">
              Cancel Booking
            </button>
          </div>
        </div>
        <div class="modal-actions">
          <button class="btn-secondary" id="close-booking-info-modal2">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Cancellation Reason Modal -->
  <div id="cancellation-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Request Cancellation</h2>
        <span class="close" onclick="closeCancellationModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div class="cancellation-details">
          <p><strong>Class:</strong> <span id="cancel-class-info"></span></p>
          <p><strong>Teacher:</strong> <span id="cancel-teacher-info"></span></p>
          <div class="form-group">
            <label for="cancellation-reason">Reason for Cancellation:</label>
            <textarea id="cancellation-reason" placeholder="Please provide a detailed reason for cancellation (minimum 10 characters)..." rows="4" maxlength="500"></textarea>
            <div class="char-count">
              <span id="char-count">0</span>/500 characters
            </div>
          </div>
        </div>
        <div class="modal-actions">
          <button class="btn-secondary" onclick="closeCancellationModal()">Cancel</button>
          <button class="btn-danger" onclick="submitCancellationRequest()">Submit Request</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Past Class Feedback Modal -->
  <div id="feedback-modal" class="remoed-modal">
    <div class="remoed-modal-content">
      <div class="remoed-modal-header">
        <div class="remoed-modal-title">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
          </svg>
          Class Feedback
        </div>
        <button class="remoed-modal-close" id="close-feedback-modal">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      
      <div class="remoed-modal-body">
        <!-- Class Details Card -->
        <div class="remoed-feedback-class-details">
          <div class="remoed-feedback-detail-item">
            <div class="remoed-feedback-detail-label">Date</div>
            <div class="remoed-feedback-detail-value" id="feedback-class-date"></div>
          </div>
          <div class="remoed-feedback-detail-item">
            <div class="remoed-feedback-detail-label">Time</div>
            <div class="remoed-feedback-detail-value" id="feedback-class-time"></div>
          </div>
          <div class="remoed-feedback-detail-item">
            <div class="remoed-feedback-detail-label">Teacher</div>
            <div class="remoed-feedback-detail-value" id="feedback-class-teacher"></div>
          </div>
          <div class="remoed-feedback-detail-item">
            <div class="remoed-feedback-detail-label">Level</div>
            <div class="remoed-feedback-detail-value" id="feedback-class-level"></div>
          </div>
          <div class="remoed-feedback-detail-item">
            <div class="remoed-feedback-detail-label">Lesson</div>
            <div class="remoed-feedback-detail-value" id="feedback-class-lesson"></div>
          </div>
        </div>
        
        <!-- Rating Section -->
        <div class="remoed-feedback-section">
          <h3 class="remoed-feedback-section-title">Rate Your Experience</h3>
          <div class="remoed-rating-container">
            <div class="remoed-stars" id="star-rating">
              <span class="remoed-star" data-rating="1" onclick="selectRating(1)" onmouseenter="previewRating(1)" onmouseleave="restoreRating()">‚òÖ</span>
              <span class="remoed-star" data-rating="2" onclick="selectRating(2)" onmouseenter="previewRating(2)" onmouseleave="restoreRating()">‚òÖ</span>
              <span class="remoed-star" data-rating="3" onclick="selectRating(3)" onmouseenter="previewRating(3)" onmouseleave="restoreRating()">‚òÖ</span>
              <span class="remoed-star" data-rating="4" onclick="selectRating(4)" onmouseenter="previewRating(4)" onmouseleave="restoreRating()">‚òÖ</span>
              <span class="remoed-star" data-rating="5" onclick="selectRating(5)" onmouseenter="previewRating(5)" onmouseleave="restoreRating()">‚òÖ</span>
            </div>
            <div class="remoed-rating-text" id="rating-text">Click to rate (1-5 stars)</div>
          </div>
        </div>
        
        <!-- Comments Section -->
        <div class="remoed-feedback-section">
          <h3 class="remoed-feedback-section-title">Share Your Experience</h3>
          <div class="remoed-form-group">
            <textarea 
              id="feedback-comments" 
              class="remoed-form-textarea" 
              placeholder="Tell us about your experience with this class. What went well? What could be improved?"
              rows="4" 
              maxlength="500"
            ></textarea>
            <div class="remoed-char-count">
              <span id="feedback-char-count">0</span>/500 characters
            </div>
          </div>
        </div>
        
        <!-- Technical Issues Section -->
        <div class="remoed-feedback-section">
          <h3 class="remoed-feedback-section-title">Technical Issues (if any)</h3>
          <div class="remoed-issue-grid">
            <label class="remoed-checkbox-item">
              <input type="checkbox" id="issue-internet" value="internet">
              <div class="remoed-checkbox-custom">
                <svg class="remoed-checkbox-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20 6L9 17l-5-5"/>
                </svg>
              </div>
              <span class="remoed-checkbox-label">Internet Connection</span>
            </label>
            <label class="remoed-checkbox-item">
              <input type="checkbox" id="issue-microphone" value="microphone">
              <div class="remoed-checkbox-custom">
                <svg class="remoed-checkbox-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20 6L9 17l-5-5"/>
                </svg>
              </div>
              <span class="remoed-checkbox-label">Microphone Issues</span>
            </label>
            <label class="remoed-checkbox-item">
              <input type="checkbox" id="issue-camera" value="camera">
              <div class="remoed-checkbox-custom">
                <svg class="remoed-checkbox-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20 6L9 17l-5-5"/>
                </svg>
              </div>
              <span class="remoed-checkbox-label">Camera Problems</span>
            </label>
            <label class="remoed-checkbox-item">
              <input type="checkbox" id="issue-lesson" value="lesson">
              <div class="remoed-checkbox-custom">
                <svg class="remoed-checkbox-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20 6L9 17l-5-5"/>
                </svg>
              </div>
              <span class="remoed-checkbox-label">Lesson Material Issues</span>
            </label>
          </div>
        </div>
      </div>
      
      <div class="remoed-modal-footer">
        <button class="remoed-btn remoed-btn-secondary" id="close-feedback-modal2">Cancel</button>
        <button class="remoed-btn remoed-btn-primary" id="submit-feedback-btn">Submit Feedback</button>
      </div>
    </div>
  </div>

  <script>
    // Prevent external script errors from interfering with our functionality
    window.addEventListener('error', function(e) {
      // Ignore errors from external scripts like QuillBot
      if (e.filename && e.filename.includes('quillbot-content.js')) {
        console.log('üõ°Ô∏è Ignoring external script error from QuillBot extension');
        e.preventDefault();
        return false;
      }
    });
    
    // Disable problematic browser extensions that might interfere
    function disableProblematicExtensions() {
      try {
        // Disable QuillBot extension if present
        if (window.quillbot || window.QuillBot) {
          console.log('üõ°Ô∏è QuillBot extension detected, disabling...');
          window.quillbot = null;
          window.QuillBot = null;
        }
        
        // Remove any problematic event listeners
        document.removeEventListener('focus', window.quillbotFocusHandler);
        window.removeEventListener('focus', window.quillbotFocusHandler);
        
        console.log('üõ°Ô∏è Browser extension protection enabled');
      } catch (error) {
        console.log('üõ°Ô∏è Extension protection error:', error);
      }
    }
    
    // Run protection on page load
    document.addEventListener('DOMContentLoaded', disableProblematicExtensions);
    
    // Feedback Modal Functions - Define these first so they're available when called
    let currentFeedbackBooking = null;
    let selectedRating = 0;
    
    function showPastBookingFeedback(booking) {
        currentFeedbackBooking = booking;
        
        // Format date
        const date = new Date(booking.date);
        const formattedDate = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        document.getElementById('feedback-class-date').textContent = formattedDate;
        document.getElementById('feedback-class-time').textContent = formatTime24Hour(booking.time);
        
        // Handle teacher name
        let teacherName = 'Unknown Teacher';
        if (booking.teacherId) {
            if (typeof booking.teacherId === 'string') {
                teacherName = booking.teacherId;
            } else if (booking.teacherId.username) {
                teacherName = booking.teacherId.username;
            } else if (booking.teacherId.firstName) {
                teacherName = `${booking.teacherId.firstName} ${booking.teacherId.lastName || ''}`.trim();
            }
        }
        document.getElementById('feedback-class-teacher').textContent = teacherName;
        document.getElementById('feedback-class-level').textContent = booking.studentLevel || 'Not specified';
        document.getElementById('feedback-class-lesson').textContent = booking.lesson || 'Not specified';
        
        // Reset form
        resetFeedbackForm();
        
        // Show modal
        const modal = document.getElementById('feedback-modal');
        modal.style.display = 'flex';
        modal.classList.add('show');
        
        // Setup event listeners after modal is shown
        setTimeout(() => {
            setupFeedbackEventListeners();
        }, 100);
        
        // Check if feedback already exists for this booking
        checkExistingFeedback(booking._id);
    }
    
    function closeFeedbackModal() {
        const modal = document.getElementById('feedback-modal');
        modal.style.display = 'none';
        modal.classList.remove('show');
        currentFeedbackBooking = null;
        selectedRating = 0;
    }
    
    function resetFeedbackForm() {
        // Reset stars - ensure they start empty
        selectedRating = 0;
        const stars = document.querySelectorAll('.remoed-star');
        const ratingText = document.querySelector('.remoed-rating-text');
        
        if (stars.length > 0) {
            stars.forEach(star => {
                star.classList.remove('active');
            });
        }
        
        if (ratingText) {
            ratingText.textContent = 'Click to rate (1-5 stars)';
        }
        
        // Reset comments
        const commentsTextarea = document.getElementById('feedback-comments');
        const charCount = document.getElementById('feedback-char-count');
        if (commentsTextarea) {
            commentsTextarea.value = '';
        }
        if (charCount) {
            charCount.textContent = '0';
        }
        
        // Reset checkboxes
        const checkboxes = document.querySelectorAll('.remoed-issue-grid input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
    }
    
    function submitFeedback() {
        console.log('üìù submitFeedback function called');
        console.log('üìù currentFeedbackBooking:', currentFeedbackBooking);
        console.log('üìù selectedRating:', selectedRating);
        
        if (!currentFeedbackBooking) {
            console.error('‚ùå No current feedback booking');
            alert('Error: No booking data found. Please try again.');
            return;
        }
        
        const comments = document.getElementById('feedback-comments').value.trim();
        const technicalIssues = [];
        
        // Get selected technical issues
        document.querySelectorAll('.remoed-issue-grid input[type="checkbox"]:checked').forEach(checkbox => {
            technicalIssues.push(checkbox.value);
        });
        
        console.log('üìù Comments:', comments);
        console.log('üìù Technical issues:', technicalIssues);
        
        // Validate rating
        if (selectedRating === 0) {
            console.log('‚ùå No rating selected');
            alert('Please provide a rating before submitting feedback.');
            return;
        }
        
        console.log('‚úÖ Validation passed, submitting feedback...');
        
        // Disable submit button to prevent multiple submissions
        const submitBtn = document.getElementById('submit-feedback-btn');
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
        }
        
        // Submit feedback to server
        submitFeedbackToServer({
            bookingId: currentFeedbackBooking._id,
            rating: selectedRating,
            comment: comments,
            teacherId: currentFeedbackBooking.teacherId
        });
    }
    
            // Function to setup feedback modal event listeners
        function setupFeedbackEventListeners() {
            try {
                console.log('üîß Setting up feedback modal event listeners...');
            
            // Star rating functionality - Simple and direct approach
            const stars = document.querySelectorAll('.remoed-star');
            console.log('‚≠ê Found stars:', stars.length);
            
            // Clear any existing event listeners
            stars.forEach(star => {
                star.replaceWith(star.cloneNode(true));
            });
            
            // Get fresh references after cloning
            const freshStars = document.querySelectorAll('.remoed-star');
            
            // Add event listeners to fresh stars
            freshStars.forEach((star, index) => {
                const rating = parseInt(star.getAttribute('data-rating'));
                
                // Click handler
                star.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    selectedRating = rating;
                    console.log('‚≠ê Star clicked, rating:', rating);
                    
                    // Update the visual state
                    updateStarDisplay(rating);
                    
                    // Update rating text
                    const ratingTexts = ['', 'Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
                    const ratingTextElement = document.querySelector('.remoed-rating-text');
                    if (ratingTextElement) {
                        ratingTextElement.textContent = ratingTexts[rating];
                    }
                });
                
                // Hover handler
                star.addEventListener('mouseenter', function(e) {
                    console.log(`üñ±Ô∏è Hovering over star ${rating}`);
                    
                    // Show preview
                    updateStarDisplay(rating);
                    
                    // Update rating text
                    const ratingTexts = ['', 'Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
                    const ratingTextElement = document.querySelector('.remoed-rating-text');
                    if (ratingTextElement) {
                        ratingTextElement.textContent = ratingTexts[rating];
                    }
                });
                
                console.log(`‚≠ê Star ${index + 1} (rating: ${rating}) event listeners added`);
            });
            
            // Container leave handler
            const starsContainer = document.querySelector('.remoed-stars');
            if (starsContainer) {
                starsContainer.addEventListener('mouseleave', function() {
                    console.log('üñ±Ô∏è Left stars container, restoring selected rating:', selectedRating);
                    
                    if (selectedRating > 0) {
                        updateStarDisplay(selectedRating);
                        
                        const ratingTexts = ['', 'Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
                        const ratingTextElement = document.querySelector('.remoed-rating-text');
                        if (ratingTextElement) {
                            ratingTextElement.textContent = ratingTexts[selectedRating];
                        }
                    } else {
                        // Clear all stars if no rating selected
                        document.querySelectorAll('.remoed-star').forEach(s => {
                            s.classList.remove('active');
                        });
                        
                        const ratingTextElement = document.querySelector('.remoed-rating-text');
                        if (ratingTextElement) {
                            ratingTextElement.textContent = 'Click to rate (1-5 stars)';
                        }
                    }
                });
            }
            
            // Character count for comments
            const commentsTextarea = document.getElementById('feedback-comments');
            if (commentsTextarea) {
                commentsTextarea.addEventListener('input', function() {
                    const count = this.value.length;
                    const charCountElement = document.getElementById('feedback-char-count');
                    if (charCountElement) {
                        charCountElement.textContent = count;
                    }
                });
            }
            
            // Close feedback modal - Direct approach
            const closeModalBtn = document.getElementById('close-feedback-modal');
            const closeModalBtn2 = document.getElementById('close-feedback-modal2');
            const feedbackModal = document.getElementById('feedback-modal');
            
            console.log('üîí Close buttons found:', !!closeModalBtn, !!closeModalBtn2);
            
            // Remove old listeners and add new ones
            if (closeModalBtn) {
                closeModalBtn.onclick = null;
                closeModalBtn.addEventListener('click', function() {
                    console.log('üîí Close button 1 clicked');
                    closeFeedbackModal();
                });
            }
            
            if (closeModalBtn2) {
                closeModalBtn2.onclick = null;
                closeModalBtn2.addEventListener('click', function() {
                    console.log('üîí Close button 2 clicked');
                    closeFeedbackModal();
                });
            }
            
            if (feedbackModal) {
                feedbackModal.onclick = null;
                feedbackModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        console.log('üîí Modal background clicked');
                        closeFeedbackModal();
                    }
                });
            }
            
            // Submit feedback button
            const submitBtn = document.getElementById('submit-feedback-btn');
            console.log('üìù Submit button found:', !!submitBtn);
            
            if (submitBtn) {
                submitBtn.onclick = null;
                submitBtn.addEventListener('click', function() {
                    console.log('üìù Submit button clicked!');
                    submitFeedback();
                });
            } else {
                console.error('‚ùå Submit feedback button not found!');
            }
        } catch (error) {
            console.error('‚ùå Error in setupFeedbackEventListeners:', error);
        }
        }
    
    // Global function to update star display based on rating
    function updateStarDisplay(rating) {
        try {
            console.log('üîÑ updateStarDisplay called with rating:', rating);
            
            // Reset all stars first
            const allStars = document.querySelectorAll('.remoed-star');
            console.log('üîÑ Found', allStars.length, 'stars to reset');
            
            allStars.forEach(s => {
                s.classList.remove('active');
            });
            
            // Fill stars up to selected rating
            for (let i = 1; i <= rating; i++) {
                const starElement = document.querySelector(`.remoed-star[data-rating="${i}"]`);
                if (starElement) {
                    starElement.classList.add('active');
                    console.log('üîÑ Activated star', i);
                } else {
                    console.log('‚ùå Star', i, 'not found');
                }
            }
            
            // Verify the result
            const activeStars = document.querySelectorAll('.remoed-star.active');
            console.log('üîÑ Total active stars after update:', activeStars.length);
        } catch (error) {
            console.error('‚ùå Error in updateStarDisplay:', error);
        }
    }
    

    
    // Simple star rating functions
    function selectRating(rating) {
        console.log('‚≠ê Rating selected:', rating);
        selectedRating = rating;
        updateStarDisplay(rating);
        
        // Update rating text
        const ratingTexts = ['', 'Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
        const ratingTextElement = document.querySelector('.remoed-rating-text');
        if (ratingTextElement) {
            ratingTextElement.textContent = ratingTexts[rating];
        }
    }
    
    function previewRating(rating) {
        console.log('üñ±Ô∏è Previewing rating:', rating);
        updateStarDisplay(rating);
        
        // Update rating text
        const ratingTexts = ['', 'Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
        const ratingTextElement = document.querySelector('.remoed-rating-text');
        if (ratingTextElement) {
            ratingTextElement.textContent = ratingTexts[rating];
        }
    }
    
    function restoreRating() {
        console.log('üñ±Ô∏è Restoring selected rating:', selectedRating);
        if (selectedRating > 0) {
            updateStarDisplay(selectedRating);
            
            const ratingTexts = ['', 'Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
            const ratingTextElement = document.querySelector('.remoed-rating-text');
            if (ratingTextElement) {
                ratingTextElement.textContent = ratingTexts[selectedRating];
            }
        } else {
            // Clear all stars if no rating selected
            document.querySelectorAll('.remoed-star').forEach(s => {
                s.classList.remove('active');
            });
            
            const ratingTextElement = document.querySelector('.remoed-rating-text');
            if (ratingTextElement) {
                ratingTextElement.textContent = 'Click to rate (1-5 stars)';
            }
        }
    }
    
    // Update feedback status after submission
    async function updateFeedbackStatusAfterSubmission() {
        console.log('üîÑ Updating feedback status after submission...');
        
        // Reload feedback history
        await loadFeedbackHistory();
        
        // Refresh the schedule display
        renderScheduleData();
        
        console.log('‚úÖ Feedback status updated in real-time');
    }
    
    // Load feedback history for the student
    async function loadFeedbackHistory() {
        try {
            const token = localStorage.getItem('token');
            if (!token) return;
            
            console.log('üìù Loading feedback history...');
            
            const response = await fetch('/api/student/feedback/history', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                const result = await response.json();
                feedbackHistory = result.feedback || [];
                console.log('‚úÖ Loaded feedback history:', feedbackHistory.length, 'entries');
                
                // Log which bookings have feedback
                feedbackHistory.forEach(feedback => {
                    console.log(`üìù Booking ${feedback.bookingId} has ${feedback.rating}-star feedback`);
                });
            } else {
                console.log('‚ö†Ô∏è Could not load feedback history');
                feedbackHistory = [];
            }
        } catch (error) {
            console.log('‚ùå Error loading feedback history:', error);
            feedbackHistory = [];
        }
    }
    
    // Check if feedback already exists for a booking
    async function checkExistingFeedback(bookingId) {
        try {
            // Use the global feedback history instead of making a new API call
            const existingFeedback = feedbackHistory.find(f => f.bookingId === bookingId);
            
            if (existingFeedback) {
                console.log('‚ö†Ô∏è Feedback already exists for this booking:', existingFeedback.rating, 'stars');
                // Disable submit button and show message
                const submitBtn = document.getElementById('submit-feedback-btn');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Feedback Already Submitted';
                }
                
                const ratingText = document.querySelector('.remoed-rating-text');
                if (ratingText) {
                    ratingText.textContent = `You already submitted ${existingFeedback.rating}-star feedback for this class`;
                }
                
                // Pre-fill the stars to show the existing rating
                updateStarDisplay(existingFeedback.rating);
                selectedRating = existingFeedback.rating;
            } else {
                console.log('‚úÖ No existing feedback found for this booking');
            }
        } catch (error) {
            console.log('Could not check existing feedback:', error);
        }
    }
    
    // Prevent duplicate submissions
    let isSubmitting = false;
    
    async function submitFeedbackToServer(feedbackData) {
        // Prevent duplicate submissions
        if (isSubmitting) {
            console.log('üîÑ Already submitting feedback, please wait...');
            return;
        }
        
        isSubmitting = true;
        
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                throw new Error('No authentication token found');
            }
            
            console.log('üì§ Submitting feedback data:', feedbackData);
            
            const response = await fetch('/api/student/feedback/submit', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(feedbackData)
            });
            
            console.log('üì• Response status:', response.status);
            
            if (response.ok) {
                const result = await response.json();
                console.log('‚úÖ Feedback submitted successfully:', result);
                alert('Thank you for your feedback!');
                closeFeedbackModal();
                
                // Update feedback history and refresh display in real-time
                await updateFeedbackStatusAfterSubmission();
            } else {
                const errorData = await response.json();
                console.log('‚ùå Server error response:', errorData);
                throw new Error(errorData.error || 'Failed to submit feedback');
            }
        } catch (error) {
            console.error('‚ùå Error submitting feedback:', error);
            alert(`Failed to submit feedback: ${error.message}`);
        } finally {
            isSubmitting = false;
            
            // Re-enable submit button
            const submitBtn = document.getElementById('submit-feedback-btn');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Feedback';
            }
        }
    }
    
    // Role-based access control
    const userType = localStorage.getItem('userType');
    if (userType !== 'student') {
      alert('Access denied. This page is for students only.');
      window.location.href = 'index.html';
    }
    
  // Get user info from localStorage
  const username = localStorage.getItem('remoedUsername') || 'Student';
  const studentId = localStorage.getItem('studentId');
    
  // Update sidebar - set initials in the avatar-text span (do not overwrite container)
  const avatarTextEl = document.getElementById('avatar-text');
  if (avatarTextEl) avatarTextEl.textContent = username[0].toUpperCase();
  const sidebarEmailEl = document.getElementById('sidebar-email');
  if (sidebarEmailEl) sidebarEmailEl.textContent = username;
    
    // Load profile picture if available
    if (studentId) {
        loadProfilePicture(studentId);
    }
    
    // Logout functionality
    document.getElementById('logout-nav').onclick = function() {
      localStorage.clear();
      window.location.href = 'student-login.html';
    };

    // Weekly grid variables
    let currentWeek = new Date();
    let bookingsData = [];
    let feedbackHistory = []; // Store feedback history

    // Initialize the weekly grid
    function initializeWeeklyGrid() {
      generateDayHeaders();
      generateTimeSlots();
      loadScheduleData();
    }

    // Luxon helper (with native fallback)
    function createDateTime(jsDate, timeZone) {
      const Lux = window.luxon && window.luxon.DateTime;
      if (Lux) return Lux.fromJSDate(jsDate, { zone: timeZone });
      const d = new Date(jsDate);
      return {
        _d: d,
        weekday: ((d.getDay() + 6) % 7) + 1, // ISO: Monday=1 ... Sunday=7
        plus: ({ days = 0 } = {}) => createDateTime(new Date(d.getTime() + days * 86400000), timeZone),
        minus: ({ days = 0 } = {}) => createDateTime(new Date(d.getTime() - days * 86400000), timeZone),
        toFormat: (fmt) => {
          if (fmt === 'ccc') return d.toLocaleDateString(undefined, { weekday: 'short' });
          if (fmt === 'LLLL d') return d.toLocaleDateString(undefined, { month: 'long', day: 'numeric' });
          if (fmt === 'ccc LLLL d') {
            return `${d.toLocaleDateString(undefined, { weekday: 'short' })} ${d.toLocaleDateString(undefined, { month: 'long' })} ${d.getDate()}`;
          }
          return d.toLocaleDateString();
        },
        toISODate: () => d.toISOString().split('T')[0]
      };
    }

    // Generate day headers
    function generateDayHeaders() {
      const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
      const dayHeadersRow = document.getElementById('day-headers-row');

      // Clear existing day headers, but keep the 'Time' th
      while (dayHeadersRow.children.length > 1) {
        dayHeadersRow.removeChild(dayHeadersRow.lastChild);
      }

      const baseWeek = createDateTime(currentWeek, timeZone);
      const monday = baseWeek.minus({ days: baseWeek.weekday - 1 }); // ISO weekday: 1=Monday, 7=Sunday

      for (let i = 0; i < 7; i++) {
        const day = monday.plus({ days: i });

        const dayTh = document.createElement('th');
        dayTh.className = 'day-column';
        dayTh.innerHTML = `${day.toFormat('ccc')}<br>${day.toFormat('LLLL d')}`;
        dayTh.dataset.date = day.toISODate();

        dayHeadersRow.appendChild(dayTh);
      }
    }

    // Generate time slots (30-minute intervals from 01:00 to 24:00) - 24-hour format
    function generateTimeSlots() {
      const gridBody = document.getElementById('time-slots-grid');
      gridBody.innerHTML = '';
      
      const startHour = 1;
      const endHour = 24;
      
      for (let hour = startHour; hour < endHour; hour++) {
        for (let minute = 0; minute < 60; minute += 30) {
          const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
          
          const timeRow = document.createElement('tr');
          
          // Time column
          const timeColumn = document.createElement('td');
          timeColumn.className = 'time-slot';
          timeColumn.textContent = formatTime24Hour(timeString);
          timeRow.appendChild(timeColumn);
          
          // Day columns
                  for (let day = 0; day < 7; day++) {
          const date = new Date(currentWeek);
          // Calculate Monday as the start of the week
          const dayOfWeek = currentWeek.getDay();
          const daysToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
          date.setDate(currentWeek.getDate() - daysToMonday + day);
            const dateString = date.toISOString().split('T')[0];
            
            const slot = document.createElement('td');
            slot.className = 'time-slot';
            slot.dataset.date = dateString;
            slot.dataset.time = timeString;
            
            // Check if slot is in the past
            const slotDateTime = new Date(`${dateString}T${timeString}`);
            const now = new Date();
            
            // Check if the class duration has passed (25 minutes after start time)
            const currentDate = now.toISOString().split('T')[0];
            const currentTime = now.toTimeString().split(' ')[0].substring(0, 5); // HH:MM format
            
            let isClassDurationPassed = false;
            if (dateString === currentDate) {
                // If it's today, check if the class duration has passed (25 minutes after start)
                const [startHour, startMinute] = timeString.split(':').map(Number);
                const endTime = new Date();
                endTime.setHours(startHour, startMinute + 25, 0, 0); // 25 minutes after start
                
                const currentDateTime = new Date();
                isClassDurationPassed = currentDateTime > endTime;
            }
            
            if (slotDateTime <= now && isClassDurationPassed) {
              slot.classList.add('unavailable');
            }
            
            timeRow.appendChild(slot);
          }
          
          gridBody.appendChild(timeRow);
        }
      }
    }

    // Load schedule data from backend
    async function loadScheduleData() {
      try {
              const weekStart = new Date(currentWeek);
      // Calculate Monday as the start of the week
      const dayOfWeek = currentWeek.getDay();
      const daysToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
      weekStart.setDate(currentWeek.getDate() - daysToMonday);
      const weekString = weekStart.toISOString().split('T')[0];
        
        console.log('üîç Loading student bookings for week:', weekString);
        console.log('üîç Username from localStorage:', username);
        
        const token = localStorage.getItem('token');
        console.log('üîç Token being sent:', token ? 'Token exists' : 'No token');
        
        if (!token) {
          console.error('‚ùå No auth token found - student may not be logged in');
          showMessage('Please log in to view your class schedule.', 'error');
          return;
        }
        
        // Add timeout to prevent hanging
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
        
        const response = await fetch(`/api/student/bookings?week=${weekString}`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Cache-Control': 'no-cache',
            'Pragma': 'no-cache'
          },
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        console.log('üîç Response status:', response.status);
        
        if (!response.ok) {
          if (response.status === 401) {
            console.log('‚ùå Unauthorized - token may be expired');
            alert('Session expired. Please log in again.');
            localStorage.clear();
            window.location.href = 'student-login.html';
            return;
          } else if (response.status === 404) {
            console.log('‚ÑπÔ∏è No bookings found for this week');
            bookingsData = [];
            renderScheduleData();
            return;
          } else {
            const errorText = await response.text();
            console.error('‚ùå API Error:', response.status, errorText);
            showMessage('Failed to load class schedule. Please try again.', 'error');
            return;
          }
        }
        
        const data = await response.json();
        
        console.log('‚úÖ Student bookings data:', data);
        
        bookingsData = data.bookings || [];
        
        if (bookingsData.length === 0) {
          console.log('‚ÑπÔ∏è No bookings found for this week');
        } else {
          console.log('‚úÖ Found', bookingsData.length, 'bookings');
        }
        
        // Load feedback history to check which bookings already have feedback
        await loadFeedbackHistory();

        renderScheduleData();
      } catch (error) {
        console.error('‚ùå Error loading student bookings:', error);
        if (error.name === 'AbortError') {
          showMessage('Request timed out. Please check your connection and try again.', 'error');
        } else {
          showMessage('Network error. Please check your connection and try again.', 'error');
        }
      }
    }

    // Render the schedule data on the grid
    function renderScheduleData() {
      console.log('üîÑ Rendering schedule data...');
      console.log('üìä Bookings data:', bookingsData.length, 'bookings');
      console.log('üìù Feedback history:', feedbackHistory.length, 'entries');
      
      // Clear all existing classes
      const allSlots = document.querySelectorAll('.time-slot[data-date]');
      allSlots.forEach(slot => {
        slot.classList.remove('booked', 'past', 'feedback-submitted', 'feedback-needed');
        slot.textContent = '';
        slot.onclick = null;
        slot.title = '';
      });

      // Render booked classes
      bookingsData.forEach(booking => {
          const normalizedBookingTime = normalizeTimeToHHMM(booking.time);
          const slotSelector = `[data-date="${booking.date}"][data-time="${normalizedBookingTime}"]`;
          const slotElement = document.querySelector(slotSelector);
          console.log(`üîç Looking for slot: date="${booking.date}", time="${booking.time}" (normalized: "${normalizedBookingTime}")`);
          console.log(`üîç Slot selector: ${slotSelector}`);
          console.log(`üîç Slot element found: ${slotElement ? 'YES' : 'NO'}`);
        if (!slotElement) {
          // Debug: show available slots for this date
          const availableSlotsForDate = document.querySelectorAll(`[data-date="${booking.date}"]`);
          console.log(`‚ö†Ô∏è Slot not found! Available slots for ${booking.date}:`, Array.from(availableSlotsForDate).map(s => s.dataset.time).filter(t => t).slice(0, 10));
        }
        if (slotElement) {
          console.log(`üìÖ Processing booking: ${booking.date} ${booking.time} (ID: ${booking._id})`);
          
          // Check if the class duration has passed (25 minutes after start time)
          const now = new Date();
          const bookingDateTime = new Date(`${booking.date}T${booking.time}`);
          const endTime = new Date(bookingDateTime);
          endTime.setMinutes(endTime.getMinutes() + 25); // 25 minutes after start
          
                    const isClassDurationPassed = now > endTime;
          console.log(`‚è∞ Class end time: ${endTime.toLocaleString()}, Is past: ${isClassDurationPassed}`);
          
          if (isClassDurationPassed) {
            // Check if feedback already exists for this booking
            const existingFeedback = feedbackHistory.find(f => f.bookingId === booking._id);
            console.log(`üìù Checking feedback for booking ${booking._id}:`, existingFeedback ? `Found ${existingFeedback.rating}-star feedback` : 'No feedback found');
            
            if (existingFeedback) {
              // If feedback already submitted, show feedback status
              slotElement.classList.add('past', 'feedback-submitted');
              slotElement.textContent = `${existingFeedback.rating}‚òÖ`;
              slotElement.title = `Feedback submitted: ${existingFeedback.rating} stars`;
              slotElement.style.cursor = 'pointer';
              slotElement.onclick = () => showPastBookingFeedback(booking);
              console.log(`‚úÖ Slot marked as feedback submitted: ${existingFeedback.rating}‚òÖ`);
            } else {
              // If no feedback submitted, show as "Past" and allow feedback
              slotElement.classList.add('past', 'feedback-needed');
              slotElement.textContent = 'Past';
              slotElement.title = 'Click to submit feedback';
              slotElement.style.cursor = 'pointer';
              slotElement.onclick = () => showPastBookingFeedback(booking);
              console.log(`‚ö†Ô∏è Slot marked as feedback needed: Past`);
            }
          } else {
            // If class duration hasn't passed, show as "Booked"
            slotElement.classList.add('booked');
            slotElement.textContent = 'Booked';
            slotElement.onclick = () => showBookingInfo(booking);
          }
        }
      });
      
      // Show message if no bookings found
      if (bookingsData.length === 0) {
        const messageDiv = document.createElement('div');
        messageDiv.style.cssText = `
          text-align: center;
          padding: 20px;
          color: #666;
          font-style: italic;
          background: #f8f9fa;
          border-radius: 8px;
          margin: 20px 0;
        `;
        messageDiv.textContent = 'No classes booked for this week. Click "Book Class" in the sidebar to schedule a class.';
        
        const existingMessage = document.querySelector('.no-bookings-message');
        if (existingMessage) {
          existingMessage.remove();
        }
        
        messageDiv.className = 'no-bookings-message';
        const weeklyGrid = document.querySelector('.weekly-grid');
        weeklyGrid.parentNode.insertBefore(messageDiv, weeklyGrid);
          } else {
        const existingMessage = document.querySelector('.no-bookings-message');
        if (existingMessage) {
          existingMessage.remove();
        }
      }
    }

    // Modal logic for class info
    let currentBookingInfo = null;
    function showBookingInfo(booking) {
      currentBookingInfo = booking;
      // Format date
      const date = new Date(booking.date);
      const formattedDate = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      document.getElementById('info-class-date').textContent = formattedDate;
      document.getElementById('info-class-time').textContent = formatTime24Hour(booking.time);
      // Handle both old and new teacher data structures
      let teacherName = 'Unknown Teacher';
      if (booking.teacherId) {
        if (typeof booking.teacherId === 'string') {
          teacherName = booking.teacherId;
        } else if (booking.teacherId.username) {
          teacherName = booking.teacherId.username;
        } else if (booking.teacherId.firstName) {
          teacherName = `${booking.teacherId.firstName} ${booking.teacherId.lastName || ''}`.trim();
        }
      }
      document.getElementById('info-class-teacher').textContent = teacherName;
      document.getElementById('info-class-level').textContent = booking.studentLevel || 'Not specified';
      document.getElementById('info-class-lesson').textContent = booking.lesson || 'Not specified';
      document.getElementById('info-classroom-id').textContent = booking.classroomId || 'Not set';
      
      // Show/hide cancel button based on booking status and time
      const cancelRow = document.getElementById('cancel-booking-row');
      const cancelBtn = document.getElementById('cancel-booking-btn');
      const classDateTime = new Date(`${booking.date}T${booking.time}:00`);
      const now = new Date();
      const isPastOrStarted = classDateTime <= now;
      const isCancelled = booking.status === 'cancelled';
      const elapsedHours = (now - classDateTime) / (1000 * 60 * 60);
      
      // Show Preview Video button if 1 hour has passed and video is available
      const previewRow = document.getElementById('preview-lesson-row');
      const previewBtn = document.getElementById('preview-lesson-btn');
      const joinBtn = document.getElementById('join-classroom-btn');
      
      if (elapsedHours >= 1 && booking.recording && booking.recording.videoPath) {
        // After 1 hour, show Preview Video instead
        if (previewRow) previewRow.style.display = 'flex';
        if (joinBtn) joinBtn.style.display = 'none';
        if (previewBtn) {
          previewBtn.onclick = () => previewLesson(booking._id, true); // true = auto-download
        }
      } else {
        // Before 1 hour, show Enter Live Classroom
        if (previewRow) previewRow.style.display = 'none';
        if (joinBtn) joinBtn.style.display = 'inline-block';
      }
      
      if (isCancelled || isPastOrStarted) {
        cancelRow.style.display = 'none';
      } else {
        cancelRow.style.display = 'flex';
        cancelBtn.disabled = false;
        cancelBtn.textContent = 'Cancel Booking';
      }
      
      const modal = document.getElementById('booking-info-modal');
      if (modal) {
        modal.classList.add('show');
      }
    }
    function closeBookingInfo() {
      const modal = document.getElementById('booking-info-modal');
      if (modal) {
        modal.classList.remove('show');
      }
      currentBookingInfo = null;
    }
    document.getElementById('close-booking-info-modal').onclick = closeBookingInfo;
    document.getElementById('close-booking-info-modal2').onclick = closeBookingInfo;
    document.getElementById('booking-info-modal').onclick = function(e) {
      if (e.target === this) closeBookingInfo();
    };
    // Preview lesson function
    async function previewLesson(bookingId, autoDownload = true) {
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          alert('Please log in to preview the lesson.');
          return;
        }
        
        // Show loading message
        if (autoDownload) {
          const notification = document.createElement('div');
          notification.textContent = 'üì• Downloading lesson video...';
          notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #667eea; color: white; padding: 12px 20px; border-radius: 8px; z-index: 10000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
          document.body.appendChild(notification);
          setTimeout(() => notification.remove(), 3000);
        }
        
        // Download the video
        const response = await fetch(`/api/recording/video/${bookingId}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          const error = await response.json();
          alert('Failed to load video: ' + (error.error || 'Unknown error'));
          return;
        }
        
        // Create blob and automatically download
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `lesson-recording-${bookingId}-${new Date().toISOString().split('T')[0]}.webm`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        if (autoDownload) {
          const successNotification = document.createElement('div');
          successNotification.textContent = '‚úÖ Video downloaded successfully!';
          successNotification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 12px 20px; border-radius: 8px; z-index: 10000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
          document.body.appendChild(successNotification);
          setTimeout(() => successNotification.remove(), 3000);
        }
      } catch (error) {
        console.error('Error previewing lesson:', error);
        alert('Failed to download video: ' + error.message);
      }
    }
    
    document.getElementById('join-classroom-btn').onclick = function() {
      if (!currentBookingInfo) return;
      const classroomId = currentBookingInfo.classroomId;
      if (!classroomId) {
        alert('No classroom ID set for this booking.');
        return;
      }
      const slotTime = currentBookingInfo.time || '';
      const roomUrl = `live-classroom.html?room=${classroomId}&type=student&bookingId=${currentBookingInfo._id}&slot=${encodeURIComponent(slotTime)}`;
      window.open(roomUrl, '_blank');
    };
    
    // Cancel booking functionality
    document.getElementById('cancel-booking-btn').onclick = async function() {
      if (!currentBookingInfo) return;
      
      // Check if class has already started
      const classDateTime = new Date(`${currentBookingInfo.date}T${currentBookingInfo.time}:00`);
      const now = new Date();
      
      if (classDateTime <= now) {
        alert('Cannot cancel a class that has already started.');
        return;
      }
      
      // Confirmation dialog
      const confirmed = confirm(
        `Are you sure you want to cancel this booking?\n\n` +
        `Date: ${new Date(currentBookingInfo.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}\n` +
        `Time: ${formatTime24Hour(currentBookingInfo.time)}\n\n` +
        `This action cannot be undone.`
      );
      
      if (!confirmed) return;
      
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          alert('Authentication required. Please log in again.');
          window.location.href = 'student-login.html';
          return;
        }
        
        // Disable button during request
        const cancelBtn = document.getElementById('cancel-booking-btn');
        cancelBtn.disabled = true;
        cancelBtn.textContent = 'Cancelling...';
        
        const response = await fetch('/api/student/cancel-booking', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            bookingId: currentBookingInfo._id
          })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          alert('Booking cancelled successfully!');
          closeBookingInfo();
          // Reload the schedule to reflect the cancellation
          loadScheduleData();
        } else {
          const errorMsg = data.error || data.message || response.statusText || 'Unknown error';
          console.error('Cancellation error:', { status: response.status, statusText: response.statusText, data });
          alert(`Failed to cancel booking: ${errorMsg}`);
          cancelBtn.disabled = false;
          cancelBtn.textContent = 'Cancel Booking';
        }
      } catch (error) {
        console.error('Error cancelling booking:', error);
        let errorMessage = 'An error occurred while cancelling the booking.';
        if (error.message) {
          errorMessage += ` Error: ${error.message}`;
        }
        alert(errorMessage);
        const cancelBtn = document.getElementById('cancel-booking-btn');
        cancelBtn.disabled = false;
        cancelBtn.textContent = 'Cancel Booking';
      }
    };

    // Week navigation functionality
    document.getElementById('prev-week').addEventListener('click', () => {
      currentWeek.setDate(currentWeek.getDate() - 7);
      updateWeekDisplay();
      initializeWeeklyGrid();
    });

    document.getElementById('next-week').addEventListener('click', () => {
      currentWeek.setDate(currentWeek.getDate() + 7);
      updateWeekDisplay();
      initializeWeeklyGrid();
    });

    document.getElementById('current-week').addEventListener('click', () => {
      currentWeek = new Date();
      updateWeekDisplay();
      initializeWeeklyGrid();
    });

    // Update week display
    function updateWeekDisplay() {
      const weekStart = new Date(currentWeek);
      // Calculate Monday as the start of the week (Monday = 1, Sunday = 0)
      const dayOfWeek = currentWeek.getDay();
      const daysToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // If Sunday, go back 6 days; if Monday, go back 0 days, etc.
      weekStart.setDate(currentWeek.getDate() - daysToMonday);
      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekStart.getDate() + 6);
      
      const display = document.getElementById('week-display');
      display.textContent = `${weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
      
      // Allow navigation to previous weeks (remove the restriction)
      const prevBtn = document.getElementById('prev-week');
      prevBtn.disabled = false; // Always allow previous week navigation
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', () => {
      updateWeekDisplay();
      initializeWeeklyGrid();
    });
    
    // Helper function to show messages
    function showMessage(message, type = 'info') {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = message;
      messageDiv.style.cssText = `
        margin: 18px 0;
        text-align: center;
        font-size: 1.1rem;
        padding: 12px;
        border-radius: 6px;
        background: ${type === 'error' ? '#f8d7da' : type === 'success' ? '#d4edda' : '#d1ecf1'};
        color: ${type === 'error' ? '#721c24' : type === 'success' ? '#155724' : '#0c5460'};
        border: 1px solid ${type === 'error' ? '#f5c6cb' : type === 'success' ? '#c3e6cb' : '#bee5eb'};
      `;
      
      // Remove existing messages
      const existingMessages = document.querySelectorAll('.message');
      existingMessages.forEach(msg => msg.remove());
      
      // Insert message before the weekly grid
      const weeklyGrid = document.querySelector('.weekly-grid');
      if (weeklyGrid && weeklyGrid.parentNode) {
        weeklyGrid.parentNode.insertBefore(messageDiv, weeklyGrid);
      }
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
        if (messageDiv.parentNode) {
          messageDiv.remove();
        }
      }, 5000);
    }

    function normalizeTimeToHHMM(timeValue) {
      if (!timeValue) return '';
      const [hourStr = '', minuteStr = '0'] = timeValue.split(':');
      const hour = parseInt(hourStr, 10);
      const minute = parseInt(minuteStr, 10);
      if (Number.isNaN(hour) || Number.isNaN(minute)) return '';
      return `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
    }

    function formatTime24Hour(timeString) {
      const [hourStr, minuteStr] = timeString.split(':');
      const hour = parseInt(hourStr, 10);
      const minute = minuteStr.padStart(2, '0');
      return `${hour.toString().padStart(2, '0')}:${minute}`;
    }

    // Cancellation Modal Logic
    function showCancellationModal() {
      if (!currentBookingInfo) return;
      
      // Check if class has already started
      const classDateTime = new Date(`${currentBookingInfo.date}T${currentBookingInfo.time}:00`);
      const now = new Date();
      
      if (classDateTime <= now) {
        alert('Cannot cancel a class that has already started.');
        return;
      }
      
              document.getElementById('cancel-class-info').textContent = `${currentBookingInfo.date} at ${formatTime24Hour(currentBookingInfo.time)}`;
      // Handle both old and new teacher data structures for cancellation modal
      let cancelTeacherName = 'Unknown Teacher';
      if (currentBookingInfo.teacherId) {
        if (typeof currentBookingInfo.teacherId === 'string') {
          cancelTeacherName = currentBookingInfo.teacherId;
        } else if (currentBookingInfo.teacherId.username) {
          cancelTeacherName = currentBookingInfo.teacherId.username;
        } else if (currentBookingInfo.teacherId.firstName) {
          cancelTeacherName = `${currentBookingInfo.teacherId.firstName} ${currentBookingInfo.teacherId.lastName || ''}`.trim();
        }
      }
      document.getElementById('cancel-teacher-info').textContent = cancelTeacherName;
      document.getElementById('cancellation-modal').style.display = 'block';
      document.getElementById('cancellation-reason').value = '';
      document.getElementById('char-count').textContent = '0';
    }

    function closeCancellationModal() {
      document.getElementById('cancellation-modal').style.display = 'none';
    }

    function updateCharCount() {
      const reason = document.getElementById('cancellation-reason').value.trim();
      document.getElementById('char-count').textContent = reason.length;
    }

    async function submitCancellationRequest() {
      const reason = document.getElementById('cancellation-reason').value.trim();
      
      if (reason.length < 10) {
        alert('Cancellation reason must be at least 10 characters long.');
        return;
      }

      if (!currentBookingInfo) return;

      try {
        const token = localStorage.getItem('token');
        if (!token) {
          alert('Authentication required for cancellation.');
          window.location.href = 'student-login.html';
          return;
        }

        const response = await fetch('/api/student/request-cancellation', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            bookingId: currentBookingInfo._id,
            reason: reason
          })
        });

        const data = await response.json();

        if (response.ok) {
          alert('Cancellation request submitted successfully! It will be reviewed by admin.');
          closeCancellationModal();
          closeBookingInfo();
          initializeWeeklyGrid(); // Refresh the grid
        } else {
          alert(`Cancellation failed: ${data.error || response.statusText}`);
        }
      } catch (error) {
        console.error('Error submitting cancellation request:', error);
        alert('An error occurred while submitting the cancellation request.');
      }
    }

    // Add event listeners
    document.addEventListener('DOMContentLoaded', function() {
      const reasonTextarea = document.getElementById('cancellation-reason');
      if (reasonTextarea) {
        reasonTextarea.addEventListener('input', updateCharCount);
      }
    });

    // Close modal when clicking outside
    window.onclick = function(event) {
      const bookingModal = document.getElementById('booking-info-modal');
      if (event.target === bookingModal) {
        closeBookingInfo();
      }
      
      const cancellationModal = document.getElementById('cancellation-modal');
      if (event.target === cancellationModal) {
        closeCancellationModal();
      }
    }
    
        // Load profile picture from backend
    async function loadProfilePicture(studentId) {
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                console.log('üîç No token found for profile picture');
                return;
            }
            
            const username = localStorage.getItem('remoedUsername') || 'Student';
            console.log('üîç Loading profile picture for studentId:', studentId);
            console.log('üîç Username from localStorage:', username);
            
            // Try multiple API endpoints
            let profileData = null;
            let response = null;
            
            // First try: /api/student/profile
            try {
                console.log('üîç Trying /api/student/profile endpoint...');
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                response = await fetch(`/api/student/profile`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    profileData = await response.json();
                    console.log('‚úÖ Profile data received from /api/student/profile:', profileData);
                } else {
                    console.log('‚ùå /api/student/profile failed with status:', response.status);
                }
            } catch (error) {
                console.log('‚ùå Error with /api/student/profile:', error.message);
            }
            
            // Second try: /api/students/profile (alternative endpoint)
            if (!profileData && response && response.status !== 200) {
                try {
                    console.log('üîç Trying /api/students/profile endpoint...');
                    const controller2 = new AbortController();
                    const timeoutId2 = setTimeout(() => controller2.abort(), 5000);
                    
                    response = await fetch(`/api/students/profile`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Cache-Control': 'no-cache',
                            'Pragma': 'no-cache'
                        },
                        signal: controller2.signal
                    });
                    
                    clearTimeout(timeoutId2);
                    
                    if (response.ok) {
                        profileData = await response.json();
                        console.log('‚úÖ Profile data received from /api/students/profile:', profileData);
                    }
                } catch (error) {
                    console.log('‚ùå Error with /api/students/profile:', error.message);
                }
            }
            
            // Third try: Direct student lookup by ID
            if (!profileData && studentId) {
                try {
                    console.log('üîç Trying direct student lookup by ID...');
                    const controller3 = new AbortController();
                    const timeoutId3 = setTimeout(() => controller3.abort(), 5000);
                    
                    response = await fetch(`/api/students/${studentId}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Cache-Control': 'no-cache',
                            'Pragma': 'no-cache'
                        },
                        signal: controller3.signal
                    });
                    
                    clearTimeout(timeoutId3);
                    
                    if (response.ok) {
                        profileData = await response.json();
                        console.log('‚úÖ Profile data received from direct lookup:', profileData);
                    }
                } catch (error) {
                    console.log('‚ùå Error with direct student lookup:', error.message);
                }
            }
            
            // Process the profile data
            if (profileData) {
                // Handle different response structures
                let profile;
                if (profileData.profile) {
                    profile = profileData.profile;
                } else if (profileData.student) {
                    profile = profileData.student;
                } else {
                    profile = profileData;
                }
                
                console.log('üîç Final profile data for picture:', profile);
                
        if (profile.profilePicture && profile.profilePicture.trim() !== '') {
          setAvatar({
            imageUrl: profile.profilePicture,
            displayName: username,
            imgSelector: '#profile-image',
            textSelector: '#avatar-text'
          });
        } else {
          setAvatar({
            imageUrl: '',
            displayName: username,
            imgSelector: '#profile-image',
            textSelector: '#avatar-text'
          });
        }
            } else {
                console.log('‚ùå All API attempts failed');
                // Ensure avatar text is visible
                const profileImage = document.getElementById('profile-image');
                const avatarText = document.getElementById('avatar-text');
                if (profileImage && avatarText) {
                    profileImage.style.display = 'none';
                    avatarText.style.display = 'block';
                }
            }
        } catch (error) {
            console.error('‚ùå Error loading profile picture:', error);
            // Ensure avatar text is visible on error
            const profileImage = document.getElementById('profile-image');
            const avatarText = document.getElementById('avatar-text');
            if (profileImage && avatarText) {
                profileImage.style.display = 'none';
                avatarText.style.display = 'block';
            }
        }
        
        // Setup event listeners when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            setupFeedbackEventListeners();
        });

    }
  </script>
  <script src="avatar-helper.js"></script>
</body>
</html> 
