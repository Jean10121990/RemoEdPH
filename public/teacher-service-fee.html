<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teaching Fee - RemoEdPH</title>
  <link rel="stylesheet" href="modern-styles.css?v=6">
  <style>
    body { 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        background: #f6fbff; 
        margin: 0;
        padding: 0;
    }
    .remoed-main { 
        display: flex; 
        min-height: 100vh; 
    }
    .remoed-sidebar { 
        width: 260px; 
        min-width: 260px;
        background: linear-gradient(180deg, #ffffff 0%, #f8fbff 100%); 
        box-shadow: 4px 0 20px rgba(102, 126, 234, 0.1);
        padding: 0; 
        display: flex; 
        flex-direction: column; 
        align-items: stretch;
        position: fixed;
        height: 100vh;
        z-index: 100;
        border-right: 1px solid rgba(102, 126, 234, 0.1);
    }
    .remoed-logo { 
        display: flex; 
        align-items: center; 
        gap: 14px; 
    }
    .remoed-logo img { 
        height: 48px; 
    }
    .remoed-title { 
        font-size: 1.7rem; 
        font-weight: 700; 
        color: #667eea; 
        letter-spacing: 1px; 
    }
    .remoed-user { 
        display: flex; 
        align-items: center; 
        gap: 10px; 
    }
    .remoed-avatar { 
        width: 72px; 
        height: 72px; 
        border-radius: 50%; 
        background: #667eea; 
        color: #fff; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        font-weight: bold; 
        font-size: 2.2rem; 
    }
    .remoed-username { 
        color: #667eea; 
        font-weight: 600; 
    }
    .remoed-menu { 
        list-style: none; 
        padding: 0; 
        margin: 0; 
    }
    .remoed-menu li { 
        padding: 14px 32px; 
        color: #667eea; 
        font-weight: 500; 
        cursor: pointer; 
        display: flex; 
        align-items: center; 
        gap: 12px; 
        border-left: 4px solid transparent; 
        transition: background 0.2s, border-color 0.2s; 
    }
            .remoed-menu li.active, .remoed-menu li:hover { 
            background: linear-gradient(90deg, #667eea 0%, #5a67d8 100%); 
            border-left: 4px solid #667eea; 
            color: white; 
            transform: translateX(4px);
            transition: all 0.3s ease;
        }
        .remoed-menu svg { 
            width: 20px; 
            height: 20px; 
            stroke: currentColor; 
        }
    .remoed-content { 
        flex: 1; 
        padding: 12px 16px; 
        margin-left: 260px;
        max-width: calc(100vw - 260px);
        display: flex;
        flex-direction: column;
        align-items: center;
        box-sizing: border-box;
        overflow-x: hidden;
    }
    .service-header-panel {
      display: flex;
      justify-content: center;
      width: 100%;
      margin-top: 8px;
      margin-bottom: 0;
      align-items: center;
    }
    .service-header {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      padding: 8px 12px;
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
      max-width: 100%;
      width: 100%;
      flex-wrap: wrap;
      gap: 10px;
    }
    .account-info-row {
      font-size: 0.95rem;
      color: #222;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .account-label {
      font-weight: 600;
      color: #667eea;
      margin-right: 6px;
    }
    .service-header .account-info { font-size: 1rem; color: #222; }
    .service-header .account-info span { font-weight: 600; color: #667eea; }
    .service-header .pay-period { color: #888; font-size: 0.95rem; }
    .service-tabs { display: flex; justify-content: center; margin: 18px 0 0 0; gap: 8px; align-items: center; }
    .service-tab { background: #fff; border: none; border-radius: 5px 5px 0 0; padding: 7px 18px; font-size: 1rem; color: #3a7afe; font-weight: 600; margin-right: 2px; cursor: pointer; box-shadow: 0 1px 4px rgba(28,167,231,0.04); }
    .service-tab.inactive { color: #888; background: #fafdff; font-weight: 500; }
    .service-main-col { display: flex; flex-direction: row; align-items: flex-start; width: 100%; justify-content: center; gap: 15px; }
    .service-section { background: #fff; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); padding: 10px 12px; width: 100%; max-width: 100%; margin: 6px 0; transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .service-section:hover { transform: translateY(-1px); box-shadow: 0 3px 10px rgba(0,0,0,0.08); }
    .service-section-title { font-size: 0.95rem; font-weight: 700; color: #222; margin-bottom: 8px; }
    .service-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; }
    .service-label { color: #888; font-size: 0.85rem; min-width: 80px; }
    .service-value, .service-input { font-size: 0.9rem; color: #667eea; font-weight: 600; min-width: 50px; }
    .service-input { border: 1px solid #e0e6ed; border-radius: 4px; padding: 2px 6px; width: 60px; font-size: 0.9rem; color: #667eea; background: #fafdff; }
    .service-input:disabled { background: #f8f9fa; color: #6c757d; border-color: #dee2e6; cursor: not-allowed; }
    .service-sum { color: #e74c3c; font-size: 1rem; font-weight: 700; }
    .service-section .service-row:last-child { margin-bottom: 0; }
    .service-summary, .service-remark { background: #fafdff; border-radius: 6px; padding: 8px 12px; margin: 8px 0 0 0; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; max-width: 100%; width: 100%; margin-left: auto; margin-right: auto; }
    .service-summary .label, .service-remark .label { color: #888; font-weight: 500; }
    .service-summary .value, .service-remark .value { color: #e74c3c; font-weight: 700; font-size: 1rem; }
    
    /* Weekly Tabs Styles */
    .week-tab {
      background: #fff;
      border: 2px solid #e0e6ed;
      border-radius: 8px 8px 0 0;
      padding: 8px 16px;
      font-size: 0.9rem;
      font-weight: 600;
      color: #666;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-right: 2px;
      border-bottom: none;
      position: relative;
      white-space: nowrap;
    }
    .week-tab:hover {
      border-color: #667eea;
      color: #667eea;
      background: #f8f9fa;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(102, 126, 234, 0.1);
    }
    .week-tab.active {
      background: #667eea !important;
      border-color: #667eea !important;
      color: #fff !important;
      z-index: 10;
    }
    .week-tab.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 2px;
      background: #667eea;
    }
    .week-tab.active:hover {
      background: linear-gradient(135deg, #667eea 0%, #5a67d8 100%) !important;
      border-color: #5a67d8 !important;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
    }
    
    /* Ensure all tabs have consistent active state */
    #current-week-tab.active,
    #previous-week-tab.active,
    #daily-breakdown-tab.active,
    #weekly-payment-history-tab.active {
      background: #667eea !important;
      border-color: #667eea !important;
      color: #fff !important;
      z-index: 10;
    }
    
    #current-week-tab.active:hover,
    #previous-week-tab.active:hover,
    #daily-breakdown-tab.active:hover,
    #weekly-payment-history-tab.active:hover {
      background: linear-gradient(135deg, #667eea 0%, #5a67d8 100%) !important;
      border-color: #5a67d8 !important;
      color: #fff !important;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
    }
    .weekly-tabs {
      border-bottom: 2px solid #e0e6ed;
      background: #f8f9fa;
      padding: 0 10px;
      border-radius: 8px 8px 0 0;
      overflow-x: auto;
      display: flex;
      justify-content: center;
    }
    
    /* Week History Table */
    .week-history-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .week-history-table th,
    .week-history-table td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid #e0e6ed;
      font-size: 0.95rem;
    }
    .week-history-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #1ca7e7;
      font-size: 1rem;
    }
    .week-history-table tr:hover {
      background: #fafdff;
    }
    .week-history-table td {
      color: #333;
    }
    .week-history-table .status-success {
      color: #27ae60;
      font-weight: 500;
    }
    
    @media (max-width: 1200px) {
      .service-main-col { flex-direction: column; align-items: center; }
      .service-section { max-width: 100%; }
      .service-header { flex-direction: column; gap: 15px; }
      .service-header > div:first-child { flex-direction: column; gap: 10px; }
      .remoed-content { padding: 15px; }
    }
    
    @media (max-width: 768px) {
      .service-main-col { flex-direction: column; align-items: center; gap: 10px; }
      .service-section { padding: 12px 15px; margin: 8px 0; }
      .service-header { padding: 10px 12px; }
      .week-tab { padding: 6px 12px; font-size: 0.85rem; }
      .tab-content-container { padding: 12px; }
      .service-summary, .service-remark { padding: 8px 12px; margin: 8px 0; }
      .remoed-content { padding: 10px; }
      .account-info-row { font-size: 0.9rem; }
    }
    
    @media (max-width: 600px) {
      .service-section, .service-summary, .service-remark { max-width: 100%; padding: 10px 12px; }
      .week-tab { padding: 6px 10px; font-size: 0.8rem; }
      .tab-content-container { max-width: 100%; padding: 10px; }
      #weekly-payment-history-content { max-width: 100%; }
      .service-header { padding: 8px 10px; }
      .remoed-content { padding: 8px; }
      .account-info-row { font-size: 0.85rem; }
      .service-section-title { font-size: 1rem; }
      .service-label { font-size: 0.9rem; }
      .service-value, .service-input { font-size: 0.9rem; }
    }
  </style>
  <script>
    // Initialize sidebar info after DOM is parsed to avoid null element errors.
    document.addEventListener('DOMContentLoaded', function () {
      const username = localStorage.getItem('remoedUsername') || 'User';
      const teacherId = localStorage.getItem('teacherId');

      const usernameEl = document.getElementById('remoed-username');
      const accountEmailEl = document.getElementById('account-email');

      if (usernameEl) usernameEl.textContent = 'Loading...';
      if (accountEmailEl) accountEmailEl.textContent = username;

      // Use setAvatar when available; otherwise safely fallback to initials.
      if (typeof setAvatar === 'function') {
        try {
          setAvatar({ imageUrl: '', displayName: username, imgSelector: '#profile-image', textSelector: '#avatar-text' });
        } catch (e) {
          // ignore and fallback
          const at = document.getElementById('avatar-text');
          if (at) at.textContent = username[0].toUpperCase();
        }
      } else {
        const at = document.getElementById('avatar-text');
        if (at) at.textContent = username[0].toUpperCase();
      }

      // Load profile picture if available and loader function exists
      if (teacherId && typeof loadProfilePicture === 'function') {
        try { loadProfilePicture(teacherId); } catch (e) { /* ignore */ }
      }
    });
  </script>
        <nav class="remoed-sidebar">
            <div class="remoed-logo" style="height:100px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px; padding-top:5px;">
                <img src="remoed-logo.png" alt="RemoEdPH Logo" style="height:40px; width:auto; display:inline-block; vertical-align:middle;">
                <span class="remoed-title" style="font-size:1.3rem; font-weight:700; color:#667eea; letter-spacing:1px;">RemoEdPH</span>
            </div>
            <div class="remoed-user" style="display:flex; flex-direction:column; align-items:center; margin-bottom:24px;">
                <div class="remoed-avatar" id="remoed-avatar" onclick="window.location.href='teacher-profile.html'" style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'"><!-- avatar container -->
                    <img id="profile-image" src="" alt="Profile" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover; display: none;">
                    <span id="avatar-text">K</span>
                </div>
                <span class="remoed-username" id="remoed-username"></span>
            </div>
            <ul class="remoed-menu">
                <li onclick="window.location.href='teacher-dashboard.html'"><svg fill="none" stroke="#667eea" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="4"/></svg>Dashboard</li>
                <li onclick="window.location.href='teacher-class-table.html'"><svg fill="none" stroke="#667eea" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="7" width="18" height="13" rx="2"/><path d="M16 3v4M8 3v4"/></svg>Class Schedule</li>
                <li onclick="window.location.href='teacher-open-class.html'"><svg fill="none" stroke="#667eea" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M8 12h8M12 8v8"/></svg>Class Configuration</li>
                <li onclick="window.location.href='device-check.html'"><svg fill="none" stroke="#667eea" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M8 12h8M12 8v8"/></svg>Device Check</li>
                <li class="active" onclick="window.location.href='teacher-service-fee.html'"><svg fill="none" stroke="#667eea" stroke-width="2" viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 10c-4.41 0-8-1.79-8-4V6c0-2.21 3.59-4 8-4s8 1.79 8 4v8c0 2.21-3.59 4-8 4z"/></svg>Teaching Fee</li>
                <li onclick="window.location.href='teacher-performance-indicator.html'"><svg fill="none" stroke="#667eea" stroke-width="2" viewBox="0 0 24 24"><path d="M3 3v18h18M7 12h10M7 8h6M7 16h4"/></svg>Performance Indicator</li>
                <li onclick="window.location.href='teacher-professional-development.html'"><svg fill="none" stroke="#667eea" stroke-width="2" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>Professional Development</li>
                <li onclick="window.location.href='teacher-profile.html'"><svg fill="none" stroke="#667eea" stroke-width="2" viewBox="0 0 24 24"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>Profile</li>
                <li id="logout-nav" style="margin-top:auto; color:#e74c3c; cursor:pointer;"><svg fill="none" stroke="#e74c3c" stroke-width="2" viewBox="0 0 24 24"><path d="M17 16l4-4m0 0l-4-4m4 4H7"/><path d="M3 12a9 9 0 0118 0 9 9 0 01-18 0z"/></svg>Logout</li>
            </ul>
        </nav>
    <div class="remoed-content">
      <div class="service-header-panel">
        <div class="service-header">
          <div style="display: flex; gap: 16px; flex-wrap: nowrap; align-items: center; overflow-x: auto;">
          <div class="account-info-row">
            <span class="account-label">Account:</span> <span id="account-email">user@remoedph.com</span>
          </div>
          <div class="account-info-row">
            <span class="account-label">Payment Method:</span> <span>PayPal</span>
          </div>
          <div class="account-info-row">
            <span class="account-label">Weekly Period:</span> <span id="pay-period">Monday - Friday</span>
            </div>
          </div>
          <!-- Debug gear icon hidden -->
        </div>
      </div>
      
      <!-- Weekly Tabs -->
      <div class="weekly-tabs" style="display: flex; justify-content: center; margin: 8px 0 0 0; width: 100%; max-width: 100%; gap: 8px; flex-wrap: wrap;">
        <button id="current-week-tab" class="week-tab active" onclick="switchWeekTab('current')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: #fff; padding: 6px 12px; border-radius: 20px; font-weight: 600; font-size: 0.85rem; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3); transition: all 0.3s ease; display: flex; align-items: center; gap: 6px;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
          </svg>
          Current Week
        </button>
        <button id="previous-week-tab" class="week-tab" onclick="switchWeekTab('previous')" style="background: #f8f9fa; border: 2px solid #e9ecef; color: #495057; padding: 6px 12px; border-radius: 20px; font-weight: 600; font-size: 0.85rem; transition: all 0.3s ease; display: flex; align-items: center; gap: 6px;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
          </svg>
          Previous Week
        </button>
        <button id="daily-breakdown-tab" class="week-tab" onclick="switchWeekTab('daily-breakdown')" style="background: #f8f9fa; border: 2px solid #e9ecef; color: #495057; padding: 6px 12px; border-radius: 20px; font-weight: 600; font-size: 0.85rem; transition: all 0.3s ease; display: flex; align-items: center; gap: 6px;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/>
          </svg>
          Daily Breakdown
        </button>
        <button id="weekly-payment-history-tab" class="week-tab" onclick="switchWeekTab('weekly-payment-history')" style="background: #f8f9fa; border: 2px solid #e9ecef; color: #495057; padding: 6px 12px; border-radius: 20px; font-weight: 600; font-size: 0.85rem; transition: all 0.3s ease; display: flex; align-items: center; gap: 6px;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
          </svg>
          Payment History
        </button>
      </div>
      
      <!-- Tab Content Container -->
      <div class="tab-content-container" style="background: #f8f9fa; border: 2px solid #e0e6ed; border-top: none; border-radius: 0 0 8px 8px; padding: 12px; margin-top: 0; width: 100%; max-width: 100%;">
        
        <!-- Summary Stats Row -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; max-width: 1200px; margin: 0 auto 12px auto;">
          <div style="background: #fff; border: 1px solid #e0e6ed; padding: 12px; border-radius: 8px; text-align: center; box-shadow: 0 2px 6px rgba(0,0,0,0.05);">
            <div style="font-size: 1.5rem; margin-bottom: 4px; color: #667eea;">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 3L1 9l4 2.18v6L12 21l7-3.82v-6l2-1.09v6.91L12 23 1 17V9l11-6z"/>
              </svg>
            </div>
            <div style="font-size: 1.2rem; font-weight: 700; margin-bottom: 3px; color: #333;" id="summary-completed-classes">0</div>
            <div style="font-size: 0.8rem; color: #666;">Completed Classes</div>
          </div>
          <div style="background: #fff; border: 1px solid #e0e6ed; padding: 12px; border-radius: 8px; text-align: center; box-shadow: 0 2px 6px rgba(0,0,0,0.05);">
            <div style="font-size: 1.5rem; margin-bottom: 4px; color: #ff8c42;">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
              </svg>
            </div>
            <div style="font-size: 1.2rem; font-weight: 700; margin-bottom: 3px; color: #333;" id="summary-student-absent">0</div>
            <div style="font-size: 0.8rem; color: #666;">Student Absent</div>
          </div>
          <div style="background: #fff; border: 1px solid #e0e6ed; padding: 12px; border-radius: 8px; text-align: center; box-shadow: 0 2px 6px rgba(0,0,0,0.05);">
            <div style="font-size: 1.5rem; margin-bottom: 4px; color: #ff6b6b;">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 13H5v-2h14v2z"/>
              </svg>
            </div>
            <div style="font-size: 1.2rem; font-weight: 700; margin-bottom: 3px; color: #333;" id="summary-deductions">‚Ç±0</div>
            <div style="font-size: 0.8rem; color: #666;">Total Deductions</div>
          </div>
          <div style="background: #fff; border: 1px solid #e0e6ed; padding: 12px; border-radius: 8px; text-align: center; box-shadow: 0 2px 6px rgba(0,0,0,0.05);">
            <div style="font-size: 1.5rem; margin-bottom: 4px; color: #27ae60;">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/>
              </svg>
            </div>
            <div style="font-size: 1.2rem; font-weight: 700; margin-bottom: 3px; color: #333;" id="summary-net-amount">‚Ç±0</div>
            <div style="font-size: 0.8rem; color: #666;">Net Payable</div>
          </div>
        </div>

        <!-- Main Content Grid -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 12px; max-width: 1200px; margin: 0 auto;">
          
          <!-- Weekly Fee Card -->
          <div class="service-section" style="background: #fff; border: 1px solid #e0e6ed; border-radius: 8px; padding: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.05);">
            <div class="service-section-title" style="color: #333; font-size: 1rem; margin-bottom: 10px; display: flex; align-items: center; gap: 6px;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="color: #667eea;">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
              </svg>
              Weekly Fee
            </div>
            
            <div class="service-row" style="background: #f8f9fa; padding: 8px; border-radius: 6px; margin-bottom: 8px; border: 1px solid #e9ecef;">
              <div class="service-label" style="color: #495057; font-size: 0.85rem;">25 minutes rate <span style="font-size: 0.75rem; color: #6c757d;">(Admin Only)</span></div>
              <input type="number" id="hourly-rate" class="service-input" value="100" min="0" readonly disabled style="background: #fff; border: 1px solid #ced4da; color: #495057; border-radius: 4px; padding: 4px 8px; width: 100px; min-width: 100px; font-size: 0.9rem;">
            </div>
            
            <div class="service-row" style="background: #f8f9fa; padding: 8px; border-radius: 6px; margin-bottom: 8px; border: 1px solid #e9ecef;">
              <div class="service-label" style="color: #495057; font-size: 0.85rem;">Completed classes</div>
              <div class="service-value" id="completed-classes" style="color: #333; font-weight: 600; font-size: 0.95rem;">Loading...</div>
            </div>
            
            <!-- Helpful message when no completed classes -->
            <div id="no-classes-message" style="display: none; background: #e3f2fd; padding: 8px; border-radius: 6px; margin-bottom: 8px; border: 1px solid #bbdefb;">
              <div style="color: #1976d2; font-weight: 600; margin-bottom: 4px; font-size: 0.85rem;">üìö No completed classes this week</div>
              <div style="color: #424242; font-size: 0.75rem;">
                Teaching fees are calculated based on completed classes (15-25 minutes duration) within the current week.<br>
                ‚Ä¢ Check your <a href="teacher-class-table.html" style="color: #1976d2; text-decoration: underline;">Class Schedule</a> for upcoming classes<br>
                ‚Ä¢ Classes must be marked as "completed" to count for payment<br>
                ‚Ä¢ Only classes from Monday to Sunday are included
              </div>
            </div>
            
            <div class="service-row" style="background: #e3f2fd; padding: 8px; border-radius: 6px; margin-bottom: 8px; border: 2px solid #bbdefb;">
              <div class="service-label" style="color: #1976d2; font-weight: 600; font-size: 0.85rem;">Weekly fee (Rate √ó Completed class)</div>
              <div class="service-sum" id="base-sum" style="color: #1976d2; font-size: 1.1rem; font-weight: 700;">‚Ç±0.00</div>
            </div>
            
            <div class="service-row" style="background: #f8f9fa; padding: 8px; border-radius: 6px; margin-bottom: 8px; border: 1px solid #e9ecef;">
              <div class="service-label" style="color: #495057; font-size: 0.85rem;">Student absent classes (50% of rate)</div>
              <div class="service-value" id="student-absent-classes" style="color: #333; font-weight: 600; font-size: 0.9rem;">0</div>
            </div>
            
            <div class="service-row" style="background: #fff3e0; padding: 8px; border-radius: 6px; border: 2px solid #ffcc02;">
              <div class="service-label" style="color: #f57c00; font-weight: 600; font-size: 0.85rem;">Student absent fee (50% Rate √ó Student absent class)</div>
              <div class="service-sum" id="student-absent-sum" style="color: #f57c00; font-size: 1rem; font-weight: 700;">‚Ç±0.00</div>
            </div>
          </div>

          <!-- Deductions Card -->
          <div class="service-section" style="background: #fff; border: 1px solid #e0e6ed; border-radius: 8px; padding: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.05);">
            <div class="service-section-title" style="color: #333; font-size: 1rem; margin-bottom: 10px; display: flex; align-items: center; gap: 6px;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="color: #ff6b6b;">
                <path d="M19 13H5v-2h14v2z"/>
              </svg>
              Deductions
            </div>
            
            <div class="service-row" style="background: #f8f9fa; padding: 8px; border-radius: 6px; margin-bottom: 8px; border: 1px solid #e9ecef;">
              <div class="service-label" style="color: #495057; font-size: 0.85rem;">Late arrivals (-‚Ç±2 per minute)</div>
              <input type="number" id="late-deductions" class="service-input" value="0.00" step="0.01" min="0" readonly disabled style="background: #fff; border: 1px solid #ced4da; color: #495057; border-radius: 4px; padding: 4px 8px; width: 100px; font-size: 0.9rem;" title="Late arrival deductions are calculated automatically based on teacher entry time">
            </div>
            
            <div class="service-row" style="background: #f8f9fa; padding: 8px; border-radius: 6px; margin-bottom: 8px; border: 1px solid #e9ecef;">
              <div class="service-label" style="color: #495057; font-size: 0.85rem;">Teacher absent classes (No. of Teacher Absences √ó rate)</div>
              <input type="number" id="absent-deductions" class="service-input" value="0.00" step="0.01" min="0" readonly disabled style="background: #fff; border: 1px solid #ced4da; color: #495057; border-radius: 4px; padding: 4px 8px; width: 100px; font-size: 0.9rem;" title="Teacher absent deductions are calculated automatically based on class duration requirements">
            </div>
            
            <div class="service-row" style="background: #f8f9fa; padding: 8px; border-radius: 6px; margin-bottom: 8px; border: 1px solid #e9ecef;">
              <div class="service-label" style="color: #495057; font-size: 0.85rem;">
                Cancelled classes 
                <div style="font-size: 0.7rem; color: #6c757d; margin-top: 2px;">
                  >72h: 0% | 24-72h: 100% | <24h: 200%
                </div>
              </div>
              <input type="number" id="cancelled-deductions" class="service-input" value="0.00" step="0.01" min="0" readonly disabled style="background: #fff; border: 1px solid #ced4da; color: #495057; border-radius: 4px; padding: 4px 8px; width: 100px; font-size: 0.9rem;" title="Cancellation deductions are calculated automatically based on timing">
            </div>
            
            <div class="service-row" style="background: #ffebee; padding: 8px; border-radius: 6px; border: 2px solid #ffcdd2; font-weight: 600;">
              <div class="service-label" style="color: #d32f2f; font-size: 0.9rem;">Total Deductions:</div>
              <div class="service-sum" id="total-deductions" style="color: #d32f2f; font-size: 1.1rem; font-weight: 700;">‚Ç±0.00</div>
            </div>
          </div>

          <!-- Resolved Issue Payments Card -->
          <div class="service-section" style="background: #fff; border: 1px solid #e0e6ed; border-radius: 8px; padding: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.05);">
            <div class="service-section-title" style="color: #333; font-size: 1rem; margin-bottom: 10px; display: flex; align-items: center; gap: 6px;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="color: #9c27b0;">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
              </svg>
              Resolved Issue Payments
            </div>
            
            <div class="service-row" style="background: #f8f9fa; padding: 8px; border-radius: 6px; margin-bottom: 8px; border: 1px solid #e9ecef;">
              <div class="service-label" style="color: #495057; font-size: 0.85rem;">System issue classes (10% of rate)</div>
              <div class="service-value" id="system-issue-classes" style="color: #333; font-weight: 600; font-size: 0.9rem;">0</div>
            </div>
            
            <div class="service-row" style="background: #f3e5f5; padding: 8px; border-radius: 6px; margin-bottom: 8px; border: 2px solid #ce93d8;">
              <div class="service-label" style="color: #7b1fa2; font-weight: 600; font-size: 0.85rem;">System issue payment (10% Rate √ó System issue class)</div>
              <div class="service-sum" id="system-issue-sum" style="color: #7b1fa2; font-size: 1rem; font-weight: 700;">‚Ç±0.00</div>
            </div>
            
            <div class="service-row" style="background: #f8f9fa; padding: 8px; border-radius: 6px; margin-bottom: 8px; border: 1px solid #e9ecef;">
              <div class="service-label" style="color: #495057; font-size: 0.85rem;">Student issue classes (50% of rate)</div>
              <div class="service-value" id="student-issue-classes" style="color: #333; font-weight: 600; font-size: 0.9rem;">0</div>
            </div>
            
            <div class="service-row" style="background: #e8f5e8; padding: 8px; border-radius: 6px; border: 2px solid #a5d6a7;">
              <div class="service-label" style="color: #2e7d32; font-weight: 600; font-size: 0.85rem;">Student issue payment (50% Rate √ó Student issue class)</div>
              <div class="service-sum" id="student-issue-sum" style="color: #2e7d32; font-size: 1rem; font-weight: 700;">‚Ç±0.00</div>
            </div>
            
            <div class="service-row" style="background: #fff3e0; padding: 8px; border-radius: 6px; border: 2px solid #ffcc02; margin-top: 8px;">
              <div class="service-label" style="color: #f57c00; font-weight: 600; font-size: 0.85rem;">Total Issue Payments</div>
              <div class="service-sum" id="total-issue-sum" style="color: #f57c00; font-size: 1.1rem; font-weight: 700;">‚Ç±0.00</div>
            </div>
          </div>

          <!-- Net Payable Card -->
          <div class="service-section" style="background: #fff; border: 1px solid #e0e6ed; border-radius: 8px; padding: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.05);">
            <div class="service-section-title" style="color: #333; font-size: 1rem; margin-bottom: 10px; display: flex; align-items: center; gap: 6px;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="color: #27ae60;">
                <path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/>
              </svg>
              Payment Summary
            </div>
            
            <div class="service-summary" style="background: #e8f5e8; padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 2px solid #c8e6c9; text-align: center;">
              <div class="label" style="color: #2e7d32; font-size: 0.85rem; margin-bottom: 6px;">Net Payable Amount:</div>
              <div class="value" id="net-amount" style="color: #2e7d32; font-size: 1.5rem; font-weight: 700;">‚Ç±0.00</div>
            </div>
            
            <div class="service-remark" style="background: #f8f9fa; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #e9ecef;">
              <div class="label" style="color: #495057; font-size: 0.8rem; margin-bottom: 4px;">Payment Status:</div>
              <div class="value" style="color: #27ae60; font-weight: 600; font-size: 0.95rem; background: #e8f5e8; padding: 4px 10px; border-radius: 4px; display: inline-block; border: 1px solid #c8e6c9;">Success</div>
            </div>
          </div>
          
        </div>
      
      <!-- Daily Breakdown Content -->
      <div id="daily-breakdown-content" class="service-main-col" style="display: none; width: 100%; max-width: 100%;">
        <div class="service-section">
          <div class="service-section-title">Daily Class Breakdown</div>
          
          <!-- Date Range Selector -->
          <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
              <div style="display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">
                <label style="font-weight: 600; color: #495057; font-size: 0.9rem;">Date Range:</label>
                <input type="date" id="daily-start-date" style="padding: 6px 10px; border: 1px solid #ced4da; border-radius: 4px; background: white; font-size: 0.9rem;">
                <span style="color: #666;">~</span>
                <input type="date" id="daily-end-date" style="padding: 6px 10px; border: 1px solid #ced4da; border-radius: 4px; background: white; font-size: 0.9rem;">
              </div>
              <button onclick="loadDailyBreakdown()" style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.9rem;">Search</button>
            </div>
          </div>
          
          <!-- Daily Breakdown Table -->
          <div id="daily-breakdown-table" style="display: none;">
            <table class="week-history-table">
              <thead>
                <tr>
                  <th style="text-align: left;">Date</th>
                  <th style="text-align: center;">Total Classes</th>
                  <th style="text-align: center;">Completed Classes</th>
                </tr>
              </thead>
              <tbody id="daily-breakdown-tbody">
                <!-- Daily breakdown rows will be populated here -->
              </tbody>
            </table>
          </div>
          
          <!-- Loading/No Data Message -->
          <div id="daily-breakdown-message" style="text-align: center; color: #666; padding: 20px;">
            Select a date range and click Search to view daily breakdown
          </div>
        </div>
      </div>
      
      <!-- Weekly Payment History Content -->
      <div id="weekly-payment-history-content" class="service-main-col" style="display: none; width: 100%; max-width: 100%;">
        <div class="service-section">
          <div class="service-section-title">Payment History</div>
          
          <!-- Filter Controls -->
          <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
              <div style="display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">
                <label for="history-filter-type" style="font-weight: 600; color: #495057; font-size: 0.9rem;">Filter by:</label>
                <select id="history-filter-type" style="padding: 6px 10px; border: 1px solid #ced4da; border-radius: 4px; background: white; min-width: 150px; font-size: 0.9rem;">
                  <option value="all">All Records</option>
                  <option value="weekly">Weekly</option>
                  <option value="monthly">Monthly</option>
                  <option value="this-year">This Year</option>
                  <option value="last-year">Last Year</option>
                  <option value="paid">Paid Only</option>
                  <option value="pending">Pending Only</option>
                </select>
              </div>
              
              <!-- Week Selection (shown when weekly filter is selected) -->
              <div id="week-selection-controls" style="display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">
                <label for="week-select" style="font-weight: 600; color: #495057; font-size: 0.9rem;">Select Week:</label>
                <select id="week-select" style="padding: 6px 10px; border: 1px solid #ced4da; border-radius: 4px; background: white; min-width: 180px; font-size: 0.9rem;">
                  <option value="">Loading weeks...</option>
                </select>
              </div>
              
              <button id="refresh-week-data" style="padding: 6px 12px; background: #1ca7e7; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.9rem;">Refresh Data</button>
            </div>
              </div>
              
          <!-- Payment Statistics Summary -->
          <div id="payment-statistics" style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef; display: none;">
            <h4 style="margin: 0 0 12px 0; color: #495057; font-size: 15px;">Payment Statistics</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
              <div style="background: white; padding: 10px; border-radius: 6px; border: 1px solid #dee2e6; text-align: center;">
                <div style="font-size: 20px; font-weight: bold; color: #28a745;" id="total-paid">‚Ç±0.00</div>
                <div style="font-size: 11px; color: #6c757d;">Total Paid</div>
              </div>
              <div style="background: white; padding: 10px; border-radius: 6px; border: 1px solid #dee2e6; text-align: center;">
                <div style="font-size: 20px; font-weight: bold; color: #ffc107;" id="total-pending">‚Ç±0.00</div>
                <div style="font-size: 11px; color: #6c757d;">Total Pending</div>
              </div>
              <div style="background: white; padding: 10px; border-radius: 6px; border: 1px solid #dee2e6; text-align: center;">
                <div style="font-size: 20px; font-weight: bold; color: #1ca7e7;" id="total-records">0</div>
                <div style="font-size: 11px; color: #6c757d;">Total Records</div>
              </div>
              <div style="background: white; padding: 10px; border-radius: 6px; border: 1px solid #dee2e6; text-align: center;">
                <div style="font-size: 20px; font-weight: bold; color: #6c757d;" id="avg-amount">‚Ç±0.00</div>
                <div style="font-size: 11px; color: #6c757d;">Average Amount</div>
              </div>
            </div>
          </div>
          
          <!-- Payment History Table -->
          <div id="payment-history-table" style="display: none;">
            <table class="week-history-table">
              <thead>
                <tr>
                  <th>Period</th>
                  <th>Issue Date</th>
                  <th>Amount</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="payment-history-tbody">
                <!-- Payment history rows will be populated here -->
              </tbody>
            </table>
          </div>
          
          <!-- Payment Details Display (for weekly view) -->
          <div id="payment-details-container">
            <div style="text-align: center; color: #666; padding: 20px;">
              Select a filter to view payment history
            </div>
          </div>
        </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    // Set sidebar avatar and email (declare identifiers now; DOM ops deferred)
    const username = localStorage.getItem('remoedUsername') || 'User';
    const teacherId = localStorage.getItem('teacherId');

    // Defer DOM writes until DOM is ready and guard element access.
    document.addEventListener('DOMContentLoaded', function () {
      const avatarTextEl = document.getElementById('avatar-text');
      if (avatarTextEl) avatarTextEl.textContent = username[0].toUpperCase();

      const sidebarEmailEl = document.getElementById('sidebar-email');
      if (sidebarEmailEl) sidebarEmailEl.textContent = 'Loading...';

      const accountEmailEl = document.getElementById('account-email');
      if (accountEmailEl) accountEmailEl.textContent = username;

      // Load profile picture if available
      if (teacherId && typeof loadProfilePicture === 'function') {
        try { loadProfilePicture(teacherId); } catch (e) { /* ignore */ }
      }

      // Logout functionality
      const logoutNav = document.getElementById('logout-nav');
      if (logoutNav) {
        logoutNav.onclick = function() { localStorage.clear(); window.location.href = 'teacher-login.html'; };
      }
    });

    // Global variables for week management
    let currentWeekData = null;
    let previousWeekData = null;
    let weekHistoryData = [];
    
    // Load teacher's completed classes and calculate fee
    async function loadTeacherFeeData(weekType = 'current') {
      if (!teacherId) {
        console.log('No teacher ID found');
        return;
      }

      try {
        let startDate, endDate, weekLabel;
        
        // Helper function to get Monday of a given week (Global format)
        function getMondayOfWeek(date) {
          const dayOfWeek = date.getDay(); // 0 = Sunday, 1 = Monday, etc.
          const monday = new Date(date);
          monday.setDate(date.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1)); // Monday
          return monday;
        }
        
        if (weekType === 'current') {
          // Get current week (Monday to Sunday) - Global format
          const now = new Date();
          const monday = getMondayOfWeek(now);
          const sunday = new Date(monday);
          sunday.setDate(monday.getDate() + 6); // Sunday (7-day week)
          
          startDate = monday.toISOString().split('T')[0];
          endDate = sunday.toISOString().split('T')[0];
          weekLabel = `Week of ${monday.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
          
          console.log('üîç Current week calculation (Global format):', {
            now: now.toISOString().split('T')[0],
            monday: monday.toISOString().split('T')[0],
            sunday: sunday.toISOString().split('T')[0],
            startDate: startDate,
            endDate: endDate
          });
        } else if (weekType === 'previous') {
          // Get previous week (Monday to Sunday) - Global format
          const now = new Date();
          const currentMonday = getMondayOfWeek(now);
          const lastMonday = new Date(currentMonday);
          lastMonday.setDate(currentMonday.getDate() - 7); // Previous Monday (7 days before current Monday)
          const lastSunday = new Date(lastMonday);
          lastSunday.setDate(lastMonday.getDate() + 6); // Previous Sunday (7-day week)
          
          startDate = lastMonday.toISOString().split('T')[0];
          endDate = lastSunday.toISOString().split('T')[0];
          weekLabel = `Week of ${lastMonday.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
          
          console.log('üîç Previous week calculation (Global format):', {
            now: now.toISOString().split('T')[0],
            currentMonday: currentMonday.toISOString().split('T')[0],
            lastMonday: lastMonday.toISOString().split('T')[0],
            lastSunday: lastSunday.toISOString().split('T')[0],
            startDate: startDate,
            endDate: endDate
          });
        }
        
        // Update pay period display with dynamic dates
        const monday = new Date(startDate);
        const endDay = new Date(endDate);
        const periodText = `${monday.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${endDay.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
        document.getElementById('pay-period').textContent = periodText;
        
        // Fetch global rate from admin API
        const token = localStorage.getItem('token');
        const rateResponse = await fetch(`/api/admin/teacher-rate`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        let teacherRate = 0; // Start with 0, will be updated from API
        if (rateResponse.ok) {
          const rateData = await rateResponse.json();
          if (rateData.success) {
            teacherRate = rateData.rate;
            document.getElementById('hourly-rate').value = teacherRate;
            console.log('‚úÖ Teacher rate loaded from admin API:', teacherRate);
          } else {
            console.error('‚ùå Failed to get teacher rate from API:', rateData.message);
            throw new Error('Failed to load teacher rate from admin system');
          }
        } else {
          console.error('‚ùå Failed to fetch teacher rate from admin API:', rateResponse.status);
          throw new Error('Failed to connect to admin rate system');
        }
        
        // Fetch completed classes for the current month using new API
        console.log('üîç Fetching completed classes for date range:', startDate, 'to', endDate);
        const response = await fetch(`/api/teacher/completed-classes?startDate=${startDate}&endDate=${endDate}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
          const completedClasses = data.completedClasses || 0;
          const teacherAbsentClasses = data.teacherAbsentClasses || 0;
          const studentAbsentClasses = data.studentAbsentClasses || 0;
          document.getElementById('completed-classes').textContent = completedClasses;
          
          // Show/hide helpful message based on completed classes
          const noClassesMessage = document.getElementById('no-classes-message');
          if (completedClasses === 0) {
            noClassesMessage.style.display = 'block';
          } else {
            noClassesMessage.style.display = 'none';
          }
          
          console.log(`‚úÖ API Response - Completed: ${completedClasses}, Teacher Absent: ${teacherAbsentClasses}, Student Absent: ${studentAbsentClasses}`);
          console.log(`üìÖ Date range: ${startDate} to ${endDate}`);
          console.log(`üí∞ Teacher rate: ${teacherRate}`);
          
          // Debug: Log detailed API response if available
          if (data.debug) {
            console.log('üîç DEBUG API Response:', data.debug);
            console.log('üìä Status breakdown:', data.debug.statusBreakdown);
            console.log('üìã All classes:', data.debug.allClasses);
          }
          
          // Calculate fee with teacher absent classes for deductions
          calculateFee(completedClasses, teacherAbsentClasses, studentAbsentClasses, startDate, endDate);
          
          // Load resolved issue payments
          await loadResolvedIssuePayments(startDate, endDate);
          
          // Check payment status for this week
          await checkPaymentStatus(startDate, endDate);
          
          console.log(`‚úÖ Successfully loaded ${completedClasses} completed classes for period ${startDate} to ${endDate}`);
          
          // Show notification if completed classes > 0
          if (completedClasses > 0) {
            console.log(`üéâ Found ${completedClasses} completed classes for this week!`);
          } else {
            console.log(`‚ÑπÔ∏è No completed classes found for this week (${startDate} to ${endDate})`);
            console.log(`üí° This is why the teaching fee shows ‚Ç±0.00`);
            console.log(`üí° To see teaching fees, you need classes with status 'completed' and duration 15-25 minutes`);
          }
        } else {
          console.error('‚ùå Error loading completed classes:', data.error);
          document.getElementById('completed-classes').textContent = '0';
          calculateFee(0);
        }
      } catch (error) {
        console.error('Error loading teacher fee data:', error);
        document.getElementById('completed-classes').textContent = '0';
        document.getElementById('hourly-rate').value = '0';
        document.getElementById('base-sum').textContent = '0.00';
        document.getElementById('net-amount').textContent = '0.00';
        
        // Show error message to user
        const errorMessage = error.message || 'Failed to load teacher data';
        alert(`Error: ${errorMessage}. Please refresh the page or contact support.`);
      }
    }
    
    // Refresh completed classes count (called when class is finished)
    async function refreshCompletedClasses() {
      console.log('üîÑ Refreshing completed classes...');
      
      const activeTab = document.querySelector('.week-tab.active');
      if (activeTab) {
        const tabType = activeTab.id.replace('-week-tab', '');
        console.log(`üìã Active tab: ${tabType}`);
        
        if (tabType === 'weekly-payment-history') {
          console.log('üìä Refreshing weekly payment history...');
          await loadWeeklyPaymentHistory();
        } else {
          console.log(`üìà Refreshing teacher fee data for: ${tabType} week`);
          await loadTeacherFeeData(tabType);
        }
      } else {
        console.log('‚ö†Ô∏è No active tab found, refreshing current week data');
        await loadTeacherFeeData('current');
      }
      
      console.log('‚úÖ Refresh completed');
    }
    
    // Force immediate refresh for student absent classes
    async function forceRefreshForStudentAbsent() {
      console.log('üîÑ Force refreshing for student absent classes...');
      
      // Clear any cached data
      localStorage.removeItem('last_fee_refresh');
      
      // Force immediate refresh
      await refreshCompletedClasses();
      
      // Show notification
      console.log('‚úÖ Force refresh completed for student absent classes');
    }
    
    // Calculate service fee with deductions
    async function calculateFee(completedClasses = null, absentClasses = null, studentAbsentClasses = null, startDate = null, endDate = null) {
      const ratePer25Minutes = parseFloat(document.getElementById('hourly-rate').value);
      if (ratePer25Minutes <= 0) {
        console.error('‚ùå Invalid teacher rate:', ratePer25Minutes);
        alert('Teacher rate not properly loaded. Please refresh the page.');
        return;
      }
      
      const classesCount = completedClasses !== null ? completedClasses : parseFloat(document.getElementById('completed-classes').textContent) || 0;
      
      // Calculate deductions using the same date range
      const deductions = await calculateDeductions(absentClasses, startDate, endDate);
      
      // Use completed count from deductions calculation for consistency
      const actualCompletedClasses = deductions.completedCount || classesCount;
      
      // Use student absent count from API response if provided, otherwise from deductions calculation
      const actualStudentAbsentClasses = studentAbsentClasses !== null ? studentAbsentClasses : (deductions.studentAbsentCount || 0);
      
      // Calculate base amount based on 25-minute lessons (weekly only)
      // Each completed class counts as 1 lesson (25 minutes)
      const baseSum = ratePer25Minutes * actualCompletedClasses;
      
      // Calculate student absent payment: student absent count √ó 50% of rate
      const studentAbsentPayment = actualStudentAbsentClasses * (ratePer25Minutes * 0.5);
      
      // Update display
      document.getElementById('completed-classes').textContent = actualCompletedClasses;
      document.getElementById('base-sum').textContent = baseSum.toFixed(2);
      document.getElementById('student-absent-classes').textContent = actualStudentAbsentClasses;
      document.getElementById('student-absent-sum').textContent = studentAbsentPayment.toFixed(2);
      
      // Log the student absent calculation for debugging
      console.log(`üìä STUDENT ABSENT CALCULATION:`);
      console.log(`   Student absent classes: ${actualStudentAbsentClasses}`);
      console.log(`   Rate per class: ‚Ç±${ratePer25Minutes}`);
      console.log(`   50% of rate: ‚Ç±${(ratePer25Minutes * 0.5).toFixed(2)}`);
      console.log(`   Student absent payment: ${actualStudentAbsentClasses} √ó ‚Ç±${(ratePer25Minutes * 0.5).toFixed(2)} = ‚Ç±${studentAbsentPayment.toFixed(2)}`);
      document.getElementById('late-deductions').value = deductions.late.toFixed(2);
      document.getElementById('absent-deductions').value = deductions.absent.toFixed(2);
      document.getElementById('cancelled-deductions').value = deductions.cancelled.toFixed(2);
      
      // Calculate net amount
      calculateNetAmount();
    }
    
    // Calculate deductions for the specified week
    async function calculateDeductions(absentClasses = null, startDate = null, endDate = null) {
      try {
        const token = localStorage.getItem('token');
        const teacherId = localStorage.getItem('teacherId');
        
        // Use provided dates or fall back to current week (Global format)
        if (!startDate || !endDate) {
          const now = new Date();
          
          // Helper function to get Monday of a given week (Global format)
          function getMondayOfWeek(date) {
            const dayOfWeek = date.getDay(); // 0 = Sunday, 1 = Monday, etc.
            const monday = new Date(date);
            monday.setDate(date.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1)); // Monday
            return monday;
          }
          
          const monday = getMondayOfWeek(now);
          const sunday = new Date(monday);
          sunday.setDate(monday.getDate() + 6); // Sunday (7-day week)
          
          startDate = monday.toISOString().split('T')[0];
          endDate = sunday.toISOString().split('T')[0];
        }
        
        console.log('üîç Calculating deductions for date range:', startDate, 'to', endDate);
        
        // Fetch teacher's classes for the week using the authenticated endpoint
        const response = await fetch(`/api/teacher/classes?startDate=${startDate}&endDate=${endDate}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          console.error('Failed to fetch classes for deduction calculation');
          return { late: 0, absent: 0, cancelled: 0 };
        }
        
        const data = await response.json();
        console.log('üîç RAW API RESPONSE for classes:', data);
        
        // Log the specific class we're looking for
        const targetClass = data.classes?.find(cls => cls.date === '2025-08-21' && cls.time === '21:30');
        if (targetClass) {
          console.log('üéØ TARGET CLASS from API:', targetClass);
        } else {
          console.log('‚ùå Target class not found in API response');
        }
        
        const classes = data.classes || []; // Authenticated endpoint returns 'classes'
        
        let lateDeductions = 0;
        let absentDeductions = 0;
        let cancelledDeductions = 0;
        let studentAbsentCount = 0;
        const ratePer25Minutes = parseFloat(document.getElementById('hourly-rate').value);
        if (ratePer25Minutes <= 0) {
          console.error('‚ùå Invalid teacher rate for deduction calculation:', ratePer25Minutes);
          return { late: 0, absent: 0, cancelled: 0 };
        }
        
        // Count classes based on their status and absentMarkedAt field
        let absentCount = 0;
        let completedCount = 0;
        classes.forEach(classItem => {
          console.log(`üîç DEBUG: Class ${classItem.date} ${classItem.time} - Status: ${classItem.status}, absentMarkedAt: ${classItem.absentMarkedAt}`);
          
          // Check for student absent classes (marked by teacher with absentMarkedAt)
          if (classItem.absentMarkedAt) {
            studentAbsentCount++;
            console.log(`‚úÖ STUDENT ABSENT FOUND: Class ${classItem.date} ${classItem.time} - Teacher marked student absent, counting for 50% payment`);
            console.log(`   üìÖ Date: ${classItem.date}`);
            console.log(`   üïê Time: ${classItem.time}`);
            console.log(`   üìä Status: ${classItem.status}`);
            console.log(`   üïê Absent Marked At: ${classItem.absentMarkedAt}`);
          } else if (classItem.status === 'absent') {
            // Only count as teacher absent if the TEACHER was absent, not the student
            // Check if teacher entered the classroom
            const teacherEntered = classItem.attendance?.teacherEntered || false;
            const studentEntered = classItem.attendance?.studentEntered || false;
            
            console.log(`üîç DEBUG: Class ${classItem.date} ${classItem.time} - Status: ${classItem.status}`);
            console.log(`   Attendance data:`, classItem.attendance);
            console.log(`   Teacher Entered: ${teacherEntered}`);
            console.log(`   Student Entered: ${studentEntered}`);
            
            if (!teacherEntered) {
              // Teacher was absent - count for deduction
              absentCount++;
              console.log(`‚ùå TEACHER ABSENT DEDUCTION: Class ${classItem.date} ${classItem.time} - Teacher didn't enter, counting for ‚Ç±${ratePer25Minutes} deduction`);
              console.log(`   üìÖ Date: ${classItem.date}`);
              console.log(`   üïê Time: ${classItem.time}`);
              console.log(`   üìä Status: ${classItem.status}`);
              console.log(`   üë®‚Äçüè´ Teacher Entered: ${teacherEntered}`);
              console.log(`   üë®‚Äçüéì Student Entered: ${studentEntered}`);
            } else {
              // Student was absent but teacher was present - count for 50% payment
              studentAbsentCount++;
              console.log(`Student absent but teacher present for class ${classItem.date} ${classItem.time} - counting for 50% payment`);
            }
          } else if (classItem.status === 'completed') {
            // Completed classes should be counted as completed regardless of duration
            // The 15-minute rule is for student entry, not class duration
            completedCount++;
            console.log(`‚úÖ Completed class found for ${classItem.date} ${classItem.time} - counting as completed`);
          } else if (classItem.status === 'pending') {
            // Check if pending class should be marked as teacher absent or student absent
            const teacherEntered = classItem.attendance?.teacherEntered || false;
            const studentEntered = classItem.attendance?.studentEntered || false;
            
            // Check if class time has passed (more than 15 minutes past scheduled time)
            const classDateTime = new Date(`${classItem.date}T${classItem.time}:00`);
            const now = new Date();
            const timeDiffMinutes = (now - classDateTime) / (1000 * 60);
            
            if (timeDiffMinutes > 15 && !teacherEntered) {
              // Class is more than 15 minutes past scheduled time and teacher didn't enter
              // Mark as teacher absent
              absentCount++;
              console.log(`‚ùå TEACHER ABSENT DEDUCTION (PENDING): Class ${classItem.date} ${classItem.time} - Teacher didn't enter (${timeDiffMinutes.toFixed(1)} minutes past), counting for ‚Ç±${ratePer25Minutes} deduction`);
              console.log(`   üìÖ Date: ${classItem.date}`);
              console.log(`   üïê Time: ${classItem.time}`);
              console.log(`   üìä Status: ${classItem.status}`);
              console.log(`   üë®‚Äçüè´ Teacher Entered: ${teacherEntered}`);
              console.log(`   üë®‚Äçüéì Student Entered: ${studentEntered}`);
              console.log(`   ‚è∞ Minutes past: ${timeDiffMinutes.toFixed(1)}`);
            } else if (timeDiffMinutes > 15 && teacherEntered && !studentEntered) {
              // Class is more than 15 minutes past scheduled time, teacher entered but student didn't
              // This is student absent, not teacher absent (15-minute rule for student entry)
              studentAbsentCount++;
              console.log(`‚ö†Ô∏è Student absent for pending class ${classItem.date} ${classItem.time} - teacher entered but student didn't enter within 15 minutes (${timeDiffMinutes.toFixed(1)} minutes past) - counting for 50% payment`);
            } else {
              console.log(`‚è≥ Pending class ${classItem.date} ${classItem.time} - ${timeDiffMinutes.toFixed(1)} minutes past, teacher: ${teacherEntered}, student: ${studentEntered}`);
            }
          }
          
          // Late arrival deduction (-‚Ç±2 per minute)
          if (classItem.lateMinutes && classItem.lateMinutes > 0) {
            lateDeductions += classItem.lateMinutes * 2;
          }
          
          // Cancelled deduction calculation based on time difference
          if (classItem.status === 'cancelled' && classItem.cancellationTime && classItem.date && classItem.time) {
            const classDateTime = new Date(`${classItem.date}T${classItem.time}:00`);
            const cancellationTime = new Date(classItem.cancellationTime);
            const timeDifferenceHours = (classDateTime - cancellationTime) / (1000 * 60 * 60);
            
            console.log(`Cancelled class: ${classItem.date} ${classItem.time}, cancelled at: ${cancellationTime}, hours difference: ${timeDifferenceHours}`);
            
            if (timeDifferenceHours > 72) {
              // Cancel > 72 hours: zero deduction
              console.log(`Cancellation > 72 hours: no deduction`);
            } else if (timeDifferenceHours > 24) {
              // Within 72 hours: 100% rate deduction
              cancelledDeductions += ratePer25Minutes;
              console.log(`Cancellation within 72 hours: 100% deduction (${ratePer25Minutes})`);
            } else {
              // Within 24 hours: 200% rate deduction
            cancelledDeductions += ratePer25Minutes * 2;
              console.log(`Cancellation within 24 hours: 200% deduction (${ratePer25Minutes * 2})`);
            }
          }
        });
        
        // Calculate absent deductions: absent count √ó rate
        absentDeductions = absentCount * ratePer25Minutes;
        
        // Calculate student absent payments: student absent count √ó 50% of rate
        const studentAbsentPayment = studentAbsentCount * (ratePer25Minutes * 0.5);
        
        console.log(`üìä CALCULATION SUMMARY:`);
        console.log(`   Completed classes: ${completedCount}`);
        console.log(`   Teacher absent classes: ${absentCount} √ó ${ratePer25Minutes} = ${absentDeductions}`);
        console.log(`   Student absent classes: ${studentAbsentCount} √ó ${ratePer25Minutes * 0.5} = ${studentAbsentPayment}`);
        console.log(`   Late deductions: ${lateDeductions}`);
        console.log(`   Cancelled deductions: ${cancelledDeductions}`);
        console.log(`   Total deductions: ${lateDeductions + absentDeductions + cancelledDeductions}`);
        console.log(`   Student absent payment: ${studentAbsentPayment}`);
        
        return {
          late: lateDeductions,
          absent: absentDeductions,
          cancelled: cancelledDeductions,
          studentAbsent: studentAbsentPayment,
          studentAbsentCount: studentAbsentCount,
          completedCount: completedCount
        };
        
      } catch (error) {
        console.error('Error calculating deductions:', error);
        return { late: 0, absent: 0, cancelled: 0, studentAbsent: 0, studentAbsentCount: 0, completedCount: 0 };
      }
    }
    
    // Load resolved issue payments data
    async function loadResolvedIssuePayments(startDate, endDate) {
      try {
        const token = localStorage.getItem('token');
        const teacherId = localStorage.getItem('teacherId');
        
        if (!token || !teacherId) {
          console.log('No token or teacher ID found for resolved issue payments');
          return;
        }
        
        console.log('üîç Loading resolved issue payments for date range:', startDate, 'to', endDate);
        
        const response = await fetch(`/api/teacher/resolved-issue-payments?startDate=${startDate}&endDate=${endDate}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          console.error('Failed to fetch resolved issue payments:', response.status);
          return;
        }
        
        const data = await response.json();
        
        if (data.success) {
          const ratePer25Minutes = parseFloat(document.getElementById('hourly-rate').value) || 0;
          
          // Calculate payments
          const systemIssuePayment = data.systemIssueCount * (ratePer25Minutes * 0.1); // 10% of rate
          const studentIssuePayment = data.studentIssueCount * (ratePer25Minutes * 0.5); // 50% of rate
          const totalIssuePayment = systemIssuePayment + studentIssuePayment;
          
          // Update display
          document.getElementById('system-issue-classes').textContent = data.systemIssueCount;
          document.getElementById('system-issue-sum').textContent = systemIssuePayment.toFixed(2);
          document.getElementById('student-issue-classes').textContent = data.studentIssueCount;
          document.getElementById('student-issue-sum').textContent = studentIssuePayment.toFixed(2);
          document.getElementById('total-issue-sum').textContent = totalIssuePayment.toFixed(2);
          
          console.log(`üìä RESOLVED ISSUE PAYMENTS:`);
          console.log(`   System issue classes: ${data.systemIssueCount} √ó ‚Ç±${(ratePer25Minutes * 0.1).toFixed(2)} = ‚Ç±${systemIssuePayment.toFixed(2)}`);
          console.log(`   Student issue classes: ${data.studentIssueCount} √ó ‚Ç±${(ratePer25Minutes * 0.5).toFixed(2)} = ‚Ç±${studentIssuePayment.toFixed(2)}`);
          console.log(`   Total issue payments: ‚Ç±${totalIssuePayment.toFixed(2)}`);
          
          return totalIssuePayment;
        } else {
          console.error('Failed to load resolved issue payments:', data.error);
          return 0;
        }
      } catch (error) {
        console.error('Error loading resolved issue payments:', error);
        return 0;
      }
    }

    // Calculate net amount based on current deduction values
    function calculateNetAmount() {
      const baseSum = parseFloat(document.getElementById('base-sum').textContent) || 0;
      const studentAbsentPayment = parseFloat(document.getElementById('student-absent-sum').textContent) || 0;
      const systemIssuePayment = parseFloat(document.getElementById('system-issue-sum').textContent) || 0;
      const studentIssuePayment = parseFloat(document.getElementById('student-issue-sum').textContent) || 0;
      const totalIssuePayment = parseFloat(document.getElementById('total-issue-sum').textContent) || 0;
      const lateDeductions = parseFloat(document.getElementById('late-deductions').value) || 0;
      const absentDeductions = parseFloat(document.getElementById('absent-deductions').value) || 0;
      const cancelledDeductions = parseFloat(document.getElementById('cancelled-deductions').value) || 0;
      
      const totalDeductions = lateDeductions + absentDeductions + cancelledDeductions;
      const netAmount = baseSum + studentAbsentPayment + totalIssuePayment - totalDeductions;
      
      // Update display
      document.getElementById('total-deductions').textContent = totalDeductions.toFixed(2);
      const netAmountElement = document.getElementById('net-amount');
      netAmountElement.textContent = netAmount.toFixed(2);
      // Style negative amounts in red
      if (netAmount < 0) {
        netAmountElement.style.color = '#dc3545'; // Red for negative
      } else {
        netAmountElement.style.color = '#2e7d32'; // Green for positive
      }
        
      // Update summary stats
      document.getElementById('summary-completed-classes').textContent = document.getElementById('completed-classes').textContent;
      document.getElementById('summary-student-absent').textContent = document.getElementById('student-absent-classes').textContent;
      document.getElementById('summary-deductions').textContent = '‚Ç±' + totalDeductions.toFixed(2);
      const summaryNetAmountElement = document.getElementById('summary-net-amount');
      summaryNetAmountElement.textContent = '‚Ç±' + netAmount.toFixed(2);
      // Style negative amounts in red for summary
      if (netAmount < 0) {
        summaryNetAmountElement.style.color = '#dc3545'; // Red for negative
      } else {
        summaryNetAmountElement.style.color = '#333'; // Default color for positive
      }
      
      // Log the calculation for debugging
      console.log(`üí∞ NET AMOUNT CALCULATION:`);
      console.log(`   Base sum (completed classes): ‚Ç±${baseSum.toFixed(2)}`);
      console.log(`   Student absent payment (50%): ‚Ç±${studentAbsentPayment.toFixed(2)}`);
      console.log(`   System issue payment (10%): ‚Ç±${systemIssuePayment.toFixed(2)}`);
      console.log(`   Student issue payment (50%): ‚Ç±${studentIssuePayment.toFixed(2)}`);
      console.log(`   Total issue payments: ‚Ç±${totalIssuePayment.toFixed(2)}`);
      console.log(`   Total deductions: ‚Ç±${totalDeductions.toFixed(2)}`);
      console.log(`   Net amount: ‚Ç±${netAmount.toFixed(2)}`);
    }
    
    // Note: Rate and completed lessons inputs are disabled for teachers
    // Only admins can modify these values
    // Event listeners removed since inputs are now readonly
    
    // Tab switching functionality
    function switchWeekTab(tabType) {
      try {
        console.log('üîÑ Switching to tab:', tabType);
        
      // Update tab buttons
        document.querySelectorAll('.week-tab').forEach(tab => {
          tab.classList.remove('active');
          tab.style.background = '#f8f9fa';
          tab.style.border = '2px solid #e9ecef';
          tab.style.color = '#495057';
          tab.style.boxShadow = 'none';
          console.log('üìã Reset tab:', tab.id, 'to default background');
        });
        
        // Handle different tab ID formats
        let activeTab = document.getElementById(tabType + '-tab');
        if (!activeTab) {
          // Handle special cases for tabs with different ID formats
          if (tabType === 'previous') {
            activeTab = document.getElementById('previous-week-tab');
          } else if (tabType === 'current') {
            activeTab = document.getElementById('current-week-tab');
          }
        }
        
        if (activeTab) {
          activeTab.classList.add('active');
          activeTab.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
          activeTab.style.border = 'none';
          activeTab.style.color = '#fff';
          activeTab.style.boxShadow = '0 4px 15px rgba(102, 126, 234, 0.3)';
          console.log('‚úÖ Set active tab:', activeTab.id, 'to gradient background');
        } else {
          console.error('‚ùå Active tab not found:', tabType + '-tab');
        }
      
      // Show/hide content
      const mainContent = document.querySelector('.service-main-col');
        const paymentHistoryContent = document.getElementById('weekly-payment-history-content');
        const dailyBreakdownContent = document.getElementById('daily-breakdown-content');
        
        if (!mainContent || !paymentHistoryContent || !dailyBreakdownContent) {
          console.error('Required content elements not found:', {
            mainContent: !!mainContent,
            paymentHistoryContent: !!paymentHistoryContent,
            dailyBreakdownContent: !!dailyBreakdownContent
          });
          return;
        }
        
        if (tabType === 'weekly-payment-history') {
        mainContent.style.display = 'none';
          paymentHistoryContent.style.display = 'block';
          dailyBreakdownContent.style.display = 'none';
          loadWeeklyPaymentHistory();
        } else if (tabType === 'daily-breakdown') {
          mainContent.style.display = 'none';
          paymentHistoryContent.style.display = 'none';
          dailyBreakdownContent.style.display = 'block';
          initializeDailyBreakdown();
      } else {
        mainContent.style.display = 'block';
          paymentHistoryContent.style.display = 'none';
          dailyBreakdownContent.style.display = 'none';
        loadTeacherFeeData(tabType);
        }
      } catch (error) {
        console.error('Error switching week tab:', error);
      }
    }
    
    // Load weekly payment history with filter functionality
    async function loadWeeklyPaymentHistory() {
      try {
        const token = localStorage.getItem('token');
        const filterType = document.getElementById('history-filter-type');
        const weekSelect = document.getElementById('week-select');
        const weekSelectionControls = document.getElementById('week-selection-controls');
        const paymentDetailsContainer = document.getElementById('payment-details-container');
        const paymentHistoryTable = document.getElementById('payment-history-table');
        
        // Check if all required elements exist
        if (!filterType || !weekSelect || !weekSelectionControls || !paymentDetailsContainer || !paymentHistoryTable) {
          console.error('Required elements not found for payment history:', {
            filterType: !!filterType,
            weekSelect: !!weekSelect,
            weekSelectionControls: !!weekSelectionControls,
            paymentDetailsContainer: !!paymentDetailsContainer,
            paymentHistoryTable: !!paymentHistoryTable
          });
          return;
        }
        
        // Generate weeks for dropdown (last 12 weeks)
        const weeks = generateWeeksForDropdown(12);
        weekSelect.innerHTML = '<option value="">Select a week...</option>' + 
          weeks.map(week => `<option value="${week.startDate},${week.endDate}">${week.label}</option>`).join('');
        
        // Set up filter type change listener
        filterType.addEventListener('change', async function() {
          const selectedFilter = this.value;
          
          // Show/hide week selection based on filter type
          if (selectedFilter === 'weekly') {
            weekSelectionControls.style.display = 'flex';
            paymentHistoryTable.style.display = 'none';
            paymentDetailsContainer.style.display = 'block';
            document.getElementById('payment-statistics').style.display = 'none';
          } else {
            weekSelectionControls.style.display = 'none';
            paymentHistoryTable.style.display = 'block';
            paymentDetailsContainer.style.display = 'none';
            document.getElementById('payment-statistics').style.display = 'block';
            await loadPaymentHistoryByFilter(selectedFilter);
          }
        });
        
        // Set up week selection change listener
        weekSelect.addEventListener('change', async function() {
          if (this.value) {
            const [startDate, endDate] = this.value.split(',');
            await loadPaymentDetailsForWeek(startDate, endDate);
          } else {
            paymentDetailsContainer.innerHTML = `
              <div style="text-align: center; color: #666; padding: 20px;">
                Select a week to view payment details
              </div>
            `;
          }
        });
        
        // Set up refresh button
        document.getElementById('refresh-week-data').addEventListener('click', async function() {
          const selectedFilter = filterType.value;
          if (selectedFilter === 'weekly' && weekSelect.value) {
            const [startDate, endDate] = weekSelect.value.split(',');
            await loadPaymentDetailsForWeek(startDate, endDate);
          } else {
            await loadPaymentHistoryByFilter(selectedFilter);
          }
        });
        
        // Initialize with "All Records" filter to show all payment history by default
        filterType.value = 'all';
        weekSelectionControls.style.display = 'none';
        paymentHistoryTable.style.display = 'block';
        paymentDetailsContainer.style.display = 'none';
        document.getElementById('payment-statistics').style.display = 'block';
        
        // Load all payment history immediately
        await loadPaymentHistoryByFilter('all');
        
      } catch (error) {
        console.error('Error loading weekly payment history:', error);
        document.getElementById('payment-details-container').innerHTML = `
          <div style="text-align: center; color: #dc3545; padding: 20px;">
            Error loading payment history. Please try again.
          </div>
        `;
      }
    }
    
    // Generate weeks for dropdown
    function generateWeeksForDropdown(numWeeks) {
      const weeks = [];
          const now = new Date();
      
      for (let i = 0; i < numWeeks; i++) {
        const weekStart = new Date(now);
        weekStart.setDate(now.getDate() - (now.getDay() + 7 * i) + 1); // Monday of each week
        weekStart.setHours(0, 0, 0, 0);
        
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 4); // Friday (5-day week like admin)
        weekEnd.setHours(23, 59, 59, 999);
        
        const startDateStr = weekStart.toISOString().split('T')[0];
        const endDateStr = weekEnd.toISOString().split('T')[0];
        
        weeks.push({
          label: `${weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`,
          startDate: startDateStr,
          endDate: endDateStr
        });
      }
      
      return weeks.reverse(); // Most recent first
    }
    
    // Load payment history by filter type
    async function loadPaymentHistoryByFilter(filterType) {
      try {
        const token = localStorage.getItem('token');
        const teacherId = localStorage.getItem('teacherId');
        
        console.log('üîç Debug - Token exists:', !!token);
        console.log('üîç Debug - Teacher ID:', teacherId);
        
        if (!token) {
          console.log('üîç Debug - No token found, redirecting to login');
          alert('Please log in again to view payment history.');
          window.location.href = 'teacher-login.html';
          return;
        }
        
        const paymentHistoryTable = document.getElementById('payment-history-table');
        const tbody = document.getElementById('payment-history-tbody');
        
        // Show loading state
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666; padding: 20px;">Loading payment history...</td></tr>';
        
        // Fetch payment history based on filter type
        let url = '/api/teacher/payment-history';
        const params = new URLSearchParams();
        
        if (filterType === 'monthly') {
          // Get current month
          const now = new Date();
          const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
          const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
          params.append('startDate', startOfMonth.toISOString().split('T')[0]);
          params.append('endDate', endOfMonth.toISOString().split('T')[0]);
        } else if (filterType === 'this-year') {
          // Get current year
          const now = new Date();
          const startOfYear = new Date(now.getFullYear(), 0, 1);
          const endOfYear = new Date(now.getFullYear(), 11, 31);
          params.append('startDate', startOfYear.toISOString().split('T')[0]);
          params.append('endDate', endOfYear.toISOString().split('T')[0]);
        } else if (filterType === 'last-year') {
          // Get last year
          const now = new Date();
          const startOfLastYear = new Date(now.getFullYear() - 1, 0, 1);
          const endOfLastYear = new Date(now.getFullYear() - 1, 11, 31);
          params.append('startDate', startOfLastYear.toISOString().split('T')[0]);
          params.append('endDate', endOfLastYear.toISOString().split('T')[0]);
        }
        // For 'all', 'paid', 'pending' records, no date parameters needed
        
        if (params.toString()) {
          url += '?' + params.toString();
        }
        
        console.log('üîç Debug - Making request to:', url);
        console.log('üîç Debug - Authorization header:', `Bearer ${token.substring(0, 20)}...`);
        
        const response = await fetch(url, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        console.log('üîç Debug - Response status:', response.status);
        console.log('üîç Debug - Response status text:', response.statusText);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.log('üîç Debug - Error response body:', errorText);
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
          let payments = data.payments || [];
          
          // Apply additional filters for paid/pending
          if (filterType === 'paid') {
            payments = payments.filter(payment => 
              payment.status === 'Success' || payment.status === 'paid' || payment.status === 'Paid'
            );
          } else if (filterType === 'pending') {
            payments = payments.filter(payment => 
              payment.status === 'Pending' || payment.status === 'pending' || payment.status === 'Processing'
            );
          }
          
          displayPaymentHistoryTable(payments);
          } else {
          throw new Error(data.error || 'Failed to load payment history');
        }
        
      } catch (error) {
        console.error('Error loading payment history by filter:', error);
        const tbody = document.getElementById('payment-history-tbody');
        tbody.innerHTML = `
          <tr>
            <td colspan="4" style="text-align: center; color: #dc3545; padding: 20px;">
              Error loading payment history: ${error.message}
            </td>
            </tr>
          `;
      }
    }
    
    // Display payment history in table format
    function displayPaymentHistoryTable(payments) {
      const tbody = document.getElementById('payment-history-tbody');
      
      if (payments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #888; padding: 20px;">No payment records found for the selected period.</td></tr>';
        return;
      }
      
      // Sort payments by issue date (newest first)
      payments.sort((a, b) => {
        const dateA = a.issueDate ? new Date(a.issueDate) : new Date(0);
        const dateB = b.issueDate ? new Date(b.issueDate) : new Date(0);
        return dateB - dateA;
      });
      
      // Calculate statistics
      const totalAmount = payments.reduce((sum, payment) => sum + (payment.amount || 0), 0);
      const paidPayments = payments.filter(p => {
        const status = (p.status || '').toLowerCase();
        return status === 'success' || status === 'paid';
      });
      const pendingPayments = payments.filter(p => {
        const status = (p.status || '').toLowerCase();
        return status === 'pending' || status === 'processing';
      });
      const totalPaid = paidPayments.reduce((sum, payment) => sum + (payment.amount || 0), 0);
      const totalPending = pendingPayments.reduce((sum, payment) => sum + (payment.amount || 0), 0);
      const avgAmount = payments.length > 0 ? totalAmount / payments.length : 0;
      
      // Update statistics display
      document.getElementById('total-paid').textContent = `‚Ç±${totalPaid.toFixed(2)}`;
      document.getElementById('total-pending').textContent = `‚Ç±${totalPending.toFixed(2)}`;
      document.getElementById('total-records').textContent = payments.length;
      document.getElementById('avg-amount').textContent = `‚Ç±${avgAmount.toFixed(2)}`;
      
      tbody.innerHTML = `
        <tr style="background: #f8f9fa; font-weight: bold;">
          <td colspan="3" style="text-align: right; color: #1ca7e7;">Total Records: ${payments.length}</td>
          <td style="color: #28a745; font-weight: bold;">‚Ç±${totalAmount.toFixed(2)}</td>
        </tr>
        ${payments.map(payment => `
          <tr>
            <td style="font-weight: 500;">${payment.period || payment.duration || 'N/A'}</td>
            <td>${payment.issueDate ? new Date(payment.issueDate).toLocaleDateString('en-US', { 
              month: 'short', 
              day: 'numeric', 
              year: 'numeric' 
            }) : 'N/A'}</td>
            <td style="font-weight: 600; color: #1ca7e7;">‚Ç±${(payment.amount || 0).toFixed(2)}</td>
            <td>
              <span style="color: ${getStatusColor(payment.status)}; font-weight: 600; padding: 4px 8px; border-radius: 4px; background: ${getStatusBackground(payment.status)};">
                ${formatStatus(payment.status)}
              </span>
            </td>
          </tr>
        `).join('')}
      `;
    }
    
    // Helper function to get status color
    function getStatusColor(status) {
      const statusLower = (status || '').toLowerCase();
      if (statusLower === 'success' || statusLower === 'paid') return '#28a745';
      if (statusLower === 'pending' || statusLower === 'processing') return '#ffc107';
      if (statusLower === 'failed' || statusLower === 'cancelled') return '#dc3545';
      return '#6c757d';
    }
    
    // Helper function to get status background
    function getStatusBackground(status) {
      const statusLower = (status || '').toLowerCase();
      if (statusLower === 'success' || statusLower === 'paid') return '#d4edda';
      if (statusLower === 'pending' || statusLower === 'processing') return '#fff3cd';
      if (statusLower === 'failed' || statusLower === 'cancelled') return '#f8d7da';
      return '#f8f9fa';
    }
    
    // Helper function to format status
    function formatStatus(status) {
      const statusLower = (status || '').toLowerCase();
      if (statusLower === 'success' || statusLower === 'paid') return '‚úÖ Paid';
      if (statusLower === 'pending' || statusLower === 'processing') return '‚è≥ Pending';
      if (statusLower === 'failed' || statusLower === 'cancelled') return '‚ùå Failed';
      return status || 'Unknown';
    }
    
    // Load payment details for a specific week
    async function loadPaymentDetailsForWeek(startDate, endDate) {
      const token = localStorage.getItem('token');
      const paymentDetailsContainer = document.getElementById('payment-details-container');
      
      paymentDetailsContainer.innerHTML = `
        <div style="text-align: center; color: #666; padding: 20px;">
          Loading payment details...
        </div>
      `;
      
      try {
        // Fetch weekly payment summary from API
        const response = await fetch(`/api/teacher/weekly-payment-summary?startDate=${startDate}&endDate=${endDate}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
          // Display payment details
          paymentDetailsContainer.innerHTML = `
            <div style="background: #f8f9fa; border-radius: 8px; padding: 20px; border: 1px solid #e9ecef;">
              <h4 style="margin-top: 0; color: #333; border-bottom: 2px solid #1ca7e7; padding-bottom: 10px;">
                Payment Summary for ${new Date(startDate).toLocaleDateString()} - ${new Date(endDate).toLocaleDateString()}
              </h4>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #dee2e6;">
                  <h5 style="margin-top: 0; color: #1ca7e7;">Weekly Fee</h5>
                  <p><strong>Amount:</strong> ‚Ç±${(data.weeklyFee || 0).toFixed(2)}</p>
                  <p><strong>Completed Classes:</strong> ${data.completedClasses || 0}</p>
                  <p><strong>Rate per Class:</strong> ‚Ç±${(data.ratePerClass || parseFloat(document.getElementById('hourly-rate').value) || 0).toFixed(2)}</p>
                </div>
                
                <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #dee2e6;">
                  <h5 style="margin-top: 0; color: #dc3545;">Deductions</h5>
                  <p><strong>Late Arrivals:</strong> ‚Ç±${(data.lateDeductions || 0).toFixed(2)}</p>
                  <p><strong>Cancelled Classes:</strong> ‚Ç±${(data.cancellationDeductions || 0).toFixed(2)}</p>
                  <p><strong>Absent Classes:</strong> ‚Ç±${(data.absentDeductions || 0).toFixed(2)}</p>
                </div>
              </div>
              
              <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #dee2e6; margin-top: 20px;">
                <h5 style="margin-top: 0; color: #28a745;">Payment Information</h5>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                  <div>
                    <p><strong>Salary Date Range:</strong> ${data.salaryDateRange || 'N/A'}</p>
                    <p><strong>Total Classes:</strong> ${data.totalClasses || 0}</p>
                    <p><strong>Cancelled Classes:</strong> ${data.cancelledClasses || 0}</p>
                    <p><strong>Absent Classes:</strong> ${data.absentClasses || 0}</p>
                  </div>
                  <div>
                    <p><strong>Net Amount:</strong> <span style="font-size: 1.2em; font-weight: bold; color: #28a745;">‚Ç±${(data.netAmount || 0).toFixed(2)}</span></p>
                    <p><strong>Status:</strong> 
                      <span style="font-weight: bold; color: ${data.status === 'success' ? '#28a745' : '#ffc107'};">
                        ${data.status === 'success' ? '‚úÖ Dispersed' : '‚è≥ Pending'}
                      </span>
                    </p>
                  </div>
                </div>
              </div>
            </div>
          `;
        } else {
          throw new Error(data.error || 'Failed to load payment details');
        }
        
      } catch (error) {
        console.error('Error loading payment details:', error);
        paymentDetailsContainer.innerHTML = `
          <div style="text-align: center; color: #dc3545; padding: 20px;">
            Error loading payment details: ${error.message}
          </div>
        `;
      }
    }
    

    
    // Check for newly finished classes and update count
    async function checkForNewlyFinishedClasses() {
      try {
        console.log('üîç Checking for newly finished classes...');
        
        // Get all finished class keys from localStorage
        const finishedClasses = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.startsWith('class_finished_')) {
            finishedClasses.push(key);
          }
        }
        
        console.log('üìã Found finished classes in localStorage:', finishedClasses);
        
        // Check for any recent class completion notifications
        const lastNotification = localStorage.getItem('class_completion_notification');
        const lastRefresh = localStorage.getItem('last_fee_refresh');
        const currentTime = Date.now();
        
        let shouldRefresh = false;
        let refreshReason = '';
        
        // Check if we have finished classes
        if (finishedClasses.length > 0) {
          shouldRefresh = true;
          refreshReason = 'Found finished classes in localStorage';
        }
        
        // Check if we have a recent notification (within 15 minutes)
        if (lastNotification) {
          const notificationTime = parseInt(lastNotification);
          if (currentTime - notificationTime < 900000) { // 15 minutes
            shouldRefresh = true;
            refreshReason = 'Recent class completion notification detected';
          }
        }
        
        // Check if we haven't refreshed in the last 5 minutes (force refresh)
        if (lastRefresh) {
          const lastRefreshTime = parseInt(lastRefresh);
          if (currentTime - lastRefreshTime > 300000) { // 5 minutes
            shouldRefresh = true;
            refreshReason = 'Periodic refresh (5 minutes)';
          }
        } else {
          // No last refresh recorded, refresh now
          shouldRefresh = true;
          refreshReason = 'First refresh';
        }
        
        if (shouldRefresh) {
          console.log(`üîÑ Refreshing completed classes: ${refreshReason}`);
            await refreshCompletedClasses();
          localStorage.setItem('last_fee_refresh', currentTime.toString());
        } else {
          console.log('‚è≠Ô∏è No refresh needed at this time');
        }
        
      } catch (error) {
        console.error('‚ùå Error checking for newly finished classes:', error);
      }
    }
    
    // Ensure teacher rate is properly loaded from admin system
    async function ensureTeacherRateLoaded() {
      if (!teacherId) {
        console.error('‚ùå No teacher ID found for rate loading');
        return false;
      }
      
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          console.error('‚ùå No authentication token found for rate loading');
          return false;
        }
        
        const response = await fetch(`/api/admin/teacher-rate`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          console.error('‚ùå Failed to fetch teacher rate from admin API:', response.status);
          return false;
        }
        
        const data = await response.json();
        if (!data.success || !data.rate || data.rate <= 0) {
          console.error('‚ùå Invalid teacher rate received from admin API:', data);
          return false;
        }
        
        const currentRate = parseFloat(document.getElementById('hourly-rate').value) || 0;
        if (currentRate !== data.rate) {
          console.log(`‚úÖ Loading teacher rate from admin system: ${data.rate}`);
          document.getElementById('hourly-rate').value = data.rate;
        }
        
        return true;
      } catch (error) {
        console.error('‚ùå Error ensuring teacher rate is loaded:', error);
        return false;
      }
    }
    
    // Check for rate updates from admin
    async function checkForRateUpdates() {
      if (!teacherId) return;
      
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`/api/admin/teacher-rate`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.rate > 0) {
            const currentRate = parseFloat(document.getElementById('hourly-rate').value) || 0;
            const newRate = data.rate;
            
            if (currentRate !== newRate) {
              console.log(`‚úÖ Rate updated from ${currentRate} to ${newRate}`);
              document.getElementById('hourly-rate').value = newRate;
              // Recalculate fee with new rate
              const completedClasses = parseFloat(document.getElementById('completed-classes').textContent) || 0;
              calculateFee(completedClasses);
            }
          } else {
            console.error('‚ùå Invalid rate received from admin API:', data);
          }
        } else {
          console.error('‚ùå Failed to fetch rate update from admin API:', response.status);
        }
      } catch (error) {
        console.error('Error checking for rate updates:', error);
      }
    }
    
    // Initialize payment count for tracking new payments
    async function initializePaymentCount() {
      if (!teacherId) return;
      
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`/api/teacher/profile`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.profile && data.profile.paymentHistory) {
            const currentPaymentCount = data.profile.paymentHistory.length;
            localStorage.setItem('lastPaymentCount', currentPaymentCount.toString());
            console.log(`Initialized payment count: ${currentPaymentCount}`);
          }
        }
      } catch (error) {
        console.error('Error initializing payment count:', error);
      }
    }
    
    // Check for new payment records
    async function checkForNewPayments() {
      if (!teacherId) return;
      
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`/api/teacher/profile`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.profile && data.profile.paymentHistory) {
            const currentPaymentCount = data.profile.paymentHistory.length;
            const lastKnownCount = parseInt(localStorage.getItem('lastPaymentCount') || '0');
            
            if (currentPaymentCount > lastKnownCount) {
              console.log(`New payment detected! Payment count: ${lastKnownCount} -> ${currentPaymentCount}`);
              localStorage.setItem('lastPaymentCount', currentPaymentCount.toString());
              
              // Refresh payment history if currently viewing it
              const activeTab = document.querySelector('.week-tab.active');
              if (activeTab) {
                const tabType = activeTab.id.replace('-week-tab', '');
                if (tabType === 'weekly-payment-history') {
                  loadWeeklyPaymentHistory();
                } else {
                  loadTeacherFeeData(tabType);
                }
              }
            }
          }
        }
      } catch (error) {
        console.error('Error checking for new payments:', error);
      }
    }
    
    // Debug function to show detailed cancellation deduction information
    async function debugCancellationDeductions() {
      try {
        const token = localStorage.getItem('token');
        const teacherId = localStorage.getItem('teacherId');
        
        // Get current week dates (Monday to Sunday)
        const now = new Date();
        const monday = new Date(now);
        monday.setDate(now.getDate() - now.getDay() + 1); // Monday
        const sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6); // Sunday (full week)
        
        const startDate = monday.toISOString().split('T')[0];
        const endDate = sunday.toISOString().split('T')[0];
        
        console.log('üîç Debugging cancellation deductions for week:', startDate, 'to', endDate);
        
        // Fetch teacher's classes for the week
        const response = await fetch(`/api/teacher/classes?startDate=${startDate}&endDate=${endDate}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          console.error('Failed to fetch classes for debug');
          return;
        }
        
        const data = await response.json();
        const classes = data.classes || [];
        
        console.log('üìä Total classes found:', classes.length);
        
        const cancelledClasses = classes.filter(c => c.status === 'cancelled');
        console.log('‚ùå Cancelled classes found:', cancelledClasses.length);
        
        const ratePer25Minutes = parseFloat(document.getElementById('hourly-rate').value);
        if (ratePer25Minutes <= 0) {
          console.error('‚ùå Invalid teacher rate for debug calculation:', ratePer25Minutes);
          alert('Teacher rate not properly loaded. Please refresh the page.');
          return;
        }
        
        cancelledClasses.forEach((classItem, index) => {
          console.log(`\nüîç Cancelled Class ${index + 1}:`);
          console.log(`   Date: ${classItem.date} ${classItem.time}`);
          console.log(`   Cancellation Time: ${classItem.cancellationTime}`);
          console.log(`   Reason: ${classItem.cancellationReason?.reason || 'No reason'}`);
          console.log(`   Rejected: ${classItem.cancellationReason?.rejected || false}`);
          
          if (classItem.cancellationTime && classItem.date && classItem.time) {
            const classDateTime = new Date(`${classItem.date}T${classItem.time}:00`);
            const cancellationTime = new Date(classItem.cancellationTime);
            const timeDifferenceHours = (classDateTime - cancellationTime) / (1000 * 60 * 60);
            
            console.log(`   Class DateTime: ${classDateTime}`);
            console.log(`   Cancellation DateTime: ${cancellationTime}`);
            console.log(`   Hours Difference: ${timeDifferenceHours.toFixed(2)}`);
            
            let deduction = 0;
            let deductionType = '';
            
            if (timeDifferenceHours > 72) {
              deductionType = 'No deduction (>72h)';
            } else if (timeDifferenceHours > 24) {
              deduction = ratePer25Minutes;
              deductionType = '100% deduction (24-72h)';
            } else {
              deduction = ratePer25Minutes * 2;
              deductionType = '200% deduction (<24h)';
            }
            
            console.log(`   Deduction: ‚Ç±${deduction.toFixed(2)} (${deductionType})`);
          } else {
            console.log(`   ‚ö†Ô∏è Missing cancellation time data`);
          }
        });
        
        // Show alert with summary
        const totalDeduction = cancelledClasses.reduce((total, classItem) => {
          if (classItem.cancellationTime && classItem.date && classItem.time) {
            const classDateTime = new Date(`${classItem.date}T${classItem.time}:00`);
            const cancellationTime = new Date(classItem.cancellationTime);
            const timeDifferenceHours = (classDateTime - cancellationTime) / (1000 * 60 * 60);
            
            if (timeDifferenceHours > 72) {
              return total;
            } else if (timeDifferenceHours > 24) {
              return total + ratePer25Minutes;
            } else {
              return total + (ratePer25Minutes * 2);
            }
          }
          return total;
        }, 0);
        
        alert(`Cancellation Debug Summary:\n\nTotal cancelled classes: ${cancelledClasses.length}\nTotal deduction: ‚Ç±${totalDeduction.toFixed(2)}\n\nCheck console for detailed breakdown.`);
        
      } catch (error) {
        console.error('Error debugging cancellation deductions:', error);
        alert('Error debugging cancellation deductions. Check console for details.');
      }
    }
    
    // Check payment status for a specific week
    async function checkPaymentStatus(startDate, endDate) {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`/api/teacher/profile`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.profile && data.profile.paymentHistory) {
            // Check if there's a payment record for this week
            const weekPayment = data.profile.paymentHistory.find(payment => {
              return payment.duration === `${startDate} - ${endDate}` && payment.status === 'Success';
            });
            
            // Update payment status display
            const statusElement = document.querySelector('.service-remark .value');
            if (weekPayment) {
              statusElement.textContent = 'Success';
              statusElement.style.color = '#27ae60';
            } else {
              statusElement.textContent = 'Pending';
              statusElement.style.color = '#888';
            }
          }
        }
      } catch (error) {
        console.error('Error checking payment status:', error);
      }
    }
    
    // Load profile picture and update sidebar from backend
    async function loadProfilePicture(teacherId) {
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                console.log('No token found for profile picture');
                return;
            }
            
            const response = await fetch(`/api/teacher/profile`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                
                // Update sidebar with first name
                if (data.profile && data.profile.firstName) {
                    const usernameElement = document.getElementById('remoed-username');
                    if (usernameElement) {
                        usernameElement.textContent = `Hi, ${data.profile.firstName}`;
                        console.log('‚úÖ Sidebar updated with first name:', data.profile.firstName);
                    }
                } else {
                    // Fallback if no firstName
                    const username = localStorage.getItem('remoedUsername') || 'Teacher';
                    const usernameElement = document.getElementById('remoed-username');
                    if (usernameElement) {
                        usernameElement.textContent = `Hi, ${username}`;
                    }
                }
                
                if (data.profile && data.profile.profilePicture) {
                    // Show profile image and hide text
                    const profileImage = document.getElementById('profile-image');
                    const avatarText = document.getElementById('avatar-text');
                    
                    profileImage.src = data.profile.profilePicture;
                    profileImage.style.display = 'block';
                    avatarText.style.display = 'none';
                }
            }
        } catch (error) {
            console.error('Error loading profile picture:', error);
        }
    }
    

    
    // Initialize the page
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('Teacher service fee page loaded');
      
      // Force apply tab styles on page load
      setTimeout(() => {
        console.log('üé® Applying initial tab styles...');
        const currentWeekTab = document.getElementById('current-week-tab');
        if (currentWeekTab) {
          currentWeekTab.style.background = '#667eea';
          currentWeekTab.style.borderColor = '#667eea';
          currentWeekTab.style.color = '#fff';
          console.log('‚úÖ Applied violet styles to Current Week tab');
        }
        
        // Reset other tabs
        ['previous-week-tab', 'daily-breakdown-tab', 'weekly-payment-history-tab'].forEach(tabId => {
          const tab = document.getElementById(tabId);
          if (tab) {
            tab.style.background = '#fff';
            tab.style.borderColor = '#e0e6ed';
            tab.style.color = '#666';
            console.log('üìã Reset tab:', tabId);
          }
        });
      }, 100);
      
      // Debug gear dropdown removed
      
      // Ensure teacher rate is loaded first
      await ensureTeacherRateLoaded();
      
      // Load initial data
      await loadTeacherFeeData('current');
      await initializePaymentCount();
      
      // Set up periodic checks - More frequent for better real-time updates
      setInterval(checkForNewlyFinishedClasses, 15000); // Check every 15 seconds
      setInterval(checkForRateUpdates, 60000); // Check every minute
      setInterval(checkForNewPayments, 30000); // Check every 30 seconds
      
      // Listen for class completion events
      window.addEventListener('classFinished', () => {
        console.log('Class finished event received, refreshing data...');
        refreshCompletedClasses();
      });
      
      // Listen for salary disbursement events
      window.addEventListener('salaryDisbursed', () => {
        console.log('Salary disbursed event received, refreshing payment history...');
        const activeTab = document.querySelector('.week-tab.active');
        if (activeTab) {
          const tabType = activeTab.id.replace('-week-tab', '');
          if (tabType === 'weekly-payment-history') {
            loadWeeklyPaymentHistory();
        } else {
            loadTeacherFeeData(tabType);
          }
        }
      });
      
      // Check for immediate class completion notifications
      const lastNotification = localStorage.getItem('class_completion_notification');
      if (lastNotification) {
        const notificationTime = parseInt(lastNotification);
        const currentTime = Date.now();
        
        // If notification is less than 5 minutes old, refresh immediately
        if (currentTime - notificationTime < 300000) {
          console.log('Recent class completion detected, refreshing immediately...');
          refreshCompletedClasses();
        }
      }
      
      // Debug: Log current localStorage state
      console.log('üîç Current localStorage state:', {
        teacherId: teacherId,
        token: localStorage.getItem('token') ? 'Present' : 'Missing',
        finishedClasses: Object.keys(localStorage).filter(key => key.startsWith('class_finished_')),
        lastNotification: localStorage.getItem('class_completion_notification'),
        lastRefresh: localStorage.getItem('last_fee_refresh')
      });
      
      // Add a function to clear localStorage for testing
      window.clearClassData = function() {
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && (key.startsWith('class_finished_') || key === 'class_completion_notification' || key === 'last_fee_refresh')) {
            keysToRemove.push(key);
          }
        }
        
        keysToRemove.forEach(key => localStorage.removeItem(key));
        console.log('üßπ Cleared class-related localStorage data:', keysToRemove);
        alert('Class-related localStorage data cleared!');
      };
      
      console.log('üí° Debug commands available:');
      console.log('  - clearClassData() - Clear class-related localStorage');
      console.log('  - simulateClassCompletion() - Simulate a class completion');
      console.log('  - refreshCompletedClasses() - Manual refresh');
    });
    
    // Debug function to show week date calculations
    function debugWeekCalculation() {
      console.log('üîç Debug: Week date calculations (Philippine time)');
      
      const now = new Date();
      const phTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Manila"}));
      console.log('Current date (UTC):', now.toISOString().split('T')[0]);
      console.log('Current date (Philippine):', phTime.toISOString().split('T')[0]);
      
      // Helper function to get Monday of a given week (Philippine time)
      function getMondayOfWeek(date) {
        const phTime = new Date(date.toLocaleString("en-US", {timeZone: "Asia/Manila"}));
        const dayOfWeek = phTime.getDay(); // 0 = Sunday, 1 = Monday, etc.
        const monday = new Date(phTime);
        monday.setDate(phTime.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1)); // Monday
        return monday;
      }
      
      // Current week calculation (Philippine time)
      const currentMonday = getMondayOfWeek(now);
      const currentFriday = new Date(currentMonday);
      currentFriday.setDate(currentMonday.getDate() + 4); // Friday (5-day week like admin)
      
      console.log('Current week (Philippine time):', {
        monday: currentMonday.toISOString().split('T')[0],
        friday: currentFriday.toISOString().split('T')[0]
      });
      
      // Previous week calculation (Philippine time)
      const lastMonday = new Date(currentMonday);
      lastMonday.setDate(currentMonday.getDate() - 7);
      const lastFriday = new Date(lastMonday);
      lastFriday.setDate(lastMonday.getDate() + 4); // Friday (5-day week like admin)
      
      console.log('Previous week (Philippine time):', {
        monday: lastMonday.toISOString().split('T')[0],
        friday: lastFriday.toISOString().split('T')[0]
      });
      
      // Expected August 18-22, 2025 (current week)
      console.log('Expected August 18-22, 2025:', {
        monday: '2025-08-18',
        friday: '2025-08-22'
      });
      
      alert(`Debug Info (Philippine Time):\nCurrent Week: ${currentMonday.toISOString().split('T')[0]} to ${currentFriday.toISOString().split('T')[0]}\nPrevious Week: ${lastMonday.toISOString().split('T')[0]} to ${lastFriday.toISOString().split('T')[0]}\n\nPhilippine Time: ${phTime.toLocaleString('en-US', {timeZone: 'Asia/Manila'})}`);
    }
    
    // Simulate class completion for testing
    function simulateClassCompletion() {
      console.log('üé≠ Simulating class completion...');
      
      // Add a finished class to localStorage
      const classId = 'test_class_' + Date.now();
      localStorage.setItem('class_finished_' + classId, Date.now().toString());
      
      // Add a recent notification
      localStorage.setItem('class_completion_notification', Date.now().toString());
      
      console.log('‚úÖ Simulated class completion added to localStorage');
      console.log('üîÑ Triggering immediate refresh...');
      
      // Trigger immediate refresh
      refreshCompletedClasses();
      
      alert('Class completion simulated! Check console for details and the page should refresh automatically.');
    }
    
    // Initialize daily breakdown with current week dates
    function initializeDailyBreakdown() {
      const now = new Date();
      
      // Helper function to get Monday of a given week (Philippine time)
      function getMondayOfWeek(date) {
        const phTime = new Date(date.toLocaleString("en-US", {timeZone: "Asia/Manila"}));
        const dayOfWeek = phTime.getDay(); // 0 = Sunday, 1 = Monday, etc.
        const monday = new Date(phTime);
        monday.setDate(phTime.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1)); // Monday
        return monday;
      }
      
      const monday = getMondayOfWeek(now);
      const friday = new Date(monday);
      friday.setDate(monday.getDate() + 4); // Friday (5-day week like admin)
      
      // Set default date range to current week
      document.getElementById('daily-start-date').value = monday.toISOString().split('T')[0];
      document.getElementById('daily-end-date').value = friday.toISOString().split('T')[0];
      
      // Load initial data
      loadDailyBreakdown();
    }
    
    // Load daily breakdown data
    async function loadDailyBreakdown() {
      try {
        const startDate = document.getElementById('daily-start-date').value;
        const endDate = document.getElementById('daily-end-date').value;
        
        if (!startDate || !endDate) {
          alert('Please select both start and end dates');
          return;
        }
        
        const token = localStorage.getItem('token');
        const teacherId = localStorage.getItem('teacherId');
        
        if (!token || !teacherId) {
          alert('Authentication required. Please log in again.');
          return;
        }
        
        // Show loading state
        document.getElementById('daily-breakdown-message').textContent = 'Loading daily breakdown...';
        document.getElementById('daily-breakdown-table').style.display = 'none';
        
        console.log('üîç Loading daily breakdown for date range:', startDate, 'to', endDate);
        console.log('üë§ Teacher ID:', teacherId);
        
        // Fetch all classes for the date range
        const response = await fetch(`/api/teacher/completed-classes?startDate=${startDate}&endDate=${endDate}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('üìä Daily breakdown API response:', data);
        
        if (data.success && data.debug && data.debug.allClasses) {
          console.log('‚úÖ Found allClasses data:', data.debug.allClasses.length, 'classes');
          displayDailyBreakdown(data.debug.allClasses, startDate, endDate);
        } else {
          console.error('‚ùå No allClasses data found in response:', data);
          document.getElementById('daily-breakdown-message').textContent = 'No data available for the selected date range';
          document.getElementById('daily-breakdown-table').style.display = 'none';
        }
        
      } catch (error) {
        console.error('Error loading daily breakdown:', error);
        document.getElementById('daily-breakdown-message').textContent = `Error loading data: ${error.message}`;
        document.getElementById('daily-breakdown-table').style.display = 'none';
      }
    }
    
    // Display daily breakdown in table format
    function displayDailyBreakdown(allClasses, startDate, endDate) {
      const tbody = document.getElementById('daily-breakdown-tbody');
      
      console.log('üìä Processing daily breakdown for classes:', allClasses);
      console.log('üìÖ Date range:', startDate, 'to', endDate);
      
      // Group classes by date
      const dailyStats = {};
      
      // Initialize all dates in range with 0 counts
      const start = new Date(startDate);
      const end = new Date(endDate);
      for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
        const dateStr = d.toISOString().split('T')[0];
        dailyStats[dateStr] = {
          total: 0,
          completed: 0
        };
      }
      
      console.log('üìÖ Initialized daily stats for dates:', Object.keys(dailyStats));
      
      // Count classes by date and status
      allClasses.forEach((cls, index) => {
        console.log(`üìã Class ${index + 1}:`, cls);
        const dateStr = cls.date;
        if (dailyStats[dateStr]) {
          dailyStats[dateStr].total++;
          if (cls.status === 'completed') {
            // Check if class meets duration requirement (15-25 minutes)
            let meetsDurationRequirement = false;
            // Prefer attendance.classCompleted flag if provided
            if (cls.attendance && typeof cls.attendance.classCompleted === 'boolean') {
              meetsDurationRequirement = cls.attendance.classCompleted === true;
            } else if (cls.durationInfo && cls.durationInfo.meetsRequirement) {
              meetsDurationRequirement = true;
            } else if (cls.finishedAt && cls.date && cls.time) {
              // Calculate duration manually if not provided in API response
              const classDate = new Date(cls.date);
              const [hours, minutes] = cls.time.split(':').map(Number);
              const classStartTime = new Date(classDate);
              classStartTime.setHours(hours, minutes, 0, 0);
              const classFinishTime = new Date(cls.finishedAt);
              const durationMinutes = (classFinishTime - classStartTime) / (1000 * 60);
              meetsDurationRequirement = durationMinutes >= 15 && durationMinutes <= 25;
            }
            
            if (meetsDurationRequirement) {
              dailyStats[cls.date].completed++;
              console.log(`‚úÖ Completed class (meets duration) found for ${cls.date}`);
            } else {
              console.log(`‚ö†Ô∏è Finished class (doesn't meet duration) for ${cls.date}`);
            }
          }
        } else {
          console.log(`‚ö†Ô∏è Class date ${cls.date} not in range ${startDate} to ${endDate}`);
        }
      });
      
      console.log('üìä Final daily stats:', dailyStats);
      
      // Generate table rows
      const rows = Object.entries(dailyStats)
        .sort(([dateA], [dateB]) => dateA.localeCompare(dateB))
        .map(([date, stats]) => {
          const formattedDate = new Date(date).toLocaleDateString('en-US', {
            month: '2-digit',
            day: '2-digit',
            year: 'numeric'
          });
          
          return `
            <tr>
              <td style="font-weight: 500;">${formattedDate}</td>
              <td style="text-align: center; color: #1ca7e7; font-weight: 600;">${stats.total}</td>
              <td style="text-align: center; color: ${stats.completed > 0 ? '#28a745' : '#6c757d'}; font-weight: 600;">${stats.completed}</td>
            </tr>
          `;
        })
        .join('');
      
      if (rows) {
        tbody.innerHTML = rows;
        document.getElementById('daily-breakdown-table').style.display = 'block';
        document.getElementById('daily-breakdown-message').style.display = 'none';
        console.log('‚úÖ Daily breakdown table displayed successfully');
      } else {
        document.getElementById('daily-breakdown-message').textContent = 'No classes found for the selected date range';
        document.getElementById('daily-breakdown-table').style.display = 'none';
        console.log('‚ùå No rows generated for daily breakdown');
      }
      
      console.log('üìä Daily breakdown displayed:', dailyStats);
    }
    
    // Debug function to check current bookings
    async function debugCurrentBookings() {
      try {
        const token = localStorage.getItem('token');
        const teacherId = localStorage.getItem('teacherId');
        
        // Get current week dates (Global format)
        const now = new Date();
        
        // Helper function to get Monday of a given week (Global format)
        function getMondayOfWeek(date) {
          const dayOfWeek = date.getDay(); // 0 = Sunday, 1 = Monday, etc.
          const monday = new Date(date);
          monday.setDate(date.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1)); // Monday
          return monday;
        }
        
        const monday = getMondayOfWeek(now);
        const sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6); // Sunday (7-day week)
        
        const startDate = monday.toISOString().split('T')[0];
        const endDate = sunday.toISOString().split('T')[0];
        
        console.log('üîç Debugging current bookings (Global format)...');
        console.log('Date range:', startDate, 'to', endDate);
        console.log('Teacher ID:', teacherId);
        
        const response = await fetch(`/api/teacher/completed-classes?startDate=${startDate}&endDate=${endDate}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.debug) {
          const debug = data.debug;
          let message = `Current Week Bookings (${startDate} to ${endDate})\n\n`;
          message += `Teacher ID: ${debug.teacherId}\n`;
          message += `Total Classes: ${debug.totalClasses}\n`;
          message += `Completed Classes: ${data.completedClasses}\n`;
          message += `Absent Classes: ${data.absentClasses}\n\n`;
          message += `Status Breakdown:\n`;
          
          Object.entries(debug.statusBreakdown).forEach(([status, count]) => {
            message += `  ${status}: ${count}\n`;
          });
          
          message += `\nAll Classes:\n`;
          debug.allClasses.forEach((cls, index) => {
            message += `  ${index + 1}. ${cls.date} ${cls.time}: ${cls.status}\n`;
          });
          
          alert(message);
          console.log('üîç Debug data:', debug);
        } else {
          alert('No debug data available. Check console for details.');
        }
        
      } catch (error) {
        console.error('Error debugging current bookings:', error);
        alert(`Error: ${error.message}`);
      }
    }

    // Debug function to verify salary calculations
    async function debugSalaryCalculation() {
      try {
        const token = localStorage.getItem('token');
        const teacherId = localStorage.getItem('teacherId');
        
        // Get current week dates
        const now = new Date();
        const monday = new Date(now);
        monday.setDate(now.getDate() - now.getDay() + 1); // Monday
        const sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6); // Sunday
        
        const startDate = monday.toISOString().split('T')[0];
        const endDate = sunday.toISOString().split('T')[0];
        
        console.log('üîç Debugging salary calculation for week:', startDate, 'to', endDate);
        
        // Fetch teacher's classes for the week
        const response = await fetch(`/api/teacher/classes?startDate=${startDate}&endDate=${endDate}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          console.error('Failed to fetch classes for debug');
          return;
        }
        
        const data = await response.json();
        const classes = data.classes || [];
        
        console.log('üìä Total classes found:', classes.length);
        
        // Get teacher rate
        const ratePer25Minutes = parseFloat(document.getElementById('hourly-rate').value);
        console.log('üí∞ Teacher rate per 25 minutes:', ratePer25Minutes);
        
        // Analyze each class
        let completedClasses = 0;
        let absentClasses = 0;
        let cancelledClasses = 0;
        let totalLateMinutes = 0;
        let totalLateDeduction = 0;
        let totalAbsentDeduction = 0;
        let totalCancelledDeduction = 0;
        
        classes.forEach((classItem, index) => {
          console.log(`\nüìÖ Class ${index + 1}:`);
          console.log(`   Date: ${classItem.date} ${classItem.time}`);
          console.log(`   Status: ${classItem.status}`);
          console.log(`   Late Minutes: ${classItem.lateMinutes || 0}`);
          
          if (classItem.status === 'completed') {
            // Check if completed class meets duration requirement (15-25 minutes)
            let meetsDurationRequirement = false;
            
            if (classItem.attendance && typeof classItem.attendance.classCompleted === 'boolean') {
              meetsDurationRequirement = classItem.attendance.classCompleted === true;
            } else if (classItem.finishedAt && classItem.date && classItem.time) {
              const classDate = new Date(classItem.date);
              const [hours, minutes] = classItem.time.split(':').map(Number);
              const classStartTime = new Date(classDate);
              classStartTime.setHours(hours, minutes, 0, 0);
              const classFinishTime = new Date(classItem.finishedAt);
              const durationMinutes = (classFinishTime - classStartTime) / (1000 * 60);
              meetsDurationRequirement = durationMinutes >= 15 && durationMinutes <= 25;
            } else {
              // If we can't determine duration, assume it meets requirement (be conservative)
              meetsDurationRequirement = true;
            }
            
            if (meetsDurationRequirement) {
              // Class meets duration requirement - count as completed
              completedClasses++;
              if (classItem.lateMinutes && classItem.lateMinutes > 0) {
                const lateDeduction = classItem.lateMinutes * 2; // ‚Ç±2 per minute
                totalLateMinutes += classItem.lateMinutes;
                totalLateDeduction += lateDeduction;
                console.log(`   ‚úÖ Completed with ${classItem.lateMinutes} late minutes = ‚Ç±${lateDeduction.toFixed(2)} deduction`);
              } else {
                console.log(`   ‚úÖ Completed on time`);
              }
            } else {
              // Class completed but doesn't meet duration requirement - count as teacher absence
              absentClasses++;
              totalAbsentDeduction += ratePer25Minutes;
              console.log(`   ‚ùå Teacher Absent (Incomplete Class) = ‚Ç±${ratePer25Minutes.toFixed(2)} deduction`);
            }
          } else if (classItem.status === 'absent') {
            // Only count as absent if the TEACHER was absent, not the student
            const teacherEntered = classItem.attendance?.teacherEntered || false;
            if (!teacherEntered) {
              // Teacher was absent - count for deduction
              absentClasses++;
              totalAbsentDeduction += ratePer25Minutes;
              console.log(`   ‚ùå Teacher Absent = ‚Ç±${ratePer25Minutes.toFixed(2)} deduction`);
            } else {
              // Student was absent but teacher was present - don't count for deduction
              console.log(`   ‚ö†Ô∏è Student Absent (Teacher Present) = No deduction`);
            }
          } else if (classItem.status === 'cancelled') {
            cancelledClasses++;
            console.log(`   üö´ Cancelled`);
            // Cancellation deduction calculation would go here
          }
        });
        
        // Calculate totals
        const weeklyFee = completedClasses * ratePer25Minutes;
        const totalDeductions = totalLateDeduction + totalAbsentDeduction + totalCancelledDeduction;
        const netAmount = weeklyFee - totalDeductions;
        
        console.log('\nüìä SALARY CALCULATION SUMMARY:');
        console.log(`   Completed Classes: ${completedClasses} √ó ‚Ç±${ratePer25Minutes} = ‚Ç±${weeklyFee.toFixed(2)}`);
        console.log(`   Late Deductions: ${totalLateMinutes} minutes √ó ‚Ç±2 = ‚Ç±${totalLateDeduction.toFixed(2)}`);
        console.log(`   Teacher Absent Deductions (including incomplete classes): ${absentClasses} √ó ‚Ç±${ratePer25Minutes} = ‚Ç±${totalAbsentDeduction.toFixed(2)}`);
        console.log(`   Cancelled Deductions: ‚Ç±${totalCancelledDeduction.toFixed(2)}`);
        console.log(`   Total Deductions: ‚Ç±${totalDeductions.toFixed(2)}`);
        console.log(`   NET PAYABLE: ‚Ç±${netAmount.toFixed(2)}`);
        
        // Compare with UI values
        const uiWeeklyFee = parseFloat(document.getElementById('base-sum').textContent) || 0;
        const uiLateDeductions = parseFloat(document.getElementById('late-deductions').value) || 0;
        const uiAbsentDeductions = parseFloat(document.getElementById('absent-deductions').value) || 0;
        const uiNetAmount = parseFloat(document.getElementById('net-amount').textContent) || 0;
        
        console.log('\nüîç COMPARISON WITH UI:');
        console.log(`   UI Weekly Fee: ‚Ç±${uiWeeklyFee.toFixed(2)} | Calculated: ‚Ç±${weeklyFee.toFixed(2)} | Match: ${uiWeeklyFee === weeklyFee ? '‚úÖ' : '‚ùå'}`);
        console.log(`   UI Late Deductions: ‚Ç±${uiLateDeductions.toFixed(2)} | Calculated: ‚Ç±${totalLateDeduction.toFixed(2)} | Match: ${uiLateDeductions === totalLateDeduction ? '‚úÖ' : '‚ùå'}`);
        console.log(`   UI Absent Deductions: ‚Ç±${uiAbsentDeductions.toFixed(2)} | Calculated: ‚Ç±${totalAbsentDeduction.toFixed(2)} | Match: ${uiAbsentDeductions === totalAbsentDeduction ? '‚úÖ' : '‚ùå'}`);
        console.log(`   UI Net Amount: ‚Ç±${uiNetAmount.toFixed(2)} | Calculated: ‚Ç±${netAmount.toFixed(2)} | Match: ${uiNetAmount === netAmount ? '‚úÖ' : '‚ùå'}`);
        
        // Show alert with summary
        alert(`Salary Debug Summary:\n\n` +
              `Completed Classes: ${completedClasses}\n` +
              `Weekly Fee: ‚Ç±${weeklyFee.toFixed(2)}\n` +
              `Late Deductions: ‚Ç±${totalLateDeduction.toFixed(2)}\n` +
              `Teacher Absent Deductions (including incomplete classes): ‚Ç±${totalAbsentDeduction.toFixed(2)}\n` +
              `Total Deductions: ‚Ç±${totalDeductions.toFixed(2)}\n` +
              `NET PAYABLE: ‚Ç±${netAmount.toFixed(2)}\n\n` +
              `Check console for detailed breakdown.`);
        
      } catch (error) {
        console.error('Error debugging salary calculation:', error);
        alert('Error debugging salary calculation. Check console for details.');
      }
    }
    
    // Debug function to check attendance for specific bookings
    async function debugAttendanceData() {
      try {
        const token = localStorage.getItem('token');
        const teacherId = localStorage.getItem('teacherId');
        
        console.log('üîç Debugging attendance data for teacher:', teacherId);
        
        // Fetch all bookings for the current week
        const now = new Date();
        const monday = new Date(now);
        monday.setDate(now.getDate() - now.getDay() + 1); // Monday
        const sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6); // Sunday
        
        const startDate = monday.toISOString().split('T')[0];
        const endDate = sunday.toISOString().split('T')[0];
        
        const response = await fetch(`/api/teacher/classes?startDate=${startDate}&endDate=${endDate}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          console.error('Failed to fetch classes for attendance debug');
          return;
        }
        
        const data = await response.json();
        const classes = data.classes || [];
        
        console.log('üìä Attendance Debug for all classes:');
        classes.forEach((classItem, index) => {
          console.log(`\nüìÖ Class ${index + 1}: ${classItem.date} ${classItem.time}`);
          console.log(`   Status: ${classItem.status}`);
          console.log(`   Teacher Entered: ${classItem.attendance?.teacherEntered || false}`);
          console.log(`   Student Entered: ${classItem.attendance?.studentEntered || false}`);
          console.log(`   Teacher Entered At: ${classItem.attendance?.teacherEnteredAt || 'N/A'}`);
          console.log(`   Student Entered At: ${classItem.attendance?.studentEnteredAt || 'N/A'}`);
          console.log(`   Absent Checked: ${classItem.attendance?.absentChecked || false}`);
          console.log(`   Class Completed: ${classItem.attendance?.classCompleted || false}`);
          console.log(`   Finished At: ${classItem.finishedAt || 'N/A'}`);
          
          // Special focus on pending classes
          if (classItem.status === 'pending') {
            console.log(`   ‚ö†Ô∏è PENDING CLASS - Needs attention!`);
            if (!classItem.attendance?.teacherEntered && !classItem.attendance?.studentEntered) {
              console.log(`   ‚ùå No one has entered this classroom yet`);
            } else if (classItem.attendance?.teacherEntered && !classItem.attendance?.studentEntered) {
              console.log(`   üë®‚Äçüè´ Only teacher entered - student absent`);
            } else if (!classItem.attendance?.teacherEntered && classItem.attendance?.studentEntered) {
              console.log(`   üë®‚Äçüéì Only student entered - teacher absent`);
            } else {
              console.log(`   ‚úÖ Both teacher and student entered`);
            }
          }
        });
        
        // Show summary
        const pendingClasses = classes.filter(c => c.status === 'pending');
        const absentClasses = classes.filter(c => c.status === 'absent');
        const completedClasses = classes.filter(c => c.status === 'completed');
        
        console.log('\nüìã Summary:');
        console.log(`   Pending: ${pendingClasses.length}`);
        console.log(`   Absent: ${absentClasses.length}`);
        console.log(`   Completed: ${completedClasses.length}`);
        console.log(`   Total: ${classes.length}`);
        
      } catch (error) {
        console.error('Error debugging attendance data:', error);
      }
    }
    
    // Debug function to show detailed absence breakdown
    async function debugAbsenceBreakdown() {
      try {
        const token = localStorage.getItem('token');
        const teacherId = localStorage.getItem('teacherId');
        
        console.log('üîç Debugging absence breakdown for teacher:', teacherId);
        
        // Get current week dates
        const now = new Date();
        const monday = new Date(now);
        monday.setDate(now.getDate() - now.getDay() + 1); // Monday
        const sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6); // Sunday
        
        const startDate = monday.toISOString().split('T')[0];
        const endDate = sunday.toISOString().split('T')[0];
        
        const response = await fetch(`/api/teacher/classes?startDate=${startDate}&endDate=${endDate}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          console.error('Failed to fetch classes for absence debug');
          return;
        }
        
        const data = await response.json();
        const classes = data.classes || [];
        
        console.log('üìä ABSENCE BREAKDOWN ANALYSIS:');
        console.log('================================');
        
        let absentCount = 0;
        let absentDetails = [];
        
        classes.forEach((classItem, index) => {
          console.log(`\nüìÖ Class ${index + 1}: ${classItem.date} ${classItem.time}`);
          console.log(`   Status: ${classItem.status}`);
          console.log(`   Teacher Entered: ${classItem.attendance?.teacherEntered || false}`);
          console.log(`   Student Entered: ${classItem.attendance?.studentEntered || false}`);
          console.log(`   Class Completed: ${classItem.attendance?.classCompleted || false}`);
          console.log(`   Finished At: ${classItem.finishedAt || 'N/A'}`);
          
          let isAbsent = false;
          let absentReason = '';
          
          if (classItem.status === 'absent') {
            const teacherEntered = classItem.attendance?.teacherEntered || false;
            if (!teacherEntered) {
              isAbsent = true;
              absentReason = 'Status = absent AND teacher did not enter';
            } else {
              absentReason = 'Status = absent BUT teacher entered (student absent)';
            }
          } else if (classItem.status === 'completed') {
            let meetsDurationRequirement = false;
            
            if (classItem.attendance && typeof classItem.attendance.classCompleted === 'boolean') {
              meetsDurationRequirement = classItem.attendance.classCompleted === true;
            } else if (classItem.finishedAt && classItem.date && classItem.time) {
              const classDate = new Date(classItem.date);
              const [hours, minutes] = classItem.time.split(':').map(Number);
              const classStartTime = new Date(classDate);
              classStartTime.setHours(hours, minutes, 0, 0);
              const classFinishTime = new Date(classItem.finishedAt);
              const durationMinutes = (classFinishTime - classStartTime) / (1000 * 60);
              meetsDurationRequirement = durationMinutes >= 15 && durationMinutes <= 25;
            }
            
            if (!meetsDurationRequirement) {
              isAbsent = true;
              absentReason = 'Completed but duration < 15 minutes';
            } else {
              absentReason = 'Completed and duration meets requirement';
            }
          } else if (classItem.status === 'pending') {
            const teacherEntered = classItem.attendance?.teacherEntered || false;
            const studentEntered = classItem.attendance?.studentEntered || false;
            
            const classDateTime = new Date(`${classItem.date}T${classItem.time}:00`);
            const now = new Date();
            const timeDiffMinutes = (now - classDateTime) / (1000 * 60);
            
            if (timeDiffMinutes > 15 && !teacherEntered && !studentEntered) {
              isAbsent = true;
              absentReason = `Pending: neither entered (${timeDiffMinutes.toFixed(1)} min past)`;
            } else if (timeDiffMinutes > 15 && !teacherEntered && studentEntered) {
              isAbsent = true;
              absentReason = `Pending: student entered but teacher didn't (${timeDiffMinutes.toFixed(1)} min past)`;
            } else {
              absentReason = `Pending: ${timeDiffMinutes.toFixed(1)} min past, teacher: ${teacherEntered}, student: ${studentEntered}`;
            }
          }
          
          if (isAbsent) {
            absentCount++;
            absentDetails.push({
              date: classItem.date,
              time: classItem.time,
              reason: absentReason
            });
            console.log(`   ‚ùå COUNTED AS ABSENT: ${absentReason}`);
          } else {
            console.log(`   ‚úÖ NOT COUNTED AS ABSENT: ${absentReason}`);
          }
        });
        
        console.log('\nüìã ABSENCE SUMMARY:');
        console.log('==================');
        console.log(`Total classes: ${classes.length}`);
        console.log(`Absent classes: ${absentCount}`);
        console.log(`Rate per class: ‚Ç±200`);
        console.log(`Expected deduction: ‚Ç±${absentCount * 200}`);
        
        console.log('\nüìù ABSENT CLASSES DETAILS:');
        console.log('==========================');
        absentDetails.forEach((detail, index) => {
          console.log(`${index + 1}. ${detail.date} ${detail.time}: ${detail.reason}`);
        });
        
      } catch (error) {
        console.error('Error debugging absence breakdown:', error);
      }
    }
    
    // Debug function to specifically check student absences
    async function debugStudentAbsences() {
      try {
        const token = localStorage.getItem('token');
        const teacherId = localStorage.getItem('teacherId');
        
        console.log('üîç Debugging student absences for teacher:', teacherId);
        
        // Get current week dates
        const now = new Date();
        const monday = new Date(now);
        monday.setDate(now.getDate() - now.getDay() + 1); // Monday
        const sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6); // Sunday
        
        const startDate = monday.toISOString().split('T')[0];
        const endDate = sunday.toISOString().split('T')[0];
        
        const response = await fetch(`/api/teacher/classes?startDate=${startDate}&endDate=${endDate}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          console.error('Failed to fetch classes for student absence debug');
          return;
        }
        
        const data = await response.json();
        const classes = data.classes || [];
        
        console.log('üìä STUDENT ABSENCE ANALYSIS:');
        console.log('============================');
        
        let studentAbsentClasses = [];
        let teacherAbsentClasses = [];
        
        classes.forEach((classItem, index) => {
          console.log(`\nüìÖ Class ${index + 1}: ${classItem.date} ${classItem.time}`);
          console.log(`   Status: ${classItem.status}`);
          console.log(`   Teacher Entered: ${classItem.attendance?.teacherEntered || false}`);
          console.log(`   Student Entered: ${classItem.attendance?.studentEntered || false}`);
          console.log(`   Absent Checked: ${classItem.attendance?.absentChecked || false}`);
          
          if (classItem.status === 'absent') {
            const teacherEntered = classItem.attendance?.teacherEntered || false;
            const studentEntered = classItem.attendance?.studentEntered || false;
            
            if (teacherEntered && !studentEntered) {
              // Student absent - teacher entered but student didn't
              studentAbsentClasses.push({
                date: classItem.date,
                time: classItem.time,
                teacherEntered: teacherEntered,
                studentEntered: studentEntered
              });
              console.log(`   üë®‚Äçüéì STUDENT ABSENT: Teacher entered, student didn't`);
            } else if (!teacherEntered) {
              // Teacher absent - teacher didn't enter
              teacherAbsentClasses.push({
                date: classItem.date,
                time: classItem.time,
                teacherEntered: teacherEntered,
                studentEntered: studentEntered
              });
              console.log(`   üë®‚Äçüè´ TEACHER ABSENT: Teacher didn't enter`);
            } else {
              console.log(`   ‚ùì UNKNOWN ABSENCE TYPE: Teacher: ${teacherEntered}, Student: ${studentEntered}`);
            }
          } else if (classItem.status === 'pending') {
            const teacherEntered = classItem.attendance?.teacherEntered || false;
            const studentEntered = classItem.attendance?.studentEntered || false;
            
            const classDateTime = new Date(`${classItem.date}T${classItem.time}:00`);
            const now = new Date();
            const timeDiffMinutes = (now - classDateTime) / (1000 * 60);
            
            if (timeDiffMinutes > 15) {
              if (teacherEntered && !studentEntered) {
                console.log(`   ‚è≥ PENDING STUDENT ABSENT: ${timeDiffMinutes.toFixed(1)} min past, teacher entered, student didn't`);
              } else if (!teacherEntered) {
                console.log(`   ‚è≥ PENDING TEACHER ABSENT: ${timeDiffMinutes.toFixed(1)} min past, teacher didn't enter`);
              } else {
                console.log(`   ‚è≥ PENDING: ${timeDiffMinutes.toFixed(1)} min past, teacher: ${teacherEntered}, student: ${studentEntered}`);
              }
            } else {
              console.log(`   ‚è≥ PENDING: ${timeDiffMinutes.toFixed(1)} min past, still within grace period`);
            }
          }
        });
        
        console.log('\nüìã STUDENT ABSENCE SUMMARY:');
        console.log('===========================');
        console.log(`Total classes: ${classes.length}`);
        console.log(`Student absent classes: ${studentAbsentClasses.length}`);
        console.log(`Teacher absent classes: ${teacherAbsentClasses.length}`);
        
        if (studentAbsentClasses.length > 0) {
          console.log('\nüë®‚Äçüéì STUDENT ABSENT CLASSES:');
          console.log('==========================');
          studentAbsentClasses.forEach((cls, index) => {
            console.log(`${index + 1}. ${cls.date} ${cls.time} - Teacher: ${cls.teacherEntered}, Student: ${cls.studentEntered}`);
          });
        }
        
        if (teacherAbsentClasses.length > 0) {
          console.log('\nüë®‚Äçüè´ TEACHER ABSENT CLASSES:');
          console.log('==========================');
          teacherAbsentClasses.forEach((cls, index) => {
            console.log(`${index + 1}. ${cls.date} ${cls.time} - Teacher: ${cls.teacherEntered}, Student: ${cls.studentEntered}`);
          });
        }
        
        // Show alert with summary
        const ratePerClass = parseFloat(document.getElementById('hourly-rate').value) || 200;
        const studentAbsentPayment = studentAbsentClasses.length * (ratePerClass * 0.5);
        
        alert(`Student Absence Debug Summary:\n\n` +
              `Total classes: ${classes.length}\n` +
              `Student absent classes: ${studentAbsentClasses.length}\n` +
              `Teacher absent classes: ${teacherAbsentClasses.length}\n` +
              `Rate per class: ‚Ç±${ratePerClass}\n` +
              `50% rate: ‚Ç±${(ratePerClass * 0.5).toFixed(2)}\n` +
              `Expected student absent payment: ‚Ç±${studentAbsentPayment.toFixed(2)}\n\n` +
              `Check console for detailed breakdown.`);
        
      } catch (error) {
        console.error('Error debugging student absences:', error);
        alert('Error debugging student absences. Check console for details.');
      }
    }
  </script>
  <script src="avatar-helper.js"></script>
</body>
</html> 