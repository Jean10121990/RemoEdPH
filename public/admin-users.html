<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - RemoEdPH Admin</title>
    <link rel="stylesheet" href="modern-styles.css">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f6fbff; }
        .remoed-main { display: flex; min-height: calc(100vh - 70px); }
        .remoed-sidebar { width: 220px; background: #fff; box-shadow: 2px 0 8px rgba(0,0,0,0.05); padding: 32px 0 0 0; display: flex; flex-direction: column; }
        .remoed-logo { display: flex; align-items: center; gap: 14px; }
        .remoed-logo img { height: 48px; }
        .remoed-title { font-size: 1.7rem; font-weight: 700; color: #667eea; letter-spacing: 1px; }
        .remoed-user { display: flex; align-items: center; gap: 10px; }
        .remoed-avatar { width: 72px; height: 72px; border-radius: 50%; background: #667eea; color: #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 2.2rem; }
        .remoed-username { color: #667eea; font-weight: 600; }
        .remoed-menu { list-style: none; padding: 0; margin: 0; }
        .remoed-menu li { padding: 14px 32px; color: #667eea; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 12px; border-left: 4px solid transparent; transition: all 0.2s; }
        .remoed-menu li.active, .remoed-menu li:hover { background: linear-gradient(90deg, #667eea 0%, #5a67d8 100%); border-left: 4px solid #667eea; color: white; transform: translateX(4px); }
        .remoed-menu svg { width: 20px; height: 20px; }
        .remoed-content { flex: 1; padding: 12px 16px; }
        .remoed-section { background: #fff; border-radius: 12px; box-shadow: 0 4px 24px rgba(28,167,231,0.07); padding: 12px; margin-bottom: 12px; }
        .remoed-section-title { font-size: 1rem; font-weight: 700; color: #1ca7e7; margin-bottom: 10px; letter-spacing: 0.5px; }
        .tab-buttons { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; background: #f0f0f0; color: #666; transition: all 0.2s; }
        .tab-btn.active { background: #1ca7e7; color: #fff; }
        .user-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .user-table th, .user-table td { padding: 6px 8px; text-align: left; border-bottom: 1px solid #e0e6ed; font-size: 0.85rem; }
        .user-table th { background: #f8f9fa; font-weight: 600; color: #1ca7e7; }
        .user-table tr:hover { background: #f6fbff; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 600; }
        .status-active { background: #d4edda; color: #155724; }
        .status-inactive { background: #f8d7da; color: #721c24; }
        .action-btn { 
            padding: 8px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            margin-right: 5px; 
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            transition: all 0.2s;
        }
        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .btn-edit { background: #ffe85a; color: #1ca7e7; }
        .btn-edit:hover { background: #ffd700; }
        .btn-delete { background: #e74c3c; color: #fff; }
        .btn-delete:hover { background: #c0392b; }
        .btn-suspend { background: #f39c12; color: #fff; }
        .btn-suspend:hover { background: #e67e22; }
        .btn-role { background: #9b59b6; color: white; }
        .btn-role:hover { background: #8e44ad; }
        .action-btn svg { width: 16px; height: 16px; }
        @media (max-width: 900px) {
            .remoed-main { flex-direction: column; }
            .remoed-sidebar { width: 100%; flex-direction: row; box-shadow: none; border-bottom: 1px solid #e0e6ed; }
            .remoed-menu li { padding: 12px 10px; font-size: 0.97rem; }
            .remoed-content { padding: 18px 6px; }
        }
    </style>
</head>
<body>
    <div class="remoed-main">
        <nav class="remoed-sidebar">
            <div class="remoed-logo" style="height:100px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px; padding-top:5px;">
                <img src="remoed-logo.png" alt="RemoEdPH Logo" style="height:40px; width:auto; display:inline-block; vertical-align:middle;">
                <span class="remoed-title" style="font-size:1.3rem; font-weight:700; color:#667eea; letter-spacing:1px;">RemoEdPH</span>
            </div>
            <div class="remoed-user" style="display:flex; flex-direction:column; align-items:center; margin-bottom:24px;">
                <div class="remoed-avatar" id="remoed-avatar">
                    <img id="profile-image" src="" alt="Profile" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover; display: none;">
                    <span id="avatar-text">A</span>
                </div>
                <span class="remoed-username" id="remoed-username">Admin</span>
            </div>
            <ul class="remoed-menu">
                <li onclick="window.location.href='admin-dashboard.html'"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="4"/></svg>Dashboard</li>
                <li class="active"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/></svg>User Management</li>
                <li onclick="window.location.href='admin-announcements.html'"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/></svg>Announcements</li>
                <li onclick="window.location.href='admin-payroll.html'"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 10c-4.41 0-8-1.79-8-4V6c0-2.21 3.59-4 8-4s8 1.79 8 4v8c0 2.21-3.59 4-8 4z"/></svg>Payroll Management</li>
                <li onclick="window.location.href='admin-reports.html'"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>Reports</li>
                <li onclick="window.location.href='admin-issue-management.html'"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>Issue Management</li>
                <li onclick="window.location.href='admin-lessons-library.html'"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>Lesson Library</li>
                <li onclick="window.location.href='admin-settings.html'"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>Settings</li>
                <li id="logout-nav" style="margin-top:auto; color:#e74c3c; cursor:pointer;"><svg fill="none" stroke="#e74c3c" stroke-width="2" viewBox="0 0 24 24"><path d="M17 16l4-4m0 0l-4-4m4 4H7"/><path d="M3 12a9 9 0 0118 0 9 9 0 01-18 0z"/></svg>Logout</li>
            </ul>
        </nav>
        <div class="remoed-content">
            <div class="remoed-section">
                <div class="remoed-section-title">User Management</div>
                
                <div class="tab-buttons">
                    <button class="tab-btn active" onclick="switchTab('teachers')">üë®‚Äçüè´ Teachers</button>
                    <button class="tab-btn" onclick="switchTab('students')">üë®‚Äçüéì Students</button>
                    <button class="tab-btn" onclick="switchTab('admins')">üë®‚Äçüíº Admins</button>
                </div>
                
                <div id="teachers-tab" class="tab-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #1ca7e7;">Teachers List</h3>
                        <button class="action-btn btn-edit" onclick="addNewUser('teacher')" title="Add Teacher">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M12 4v16m8-8H4"/>
                            </svg>
                        </button>
                    </div>
                    <table class="user-table" id="teachers-table">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Join Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="teachers-tbody">
                            <!-- Teachers will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
                <div id="students-tab" class="tab-content" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #1ca7e7;">Students List</h3>
                        <button class="action-btn btn-edit" onclick="addNewUser('student')" title="Add Student">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M12 4v16m8-8H4"/>
                            </svg>
                        </button>
                    </div>
                    <table class="user-table" id="students-table">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Name</th>
                                <th>Status</th>
                                <th>Join Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="students-tbody">
                            <!-- Students will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
                <div id="admins-tab" class="tab-content" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #1ca7e7;">Admins List</h3>
                        <button class="action-btn btn-edit" onclick="addNewUser('admin')" title="Add Admin">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M12 4v16m8-8H4"/>
                            </svg>
                        </button>
                    </div>
                    <table class="user-table" id="admins-table">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Status</th>
                                <th>Join Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="admins-tbody">
                            <!-- Admins will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- User Modal -->
    <div id="user-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #1ca7e7; margin: 0;" id="modal-title">Add User</h2>
                <button id="close-modal" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
            </div>
            
            <form id="user-form">
                <input type="hidden" id="user-id" name="userId">
                <input type="hidden" id="user-type" name="userType">
                
                <div id="username-field" style="margin-bottom: 15px;">
                    <label for="username" style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Username</label>
                    <input type="text" id="username" name="username" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label for="email" style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Email</label>
                    <input type="email" id="email" name="email" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label for="password" style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Password</label>
                    <input type="password" id="password" name="password" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                    <small style="color: #666;">Leave blank to keep current password when editing</small>
                </div>
                
                <div id="teacher-fields" style="display: none;">
                    <div style="margin-bottom: 15px;">
                        <label for="firstName" style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">First Name</label>
                        <input type="text" id="firstName" name="firstName" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label for="lastName" style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Last Name</label>
                        <input type="text" id="lastName" name="lastName" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label for="rate" style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Hourly Rate (PHP)</label>
                        <input type="number" id="rate" name="rate" min="0" step="0.01" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                    </div>
                </div>
                
                <div id="student-fields" style="display: none;">
                    <div style="margin-bottom: 15px;">
                        <label for="studentFirstName" style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">First Name</label>
                        <input type="text" id="studentFirstName" name="studentFirstName" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label for="studentLastName" style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Last Name</label>
                        <input type="text" id="studentLastName" name="studentLastName" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" style="flex: 1; padding: 12px; background: #1ca7e7; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Save</button>
                    <button type="button" onclick="closeUserModal()" style="flex: 1; padding: 12px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Role Change Modal -->
    <div id="role-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; padding: 24px; max-width: 400px; width: 90%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #1ca7e7; margin: 0;">Change User Role</h2>
                <button id="close-role-modal" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
            </div>
            
            <div style="margin-bottom: 20px;">
                <p><strong>User:</strong> <span id="role-change-username"></span></p>
                <p><strong>Current Role:</strong> <span id="current-role"></span></p>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label for="new-role" style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">New Role:</label>
                <select id="new-role" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                    <option value="teacher">üë®‚Äçüè´ Teacher</option>
                    <option value="student">üë®‚Äçüéì Student</option>
                    <option value="admin">üë®‚Äçüíº Admin</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="confirmRoleChange()" style="flex: 1; padding: 12px; background: #1ca7e7; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Confirm Change</button>
                <button onclick="closeRoleModal()" style="flex: 1; padding: 12px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
            </div>
        </div>
    </div>

    <script src="avatar-helper.js"></script>
    <script>
        // Role-based access control
        const userType = localStorage.getItem('userType');
        if (userType !== 'admin') {
            alert('Access denied. This page is for administrators only.');
            window.location.href = 'index.html';
        }

        document.addEventListener('DOMContentLoaded', function() {
            const username = localStorage.getItem('adminUsername') || 'Admin';

            if (username) {
                document.getElementById('remoed-username').textContent = username;
                if (window.setAvatar) {
                    setAvatar({ displayName: username, imgSelector: '#profile-image', textSelector: '#avatar-text' });
                } else {
                    document.getElementById('avatar-text').textContent = username[0].toUpperCase();
                }
            }

            // Load initial data
            loadTeachers();
        });

        document.getElementById('logout-nav').onclick = function() {
            localStorage.clear();
            window.location.href = 'admin-login.html';
        };

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            
            // Show selected tab
            document.getElementById(tabName + '-tab').style.display = 'block';
            
            // Load data for selected tab
            switch(tabName) {
                case 'teachers':
                    loadTeachers();
                    break;
                case 'students':
                    loadStudents();
                    break;
                case 'admins':
                    loadAdmins();
                    break;
            }
        }

        async function loadTeachers() {
            try {
                const response = await fetch('/api/admin/teachers-list');
                const teachers = await response.json();
                
                const tbody = document.getElementById('teachers-tbody');
                if (!teachers.length) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #888;">No teachers found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = teachers.map(teacher => `
                    <tr>
                        <td>${teacher.username || 'N/A'}</td>
                        <td>${teacher.email || 'N/A'}</td>
                        <td><span class="status-badge ${teacher.status === 'suspended' ? 'status-inactive' : 'status-active'}">${teacher.status === 'suspended' ? 'Suspended' : 'Active'}</span></td>
                        <td>${teacher.createdAt ? new Date(teacher.createdAt).toLocaleDateString() : 'N/A'}</td>
                        <td>
                            <button class="action-btn btn-edit" onclick="editUser('${teacher._id}', 'teacher')" title="Edit Teacher">
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                            </button>
                            <button class="action-btn btn-suspend" onclick="${teacher.status === 'suspended' ? 'unsuspendUser' : 'suspendUser'}('${teacher._id}', 'teacher')" title="${teacher.status === 'suspended' ? 'Unsuspend Teacher' : 'Suspend Teacher'}">
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    ${teacher.status === 'suspended' ? 
                                        '<path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>' : 
                                        '<path d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L18.364 5.636M5.636 18.364l12.728-12.728"/>'
                                    }
                                </svg>
                            </button>
                            <button class="action-btn btn-delete" onclick="deleteUser('${teacher._id}', 'teacher')" title="Delete Teacher">
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2M10 11v6M14 11v6"/>
                                </svg>
                            </button>
                            <button class="action-btn btn-role" onclick="changeUserRole('${teacher.username}', 'teacher')" title="Change Role">
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading teachers:', error);
                document.getElementById('teachers-tbody').innerHTML = '<tr><td colspan="5" style="text-align: center; color: #e74c3c;">Error loading teachers</td></tr>';
            }
        }

        async function loadStudents() {
            try {
                const response = await fetch('/api/admin/students-list');
                const students = await response.json();
                
                const tbody = document.getElementById('students-tbody');
                if (!students.length) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #888;">No students found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = students.map(student => `
                    <tr>
                        <td>${student.username}</td>
                        <td>${student.email || 'N/A'}</td>
                        <td>${student.firstName} ${student.lastName}</td>
                        <td><span class="status-badge ${student.status === 'suspended' ? 'status-inactive' : 'status-active'}">${student.status === 'suspended' ? 'Suspended' : 'Active'}</span></td>
                        <td>${new Date(student.createdAt).toLocaleDateString()}</td>
                        <td>
                            <button class="action-btn btn-edit" onclick="editUser('${student._id}', 'student')" title="Edit Student">
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                            </button>
                            <button class="action-btn btn-suspend" onclick="${student.status === 'suspended' ? 'unsuspendUser' : 'suspendUser'}('${student._id}', 'student')" title="${student.status === 'suspended' ? 'Unsuspend Student' : 'Suspend Student'}">
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    ${student.status === 'suspended' ? 
                                        '<path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>' : 
                                        '<path d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L18.364 5.636M5.636 18.364l12.728-12.728"/>'
                                    }
                                </svg>
                            </button>
                            <button class="action-btn btn-delete" onclick="deleteUser('${student._id}', 'student')" title="Delete Student">
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2M10 11v6M14 11v6"/>
                                </svg>
                            </button>
                            <button class="action-btn btn-role" onclick="changeUserRole('${student.username}', 'student')" title="Change Role">
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading students:', error);
                document.getElementById('students-tbody').innerHTML = '<tr><td colspan="6" style="text-align: center; color: #e74c3c;">Error loading students</td></tr>';
            }
        }

        async function loadAdmins() {
            try {
                const response = await fetch('/api/admin/admins');
                const admins = await response.json();
                
                const tbody = document.getElementById('admins-tbody');
                if (!admins.length) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #888;">No admins found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = admins.map(admin => `
                    <tr>
                        <td>${admin.username}</td>
                        <td><span class="status-badge ${admin.status === 'suspended' ? 'status-inactive' : 'status-active'}">${admin.status === 'suspended' ? 'Suspended' : 'Active'}</span></td>
                        <td>${new Date(admin.createdAt).toLocaleDateString()}</td>
                        <td>
                            <button class="action-btn btn-edit" onclick="editUser('${admin._id}', 'admin')" title="Edit Admin">
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                            </button>
                            <button class="action-btn btn-delete" onclick="deleteUser('${admin._id}', 'admin')" title="Delete Admin">
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2M10 11v6M14 11v6"/>
                                </svg>
                            </button>
                            <button class="action-btn btn-role" onclick="changeUserRole('${admin.username}', 'admin')" title="Change Role">
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading admins:', error);
                document.getElementById('admins-tbody').innerHTML = '<tr><td colspan="4" style="text-align: center; color: #e74c3c;">Error loading admins</td></tr>';
            }
        }

        // Generic function to reload current tab
        function loadUsers() {
            const activeTab = document.querySelector('.tab-btn.active');
            if (activeTab) {
                const tabName = activeTab.textContent.toLowerCase().replace(/[^a-z]/g, '');
                switch (tabName) {
                    case 'teachers':
                        loadTeachers();
                        break;
                    case 'students':
                        loadStudents();
                        break;
                    case 'admins':
                        loadAdmins();
                        break;
                }
            }
        }

        function addNewUser(userType) {
            document.getElementById('modal-title').textContent = `Add ${userType.charAt(0).toUpperCase() + userType.slice(1)}`;
            document.getElementById('user-id').value = '';
            document.getElementById('user-type').value = userType;
            document.getElementById('user-form').reset();
            
            // Show/hide fields based on user type
            document.getElementById('teacher-fields').style.display = userType === 'teacher' ? 'block' : 'none';
            document.getElementById('student-fields').style.display = userType === 'student' ? 'block' : 'none';
            
            // Hide username field for teachers (auto-generated)
            if (userType === 'teacher') {
                document.getElementById('username-field').style.display = 'none';
                document.getElementById('username').required = false;
                document.getElementById('password').required = false;
                document.getElementById('password').style.display = 'none';
                document.getElementById('password').parentElement.style.display = 'none';
            } else {
                document.getElementById('username-field').style.display = 'block';
                document.getElementById('username').required = true;
                document.getElementById('password').required = true;
                document.getElementById('password').style.display = 'block';
                document.getElementById('password').parentElement.style.display = 'block';
            }
            
            document.getElementById('user-modal').style.display = 'block';
        }

        async function editUser(userId, userType) {
            try {
                const response = await fetch(`/api/admin/user/${userId}?type=${userType}`);
                const user = await response.json();
                
                document.getElementById('modal-title').textContent = `Edit ${userType.charAt(0).toUpperCase() + userType.slice(1)}`;
                document.getElementById('user-id').value = userId;
                document.getElementById('user-type').value = userType;
                document.getElementById('username').value = user.username || '';
                document.getElementById('email').value = user.email || '';
                document.getElementById('password').value = ''; // Don't show current password
                document.getElementById('password').required = false; // Not required for editing
                
                // Show/hide fields based on user type
                document.getElementById('teacher-fields').style.display = userType === 'teacher' ? 'block' : 'none';
                document.getElementById('student-fields').style.display = userType === 'student' ? 'block' : 'none';
                
                // Show username field for editing (even for teachers)
                document.getElementById('username-field').style.display = 'block';
                document.getElementById('username').required = true;
                
                if (userType === 'teacher') {
                    document.getElementById('firstName').value = user.firstName || '';
                    document.getElementById('lastName').value = user.lastName || '';
                    document.getElementById('rate').value = user.rate || '';
                } else if (userType === 'student') {
                    document.getElementById('studentFirstName').value = user.firstName || '';
                    document.getElementById('studentLastName').value = user.lastName || '';
                }
                
                document.getElementById('user-modal').style.display = 'block';
            } catch (error) {
                console.error('Error loading user data:', error);
                alert('Error loading user data');
            }
        }

        function closeUserModal() {
            document.getElementById('user-modal').style.display = 'none';
        }

        async function suspendUser(userId, userType) {
            if (confirm(`Are you sure you want to suspend this ${userType}?`)) {
                try {
                    const response = await fetch(`/api/admin/user/${userId}/suspend?type=${userType}`, {
                        method: 'PUT'
                    });
                    
                    if (response.ok) {
                        alert(`${userType.charAt(0).toUpperCase() + userType.slice(1)} suspended successfully`);
                        loadUsers(); // Reload the current tab
                    } else {
                        alert('Error suspending user');
                    }
                } catch (error) {
                    console.error('Error suspending user:', error);
                    alert('Error suspending user');
                }
            }
        }

        async function unsuspendUser(userId, userType) {
            if (confirm(`Are you sure you want to unsuspend this ${userType}?`)) {
                try {
                    const response = await fetch(`/api/admin/user/${userId}/unsuspend?type=${userType}`, {
                        method: 'PUT'
                    });
                    
                    if (response.ok) {
                        alert(`${userType.charAt(0).toUpperCase() + userType.slice(1)} unsuspended successfully`);
                        loadUsers(); // Reload the current tab
                    } else {
                        alert('Error unsuspending user');
                    }
                } catch (error) {
                    console.error('Error unsuspending user:', error);
                    alert('Error unsuspending user');
                }
            }
        }

        async function deleteUser(userId, userType) {
            if (confirm(`Are you sure you want to delete this ${userType}? This action cannot be undone.`)) {
                try {
                    const response = await fetch(`/api/admin/user/${userId}?type=${userType}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        alert(`${userType.charAt(0).toUpperCase() + userType.slice(1)} deleted successfully`);
                        loadUsers(); // Reload the current tab
                    } else {
                        alert('Error deleting user');
                    }
                } catch (error) {
                    console.error('Error deleting user:', error);
                    alert('Error deleting user');
                }
            }
        }

        // Handle form submission
        document.getElementById('user-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const userData = Object.fromEntries(formData.entries());
            
            // For new teachers, remove username and password fields since they're auto-generated
            if (userData.userType === 'teacher' && !userData.userId) {
                delete userData.username;
                delete userData.password;
            }
            
            try {
                const url = userData.userId ? 
                    `/api/admin/user/${userData.userId}?type=${userData.userType}` : 
                    `/api/admin/user?type=${userData.userType}`;
                
                const method = userData.userId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    if (userData.userType === 'teacher' && result.credentials) {
                        // Show credentials for teachers when email is not configured
                        alert(`Teacher created successfully!\n\nGenerated Credentials:\nUsername: ${result.credentials.username}\nPassword: ${result.credentials.password}\n\nPlease save these credentials and share them with the teacher.`);
                    } else {
                    alert(`${userData.userType.charAt(0).toUpperCase() + userData.userType.slice(1)} ${userData.userId ? 'updated' : 'created'} successfully`);
                    }
                    
                    closeUserModal();
                    loadUsers(); // Reload the current tab
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.message || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error saving user:', error);
                alert('Error saving user');
            }
        });

        // Close modal when clicking outside or on close button
        document.getElementById('close-modal').addEventListener('click', closeUserModal);
        document.getElementById('user-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeUserModal();
            }
        });

        // Role change functionality
        let currentRoleChangeData = {};

        function changeUserRole(username, currentRole) {
            currentRoleChangeData = { username, currentRole };
            document.getElementById('role-change-username').textContent = username;
            document.getElementById('current-role').textContent = currentRole.charAt(0).toUpperCase() + currentRole.slice(1);
            
            // Set the new role dropdown to a different role
            const newRoleSelect = document.getElementById('new-role');
            newRoleSelect.value = currentRole === 'teacher' ? 'student' : currentRole === 'student' ? 'admin' : 'teacher';
            
            document.getElementById('role-modal').style.display = 'block';
        }

        function closeRoleModal() {
            document.getElementById('role-modal').style.display = 'none';
            currentRoleChangeData = {};
        }

        async function confirmRoleChange() {
            const newRole = document.getElementById('new-role').value;
            const { username, currentRole } = currentRoleChangeData;
            
            if (currentRole === newRole) {
                alert('Please select a different role');
                return;
            }
            
            if (confirm(`Are you sure you want to change ${username} from ${currentRole} to ${newRole}?`)) {
                try {
                    // Use the correct API route mounted under /api/auth
                    const response = await fetch('/api/auth/user-role', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            username: username,
                            fromRole: currentRole,
                            toRole: newRole
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        alert(`User role changed successfully! ${username} is now a ${newRole}`);
                        closeRoleModal();
                        loadUsers(); // Reload the current tab
                    } else {
                        alert(`Error: ${data.message || 'Failed to change user role'}`);
                    }
                } catch (error) {
                    console.error('Error changing user role:', error);
                    alert('Error changing user role. Please try again.');
                }
            }
        }

        // Close role modal when clicking outside or on close button
        document.getElementById('close-role-modal').addEventListener('click', closeRoleModal);
        document.getElementById('role-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeRoleModal();
            }
        });
    </script>
</body>
</html> 