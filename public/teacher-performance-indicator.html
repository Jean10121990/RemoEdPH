<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Indicator - RemoEdPH</title>
    <link rel="stylesheet" href="modern-styles.css">
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: #f8fafc; 
            color: #1a202c;
            margin: 0;
            padding: 0;
        }
        
        .remoed-main {
            display: flex;
            min-height: 100vh;
        }
        
        .remoed-sidebar {
            width: 260px;
            min-width: 260px;
            background: linear-gradient(180deg, #ffffff 0%, #f8fbff 100%);
            box-shadow: 4px 0 20px rgba(102, 126, 234, 0.1);
            padding: 0;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            overflow: hidden;
            z-index: 100;
        }
        
        .remoed-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .remoed-menu li {
            padding: 14px 32px;
            color: #64748b;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            border-left: 4px solid transparent;
            transition: background 0.2s, border-color 0.2s;
        }

        .remoed-menu li.active,
        .remoed-menu li:hover {
            background: linear-gradient(90deg, #667eea 0%, #5a67d8 100%);
            border-left: 4px solid #667eea;
            color: white;
            transform: translateX(4px);
            transition: all 0.3s ease;
            border-radius: 0 8px 8px 0;
        }
        
        .remoed-menu svg {
            width: 20px;
            height: 20px;
            stroke: currentColor;
        }
        
        .remoed-content {
            flex: 1;
            padding: 36px 40px;
            margin-left: 260px;
            max-width: calc(100vw - 260px);
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }
        
        .page-header h1 {
            color: #667eea;
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
        }
        
        .period-selector {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .period-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .period-btn.active {
            background: #667eea;
            color: white;
        }
        
        .period-btn:hover {
            background: #667eea;
            color: white;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid;
        }
        
        .stat-card.completed { border-left-color: #28a745; }
        .stat-card.absent { border-left-color: #dc3545; }
        .stat-card.cancelled { border-left-color: #ffc107; }
        .stat-card.late { border-left-color: #fd7e14; }
        .stat-card.system-issue { border-left-color: #6f42c1; }
        .stat-card.teacher-issue { border-left-color: #e83e8c; }
        .stat-card.student-issue { border-left-color: #20c997; }
        
        .stat-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1a202c;
        }
        
        .metrics-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 32px;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 24px;
        }
        
        .metric-item {
            text-align: center;
        }
        
        .metric-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 8px;
        }
        
        .metric-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #667eea;
        }
        
        .breakdown-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }
        
        .breakdown-header {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .breakdown-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .breakdown-item {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .breakdown-item:last-child {
            border-bottom: none;
        }
        
        .breakdown-date {
            font-weight: 600;
            color: #1a202c;
        }
        
        .breakdown-time {
            color: #666;
            font-size: 0.9rem;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #fee;
            color: #c33;
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
        }
        
        /* Performance Metrics Cards Styles */
        .charts-grid-secondary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
        
        @media (max-width: 1400px) {
            .charts-grid-secondary {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .charts-grid-secondary {
                grid-template-columns: 1fr;
            }
        }
        
        .chart-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        
        /* Badge System Styles */
        .badges-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
        }
        
        .badges-header {
            color: white;
            margin-bottom: 24px;
        }
        
        .badges-header h2 {
            color: white;
            font-size: 1.8rem;
            margin: 0 0 8px 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .badges-header p {
            color: rgba(255, 255, 255, 0.9);
            margin: 0;
            font-size: 1rem;
        }
        
        .badges-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }
        
        .badge-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .badge-card.earned {
            border: 3px solid #28a745;
            transform: scale(1.05);
            box-shadow: 0 8px 24px rgba(40, 167, 69, 0.4);
        }
        
        .badge-card.earned::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transform: rotate(45deg);
            animation: shine 3s infinite;
        }
        
        .badge-card.locked {
            opacity: 0.5;
            filter: grayscale(100%);
        }
        
        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        
        .badge-icon {
            font-size: 3rem;
            margin-bottom: 12px;
            display: block;
        }
        
        .badge-card.earned .badge-icon {
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .badge-name {
            font-weight: 700;
            font-size: 1rem;
            color: #1a202c;
            margin-bottom: 8px;
        }
        
        .badge-description {
            font-size: 0.85rem;
            color: #666;
            line-height: 1.4;
        }
        
        .badge-status {
            margin-top: 8px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-status.earned {
            color: #28a745;
        }
        
        .badge-status.locked {
            color: #999;
        }
        
        .badge-progress {
            margin-top: 8px;
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .badge-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }
        
        .attendance-analysis-section {
            margin-top: 32px;
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 24px;
            padding-bottom: 12px;
            border-bottom: 3px solid #667eea;
        }
    </style>
</head>
<body>
    <div class="remoed-main">
        <!-- Sidebar will be loaded via JavaScript -->
        <div class="remoed-sidebar" id="sidebar"></div>
        
        <div class="remoed-content">
            <div class="page-header">
                <h1>Performance Indicator</h1>
                <div class="period-selector">
                    <button class="period-btn active" data-period="weekly">This Week</button>
                    <button class="period-btn" data-period="monthly">This Month</button>
                    <button class="period-btn" data-period="custom">Custom Range</button>
                </div>
            </div>
            
            <div id="loading" class="loading">Loading performance indicators...</div>
            <div id="error" class="error" style="display: none;"></div>
            
            <div id="content" style="display: none;">
                <!-- Performance Metrics Cards -->
                <div class="charts-grid-secondary">
                    <!-- Total Classes Booked Chart -->
                    <div class="chart-card" style="background: white; border-radius: 8px; padding: 0.75rem; box-shadow: 0 2px 6px rgba(0,0,0,0.05); border: 1px solid #e0e6ed; transition: transform 0.2s ease, box-shadow 0.2s ease;">
                        <div class="chart-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span class="chart-title" style="font-size: 0.75rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">Classes Booked</span>
                            <div class="chart-icon" style="background: linear-gradient(135deg, #3b82f6, #2563eb); width: 24px; height: 24px; border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="white">
                                    <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                                </svg>
                            </div>
                        </div>
                        <div class="chart-value" id="total-classes" style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.2rem;">0</div>
                        <div class="chart-change positive" style="font-size: 0.7rem; display: flex; align-items: center; gap: 0.2rem; color: #10b981;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M7 14l5-5 5 5z"/>
                            </svg>
                            <span id="classes-change">+0%</span>
                        </div>
                    </div>
                    
                    <!-- Total Cancellations Chart -->
                    <div class="chart-card" style="background: white; border-radius: 8px; padding: 0.75rem; box-shadow: 0 2px 6px rgba(0,0,0,0.05); border: 1px solid #e0e6ed; transition: transform 0.2s ease, box-shadow 0.2s ease;">
                        <div class="chart-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span class="chart-title" style="font-size: 0.75rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">Cancellations</span>
                            <div class="chart-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626); width: 24px; height: 24px; border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="white">
                                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                                </svg>
                            </div>
                        </div>
                        <div class="chart-value" id="total-cancellations" style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.2rem;">0</div>
                        <div class="chart-change negative" style="font-size: 0.7rem; display: flex; align-items: center; gap: 0.2rem; color: #ef4444;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M7 10l5 5 5-5z"/>
                            </svg>
                            <span id="cancellations-change">-0%</span>
                        </div>
                    </div>
                    
                    <!-- Total Stars Received Chart -->
                    <div class="chart-card" style="background: white; border-radius: 8px; padding: 0.75rem; box-shadow: 0 2px 6px rgba(0,0,0,0.05); border: 1px solid #e0e6ed; transition: transform 0.2s ease, box-shadow 0.2s ease;">
                        <div class="chart-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span class="chart-title" style="font-size: 0.75rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">Stars Received</span>
                            <div class="chart-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706); width: 24px; height: 24px; border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="white">
                                    <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                                </svg>
                            </div>
                        </div>
                        <div class="chart-value" id="total-stars" style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.2rem;">0</div>
                        <div class="chart-change positive" style="font-size: 0.7rem; display: flex; align-items: center; gap: 0.2rem; color: #10b981;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M7 14l5-5 5 5z"/>
                            </svg>
                            <span id="stars-change">+0%</span>
                        </div>
                    </div>

                    <!-- Average Rating Chart -->
                    <div class="chart-card" style="background: white; border-radius: 8px; padding: 0.75rem; box-shadow: 0 2px 6px rgba(0,0,0,0.05); border: 1px solid #e0e6ed; transition: transform 0.2s ease, box-shadow 0.2s ease;">
                        <div class="chart-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span class="chart-title" style="font-size: 0.75rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">Average Rating</span>
                            <div class="chart-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); width: 24px; height: 24px; border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="white">
                                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                </svg>
                            </div>
                        </div>
                        <div class="chart-value" id="average-rating" style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.2rem;">0.0</div>
                        <div class="chart-change positive" style="font-size: 0.7rem; display: flex; align-items: center; gap: 0.2rem; color: #10b981;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M7 14l5-5 5 5z"/>
                            </svg>
                            <span>‚≠ê</span>
                        </div>
                    </div>
                </div>
                
                <!-- Badges Section -->
                <div class="badges-section" id="badges-section">
                    <div class="badges-header">
                        <h2>üèÜ Achievement Badges</h2>
                        <p>Earn badges by demonstrating excellence in teaching!</p>
                    </div>
                    <div class="badges-grid" id="badges-grid"></div>
                </div>
                
                <!-- Attendance Analysis Section -->
                <div class="attendance-analysis-section">
                    <h2 class="section-title">üìä Attendance Analysis</h2>
                    
                    <!-- Stats Grid -->
                    <div class="stats-grid" id="stats-grid"></div>
                    
                    <!-- Metrics Section -->
                    <div class="metrics-section">
                        <h2 style="margin-top: 0; color: #667eea;">Performance Metrics</h2>
                        <div class="metrics-grid" id="metrics-grid"></div>
                    </div>
                    
                    <!-- Breakdown Sections -->
                    <div id="breakdown-sections"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Setup sidebar navigation links
        function setupSidebarNavigation() {
            const menuItems = document.querySelectorAll('.remoed-menu li');
            menuItems.forEach(item => {
                const text = item.textContent.trim();
                
                // Remove existing onclick and add new one to ensure it works
                item.onclick = null;
                
                if (text.includes('Dashboard')) {
                    item.onclick = () => window.location.href = 'teacher-dashboard.html';
                    item.style.cursor = 'pointer';
                } else if (text.includes('Class Schedule')) {
                    item.onclick = () => window.location.href = 'teacher-class-table.html';
                    item.style.cursor = 'pointer';
                } else if (text.includes('Class Configuration')) {
                    item.onclick = () => window.location.href = 'teacher-open-class.html';
                    item.style.cursor = 'pointer';
                } else if (text.includes('Device Check')) {
                    item.onclick = () => window.location.href = 'device-check.html';
                    item.style.cursor = 'pointer';
                } else if (text.includes('Teaching Fee')) {
                    item.onclick = () => window.location.href = 'teacher-service-fee.html';
                    item.style.cursor = 'pointer';
                } else if (text.includes('Performance Indicator')) {
                    item.onclick = () => window.location.href = 'teacher-performance-indicator.html';
                    item.style.cursor = 'pointer';
                } else if (text.includes('Professional Development')) {
                    item.onclick = () => window.location.href = 'teacher-professional-development.html';
                    item.style.cursor = 'pointer';
                } else if (text.includes('Profile') && !text.includes('Support')) {
                    item.onclick = () => window.location.href = 'teacher-profile.html';
                    item.style.cursor = 'pointer';
                } else if (text.includes('Logout')) {
                    item.onclick = () => {
                        localStorage.clear();
                        window.location.href = 'teacher-login.html';
                    };
                    item.style.cursor = 'pointer';
                }
            });
        }
        
        // Shared function to update sidebar username and profile
        async function updateSidebarProfile() {
            const username = localStorage.getItem('remoedUsername') || 'Teacher';
            const teacherId = localStorage.getItem('teacherId');
            const token = localStorage.getItem('token');
            
            // Get username element (could be remoed-username or sidebar-email depending on page)
            const usernameEl = document.getElementById('remoed-username') || document.getElementById('sidebar-email');
            const avatarTextEl = document.getElementById('avatar-text');
            const profileImageEl = document.getElementById('profile-image');
            
            // Set initial values
            if (usernameEl) {
                usernameEl.textContent = 'Loading...';
            }
            if (avatarTextEl) {
                avatarTextEl.textContent = username[0].toUpperCase();
            }
            
            // Load profile to get firstName
            if (token && teacherId) {
                try {
                    const response = await fetch('/api/teacher/profile', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.profile) {
                            const firstName = data.profile.firstName || username;
                            
                            // Update username with "Hi, [FirstName]" format
                            if (usernameEl) {
                                usernameEl.textContent = `Hi, ${firstName}`;
                            }
                            
                            // Update avatar
                            if (data.profile.profilePicture) {
                                if (profileImageEl) {
                                    profileImageEl.src = data.profile.profilePicture;
                                    profileImageEl.style.display = 'block';
                                }
                                if (avatarTextEl) {
                                    avatarTextEl.style.display = 'none';
                                }
                            } else {
                                if (profileImageEl) {
                                    profileImageEl.style.display = 'none';
                                }
                                if (avatarTextEl) {
                                    avatarTextEl.textContent = firstName[0].toUpperCase();
                                    avatarTextEl.style.display = 'inline-block';
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error loading profile:', error);
                    // Fallback to username
                    if (usernameEl) {
                        usernameEl.textContent = `Hi, ${username}`;
                    }
                }
            } else {
                // Fallback if no token
                if (usernameEl) {
                    usernameEl.textContent = `Hi, ${username}`;
                }
            }
        }
        
        // Load sidebar
        fetch('teacher-dashboard.html')
            .then(r => r.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const sidebar = doc.querySelector('.remoed-sidebar');
                if (sidebar) {
                    document.getElementById('sidebar').innerHTML = sidebar.innerHTML;

                    // Setup all navigation links
                    setupSidebarNavigation();

                    // Update active menu item - remove active from all first, then add to current page only
                    const menuItems = document.querySelectorAll('.remoed-menu li');
                    menuItems.forEach(item => {
                        item.classList.remove('active');
                        if (item.textContent.includes('Performance Indicator')) {
                            item.classList.add('active');
                        }
                    });
                    
                    // Update sidebar profile (username and picture)
                    updateSidebarProfile();
                }
            })
            .catch(err => console.error('Error loading sidebar:', err));
        
        let currentPeriod = 'weekly';
        
        // Period selector
        document.querySelectorAll('.period-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentPeriod = btn.dataset.period;
                
                if (currentPeriod === 'custom') {
                    const startDate = prompt('Enter start date (YYYY-MM-DD):');
                    const endDate = prompt('Enter end date (YYYY-MM-DD):');
                    if (startDate && endDate) {
                        loadAnalysis({ startDate, endDate });
                    }
                } else {
                    loadAnalysis({ periodType: currentPeriod });
                }
            });
        });
        
        // Load chart data (performance metrics cards)
        async function loadChartData() {
            try {
                const teacherId = localStorage.getItem('teacherId');
                if (!teacherId) return;
                
                // Load dashboard statistics
                const response = await fetch(`/api/teacher/dashboard-stats?teacherId=${teacherId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update chart values with null checks
                    const totalClassesEl = document.getElementById('total-classes');
                    const totalCancellationsEl = document.getElementById('total-cancellations');
                    const totalStarsEl = document.getElementById('total-stars');
                    const averageRatingEl = document.getElementById('average-rating');
                    const classesChangeEl = document.getElementById('classes-change');
                    const cancellationsChangeEl = document.getElementById('cancellations-change');
                    const starsChangeEl = document.getElementById('stars-change');
                    
                    if (totalClassesEl) totalClassesEl.textContent = data.totalClasses || 0;
                    if (totalCancellationsEl) totalCancellationsEl.textContent = data.totalCancellations || 0;
                    if (totalStarsEl) totalStarsEl.textContent = data.totalStars || 0;
                    if (averageRatingEl) averageRatingEl.textContent = data.averageRating || 0.0;
                    if (classesChangeEl) classesChangeEl.textContent = `${data.classesChange || 0}%`;
                    if (cancellationsChangeEl) cancellationsChangeEl.textContent = `${data.cancellationsChange || 0}%`;
                    if (starsChangeEl) starsChangeEl.textContent = `${data.starsChange || 0}%`;
                }
            } catch (error) {
                console.error('Error loading chart data:', error);
            }
        }
        
        async function loadAnalysis(params = {}) {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const content = document.getElementById('content');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            content.style.display = 'none';
            
            try {
                const teacherId = localStorage.getItem('teacherId');
                const token = localStorage.getItem('token');
                
                if (!teacherId || !token) {
                    throw new Error('Please log in to view performance indicators');
                }
                
                const queryParams = new URLSearchParams({
                    teacherId,
                    ...params
                });
                
                // Fetch attendance analysis
                const response = await fetch(`/api/teacher/attendance-analysis?${queryParams}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to load performance indicators');
                }
                
                const data = await response.json();
                if (data.success && data.analysis) {
                    // Fetch additional data for badges (slots, feedback)
                    const badgeData = await fetchBadgeData(teacherId, token, params, data.analysis);
                    displayAnalysis(data.analysis, badgeData);
                } else {
                    throw new Error('Invalid response from server');
                }
            } catch (err) {
                error.textContent = err.message;
                error.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        }
        
        async function fetchBadgeData(teacherId, token, params, analysis) {
            try {
                // Use analysis period dates if available
                const periodStart = analysis?.periodStart ? new Date(analysis.periodStart) : new Date();
                const periodEnd = analysis?.periodEnd ? new Date(analysis.periodEnd) : new Date();
                const now = new Date();
                
                // Fetch slots to check for weekends
                let weekStr = now.toISOString().split('T')[0];
                if (params.periodType === 'weekly') {
                    const dayOfWeek = now.getDay();
                    const daysToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                    const weekStart = new Date(now);
                    weekStart.setDate(now.getDate() - daysToMonday);
                    weekStr = weekStart.toISOString().split('T')[0];
                }
                
                const slotsResponse = await fetch(`/api/teacher/slots?teacherId=${teacherId}&week=${weekStr}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                }).catch(() => null);
                
                let slots = [];
                if (slotsResponse && slotsResponse.ok) {
                    const slotsData = await slotsResponse.json().catch(() => ({ slots: [] }));
                    slots = slotsData.slots || [];
                }
                
                // Try to fetch feedback/ratings - if endpoint doesn't exist, use empty array
                const feedbackResponse = await fetch(`/api/feedback?teacherId=${teacherId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                }).catch(() => null);
                
                let feedbacks = [];
                if (feedbackResponse && feedbackResponse.ok) {
                    const feedbackData = await feedbackResponse.json().catch(() => ({ feedback: [] }));
                    feedbacks = feedbackData.feedback || feedbackData || [];
                }
                
                // Extract bookings from breakdown for rebooking analysis
                const allBookings = analysis?.breakdown ? [
                    ...(analysis.breakdown.completed || []),
                    ...(analysis.breakdown.cancelled || []),
                    ...(analysis.breakdown.teacherAbsent || []),
                    ...(analysis.breakdown.studentAbsent || [])
                ] : [];
                
                return {
                    periodStart,
                    periodEnd,
                    feedback: { feedback: Array.isArray(feedbacks) ? feedbacks : [] },
                    slots: { slots: slots },
                    bookings: allBookings
                };
            } catch (err) {
                console.error('Error fetching badge data:', err);
                return { 
                    periodStart: new Date(), 
                    periodEnd: new Date(), 
                    feedback: { feedback: [] }, 
                    slots: { slots: [] },
                    bookings: []
                };
            }
        }
        
        function calculateBadges(analysis, badgeData) {
            const badges = [];
            const periodType = analysis.periodType || 'weekly';
            const isMonthly = periodType === 'monthly';
            const isWeekly = periodType === 'weekly';
            
            // Get feedback data
            const feedbacks = badgeData?.feedback?.feedback || [];
            const ratings = feedbacks.map(f => f.rating || 0).filter(r => r > 0);
            const avgRating = ratings.length > 0 ? ratings.reduce((a, b) => a + b, 0) / ratings.length : 0;
            const allFiveStars = ratings.length > 0 && ratings.every(r => r === 5);
            
            // Get slots data
            const slots = badgeData?.slots?.slots || [];
            const weekendSlots = slots.filter(slot => {
                const date = new Date(slot.date);
                const day = date.getDay();
                return day === 0 || day === 6; // Saturday or Sunday
            });
            
            // Calculate weekly bookings
            const weeklyBookings = isWeekly ? analysis.totalScheduled : 0;
            const monthlyBookings = isMonthly ? analysis.totalScheduled : 0;
            
            // Badge 1: No Late in a Month
            if (isMonthly && analysis.lateArrivals === 0) {
                badges.push({
                    id: 'no-late-month',
                    name: 'Punctual Pro',
                    icon: '‚è∞',
                    description: 'No late arrivals this month',
                    earned: true,
                    progress: 100
                });
            } else if (isMonthly) {
                badges.push({
                    id: 'no-late-month',
                    name: 'Punctual Pro',
                    icon: '‚è∞',
                    description: 'No late arrivals this month',
                    earned: false,
                    progress: Math.max(0, 100 - (analysis.lateArrivals / analysis.totalScheduled * 100))
                });
            }
            
            // Badge 2: Completed Most Bookings
            const completionRate = analysis.totalScheduled > 0 ? (analysis.completedClasses / analysis.totalScheduled) * 100 : 0;
            if (completionRate >= 98) {
                badges.push({
                    id: 'completion-master',
                    name: 'Completion Master',
                    icon: '‚úÖ',
                    description: 'Completed 98%+ of bookings',
                    earned: true,
                    progress: 100
                });
            } else {
                badges.push({
                    id: 'completion-master',
                    name: 'Completion Master',
                    icon: '‚úÖ',
                    description: 'Complete 98%+ of bookings',
                    earned: false,
                    progress: completionRate
                });
            }
            
            // Badge 3: No Cancellation
            // Only award if teacher has had classes AND no cancellations
            if (analysis.totalScheduled > 0 && analysis.cancellations === 0) {
                badges.push({
                    id: 'no-cancellation',
                    name: 'Reliable Teacher',
                    icon: 'üéØ',
                    description: 'No cancellations',
                    earned: true,
                    progress: 100
                });
            } else {
                badges.push({
                    id: 'no-cancellation',
                    name: 'Reliable Teacher',
                    icon: 'üéØ',
                    description: 'No cancellations',
                    earned: false,
                    progress: analysis.totalScheduled > 0 ? Math.max(0, 100 - (analysis.cancellations / analysis.totalScheduled * 100)) : 0
                });
            }
            
            // Badge 4: No Absent
            // Only award if teacher has had classes AND no absences
            if (analysis.totalScheduled > 0 && analysis.teacherAbsences === 0) {
                badges.push({
                    id: 'no-absent',
                    name: 'Perfect Attendance',
                    icon: 'üåü',
                    description: 'No absences',
                    earned: true,
                    progress: 100
                });
            } else {
                badges.push({
                    id: 'no-absent',
                    name: 'Perfect Attendance',
                    icon: 'üåü',
                    description: 'No absences',
                    earned: false,
                    progress: analysis.totalScheduled > 0 ? Math.max(0, 100 - (analysis.teacherAbsences / analysis.totalScheduled * 100)) : 0
                });
            }
            
            // Badge 5-8: Booking Milestones (Weekly)
            if (isWeekly) {
                const milestones = [
                    { count: 20, name: 'Rising Star', icon: '‚≠ê' },
                    { count: 40, name: 'Super Teacher', icon: 'üî•' },
                    { count: 60, name: 'Elite Educator', icon: 'üíé' },
                    { count: 100, name: 'Teaching Legend', icon: 'üëë' }
                ];
                
                milestones.forEach(milestone => {
                    if (weeklyBookings >= milestone.count) {
                        badges.push({
                            id: `bookings-${milestone.count}`,
                            name: milestone.name,
                            icon: milestone.icon,
                            description: `${milestone.count}+ bookings this week`,
                            earned: true,
                            progress: 100
                        });
                    } else {
                        badges.push({
                            id: `bookings-${milestone.count}`,
                            name: milestone.name,
                            icon: milestone.icon,
                            description: `Reach ${milestone.count} bookings/week`,
                            earned: false,
                            progress: (weeklyBookings / milestone.count) * 100
                        });
                    }
                });
            }
            
            // Badge 9: More than 100 bookings a week
            if (isWeekly && weeklyBookings > 100) {
                badges.push({
                    id: 'over-100-week',
                    name: 'Ultra Performer',
                    icon: 'üöÄ',
                    description: '100+ bookings this week',
                    earned: true,
                    progress: 100
                });
            } else if (isWeekly) {
                badges.push({
                    id: 'over-100-week',
                    name: 'Ultra Performer',
                    icon: 'üöÄ',
                    description: 'Reach 100+ bookings/week',
                    earned: false,
                    progress: Math.min(100, (weeklyBookings / 100) * 100)
                });
            }
            
            // Badge 10: Open Slots on Weekends
            if (weekendSlots.length > 0) {
                badges.push({
                    id: 'weekend-warrior',
                    name: 'Weekend Warrior',
                    icon: 'üèãÔ∏è',
                    description: 'Opens slots on weekends',
                    earned: true,
                    progress: 100
                });
            } else {
                badges.push({
                    id: 'weekend-warrior',
                    name: 'Weekend Warrior',
                    icon: 'üèãÔ∏è',
                    description: 'Open slots on weekends',
                    earned: false,
                    progress: 0
                });
            }
            
            // Badge 11: Always Got 5 Stars
            if (allFiveStars && ratings.length >= 10) {
                badges.push({
                    id: 'five-star-master',
                    name: 'Five Star Master',
                    icon: '‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê',
                    description: 'All 5-star ratings (10+ reviews)',
                    earned: true,
                    progress: 100
                });
            } else if (ratings.length > 0) {
                badges.push({
                    id: 'five-star-master',
                    name: 'Five Star Master',
                    icon: '‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê',
                    description: 'Get all 5-star ratings (10+ reviews)',
                    earned: false,
                    progress: (ratings.filter(r => r === 5).length / Math.max(10, ratings.length)) * 100
                });
            } else {
                badges.push({
                    id: 'five-star-master',
                    name: 'Five Star Master',
                    icon: '‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê',
                    description: 'Get all 5-star ratings',
                    earned: false,
                    progress: 0
                });
            }
            
            // Badge 12: Monthly Class Achievement (for promotion)
            if (isMonthly && monthlyBookings >= 200) {
                badges.push({
                    id: 'promotion-ready',
                    name: 'Promotion Ready',
                    icon: 'üìà',
                    description: '200+ classes this month',
                    earned: true,
                    progress: 100
                });
            } else if (isMonthly) {
                badges.push({
                    id: 'promotion-ready',
                    name: 'Promotion Ready',
                    icon: 'üìà',
                    description: 'Reach 200+ classes/month',
                    earned: false,
                    progress: Math.min(100, (monthlyBookings / 200) * 100)
                });
            }
            
            // Badge 13: Students Love Them (High Rebooking Rate)
            const bookings = badgeData?.bookings || [];
            const uniqueStudents = new Set(bookings.map(b => b.studentId).filter(Boolean));
            const totalBookings = bookings.length;
            const rebookingRate = uniqueStudents.size > 0 ? (totalBookings / uniqueStudents.size) : 0;
            
            if (rebookingRate >= 3 && totalBookings >= 20) {
                badges.push({
                    id: 'student-favorite',
                    name: 'Student Favorite',
                    icon: '‚ù§Ô∏è',
                    description: 'High student rebooking rate',
                    earned: true,
                    progress: 100
                });
            } else if (totalBookings > 0) {
                badges.push({
                    id: 'student-favorite',
                    name: 'Student Favorite',
                    icon: '‚ù§Ô∏è',
                    description: 'High student rebooking rate',
                    earned: false,
                    progress: Math.min(100, (rebookingRate / 3) * 100)
                });
            } else {
                badges.push({
                    id: 'student-favorite',
                    name: 'Student Favorite',
                    icon: '‚ù§Ô∏è',
                    description: 'High student rebooking rate',
                    earned: false,
                    progress: 0
                });
            }
            
            // Badge 14: Good Pronunciation (would need feedback analysis)
            badges.push({
                id: 'pronunciation-pro',
                name: 'Pronunciation Pro',
                icon: 'üó£Ô∏è',
                description: 'Excellent pronunciation',
                earned: false, // Would need feedback text analysis
                progress: 0
            });
            
            // Badge 15: Grammar Expert (would need feedback analysis)
            badges.push({
                id: 'grammar-expert',
                name: 'Grammar Expert',
                icon: 'üìö',
                description: 'Strong grammar skills',
                earned: false, // Would need feedback text analysis
                progress: 0
            });
            
            // Badge 16: Energetic in Class (would need feedback analysis)
            badges.push({
                id: 'energetic',
                name: 'Energetic Teacher',
                icon: '‚ö°',
                description: 'Always energetic in class',
                earned: false, // Would need feedback text analysis
                progress: 0
            });
            
            // Badge 17: Smiling Face (would need feedback analysis)
            badges.push({
                id: 'smiling-face',
                name: 'Smiling Face',
                icon: 'üòä',
                description: 'Positive and cheerful',
                earned: false, // Would need feedback text analysis
                progress: 0
            });
            
            // Badge 18: Knowledgeable (would need feedback analysis)
            badges.push({
                id: 'knowledgeable',
                name: 'Knowledgeable',
                icon: 'üß†',
                description: 'Deep subject knowledge',
                earned: false, // Would need feedback text analysis
                progress: 0
            });
            
            return badges;
        }
        
        function displayBadges(badges) {
            const badgesGrid = document.getElementById('badges-grid');
            badgesGrid.innerHTML = badges.map(badge => `
                <div class="badge-card ${badge.earned ? 'earned' : 'locked'}" title="${badge.description}">
                    <span class="badge-icon">${badge.icon}</span>
                    <div class="badge-name">${badge.name}</div>
                    <div class="badge-description">${badge.description}</div>
                    ${badge.earned ? 
                        `<div class="badge-status earned">‚úì Earned</div>` :
                        `<div class="badge-status locked">Locked</div>
                         <div class="badge-progress">
                             <div class="badge-progress-bar" style="width: ${Math.min(100, badge.progress)}%"></div>
                         </div>`
                    }
                </div>
            `).join('');
        }
        
        function displayAnalysis(analysis, badgeData) {
            const content = document.getElementById('content');
            content.style.display = 'block';
            
            // Calculate and display badges
            const badges = calculateBadges(analysis, badgeData);
            displayBadges(badges);
            
            // Display stats
            const statsGrid = document.getElementById('stats-grid');
            statsGrid.innerHTML = `
                <div class="stat-card completed">
                    <div class="stat-label">Completed Classes</div>
                    <div class="stat-value">${analysis.completedClasses}</div>
                </div>
                <div class="stat-card absent">
                    <div class="stat-label">Teacher Absences</div>
                    <div class="stat-value">${analysis.teacherAbsences}</div>
                </div>
                <div class="stat-card absent">
                    <div class="stat-label">Student Absences</div>
                    <div class="stat-value">${analysis.studentAbsences}</div>
                </div>
                <div class="stat-card cancelled">
                    <div class="stat-label">Cancellations</div>
                    <div class="stat-value">${analysis.cancellations}</div>
                </div>
                <div class="stat-card late">
                    <div class="stat-label">Late Arrivals</div>
                    <div class="stat-value">${analysis.lateArrivals}</div>
                </div>
                <div class="stat-card system-issue">
                    <div class="stat-label">System Issues</div>
                    <div class="stat-value">${analysis.systemIssues}</div>
                </div>
                <div class="stat-card teacher-issue">
                    <div class="stat-label">Teacher Issues</div>
                    <div class="stat-value">${analysis.teacherIssues}</div>
                </div>
                <div class="stat-card student-issue">
                    <div class="stat-label">Student Issues</div>
                    <div class="stat-value">${analysis.studentIssues}</div>
                </div>
            `;
            
            // Display metrics
            const metricsGrid = document.getElementById('metrics-grid');
            metricsGrid.innerHTML = `
                <div class="metric-item">
                    <div class="metric-label">Total Scheduled</div>
                    <div class="metric-value">${analysis.totalScheduled}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Attendance Rate</div>
                    <div class="metric-value">${analysis.attendanceRate}%</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Punctuality Rate</div>
                    <div class="metric-value">${analysis.punctualityRate}%</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Total Late Minutes</div>
                    <div class="metric-value">${analysis.totalLateMinutes}</div>
                </div>
            `;
            
            // Display breakdowns
            const breakdownSections = document.getElementById('breakdown-sections');
            breakdownSections.innerHTML = '';
            
            // Helper function to create breakdown section
            function createBreakdownSection(title, items, className) {
                if (items.length === 0) return '';
                
                return `
                    <div class="breakdown-section">
                        <div class="breakdown-header">${title} (${items.length})</div>
                        <div class="breakdown-list">
                            ${items.map(item => {
                                const date = new Date(item.date);
                                const dateStr = date.toLocaleDateString('en-US', { 
                                    weekday: 'short', 
                                    year: 'numeric', 
                                    month: 'short', 
                                    day: 'numeric' 
                                });
                                return `
                                    <div class="breakdown-item">
                                        <div>
                                            <div class="breakdown-date">${dateStr}</div>
                                            <div class="breakdown-time">${item.time || ''} ${item.lateMinutes ? `(${item.lateMinutes} min late)` : ''} ${item.reason ? `- ${item.reason}` : ''}</div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            
            breakdownSections.innerHTML = 
                createBreakdownSection('Completed Classes', analysis.breakdown.completed, 'completed') +
                createBreakdownSection('Teacher Absences', analysis.breakdown.teacherAbsent, 'absent') +
                createBreakdownSection('Student Absences', analysis.breakdown.studentAbsent, 'absent') +
                createBreakdownSection('Cancellations', analysis.breakdown.cancelled, 'cancelled') +
                createBreakdownSection('Late Arrivals', analysis.breakdown.late, 'late') +
                createBreakdownSection('System Issues', analysis.breakdown.systemIssues, 'system-issue') +
                createBreakdownSection('Teacher Issues', analysis.breakdown.teacherIssues, 'teacher-issue') +
                createBreakdownSection('Student Issues', analysis.breakdown.studentIssues, 'student-issue');
        }
        
        // Load initial analysis
        // Load chart data and analysis on page load
        loadChartData();
        loadAnalysis({ periodType: 'weekly' });
        
        // Refresh chart data every 5 minutes
        setInterval(() => {
            loadChartData();
        }, 5 * 60 * 1000);
    </script>
</body>
</html>
