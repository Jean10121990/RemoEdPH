<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Profile - RemoEdPH</title>
    <link rel="stylesheet" href="modern-styles.css">
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: #f6fbff; 
            margin: 0;
            padding: 0;
            font-size: 12px;
        }
        
        .profile-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 5px;
        }
        
        .profile-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 5px;
            margin-top: 5px;
        }
        
        .profile-sidebar {
            background: white;
            border-radius: 8px;
            padding: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            height: fit-content;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            min-width: 120px;
        }
        
        .profile-main {
            background: white;
            border-radius: 8px;
            padding: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #1ca7e7;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .profile-avatar:hover {
            transform: scale(1.05);
        }
        
        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        
        .upload-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px;
            text-align: center;
            font-size: 0.8rem;
            transform: translateY(100%);
            transition: transform 0.3s;
        }
        
        .profile-avatar:hover .upload-overlay {
            transform: translateY(0);
        }
        
        .profile-name {
            font-size: 0.8rem;
            font-weight: bold;
            color: #1ca7e7;
            margin: 0;
            text-align: center;
        }
        
        .profile-email {
            color: #666;
            margin: 0;
            font-size: 0.7rem;
            text-align: center;
        }
        
        .back-btn {
            background: #1ca7e7;
            color: white;
            border: none;
            padding: 3px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 3px;
            transition: background 0.2s;
            font-size: 0.7rem;
        }
        
        .back-btn:hover {
            background: #168fc1;
        }
        
        .section-title {
            font-size: 0.8rem;
            font-weight: bold;
            color: #1ca7e7;
            margin-bottom: 3px;
            border-bottom: 1px solid #e6f0fa;
            padding-bottom: 2px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 4px;
        }
        
        .form-group {
            margin-bottom: 3px;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .form-label {
            display: block;
            margin-bottom: 1px;
            font-weight: 600;
            color: #333;
            font-size: 0.7rem;
        }
        
        .form-input {
            width: 100%;
            padding: 3px;
            border: 1px solid #e0e6ed;
            border-radius: 6px;
            font-size: 0.7rem;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #1ca7e7;
        }
        
                 .form-textarea {
             width: 100%;
             padding: 2px;
             border: 1px solid #e0e6ed;
             border-radius: 6px;
             font-size: 0.65rem;
             min-height: 60px;
             resize: vertical;
             font-family: inherit;
             transition: border-color 0.2s;
             box-sizing: border-box;
         }
        
        .form-textarea:focus {
            outline: none;
            border-color: #1ca7e7;
        }
        
        .file-upload {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }
        
        .file-upload input[type=file] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-upload-label {
            display: block;
            padding: 4px;
            border: 1px dashed #1ca7e7;
            border-radius: 6px;
            text-align: center;
            color: #1ca7e7;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 0.7rem;
        }
        
        .file-upload:hover .file-upload-label {
            background: #f0f8ff;
            border-color: #168fc1;
        }
        
        .save-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            transition: background 0.2s;
            margin-top: 4px;
        }
        
        .save-btn:hover {
            background: #45a049;
        }
        
        .save-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .edit-btn {
            background: #1ca7e7;
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            transition: background 0.2s;
            margin-top: 4px;
            margin-right: 8px;
        }
        
        .edit-btn:hover {
            background: #168fc1;
        }
        
        .cancel-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            transition: background 0.2s;
            margin-top: 4px;
            margin-right: 8px;
        }
        
        .cancel-btn:hover {
            background: #5a6268;
        }
        
        .form-input:disabled, .form-textarea:disabled, .form-input[readonly], .form-textarea[readonly] {
            background-color: #f8f9fa;
            color: #495057;
            cursor: not-allowed;
        }
        
        .form-help {
            color: #6c757d;
            font-size: 0.7rem;
            margin-top: 2px;
            display: block;
        }
        
        .file-upload.disabled {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .education-item {
            background: #f8f9fa;
            border: 1px solid #e0e6ed;
            border-radius: 6px;
            padding: 3px;
            margin-bottom: 3px;
        }
        
        .education-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2px;
        }
        
        .work-experience-item {
            background: #f8f9fa;
            border: 1px solid #e0e6ed;
            border-radius: 6px;
            padding: 3px;
            margin-bottom: 3px;
        }
        
        .work-experience-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2px;
        }
        
        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 1px 4px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.6rem;
        }
        
        .remove-btn:hover {
            background: #c82333;
        }
        
        .add-btn {
            background: #1ca7e7;
            color: white;
            border: none;
            padding: 3px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 3px;
            font-size: 0.7rem;
        }
        
                 .add-btn:hover {
             background: #168fc1;
         }
         
         /* Video Upload Styles */
         .video-upload-section {
             margin-top: 10px;
             width: 100%;
         }
         
         .video-upload-btn {
             display: flex;
             align-items: center;
             gap: 8px;
             padding: 8px 12px;
             background: #f8f9fa;
             border: 2px dashed #1ca7e7;
             border-radius: 8px;
             cursor: pointer;
             transition: all 0.2s;
             font-size: 0.7rem;
             color: #1ca7e7;
             font-weight: 600;
             justify-content: center;
         }
         
         .video-upload-btn:hover {
             background: #eaf7ff;
             border-color: #168fc1;
         }
         
         .video-upload-btn svg {
             width: 16px;
             height: 16px;
         }
         
         .video-preview {
             margin-top: 8px;
             background: #f8f9fa;
             border-radius: 8px;
             padding: 8px;
             border: 1px solid #e0e6ed;
         }
         
         .video-info {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin-top: 6px;
             font-size: 0.65rem;
             color: #666;
         }
         
         .remove-video-btn {
             background: #dc3545;
             color: white;
             border: none;
             padding: 2px 6px;
             border-radius: 4px;
             cursor: pointer;
             font-size: 0.6rem;
         }
         
         .remove-video-btn:hover {
             background: #c82333;
         }
         
         .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            animation: fadeIn 0.5s ease-in;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Tab Styles */
        .tab-container {
            margin-bottom: 5px;
        }
        
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #e6f0fa;
            margin-bottom: 5px;
        }
        
        .tab-button {
            background: none;
            border: none;
            padding: 6px 12px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            position: relative;
        }
        
        .tab-button.active {
            color: #1ca7e7;
            border-bottom-color: #1ca7e7;
            background: #f8f9fa;
        }
        
        .tab-button:hover {
            color: #1ca7e7;
            background: #f0f8ff;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .file-preview {
            margin-top: 5px;
            max-width: 200px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .file-preview img {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .file-preview .file-info {
            background: #f8f9fa;
            padding: 3px 6px;
            font-size: 0.7rem;
            color: #666;
            border-top: 1px solid #e0e6ed;
        }
        
        @media (max-width: 768px) {
            .profile-grid {
                grid-template-columns: 1fr;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .tab-buttons {
                flex-direction: column;
            }
            
            .tab-button {
                text-align: left;
                border-bottom: 1px solid #e6f0fa;
            }
        }
    </style>
</head>
<body>
     <div class="profile-container">
         <button class="back-btn" onclick="window.location.href='teacher-dashboard.html'">‚Üê Back to Dashboard</button>
         
                 <div class="success-message" id="success-message" style="display: none;"></div>
        <div class="error-message" id="error-message">Error updating profile. Please try again.</div>
         
         <div class="profile-grid">
             <!-- Profile Sidebar -->
             <div class="profile-sidebar">
                                   <div class="profile-avatar" onclick="document.getElementById('profile-picture').click()">
                      <img id="avatar-preview" src="" alt="Profile Picture" style="display: none;">
                      <span id="avatar-initial">K</span>
                      <div class="upload-overlay">Click to upload photo</div>
                  </div>
                  <input type="file" id="profile-picture" accept="image/*" style="display: none;">
                 
                 <div class="profile-name" id="display-name">Kristine Personal</div>
                 <div class="profile-email" id="display-email">kjbflores@remoedph.com</div>
                 
                 <!-- Video Introduction Upload -->
                 <div class="video-upload-section">
                     <div class="video-upload-btn" onclick="document.getElementById('video-introduction').click()">
                         <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                             <path d="M23 7l-7 4 7 4V7z"/>
                             <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                         </svg>
                         <span>Upload Video Introduction</span>
                     </div>
                     <input type="file" id="video-introduction" accept="video/*" style="display: none;">
                     <div id="video-preview" class="video-preview" style="display: none;">
                         <video id="video-player" controls style="width: 100%; border-radius: 8px;">
                             <source src="" type="video/mp4">
                             Your browser does not support the video tag.
                         </video>
                         <div class="video-info">
                             <span id="video-name">No video selected</span>
                             <button type="button" class="remove-video-btn" onclick="removeVideo()">Remove</button>
                         </div>
                     </div>
                 </div>
             </div>
            
            <!-- Profile Main Content -->
            <div class="profile-main">
                <div id="profile-form">
                    <!-- Tab Navigation -->
                    <div class="tab-container">
                        <div class="tab-buttons">
                            <button type="button" class="tab-button active" onclick="showTab('personal')">Personal Information</button>
                            <button type="button" class="tab-button" onclick="showTab('education')">Education and Work Experience</button>
                            <button type="button" class="tab-button" onclick="showTab('documents')">Documents & IDs</button>
                            <button type="button" class="tab-button" onclick="showTab('settings')">Settings</button>
                        </div>
                    </div>
                    
                                         <!-- Personal Information Tab -->
                     <div id="personal-tab" class="tab-content active">
                         <div class="form-grid">
                             <div class="form-group">
                                 <label class="form-label">First Name *</label>
                                 <input type="text" class="form-input" id="firstname" name="firstname" required disabled>
                             </div>
                             <div class="form-group">
                                 <label class="form-label">Middle Name</label>
                                 <input type="text" class="form-input" id="middlename" name="middlename" disabled>
                             </div>
                             <div class="form-group">
                                 <label class="form-label">Last Name *</label>
                                 <input type="text" class="form-input" id="lastname" name="lastname" required disabled>
                             </div>
                            <div class="form-group">
                                <label class="form-label">Birthday</label>
                                <input type="date" class="form-input" id="birthday" name="birthday" disabled>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Gender</label>
                                <select class="form-input" id="gender" name="gender" disabled>
                                    <option value="">Select Gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Language</label>
                                <select class="form-input" id="language" name="language" disabled>
                                    <option value="">Select Language</option>
                                    <option value="English">English</option>
                                    <option value="Filipino">Filipino</option>
                                    <option value="Spanish">Spanish</option>
                                    <option value="Chinese">Chinese</option>
                                    <option value="Japanese">Japanese</option>
                                </select>
                            </div>
                                                         <div class="form-group full-width">
                                 <label class="form-label">Hobbies & Interests</label>
                                 <textarea class="form-textarea" id="hobbies" name="hobbies" rows="3" placeholder="e.g., Reading, Traveling, Music, Sports, Cooking..." disabled></textarea>
                             </div>
                            <div class="form-group full-width">
                                <label class="form-label">Address</label>
                                <textarea class="form-textarea" id="address" name="address" rows="1" disabled></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Contact Number</label>
                                <input type="tel" class="form-input" id="contact" name="contact" disabled>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email *</label>
                                <input type="email" class="form-input" id="email" name="email" required disabled>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Username *</label>
                                <input type="text" class="form-input" id="username" name="username" required disabled>
                                <small class="form-help">You can change your username to something more personal</small>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Emergency Contact</label>
                                <input type="tel" class="form-input" id="emergency-contact" name="emergency-contact" disabled>
                            </div>
                        </div>
                        
                                                 <div class="section-title">Professional Information</div>
                         <div class="form-group full-width">
                             <label class="form-label">Introduction</label>
                             <textarea class="form-textarea" id="introduction" name="introduction" rows="3" placeholder="Tell us about yourself, your teaching philosophy, and what makes you unique as an educator..." disabled></textarea>
                         </div>
                         <div class="form-group full-width">
                             <label class="form-label">Teaching Experience</label>
                             <textarea class="form-textarea" id="experience" name="experience" rows="3" placeholder="Describe your teaching experience, subjects taught, years of experience..." disabled></textarea>
                         </div>
                    </div>
                    
                    <!-- Education Tab -->
                    <div id="education-tab" class="tab-content">
                        <div class="section-title">Education Details</div>
                        <div id="education-container">
                            <!-- Education items will be added here -->
                        </div>
                        <button type="button" class="add-btn" id="add-education-btn" onclick="addEducationItem()" disabled>+ Add Education</button>
                        
                        <div class="section-title" style="margin-top: 30px;">Work Experience</div>
                        <div id="work-experience-container">
                            <!-- Work experience items will be added here -->
                        </div>
                        <button type="button" class="add-btn" id="add-work-experience-btn" onclick="addWorkExperienceItem()" disabled>+ Add Work Experience</button>
                    </div>
                    
                    <!-- Documents Tab -->
                    <div id="documents-tab" class="tab-content">
                        <div class="section-title">Documents & Certifications</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Diploma</label>
                                <div class="file-upload" id="diploma-upload">
                                    <input type="file" id="diploma" name="diploma" accept=".pdf,.jpg,.jpeg,.png" disabled>
                                    <label class="file-upload-label" for="diploma">üìÑ Upload Diploma</label>
                                </div>
                                <div class="file-preview" id="diploma-preview" style="display: none;">
                                    <img src="" alt="Diploma Preview">
                                    <div class="file-info">No file selected</div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Valid ID</label>
                                <div class="file-upload" id="valid-id-upload">
                                    <input type="file" id="valid-id" name="valid-id" accept=".pdf,.jpg,.jpeg,.png">
                                    <label class="file-upload-label" for="valid-id">üÜî Upload Valid ID</label>
                                </div>
                                <div class="file-preview" id="valid-id-preview" style="display: none;">
                                    <img src="" alt="Valid ID Preview">
                                    <div class="file-info">No file selected</div>
                                </div>
                            </div>

                        </div>
                    </div>
                    
                    <!-- Settings Tab -->
                    <div id="settings-tab" class="tab-content">
                        <div class="section-title">Account Settings</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Current Email</label>
                                <input type="email" class="form-input" id="current-email" name="current-email" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">New Email</label>
                                <input type="email" class="form-input" id="new-email" name="new-email" placeholder="Enter new email address">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Current Username</label>
                                <input type="text" class="form-input" id="current-username" name="current-username" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">New Username</label>
                                <input type="text" class="form-input" id="new-username" name="new-username" placeholder="Enter new username">
                            </div>
                        </div>
                        
                        <div class="section-title">Change Password</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Current Password</label>
                                <input type="password" class="form-input" id="current-password" name="current-password" placeholder="Enter current password">
                            </div>
                            <div class="form-group">
                                <label class="form-label">New Password</label>
                                <input type="password" class="form-input" id="new-password" name="new-password" placeholder="Enter new password">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Confirm New Password</label>
                                <input type="password" class="form-input" id="confirm-password" name="confirm-password" placeholder="Confirm new password">
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 8px; margin-top: 10px;">
                            <button type="button" class="save-btn" onclick="updateSettings()">Update Settings</button>
                            <button type="button" class="cancel-btn" onclick="resetSettingsForm()">Reset Form</button>
                            <button type="button" class="edit-btn" onclick="goToForgotPassword()">üîë Forgot Password</button>
                        </div>
                        
                        <div id="settings-message" style="margin-top: 10px;"></div>
                    </div>
                    
                    <div style="display: flex; gap: 8px; margin-top: 10px;">
                        <button type="button" class="edit-btn" id="edit-btn" onclick="enableEditing()">Edit Profile</button>
                        <button type="button" class="cancel-btn" id="cancel-btn" onclick="cancelEditing()" style="display: none;">Cancel</button>
                        <button type="button" class="save-btn" id="save-btn" style="display: none;">Save Profile</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Role-based access control
        const userType = localStorage.getItem('userType');
        if (userType !== 'teacher') {
            alert('Access denied. This page is for teachers only.');
            window.location.href = 'index.html';
        }

        let educationCounter = 0;
        let workExperienceCounter = 0;
        let isEditingProfile = false;

        document.addEventListener('DOMContentLoaded', function() {
            loadProfileData();
            setupFileUploads();
            setupFormSubmission();
        });

        function showTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab content
            const selectedTab = document.getElementById(tabName + '-tab');
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Add active class to clicked button
            const clickedButton = event.target;
            clickedButton.classList.add('active');
        }

                 function loadProfileData() {
             // Load profile data from API
             const token = localStorage.getItem('token');
             console.log('Token from localStorage:', token ? 'Present' : 'Missing');
             
             if (!token) {
                 showMessage('Authentication required. Please login again.', 'error');
                 return;
             }
            
                         fetch('/api/teacher/profile', {
                 method: 'GET',
                 headers: {
                     'Authorization': `Bearer ${token}`,
                     'Content-Type': 'application/json'
                 },
                 signal: AbortSignal.timeout(10000) // 10 second timeout
             })
             .then(response => {
                 console.log('Profile API response status:', response.status);
                 return response.json();
             })
             .then(data => {
                 console.log('Profile API response data:', data);
                 if (data.success && data.profile) {
                    const profile = data.profile;
                    
                                         // Set display values
                     const displayName = profile.fullname || `${profile.firstName || ''} ${profile.lastName || ''}`.trim() || profile.username || 'Teacher';
                     document.getElementById('display-name').textContent = displayName;
                     document.getElementById('display-email').textContent = profile.email || '';
                     
                     // Populate form fields
                     document.getElementById('firstname').value = profile.firstName || '';
                     document.getElementById('middlename').value = profile.middleName || '';
                     document.getElementById('lastname').value = profile.lastName || '';
                    document.getElementById('birthday').value = profile.birthday ? profile.birthday.split('T')[0] : '';
                    document.getElementById('gender').value = profile.gender || '';
                    document.getElementById('language').value = profile.language || '';
                    document.getElementById('hobbies').value = profile.hobbies || '';
                    document.getElementById('address').value = profile.address || '';
                    document.getElementById('contact').value = profile.contact || '';
                    document.getElementById('email').value = profile.email || '';
                    document.getElementById('username').value = profile.username || '';
                    document.getElementById('emergency-contact').value = profile.emergencyContact || '';
                    document.getElementById('introduction').value = profile.introduction || '';
                    document.getElementById('experience').value = profile.experience || '';
                    
                    // Load education items (only from real data, no mock/template rows)
                    const educationContainer = document.getElementById('education-container');
                    educationContainer.innerHTML = '';
                    educationCounter = 0;
                    if (profile.education && profile.education.length > 0) {
                        profile.education.forEach(edu => {
                            addEducationItem(edu);
                        });
                    }
                    
                    // Load work experience items (only from real data, no mock/template rows)
                    console.log('Loading work experience data:', profile.workExperience);
                    const workContainer = document.getElementById('work-experience-container');
                    workContainer.innerHTML = '';
                    workExperienceCounter = 0;
                    if (profile.workExperience && profile.workExperience.length > 0) {
                        profile.workExperience.forEach(work => {
                            console.log('Adding work experience item:', work);
                            addWorkExperienceItem(work);
                        });
                    }
                    
                                         // Load profile picture
                     if (profile.profilePicture) {
                         document.getElementById('avatar-preview').src = profile.profilePicture;
                         document.getElementById('avatar-preview').style.display = 'block';
                         document.getElementById('avatar-initial').style.display = 'none';
                     }
                     
                     // Load video introduction
                     if (profile.videoIntroduction) {
                         const videoPlayer = document.getElementById('video-player');
                         const videoSource = videoPlayer.querySelector('source');
                         videoSource.src = profile.videoIntroduction;
                         videoPlayer.load();
                         document.getElementById('video-name').textContent = profile.videoIntroductionFileName || 'Video Introduction';
                         document.getElementById('video-preview').style.display = 'block';
                     }
                    
                    // Load document previews
                    if (profile.documents) {
                        if (profile.documents.diploma) {
                            showDocumentPreview('diploma-preview', profile.documents.diploma, 'Diploma');
                        }
                        if (profile.documents.validId) {
                            showDocumentPreview('valid-id-preview', profile.documents.validId, 'Valid ID');
                        }
                    }
                    
                    // Populate settings fields
                    document.getElementById('current-email').value = profile.email || '';
                    document.getElementById('current-username').value = profile.username || '';
                } else {
                    showMessage('Failed to load profile data', 'error');
                }
            })
                         .catch(error => {
                 console.error('Error loading profile:', error);
                 if (error.name === 'AbortError') {
                     showMessage('Profile loading timed out. Please try again.', 'error');
                 } else {
                     showMessage('Error loading profile data: ' + error.message, 'error');
                 }
             });
        }
        
        function showDocumentPreview(previewId, fileData, fileName) {
            const preview = document.getElementById(previewId);
            const previewImg = preview.querySelector('img');
            const fileInfo = preview.querySelector('.file-info');
            
            if (fileData.startsWith('data:image/')) {
                previewImg.src = fileData;
                previewImg.style.display = 'block';
                fileInfo.textContent = fileName;
                preview.style.display = 'block';
            } else {
                previewImg.style.display = 'none';
                fileInfo.textContent = fileName;
                preview.style.display = 'block';
            }
        }

        function setupFileUploads() {
            // Profile picture upload
            document.getElementById('profile-picture').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        showMessage('Authentication required. Please login again.', 'error');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const fileData = e.target.result;
                        
                        // Show preview immediately
                        document.getElementById('avatar-preview').src = fileData;
                        document.getElementById('avatar-preview').style.display = 'block';
                        document.getElementById('avatar-initial').style.display = 'none';
                        
                        // Save to database
                        fetch('/api/teacher/profile', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                profilePicture: fileData
                            }),
                            signal: AbortSignal.timeout(15000) // 15 second timeout for file uploads
                        })
                        .then(response => {
                            console.log('Profile picture upload response status:', response.status);
                            return response.json();
                        })
                        .then(data => {
                            console.log('Profile picture upload response data:', data);
                            if (data.success) {
                                console.log('Profile picture updated successfully');
                                showMessage('Profile picture updated successfully!', 'success');
                            } else {
                                console.error('Profile picture update failed:', data.error);
                                showMessage('Failed to update profile picture: ' + (data.error || 'Unknown error'), 'error');
                            }
                        })
                        .catch(error => {
                            console.error('Error updating profile picture:', error);
                            showMessage('Error updating profile picture: ' + error.message, 'error');
                        });
                    };
                    reader.readAsDataURL(file);
                }
            });
            
                         // Document uploads with preview
             setupDocumentUpload('diploma', 'diploma-preview');
             setupDocumentUpload('valid-id', 'valid-id-preview');
             
             // Video introduction upload
             setupVideoUpload();
             
             // Test server connectivity
             testVideoUploadEndpoint();
        }
        
        function setupDocumentUpload(inputId, previewId) {
            const input = document.getElementById(inputId);
            const preview = document.getElementById(previewId);
            const previewImg = preview.querySelector('img');
            const fileInfo = preview.querySelector('.file-info');
            
            input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const token = localStorage.getItem('token');
                    console.log('Document upload - Token:', token ? 'Present' : 'Missing');
                    console.log('Document upload - File:', file.name, file.type, file.size);
                    
                    if (!token) {
                        showMessage('Authentication required. Please login again.', 'error');
                        return;
                    }
                    
                    // Check if it's an image file
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const fileData = e.target.result;
                            console.log('Document upload - File data length:', fileData.length);
                            
                            // Show preview immediately
                            previewImg.src = fileData;
                            previewImg.style.display = 'block';
                            fileInfo.textContent = file.name;
                            preview.style.display = 'block';
                            
                            // Save to database
                            const documentType = inputId; // 'diploma', 'certifications', 'valid-id'
                            let cleanDocumentType = documentType.replace('-', ''); // Remove hyphen for API
                            // Convert to camelCase for backend
                            if (cleanDocumentType === 'validid') {
                                cleanDocumentType = 'validId';
                            }
                            
                            console.log('Document upload - Document type:', cleanDocumentType);
                            console.log('Document upload - Request payload size:', JSON.stringify({
                                documentType: cleanDocumentType,
                                fileData: fileData.substring(0, 100) + '...' // Log first 100 chars
                            }).length);
                            
                            fetch('/api/teacher/upload-document', {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${token}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    documentType: cleanDocumentType,
                                    fileData: fileData
                                }),
                                signal: AbortSignal.timeout(15000) // 15 second timeout for file uploads
                            })
                            .then(response => {
                                console.log('Document upload response status:', response.status);
                                console.log('Document upload response headers:', response.headers);
                                return response.json();
                            })
                            .then(data => {
                                console.log('Document upload response data:', data);
                                if (data.success) {
                                    console.log('Document uploaded successfully');
                                    showMessage('Document uploaded successfully!', 'success');
                                } else {
                                    console.error('Document upload failed:', data.error);
                                    showMessage('Failed to upload document: ' + (data.error || 'Unknown error'), 'error');
                                }
                            })
                            .catch(error => {
                                console.error('Error uploading document:', error);
                                showMessage('Error uploading document: ' + error.message, 'error');
                            });
                        };
                        reader.readAsDataURL(file);
                    } else {
                        // For PDF or other files, show file info only
                        previewImg.style.display = 'none';
                        fileInfo.textContent = file.name;
                        preview.style.display = 'block';
                        
                        // Note: For non-image files, you might want to handle them differently
                        showMessage('Only image files are currently supported for preview', 'error');
                    }
                } else {
                    preview.style.display = 'none';
                }
            });
        }

        function setupFormSubmission() {
            // Add explicit event listener for save button
            document.getElementById('save-btn').addEventListener('click', function(e) {
                console.log('üîç Save button clicked');
                e.preventDefault();
                e.stopPropagation();
                console.log('üîç Save button event prevented, calling saveProfile');
                saveProfile();
            });
        }

        function addEducationItem(data = null) {
            const container = document.getElementById('education-container');
            const itemId = `education-${educationCounter++}`;
            const disabledAttr = isEditingProfile ? '' : 'disabled';
            
            const educationItem = document.createElement('div');
            educationItem.className = 'education-item';
            educationItem.id = itemId;
            
            educationItem.innerHTML = `
                <div class="education-header">
                    <strong>Education ${educationCounter}</strong>
                    <button type="button" class="remove-btn" onclick="removeEducationItem('${itemId}')">Remove</button>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Degree/Course</label>
                        <input type="text" class="form-input" name="degree" value="${data ? data.degree : ''}" placeholder="e.g., Bachelor of Education" ${disabledAttr}>
                    </div>
                    <div class="form-group">
                        <label class="form-label">School/University</label>
                        <input type="text" class="form-input" name="school" value="${data ? data.school : ''}" placeholder="e.g., University of the Philippines" ${disabledAttr}>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Year Graduated</label>
                        <input type="number" class="form-input" name="yearGraduated" value="${data ? data.yearGraduated : ''}" min="1950" max="2030" placeholder="e.g., 2020" ${disabledAttr}>
                    </div>
                    <div class="form-group">
                        <label class="form-label">GPA (Optional)</label>
                        <input type="number" class="form-input" name="gpa" value="${data ? data.gpa : ''}" step="0.01" min="1.0" max="4.0" placeholder="e.g., 3.5" ${disabledAttr}>
                    </div>
                </div>
            `;
            
            container.appendChild(educationItem);
        }

        function removeEducationItem(itemId) {
            const item = document.getElementById(itemId);
            if (item) {
                item.remove();
            }
        }

        function addWorkExperienceItem(data = null) {
            const container = document.getElementById('work-experience-container');
            const itemId = `work-experience-${workExperienceCounter++}`;
            const disabledAttr = isEditingProfile ? '' : 'disabled';
            
            const workExperienceItem = document.createElement('div');
            workExperienceItem.className = 'work-experience-item';
            workExperienceItem.id = itemId;
            
            workExperienceItem.innerHTML = `
                <div class="work-experience-header">
                    <strong>Work Experience ${workExperienceCounter}</strong>
                    <button type="button" class="remove-btn" onclick="removeWorkExperienceItem('${itemId}')">Remove</button>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Company</label>
                        <input type="text" class="form-input" name="company" value="${data ? data.company : ''}" placeholder="e.g., ABC Company" ${disabledAttr}>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Job Title</label>
                        <input type="text" class="form-input" name="jobTitle" value="${data ? data.jobTitle : ''}" placeholder="e.g., Software Engineer" ${disabledAttr}>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Duration</label>
                        <input type="text" class="form-input" name="duration" value="${data ? data.duration : ''}" placeholder="e.g., 2020-2023" ${disabledAttr}>
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Job Description</label>
                        <textarea class="form-textarea" name="jobDescription" rows="3" placeholder="Describe your role, responsibilities, and achievements..." ${disabledAttr}>${data ? data.jobDescription : ''}</textarea>
                    </div>
                </div>
            `;
            
            container.appendChild(workExperienceItem);
        }

        function removeWorkExperienceItem(itemId) {
            const item = document.getElementById(itemId);
            if (item) {
                item.remove();
            }
        }

        function saveProfile() {
            console.log('üîç saveProfile function called');
            const saveBtn = document.getElementById('save-btn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
            
            const token = localStorage.getItem('token');
            console.log('Profile save - Token:', token ? 'Present' : 'Missing');
            
            if (!token) {
                showMessage('Authentication required. Please login again.', 'error');
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Profile';
                return;
            }
            
            // Collect form data BEFORE disabling fields
            console.log('üîç Collecting form data...');
            // Since we no longer have a form, collect data directly from input elements
             const firstName = document.getElementById('firstname').value;
             const middleName = document.getElementById('middlename').value;
             const lastName = document.getElementById('lastname').value;
             const fullname = `${firstName} ${middleName} ${lastName}`.trim();
             
             const profileData = {
                 firstName: firstName,
                 middleName: middleName,
                 lastName: lastName,
                 fullname: fullname,
                birthday: document.getElementById('birthday').value,
                gender: document.getElementById('gender').value,
                language: document.getElementById('language').value,
                hobbies: document.getElementById('hobbies').value,
                address: document.getElementById('address').value,
                contact: document.getElementById('contact').value,
                email: document.getElementById('email').value,
                username: document.getElementById('username').value,
                emergencyContact: document.getElementById('emergency-contact').value,
                introduction: document.getElementById('introduction').value,
                experience: document.getElementById('experience').value,
                                 education: collectEducationData(),
                 workExperience: collectWorkExperienceData(),
                 profilePicture: document.getElementById('avatar-preview').src || null,
                 videoIntroduction: document.getElementById('video-player').querySelector('source').src || null,
                 videoIntroductionFileName: document.getElementById('video-name').textContent !== 'No video selected' ? document.getElementById('video-name').textContent : null,
                documents: {
                    diploma: document.getElementById('diploma-preview').style.display !== 'none' ? 
                        document.getElementById('diploma-preview').querySelector('img').src : null,
                    validId: document.getElementById('valid-id-preview').style.display !== 'none' ? 
                        document.getElementById('valid-id-preview').querySelector('img').src : null
                }
            };
            
            console.log('Saving profile data:', profileData);
            console.log('Work experience data being saved:', profileData.workExperience);
            console.log('firstName being saved:', profileData.firstName);
            console.log('Form firstName value:', document.getElementById('firstname').value);
            console.log('Form firstName disabled:', document.getElementById('firstname').disabled);
            console.log('email being saved:', profileData.email);
            console.log('Form email value:', document.getElementById('email').value);
            
            // Save to database
            fetch('/api/teacher/profile', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(profileData),
                signal: AbortSignal.timeout(15000) // 15 second timeout for profile save
            })
            .then(response => response.json())
            .then(data => {
                console.log('Profile update response:', data);
                if (data.success) {
                    // Update display
                    document.getElementById('display-name').textContent = profileData.fullname;
                    document.getElementById('display-email').textContent = profileData.email;
                    
                    // Update token and localStorage if username was changed
                    if (data.newToken) {
                        localStorage.setItem('token', data.newToken);
                        console.log('Token updated due to username change');
                        
                        // Update localStorage with new username
                        if (profileData.username) {
                            localStorage.setItem('remoedUsername', profileData.username);
                            console.log('LocalStorage username updated to:', profileData.username);
                        }
                    }
                    
                    // Always update sidebar first name in real-time if dashboard is open
                    if (profileData.firstName) {
                        updateSidebarUsername(profileData.firstName);
                        console.log('‚úÖ Sidebar update called with firstName:', profileData.firstName);
                    } else {
                        console.log('‚ùå No firstName found in profileData:', profileData);
                    }
                    
                    // Show success message without navigation
                    const successMessage = document.createElement('div');
                    successMessage.className = 'success-message';
                    successMessage.innerHTML = `
                        <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 5px; margin: 10px 0; border: 1px solid #c3e6cb;">
                            <h4>‚úÖ Profile Updated Successfully!</h4>
                            <p>Your profile has been updated successfully! The sidebar greeting has been updated.</p>
                        </div>
                    `;
                    
                    // Try to insert the message at the top of the form, or append to body if form not found
                    const form = document.getElementById('profile-form');
                    if (form) {
                        form.insertBefore(successMessage, form.firstChild);
                    } else {
                        // Fallback: append to body
                        document.body.insertBefore(successMessage, document.body.firstChild);
                    }
                    
                    // Scroll to top to show the message
                    window.scrollTo(0, 0);
                    
                    // Disable editing after successful save
                    const inputs = document.querySelectorAll('.form-input, .form-textarea');
                    inputs.forEach(input => input.disabled = true);
                    
                    const fileInputs = document.querySelectorAll('input[type="file"]');
                    fileInputs.forEach(input => input.disabled = true);
                    
                    document.getElementById('add-education-btn').disabled = true;
                    
                    const educationInputs = document.querySelectorAll('.education-item input, .education-item select');
                    educationInputs.forEach(input => input.disabled = true);
                    
                    // Show/hide buttons
                    document.getElementById('edit-btn').style.display = 'inline-block';
                    document.getElementById('cancel-btn').style.display = 'none';
                    document.getElementById('save-btn').style.display = 'none';
                } else {
                    showMessage(data.error || 'Failed to update profile', 'error');
                }
            })
            .catch(error => {
                console.error('Error saving profile:', error);
                if (error.name === 'AbortError') {
                    showMessage('Profile save timed out. Please try again.', 'error');
                } else {
                    showMessage('Error updating profile: ' + error.message, 'error');
                }
            })
            .finally(() => {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Profile';
            });
        }



        function collectEducationData() {
            const educationItems = document.querySelectorAll('.education-item');
            const educationData = [];
            
            educationItems.forEach(item => {
                const inputs = item.querySelectorAll('input');
                const education = {};
                
                inputs.forEach(input => {
                    education[input.name] = input.value;
                });
                
                // Only push if user actually entered something
                if (education.degree || education.school || education.yearGraduated || education.gpa) {
                    educationData.push(education);
                }
            });
            
            return educationData;
        }

        function collectWorkExperienceData() {
            const workExperienceItems = document.querySelectorAll('.work-experience-item');
            const workExperienceData = [];
            
            console.log('Collecting work experience data from', workExperienceItems.length, 'items');
            
            workExperienceItems.forEach((item, index) => {
                const inputs = item.querySelectorAll('input, textarea');
                const workExperience = {};
                
                inputs.forEach(input => {
                    workExperience[input.name] = input.value;
                });
                
                console.log(`Work experience item ${index + 1}:`, workExperience);
                
                if (workExperience.company || workExperience.jobTitle) {
                    workExperienceData.push(workExperience);
                    console.log(`Added work experience item ${index + 1} to data`);
                } else {
                    console.log(`Skipped work experience item ${index + 1} (no company or job title)`);
                }
            });
            
            console.log('Final work experience data:', workExperienceData);
            return workExperienceData;
        }

        function enableEditing() {
            isEditingProfile = true;
            // Enable all form inputs
            const inputs = document.querySelectorAll('.form-input, .form-textarea');
            inputs.forEach(input => input.disabled = false);
            
            // Enable file uploads
            const fileInputs = document.querySelectorAll('input[type="file"]');
            fileInputs.forEach(input => input.disabled = false);
            
            // Enable education add button
            document.getElementById('add-education-btn').disabled = false;
            
            // Enable work experience add button
            document.getElementById('add-work-experience-btn').disabled = false;
            
            // Enable education inputs
            const educationInputs = document.querySelectorAll('.education-item input, .education-item select');
            educationInputs.forEach(input => input.disabled = false);
            
            // Enable work experience inputs
            const workExperienceInputs = document.querySelectorAll('.work-experience-item input, .work-experience-item textarea');
            workExperienceInputs.forEach(input => input.disabled = false);
            
            // Show/hide buttons
            document.getElementById('edit-btn').style.display = 'none';
            document.getElementById('cancel-btn').style.display = 'inline-block';
            document.getElementById('save-btn').style.display = 'inline-block';
        }
        
        function cancelEditing() {
            isEditingProfile = false;
            // Disable all form inputs
            const inputs = document.querySelectorAll('.form-input, .form-textarea');
            inputs.forEach(input => input.disabled = true);
            
            // Disable file uploads
            const fileInputs = document.querySelectorAll('input[type="file"]');
            fileInputs.forEach(input => input.disabled = true);
            
            // Disable education add button
            document.getElementById('add-education-btn').disabled = true;
            
            // Disable work experience add button
            document.getElementById('add-work-experience-btn').disabled = true;
            
            // Disable education inputs
            const educationInputs = document.querySelectorAll('.education-item input, .education-item select');
            educationInputs.forEach(input => input.disabled = true);
            
            // Disable work experience inputs
            const workExperienceInputs = document.querySelectorAll('.work-experience-item input, .work-experience-item textarea');
            workExperienceInputs.forEach(input => input.disabled = true);
            
            // Show/hide buttons
            document.getElementById('edit-btn').style.display = 'inline-block';
            document.getElementById('cancel-btn').style.display = 'none';
            document.getElementById('save-btn').style.display = 'none';
            
            // Reload profile data to restore original values
            loadProfileData();
        }
        
                 function setupVideoUpload() {
             document.getElementById('video-introduction').addEventListener('change', function(e) {
                 const file = e.target.files[0];
                 console.log('File selected:', file);
                 
                 if (file) {
                     const token = localStorage.getItem('token');
                     if (!token) {
                         showMessage('Authentication required. Please login again.', 'error');
                         return;
                     }
                     
                     console.log('File type:', file.type);
                     console.log('File size:', file.size, 'bytes');
                     
                     // Check file size (limit to 50MB)
                     if (file.size > 50 * 1024 * 1024) {
                         showMessage('Video file size must be less than 50MB', 'error');
                         return;
                     }
                     
                     // Check file type
                     if (!file.type.startsWith('video/')) {
                         showMessage('Please select a valid video file. Selected file type: ' + file.type, 'error');
                         return;
                     }
                     
                     const reader = new FileReader();
                     reader.onload = function(e) {
                         const videoData = e.target.result;
                         
                         // Show preview immediately
                         const videoPlayer = document.getElementById('video-player');
                         const videoSource = videoPlayer.querySelector('source');
                         videoSource.src = videoData;
                         videoPlayer.load();
                         
                         document.getElementById('video-name').textContent = file.name;
                         document.getElementById('video-preview').style.display = 'block';
                         
                         // Save to database
                         console.log('Uploading video to server...');
                         fetch('/api/teacher/upload-video', {
                             method: 'POST',
                             headers: {
                                 'Authorization': `Bearer ${token}`,
                                 'Content-Type': 'application/json'
                             },
                             body: JSON.stringify({
                                 videoData: videoData,
                                 fileName: file.name
                             }),
                             signal: AbortSignal.timeout(60000) // 60 second timeout for video uploads
                         })
                         .then(response => {
                             console.log('Video upload response status:', response.status);
                             console.log('Video upload response headers:', response.headers);
                             
                             if (!response.ok) {
                                 throw new Error(`HTTP error! status: ${response.status}`);
                             }
                             
                             return response.json();
                         })
                         .then(data => {
                             console.log('Video upload response data:', data);
                             if (data.success) {
                                 console.log('Video introduction updated successfully');
                                 showMessage('Video introduction updated successfully!', 'success');
                             } else {
                                 console.error('Video upload failed:', data.error);
                                 showMessage('Failed to upload video: ' + (data.error || 'Unknown error'), 'error');
                             }
                         })
                         .catch(error => {
                             console.error('Error uploading video:', error);
                             showMessage('Error uploading video: ' + error.message, 'error');
                         });
                     };
                     reader.readAsDataURL(file);
                 }
             });
         }
         
         function testVideoUploadEndpoint() {
             const token = localStorage.getItem('token');
             if (!token) {
                 console.log('No token available for testing video upload endpoint');
                 return;
             }
             
             // Test if the endpoint is available
             fetch('/api/teacher/profile', {
                 headers: { 'Authorization': `Bearer ${token}` }
             })
             .then(response => {
                 console.log('Server connectivity test - Profile endpoint status:', response.status);
                 if (response.ok) {
                     console.log('‚úÖ Server is running and accessible');
                 } else {
                     console.log('‚ùå Server responded with error:', response.status);
                 }
             })
             .catch(error => {
                 console.log('‚ùå Server connectivity test failed:', error.message);
             });
         }
         
         function removeVideo() {
             const token = localStorage.getItem('token');
             if (!token) {
                 showMessage('Authentication required. Please login again.', 'error');
                 return;
             }
             
             // Clear preview
             const videoPlayer = document.getElementById('video-player');
             const videoSource = videoPlayer.querySelector('source');
             videoSource.src = '';
             videoPlayer.load();
             document.getElementById('video-name').textContent = 'No video selected';
             document.getElementById('video-preview').style.display = 'none';
             
             // Clear file input
             document.getElementById('video-introduction').value = '';
             
             // Remove from database
             fetch('/api/teacher/remove-video', {
                 method: 'POST',
                 headers: {
                     'Authorization': `Bearer ${token}`,
                     'Content-Type': 'application/json'
                 },
                 signal: AbortSignal.timeout(10000)
             })
             .then(response => response.json())
             .then(data => {
                 if (data.success) {
                     showMessage('Video introduction removed successfully!', 'success');
                 } else {
                     showMessage('Failed to remove video: ' + (data.error || 'Unknown error'), 'error');
                 }
             })
             .catch(error => {
                 console.error('Error removing video:', error);
                 showMessage('Error removing video: ' + error.message, 'error');
             });
         }
         
         function showMessage(message, type) {
             const successMsg = document.getElementById('success-message');
             const errorMsg = document.getElementById('error-message');
             
             if (type === 'success') {
                 successMsg.textContent = message;
                 successMsg.style.display = 'block';
                 errorMsg.style.display = 'none';
             } else {
                 errorMsg.textContent = message;
                 errorMsg.style.display = 'block';
                 successMsg.style.display = 'none';
             }
             
             setTimeout(() => {
                 successMsg.style.display = 'none';
                 errorMsg.style.display = 'none';
             }, 5000);
         }
         
         // Function to update sidebar first name in real-time
         function updateSidebarUsername(firstName) {
             console.log('üîÑ updateSidebarUsername called with firstName:', firstName);
             
             // TEMPORARILY DISABLED: window.open is causing new tab to open
             // Method 1: Try to update via window.open
             /*
             try {
                 const dashboardWindow = window.open('', 'teacher-dashboard');
                 console.log('Dashboard window found:', dashboardWindow ? 'Yes' : 'No');
                 
                 if (dashboardWindow && !dashboardWindow.closed) {
                     console.log('Dashboard window is open, attempting to update sidebar...');
                     
                     // Wait a bit for the page to load if needed
                     setTimeout(() => {
                         try {
                             const usernameElement = dashboardWindow.document.getElementById('remoed-username');
                             const avatarElement = dashboardWindow.document.getElementById('avatar-text');
                             
                             console.log('Username element found:', usernameElement ? 'Yes' : 'No');
                             console.log('Avatar element found:', avatarElement ? 'Yes' : 'No');
                             
                             if (usernameElement) {
                                 usernameElement.textContent = `Hi, ${firstName}`;
                                 console.log('‚úÖ Sidebar first name updated in dashboard window:', firstName);
                             } else {
                                 console.log('‚ùå Username element not found in dashboard');
                             }
                             
                             if (avatarElement) {
                                 const username = localStorage.getItem('remoedUsername');
                                 avatarElement.textContent = username ? username[0].toUpperCase() : firstName[0].toUpperCase();
                                 console.log('‚úÖ Avatar text updated in dashboard window');
                             } else {
                                 console.log('‚ùå Avatar element not found in dashboard');
                             }
                         } catch (innerError) {
                             console.log('‚ùå Error accessing dashboard DOM:', innerError.message);
                         }
                     }, 100); // Small delay to ensure page is loaded
                 } else {
                     console.log('Dashboard window is not open or closed');
                 }
             } catch (error) {
                 console.log('‚ùå Could not update dashboard sidebar via window.open:', error.message);
             }
             */
             
             // Method 2: Update localStorage so dashboard can pick it up on refresh
             try {
                 localStorage.setItem('updatedFirstName', firstName);
                 console.log('‚úÖ Updated localStorage with firstName:', firstName);
                 
                 // Also update the username in localStorage for consistency
                 const username = localStorage.getItem('remoedUsername');
                 if (username) {
                     localStorage.setItem('remoedUsername', username);
                     console.log('‚úÖ Updated localStorage username for consistency');
                 }
             } catch (error) {
                 console.log('‚ùå Could not update localStorage:', error.message);
             }
         }
         
         // Settings functions
         function updateSettings() {
             const token = localStorage.getItem('token');
             if (!token) {
                 showSettingsMessage('Authentication required. Please login again.', 'error');
                 return;
             }
             
             const newEmail = document.getElementById('new-email').value.trim();
             const newUsername = document.getElementById('new-username').value.trim();
             const currentPassword = document.getElementById('current-password').value;
             const newPassword = document.getElementById('new-password').value;
             const confirmPassword = document.getElementById('confirm-password').value;
             
             // Validate inputs
             if (!newEmail && !newUsername && !newPassword) {
                 showSettingsMessage('Please fill in at least one field to update.', 'error');
                 return;
             }
             
             if (newPassword && newPassword !== confirmPassword) {
                 showSettingsMessage('New passwords do not match.', 'error');
                 return;
             }
             
             if (newPassword && newPassword.length < 6) {
                 showSettingsMessage('New password must be at least 6 characters long.', 'error');
                 return;
             }
             
             // Prepare update data
             const updateData = {};
             if (newEmail) updateData.newEmail = newEmail;
             if (newUsername) updateData.newUsername = newUsername;
             if (currentPassword && newPassword) {
                 updateData.currentPassword = currentPassword;
                 updateData.newPassword = newPassword;
             }
             
             // Send update request
             fetch('/api/teacher/update-settings', {
                 method: 'POST',
                 headers: {
                     'Authorization': `Bearer ${token}`,
                     'Content-Type': 'application/json'
                 },
                 body: JSON.stringify(updateData)
             })
             .then(response => response.json())
             .then(data => {
                 if (data.success) {
                     showSettingsMessage('Settings updated successfully!', 'success');
                     
                     // Update localStorage if username changed
                     if (newUsername) {
                         localStorage.setItem('remoedUsername', newUsername);
                     }
                     
                     // Clear form
                     resetSettingsForm();
                     
                     // Reload profile data to reflect changes
                     loadProfileData();
                 } else {
                     showSettingsMessage(data.message || 'Failed to update settings.', 'error');
                 }
             })
             .catch(error => {
                 console.error('Error updating settings:', error);
                 showSettingsMessage('Error updating settings: ' + error.message, 'error');
             });
         }
         
         function resetSettingsForm() {
             document.getElementById('new-email').value = '';
             document.getElementById('new-username').value = '';
             document.getElementById('current-password').value = '';
             document.getElementById('new-password').value = '';
             document.getElementById('confirm-password').value = '';
             
             // Reload current values
             const currentEmail = document.getElementById('email').value;
             const currentUsername = document.getElementById('username').value;
             
             document.getElementById('current-email').value = currentEmail;
             document.getElementById('current-username').value = currentUsername;
             
             showSettingsMessage('', '');
         }
         
         function showSettingsMessage(message, type) {
             const messageDiv = document.getElementById('settings-message');
             
             if (!message) {
                 messageDiv.style.display = 'none';
                 return;
             }
             
             messageDiv.textContent = message;
             messageDiv.style.display = 'block';
             
             if (type === 'success') {
                 messageDiv.style.color = '#28a745';
                 messageDiv.style.backgroundColor = '#d4edda';
                 messageDiv.style.border = '1px solid #c3e6cb';
                 messageDiv.style.padding = '10px';
                 messageDiv.style.borderRadius = '4px';
             } else {
                 messageDiv.style.color = '#dc3545';
                 messageDiv.style.backgroundColor = '#f8d7da';
                 messageDiv.style.border = '1px solid #f5c6cb';
                 messageDiv.style.padding = '10px';
                 messageDiv.style.borderRadius = '4px';
             }
             
             setTimeout(() => {
                 messageDiv.style.display = 'none';
             }, 5000);
                  }
         
         function goToForgotPassword() {
             // Redirect to the forgot password page
             window.location.href = 'forgot-password.html';
         }
         
    </script>
</body>
</html> 