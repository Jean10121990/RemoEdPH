<!DOCTYPE html>
<html lang="en">
<head><!-- comment -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ My Level Assessment - RemoEdPH</title>
    <link rel="stylesheet" href="modern-styles.css">
    <link rel="stylesheet" href="child-friendly-styles.css">
    <style>
        body { 
            font-family: 'Comic Sans MS', 'Chalkboard SE', 'Trebuchet MS', 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #FFF0F5 0%, #E8F8F5 50%, #FFF9E6 100%);
            background-attachment: fixed;
            margin: 0;
            padding: 0;
        }
        
        .remoed-main { 
            display: flex; 
            min-height: 100vh; 
        }
        .remoed-sidebar { 
            width: 260px; 
            min-width: 260px;
            background: linear-gradient(180deg, #ffffff 0%, #f8fbff 100%); 
            box-shadow: 4px 0 20px rgba(102, 126, 234, 0.1); 
            padding: 0; 
            display: flex; 
            flex-direction: column; 
            align-items: stretch;
            position: fixed;
            height: 100vh;
            z-index: 100;
            border-right: 1px solid rgba(102, 126, 234, 0.1);
        }
        .remoed-logo { 
            display: flex; 
            align-items: center; 
            gap: 14px; 
        }
        .remoed-logo img { 
            height: 48px; 
        }
        .remoed-title { 
            font-size: 1.7rem; 
            font-weight: 700; 
            color: #667eea; 
            letter-spacing: 1px; 
        }
        .remoed-user { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        .remoed-avatar { 
            width: 72px; 
            height: 72px; 
            border-radius: 50%; 
            background: #667eea; 
            color: #fff; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: bold; 
            font-size: 2.2rem; 
        }
        .remoed-username { 
            color: #667eea; 
            font-weight: 600; 
        }
        .remoed-menu { 
            list-style: none; 
            padding: 0; 
            margin: 0; 
        }
        .remoed-menu li { 
            padding: 14px 32px; 
            color: #667eea; 
            font-weight: 500; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            border-left: 4px solid transparent; 
            transition: background 0.2s, border-color 0.2s; 
        }
        .remoed-menu li.active, .remoed-menu li:hover { 
            background: linear-gradient(90deg, #667eea 0%, #5a67d8 100%); 
            border-left: 4px solid #667eea; 
            color: white; 
            transform: translateX(4px);
            transition: all 0.3s ease;
        }
        .remoed-content { 
            flex: 1; 
            padding: 24px 32px; 
            margin-left: 260px;
            max-width: calc(100vw - 260px);
        }
        
        .assessment-container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .assessment-header {
            background: linear-gradient(135deg, #1CA7E7, #5CB3FF);
            color: white;
            padding: 32px;
            border-radius: 20px;
            margin-bottom: 32px;
            box-shadow: 0 8px 24px rgba(28, 167, 231, 0.3);
            text-align: center;
        }
        
        .assessment-header h1 {
            font-size: 2.5rem;
            margin: 0 0 12px 0;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .assessment-header p {
            font-size: 1.2rem;
            margin: 0;
            color: white;
            opacity: 1;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        
        .assessment-intro {
            background: white;
            padding: 32px;
            border-radius: 20px;
            margin-bottom: 32px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        
        .assessment-intro h2 {
            color: #1CA7E7;
            font-size: 1.8rem;
            margin-bottom: 16px;
        }
        
        .assessment-intro p {
            font-size: 1.1rem;
            line-height: 1.8;
            margin-bottom: 20px;
            color: #1E3A5F;
        }
        
        .assessment-intro ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .assessment-intro li {
            padding: 12px 0;
            font-size: 1.1rem;
            color: #1E3A5F;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .assessment-intro li::before {
            content: '‚ú®';
            font-size: 1.5rem;
        }
        
        .start-btn {
            background: linear-gradient(135deg, #1CA7E7, #5CB3FF);
            color: white;
            border: 3px solid #FFD700;
            padding: 18px 48px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 800;
            font-size: 1.3rem;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(28, 167, 231, 0.4);
            display: block;
            margin: 32px auto 0;
            font-family: 'Comic Sans MS', 'Chalkboard SE', 'Trebuchet MS', 'Segoe UI', sans-serif;
        }
        
        .start-btn:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 10px 30px rgba(28, 167, 231, 0.5);
        }
        
        .question-container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 24px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            display: none;
        }
        
        .question-container.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 3px solid #E8F4FD;
        }
        
        .question-number {
            background: linear-gradient(135deg, #1CA7E7, #5CB3FF);
            color: white;
            padding: 12px 24px;
            border-radius: 20px;
            font-weight: 800;
            font-size: 1.1rem;
            box-shadow: 0 4px 12px rgba(28, 167, 231, 0.3);
        }
        
        .progress-bar {
            flex: 1;
            height: 12px;
            background: #E8F4FD;
            border-radius: 10px;
            margin: 0 24px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #1CA7E7, #5CB3FF, #FFD700);
            border-radius: 10px;
            transition: width 0.5s ease;
            box-shadow: 0 2px 8px rgba(28, 167, 231, 0.3);
        }
        
        .question-title {
            font-size: 1.5rem;
            color: #1E3A5F;
            font-weight: 700;
            margin-bottom: 24px;
            line-height: 1.6;
        }
        
        .question-image {
            width: 100%;
            max-width: 400px;
            height: 250px;
            object-fit: contain;
            border-radius: 16px;
            margin: 24px auto;
            display: block;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .options-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-top: 24px;
        }
        
        .option-btn {
            background: linear-gradient(135deg, #F0F8FF, #FFFBF0);
            border: 3px solid #E8F4FD;
            padding: 20px 24px;
            border-radius: 16px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            color: #1E3A5F;
            transition: all 0.3s ease;
            text-align: center;
            font-family: 'Comic Sans MS', 'Chalkboard SE', 'Trebuchet MS', 'Segoe UI', sans-serif;
        }
        
        .option-btn:hover {
            border-color: #1CA7E7;
            background: linear-gradient(135deg, #E8F4FD, #FFF9E6);
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(28, 167, 231, 0.2);
        }
        
        .option-btn.selected {
            background: linear-gradient(135deg, #1CA7E7, #5CB3FF);
            color: white;
            border-color: #FFD700;
            box-shadow: 0 6px 20px rgba(28, 167, 231, 0.4);
        }
        
        .option-btn.correct {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border-color: #2E7D32;
        }
        
        .option-btn.incorrect {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
            border-color: #c62828;
        }
        
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 32px;
            gap: 16px;
        }
        
        .nav-btn {
            padding: 14px 32px;
            border-radius: 20px;
            border: none;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Comic Sans MS', 'Chalkboard SE', 'Trebuchet MS', 'Segoe UI', sans-serif;
        }
        
        .prev-btn {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            color: white;
        }
        
        .next-btn {
            background: linear-gradient(135deg, #1CA7E7, #5CB3FF);
            color: white;
            border: 2px solid #FFD700;
        }
        
        .submit-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: 2px solid #2E7D32;
        }
        
        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        
        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .results-container {
            background: white;
            padding: 48px;
            border-radius: 20px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            text-align: center;
            display: none;
        }
        
        .results-container.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        .results-header {
            font-size: 3rem;
            margin-bottom: 24px;
        }
        
        .cefr-level {
            background: linear-gradient(135deg, #1CA7E7, #5CB3FF);
            color: white;
            padding: 24px 48px;
            border-radius: 20px;
            font-size: 2.5rem;
            font-weight: 800;
            margin: 32px auto;
            display: inline-block;
            box-shadow: 0 8px 24px rgba(28, 167, 231, 0.4);
            border: 4px solid #FFD700;
        }
        
        .level-description {
            background: #F0F8FF;
            padding: 24px;
            border-radius: 16px;
            margin: 24px 0;
            border-left: 6px solid #1CA7E7;
        }
        
        .level-description h3 {
            color: #1CA7E7;
            font-size: 1.5rem;
            margin-bottom: 12px;
        }
        
        .level-description p {
            color: #1E3A5F;
            font-size: 1.1rem;
            line-height: 1.8;
        }
        
        .score-display {
            font-size: 1.3rem;
            color: #1E3A5F;
            margin: 24px 0;
        }
        
        .cefr-badge {
            display: inline-block;
            background: linear-gradient(135deg, #FFD700, #FFE66D);
            color: #1E3A5F;
            padding: 12px 24px;
            border-radius: 20px;
            font-weight: 800;
            font-size: 1.2rem;
            margin: 16px;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
        }
        
        .action-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 32px;
        }
        
        .action-btn {
            padding: 16px 32px;
            border-radius: 20px;
            border: none;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Comic Sans MS', 'Chalkboard SE', 'Trebuchet MS', 'Segoe UI', sans-serif;
        }
        
        .retake-btn {
            background: linear-gradient(135deg, #1CA7E7, #5CB3FF);
            color: white;
            border: 2px solid #FFD700;
        }
        
        .dashboard-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: 2px solid #2E7D32;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        
        @media (max-width: 768px) {
            .options-container {
                grid-template-columns: 1fr;
            }
            
            .assessment-header h1 {
                font-size: 2rem;
            }
            
            .question-title {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <div class="remoed-main">
        <nav class="remoed-sidebar">
            <div class="remoed-logo" style="height:100px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px; padding-top:24px;">
                <img src="remoed-logo.png" alt="RemoEdPH Logo" style="height:40px; width:auto; display:inline-block; vertical-align:middle;">
                <span class="remoed-title" style="font-size:1.4rem; font-weight:800; color:#1CA7E7; letter-spacing:1px; text-shadow: 2px 2px 4px rgba(28, 167, 231, 0.2);">RemoEdPH</span>
                <div style="font-size: 0.75rem; color: #666;">Student Portal</div>
            </div>
            <div class="remoed-user" style="display:flex; flex-direction:column; align-items:center; margin-bottom:24px;">
                <div class="remoed-avatar" id="sidebar-avatar" style="position: relative; overflow: hidden;">
                    <img id="profile-image" src="" alt="Profile" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover; display: none;">
                    <span id="avatar-text">S</span>
                </div>
                <span class="remoed-username" id="sidebar-email">student@remoedph.com</span>
            </div>
            <ul class="remoed-menu">
                <li onclick="window.location.href='student-dashboard.html'">üè† <span>My Home</span></li>
                <li onclick="window.location.href='student-class-table.html'">üìÖ <span>My Schedule</span></li>
                <li onclick="window.location.href='student-book.html'">‚ûï <span>Book a Class</span></li>
                <li onclick="window.location.href='student-booking-history.html'">üìú <span>My Classes</span></li>
                <li onclick="window.location.href='student-games-activities.html'">üéÆ <span>Play & Learn</span></li>
                <li onclick="window.location.href='student-profile.html'">üë§ <span>My Profile</span></li>
                <li class="active">üéØ <span>My Level</span></li>
                <li id="logout-nav" style="margin-top:auto; color:#e74c3c; cursor:pointer;">üö™ <span>Exit</span></li>
            </ul>
        </nav>
        <div class="remoed-content">
            <div class="assessment-container">
                <!-- Introduction Screen -->
                <div id="intro-screen">
                    <div class="assessment-header">
                        <h1>üéØ Welcome to Your Level Assessment!</h1>
                        <p>Let's find out your English level together! üåü</p>
                    </div>
                    
                    <div class="assessment-intro">
                        <h2>üìö What is CEFR?</h2>
                        <p style="font-size: 1.1rem; color: #1E3A5F; margin-bottom: 20px; line-height: 1.8;">
                            CEFR stands for <strong>Common European Framework of Reference for Languages</strong>. 
                            It helps us understand your English level so we can give you the best learning experience!
                        </p>
                        
                        <h2 style="margin-top: 32px;">‚ú® What to Expect:</h2>
                        <ul>
                            <li>Fun and colorful questions designed for young learners</li>
                            <li>Pictures and simple words you'll recognize</li>
                            <li>No pressure - just do your best!</li>
                            <li>Results will show your level: A1 (Beginner) or A2 (Elementary)</li>
                            <li>Takes about 10-15 minutes to complete</li>
                        </ul>
                        
                        <button class="start-btn" onclick="startAssessment()">
                            üöÄ Let's Start! üéâ
                        </button>
                    </div>
                </div>
                
                <!-- Questions Container -->
                <div id="questions-container" style="display: none;">
                    <!-- Questions will be dynamically inserted here -->
                </div>
                
                <!-- Results Screen -->
                <div id="results-container" class="results-container">
                    <div class="results-header">üéâ Great Job! üéâ</div>
                    <div class="score-display" id="score-display"></div>
                    <div class="cefr-level" id="cefr-level"></div>
                    <div class="cefr-badge" id="cefr-badge"></div>
                    
                    <div class="level-description" id="level-description">
                        <!-- Description will be inserted here -->
                    </div>
                    
                    <div class="action-buttons">
                        <button class="action-btn retake-btn" onclick="retakeAssessment()">üîÑ Take Again</button>
                        <button class="action-btn dashboard-btn" onclick="goToDashboard()">üè† Go to Dashboard</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="avatar-helper.js"></script>
    <script>
        // Role-based access control
        const userType = localStorage.getItem('userType');
        if (userType !== 'student') {
            alert('Access denied. This page is for students only.');
            window.location.href = 'index.html';
        }

        // Assessment Questions - CEFR A1/A2 Level for Young Learners
        const assessmentQuestions = [
            {
                id: 1,
                question: "What color is the sun? ‚òÄÔ∏è",
                options: ["Red", "Yellow", "Blue", "Green"],
                correct: 1,
                image: null
            },
            {
                id: 2,
                question: "How many apples do you see? üçéüçéüçé",
                options: ["One", "Two", "Three", "Four"],
                correct: 2,
                image: null
            },
            {
                id: 3,
                question: "Which animal says 'Meow'?",
                options: ["Dog üê∂", "Cat üê±", "Bird üê¶", "Fish üê†"],
                correct: 1,
                image: null
            },
            {
                id: 4,
                question: "What do you say in the morning?",
                options: ["Good night", "Good morning", "Goodbye", "Thank you"],
                correct: 1,
                image: null
            },
            {
                id: 5,
                question: "Which word means 'happy'?",
                options: ["Sad", "Happy", "Angry", "Tired"],
                correct: 1,
                image: null
            },
            {
                id: 6,
                question: "What is this? üöó",
                options: ["Bike", "Car", "Bus", "Train"],
                correct: 1,
                image: null
            },
            {
                id: 7,
                question: "Complete: 'I ___ a student.'",
                options: ["am", "is", "are", "be"],
                correct: 0,
                image: null
            },
            {
                id: 8,
                question: "What do you eat for breakfast?",
                options: ["Pizza", "Cereal", "Ice cream", "Candy"],
                correct: 1,
                image: null
            },
            {
                id: 9,
                question: "Which is bigger?",
                options: ["Elephant üêò", "Mouse üê≠", "Cat üê±", "Dog üê∂"],
                correct: 0,
                image: null
            },
            {
                id: 10,
                question: "What shape is a ball? ‚öΩ",
                options: ["Square", "Triangle", "Circle", "Rectangle"],
                correct: 2,
                image: null
            },
            {
                id: 11,
                question: "How do you greet someone?",
                options: ["Hello!", "Goodbye!", "Sorry!", "Please!"],
                correct: 0,
                image: null
            },
            {
                id: 12,
                question: "What do you wear on your feet?",
                options: ["Hat", "Shoes", "Gloves", "Shirt"],
                correct: 1,
                image: null
            },
            {
                id: 13,
                question: "Complete: 'She ___ playing.'",
                options: ["am", "is", "are", "be"],
                correct: 1,
                image: null
            },
            {
                id: 14,
                question: "What do you drink when you're thirsty?",
                options: ["Food", "Water", "Toys", "Books"],
                correct: 1,
                image: null
            },
            {
                id: 15,
                question: "Which word rhymes with 'cat'?",
                options: ["Dog", "Hat", "Bird", "Fish"],
                correct: 1,
                image: null
            }
        ];

        let currentQuestion = 0;
        let answers = [];
        let totalQuestions = assessmentQuestions.length;

        // Check if coming from landing page (guest assessment)
        let isGuestAssessment = false;
        let guestAssessmentData = null;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Check URL parameters for guest assessment
            const urlParams = new URLSearchParams(window.location.search);
            const childName = urlParams.get('childName');
            const parentEmail = urlParams.get('parentEmail');
            const contactNumber = urlParams.get('contactNumber');
            
            if (childName && parentEmail) {
                isGuestAssessment = true;
                guestAssessmentData = { childName, parentEmail, contactNumber };
                
                // Hide sidebar for guest users
                document.querySelector('.remoed-sidebar').style.display = 'none';
                document.querySelector('.remoed-content').style.marginLeft = '0';
                document.querySelector('.remoed-content').style.maxWidth = '100%';
                
                // Show guest message
                const introScreen = document.getElementById('intro-screen');
                if (introScreen) {
                    const guestMsg = document.createElement('div');
                    guestMsg.style.cssText = 'background: #FFF3CD; border: 2px solid #FFD700; padding: 16px; border-radius: 12px; margin-bottom: 24px; text-align: center;';
                    guestMsg.innerHTML = `<strong>üëã Welcome ${childName}!</strong> Complete the assessment to receive your results via email. You'll need to sign up after to view your results online.`;
                    introScreen.insertBefore(guestMsg, introScreen.firstChild);
                }
            } else {
                // Regular logged-in user
                const username = localStorage.getItem('remoedUsername') || 'Student';
                const studentId = localStorage.getItem('studentId');
                
                // Set sidebar avatar
                const sidebarImg = document.getElementById('profile-image');
                const sidebarText = document.getElementById('avatar-text');
                if (sidebarImg && sidebarText) {
                    sidebarImg.style.display = 'none';
                    sidebarText.style.display = 'inline-block';
                    sidebarText.textContent = username[0].toUpperCase();
                }
                document.getElementById('sidebar-email').textContent = username;
                
                // Load profile picture if available
                if (studentId) {
                    loadProfilePicture(studentId);
                }
                
                // Logout functionality
                document.getElementById('logout-nav').onclick = function() {
                    localStorage.clear();
                    window.location.href = 'student-login.html';
                };
            }
        });

        // Load profile picture
        async function loadProfilePicture(studentId) {
            try {
                const token = localStorage.getItem('token');
                if (!token) return;

                const response = await fetch(`/api/student/profile`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Cache-Control': 'no-cache'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const profilePic = data?.profile?.profilePicture || '';
                    if (profilePic) {
                        try {
                            setAvatar({ 
                                imageUrl: profilePic, 
                                displayName: localStorage.getItem('remoedUsername') || 'S', 
                                imgSelector: '#profile-image', 
                                textSelector: '#avatar-text' 
                            });
                        } catch (e) {
                            console.error('setAvatar failed', e);
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading profile picture:', error);
            }
        }

        function startAssessment() {
            document.getElementById('intro-screen').style.display = 'none';
            document.getElementById('questions-container').style.display = 'block';
            currentQuestion = 0;
            answers = [];
            renderQuestion();
        }

        function renderQuestion() {
            const question = assessmentQuestions[currentQuestion];
            const container = document.getElementById('questions-container');
            
            const progress = ((currentQuestion + 1) / totalQuestions) * 100;
            
            container.innerHTML = `
                <div class="question-container active">
                    <div class="question-header">
                        <div class="question-number">Question ${currentQuestion + 1} of ${totalQuestions}</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                    </div>
                    
                    <div class="question-title">${question.question}</div>
                    
                    ${question.image ? `<img src="${question.image}" class="question-image" alt="Question image">` : ''}
                    
                    <div class="options-container">
                        ${question.options.map((option, index) => `
                            <button class="option-btn" onclick="selectOption(${index})" data-option="${index}">
                                ${option}
                            </button>
                        `).join('')}
                    </div>
                    
                    <div class="navigation-buttons">
                        <button class="nav-btn prev-btn" onclick="previousQuestion()" ${currentQuestion === 0 ? 'disabled' : ''}>
                            ‚Üê Previous
                        </button>
                        <button class="nav-btn next-btn" onclick="nextQuestion()" ${answers[currentQuestion] === undefined ? 'disabled' : ''} id="next-btn">
                            ${currentQuestion === totalQuestions - 1 ? 'Submit' : 'Next ‚Üí'}
                        </button>
                    </div>
                </div>
            `;
            
            // Restore previous answer if exists
            if (answers[currentQuestion] !== undefined) {
                const selectedBtn = container.querySelector(`[data-option="${answers[currentQuestion]}"]`);
                if (selectedBtn) {
                    selectedBtn.classList.add('selected');
                }
            }
        }

        function selectOption(optionIndex) {
            answers[currentQuestion] = optionIndex;
            
            // Update button states
            const container = document.getElementById('questions-container');
            const buttons = container.querySelectorAll('.option-btn');
            buttons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === optionIndex) {
                    btn.classList.add('selected');
                }
            });
            
            // Enable next button
            const nextBtn = document.getElementById('next-btn');
            if (nextBtn) {
                nextBtn.disabled = false;
            }
        }

        function previousQuestion() {
            if (currentQuestion > 0) {
                currentQuestion--;
                renderQuestion();
            }
        }

        function nextQuestion() {
            if (answers[currentQuestion] === undefined) {
                alert('Please select an answer before continuing!');
                return;
            }
            
            if (currentQuestion < totalQuestions - 1) {
                currentQuestion++;
                renderQuestion();
            } else {
                submitAssessment();
            }
        }

        function submitAssessment() {
            // Calculate score
            let correctAnswers = 0;
            assessmentQuestions.forEach((question, index) => {
                if (answers[index] === question.correct) {
                    correctAnswers++;
                }
            });
            
            const score = Math.round((correctAnswers / totalQuestions) * 100);
            
            // Determine CEFR Level
            let cefrLevel, cefrBadge, description;
            
            if (score >= 80) {
                cefrLevel = 'A2';
                cefrBadge = 'Elementary Level';
                description = {
                    title: 'üåü A2 - Elementary Level',
                    text: 'Great job! You have a good understanding of basic English. You can understand simple sentences and communicate about familiar topics like family, school, and daily activities. Keep practicing to improve even more!'
                };
            } else if (score >= 50) {
                cefrLevel = 'A1';
                cefrBadge = 'Beginner Level';
                description = {
                    title: 'üå± A1 - Beginner Level',
                    text: 'Well done! You\'re starting your English learning journey. You can understand and use basic words and simple phrases. With practice, you\'ll improve quickly!'
                };
            } else {
                cefrLevel = 'A1';
                cefrBadge = 'Beginner Level';
                description = {
                    title: 'üå± A1 - Beginner Level',
                    text: 'Good effort! You\'re at the beginning of your English learning adventure. Don\'t worry - everyone starts here! Keep learning and practicing, and you\'ll improve soon.'
                };
            }
            
            // Save result to profile (optional - can be implemented with backend)
            saveAssessmentResult(cefrLevel, score);
            
            // Show results
            showResults(cefrLevel, cefrBadge, description, score, correctAnswers);
        }

        function showResults(level, badge, description, score, correct) {
            document.getElementById('questions-container').style.display = 'none';
            document.getElementById('results-container').classList.add('active');
            
            document.getElementById('cefr-level').textContent = `Level ${level}`;
            document.getElementById('cefr-badge').textContent = badge;
            document.getElementById('score-display').innerHTML = `
                <strong>You got ${correct} out of ${totalQuestions} questions correct!</strong><br>
                <span style="font-size: 2rem; color: #1CA7E7; font-weight: 800;">${score}%</span>
            `;
            
            document.getElementById('level-description').innerHTML = `
                <h3>${description.title}</h3>
                <p>${description.text}</p>
                ${isGuestAssessment ? '<p style="margin-top: 20px; padding: 16px; background: #FFF3CD; border: 2px solid #FFD700; border-radius: 12px;"><strong>üìß Your results have been sent to your email!</strong><br>Sign up now to access your results online and start learning!</p>' : ''}
            `;
            
            // Update action buttons for guest users
            if (isGuestAssessment) {
                const actionButtons = document.querySelector('.action-buttons');
                if (actionButtons) {
                    actionButtons.innerHTML = `
                        <button class="action-btn retake-btn" onclick="retakeAssessment()">üîÑ Take Again</button>
                        <button class="action-btn dashboard-btn" onclick="goToSignup()">‚ú® Sign Up Now</button>
                    `;
                }
                
                // Auto-redirect to sign-up after 5 seconds
                setTimeout(() => {
                    goToSignup();
                }, 5000);
            }
        }
        
        function goToSignup() {
            if (guestAssessmentData) {
                const level = document.getElementById('cefr-level').textContent.replace('Level ', '');
                const scoreMatch = document.getElementById('score-display').textContent.match(/\d+/);
                const score = scoreMatch ? scoreMatch[0] : '0';
                window.location.href = `index.html?email=${encodeURIComponent(guestAssessmentData.parentEmail)}&cefrLevel=${encodeURIComponent(level)}&score=${encodeURIComponent(score)}&signup=true`;
            } else {
                window.location.href = 'index.html?signup=true';
            }
        }

        async function saveAssessmentResult(level, score) {
            try {
                // If guest assessment, save to temporary storage and send email
                if (isGuestAssessment && guestAssessmentData) {
                    console.log('Guest assessment - sending email with results');
                    
                    const emailResponse = await fetch('/api/student/send-assessment-email', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            email: guestAssessmentData.parentEmail,
                            childName: guestAssessmentData.childName,
                            parentEmail: guestAssessmentData.parentEmail,
                            contactNumber: guestAssessmentData.contactNumber,
                            cefrLevel: level,
                            score: score
                        })
                    });
                    
                    const emailResult = await emailResponse.json();
                    if (emailResult.success || emailResult.fallback) {
                        console.log('‚úÖ Assessment results sent via email');
                        // Automatically redirect to home page with sign-up
                        setTimeout(() => {
                            window.location.href = `/?email=${encodeURIComponent(guestAssessmentData.parentEmail)}&cefrLevel=${level}&score=${score}&signup=true`;
                        }, 3000);
                    }
                    return;
                }
                
                // Regular logged-in user assessment
                const token = localStorage.getItem('token');
                if (!token) {
                    console.error('No token found for saving assessment');
                    return;
                }
                
                console.log('Saving assessment result:', { level, score });
                
                const response = await fetch('/api/student/save-assessment', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        cefrLevel: level,
                        score: score,
                        date: new Date().toISOString()
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Assessment result saved successfully:', result);
                    
                    // Clear old localStorage and save fresh data
                    localStorage.removeItem('studentCEFRLevel');
                    localStorage.setItem('studentCEFRLevel', level);
                    localStorage.setItem('studentAssessmentScore', score.toString());
                    localStorage.setItem('studentAssessmentDate', new Date().toISOString());
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    console.error('‚ùå Failed to save assessment result:', errorData);
                }
            } catch (error) {
                console.error('‚ùå Error saving assessment result:', error);
            }
        }

        function retakeAssessment() {
            document.getElementById('results-container').classList.remove('active');
            document.getElementById('intro-screen').style.display = 'block';
            currentQuestion = 0;
            answers = [];
        }

        function goToDashboard() {
            // Clear any cached data to force refresh
            localStorage.removeItem('studentCEFRLevel');
            window.location.href = 'student-dashboard.html';
        }
    </script>
</body>
</html>
