<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Profile - RemoEdPH</title>
    <link rel="stylesheet" href="modern-styles.css">
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: #f6fbff; 
            margin: 0;
            padding: 0;
        }
        
        .remoed-main { 
            display: flex; 
            min-height: 100vh; 
        }
        .remoed-sidebar { 
            width: 260px; 
            min-width: 260px;
            background: linear-gradient(180deg, #ffffff 0%, #f8fbff 100%); 
            box-shadow: 4px 0 20px rgba(102, 126, 234, 0.1); 
            padding: 0; 
            display: flex; 
            flex-direction: column; 
            align-items: stretch;
            position: fixed;
            height: 100vh;
            z-index: 100;
            border-right: 1px solid rgba(102, 126, 234, 0.1);
        }
        .remoed-logo { 
            display: flex; 
            align-items: center; 
            gap: 14px; 
        }
        .remoed-logo img { 
            height: 48px; 
        }
        .remoed-title { 
            font-size: 1.7rem; 
            font-weight: 700; 
            color: #667eea; 
            letter-spacing: 1px; 
        }
        .remoed-user { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        .remoed-avatar { 
            width: 72px; 
            height: 72px; 
            border-radius: 50%; 
            background: #667eea; 
            color: #fff; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: bold; 
            font-size: 2.2rem; 
        }
        .remoed-username { 
            color: #667eea; 
            font-weight: 600; 
        }
        .remoed-menu { 
            list-style: none; 
            padding: 0; 
            margin: 0; 
        }
        .remoed-menu li { 
            padding: 14px 32px; 
            color: #667eea; 
            font-weight: 500; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            border-left: 4px solid transparent; 
            transition: background 0.2s, border-color 0.2s; 
        }
            .remoed-menu li.active, .remoed-menu li:hover { 
      background: linear-gradient(90deg, #667eea 0%, #5a67d8 100%); 
      border-left: 4px solid #667eea; 
      color: white; 
      transform: translateX(4px);
      transition: all 0.3s ease;
    }
        .remoed-menu svg { 
            width: 20px; 
            height: 20px; 
            stroke: currentColor;
        }
        .remoed-content { 
            flex: 1; 
            padding: 36px 40px; 
            margin-left: 260px;
            max-width: calc(100vw - 260px);
        }
        
        .profile-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 5px;
        }
        
        .profile-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 5px;
            margin-top: 5px;
        }
        
        .profile-sidebar {
            background: white;
            border-radius: 8px;
            padding: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            height: fit-content;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            min-width: 120px;
        }
        
        .profile-main {
            background: white;
            border-radius: 8px;
            padding: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #1ca7e7;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .profile-avatar:hover {
            transform: scale(1.05);
        }
        
        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        
        .upload-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px;
            text-align: center;
            font-size: 0.8rem;
            transform: translateY(100%);
            transition: transform 0.3s;
        }
        
        .profile-avatar:hover .upload-overlay {
            transform: translateY(0);
        }
        
        .profile-name {
            font-size: 0.8rem;
            font-weight: bold;
            color: #1ca7e7;
            margin: 0;
            text-align: center;
        }
        
        .profile-email {
            color: #666;
            margin: 0;
            font-size: 0.7rem;
            text-align: center;
        }
        
        .back-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 3px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 3px;
            transition: background 0.2s;
            font-size: 0.9rem;
        }
        
        .back-btn:hover {
            background: #5a67d8;
        }
        
        .section-title {
            font-size: 1rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 3px;
            border-bottom: 1px solid #e6f0fa;
            padding-bottom: 2px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 4px;
        }
        
        .form-group {
            margin-bottom: 3px;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .form-label {
            display: block;
            margin-bottom: 1px;
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }
        
        .form-input {
            width: 100%;
            padding: 3px;
            border: 1px solid #e0e6ed;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #1ca7e7;
        }
        
        .form-textarea {
            width: 100%;
            padding: 2px;
            border: 1px solid #e0e6ed;
            border-radius: 6px;
            font-size: 0.85rem;
            min-height: 60px;
            resize: vertical;
            font-family: inherit;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }
        
        .form-textarea:focus {
            outline: none;
            border-color: #1ca7e7;
        }
        
        .file-upload {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }
        
        .file-upload input[type=file] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-upload-label {
            display: block;
            padding: 4px;
            border: 1px dashed #1ca7e7;
            border-radius: 6px;
            text-align: center;
            color: #1ca7e7;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 0.7rem;
        }
        
        .file-upload:hover .file-upload-label {
            background: #f0f8ff;
            border-color: #168fc1;
        }
        
        .save-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            transition: background 0.2s;
            margin-top: 4px;
        }
        
        .save-btn:hover {
            background: #45a049;
        }
        
        .save-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .edit-btn {
            background: #1ca7e7;
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            transition: background 0.2s;
            margin-top: 4px;
            margin-right: 8px;
        }
        
        .edit-btn:hover {
            background: #168fc1;
        }
        
        .cancel-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            transition: background 0.2s;
            margin-top: 4px;
            margin-right: 8px;
        }
        
        .cancel-btn:hover {
            background: #5a6268;
        }
        
        .form-input:disabled, .form-textarea:disabled, .form-input[readonly], .form-textarea[readonly] {
            background-color: #f8f9fa;
            color: #495057;
            cursor: not-allowed;
        }
        
        .file-upload.disabled {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .education-item {
            background: #f8f9fa;
            border: 1px solid #e0e6ed;
            border-radius: 6px;
            padding: 3px;
            margin-bottom: 3px;
        }
        
        .education-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2px;
        }
        
        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 1px 4px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.6rem;
        }
        
        .remove-btn:hover {
            background: #c82333;
        }
        
        .add-btn {
            background: #1ca7e7;
            color: white;
            border: none;
            padding: 3px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 3px;
            font-size: 0.7rem;
        }
        
        .add-btn:hover {
            background: #168fc1;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .tab-container {
            margin-bottom: 10px;
        }
        
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #e0e6ed;
            margin-bottom: 10px;
        }
        
        .tab-btn {
            background: none;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .tab-btn.active {
            color: #1ca7e7;
            border-bottom-color: #1ca7e7;
        }
        
        .tab-btn:hover {
            color: #1ca7e7;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .document-preview {
            max-width: 200px;
            max-height: 150px;
            border: 1px solid #e0e6ed;
            border-radius: 6px;
            margin-top: 3px;
            display: none;
        }
        
        .document-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <div class="remoed-main">
        <nav class="remoed-sidebar">
            <div class="remoed-logo" style="height:100px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px; padding-top:24px;">
                <img src="remoed-logo.png" alt="RemoEdPH Logo" style="height:40px; width:auto; display:inline-block; vertical-align:middle;">
                <span class="remoed-title" style="font-size:1.3rem; font-weight:700; color:#1ca7e7; letter-spacing:1px;">RemoEdPH</span>
            </div>
            <div class="remoed-user" style="display:flex; flex-direction:column; align-items:center; margin-bottom:24px;">
                <div class="remoed-avatar" id="sidebar-avatar" style="position: relative; overflow: hidden;">
                    <img id="profile-image" src="" alt="Profile" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover; display: none;">
                    <span id="avatar-text">S</span>
                </div>
                <span class="remoed-username" id="sidebar-email">student@remoedph.com</span>
            </div>
            <ul class="remoed-menu">
                <li onclick="window.location.href='student-dashboard.html'">
                    <svg fill="none" stroke="#667eea" stroke-width="2" viewBox="0 0 24 24">
                        <rect x="3" y="3" width="18" height="18" rx="4"/>
                    </svg>Dashboard
                </li>
                <li onclick="window.location.href='student-class-table.html'">
                    <svg fill="none" stroke="#667eea" stroke-width="2" viewBox="0 0 24 24">
                        <rect x="3" y="7" width="18" height="13" rx="2"/>
                        <path d="M16 3v4M8 3v4"/>
                    </svg>Class Schedule
                </li>
                <li onclick="window.location.href='student-book.html'">
                    <svg fill="none" stroke="#667eea" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 10c-4.41 0-8-1.79-8-4V6c0-2.21 3.59-4 8-4s8 1.79 8 4v8c0 2.21-3.59 4-8 4z"/>
                    </svg>Book Class
                </li>
                <li onclick="window.location.href='student-booking-history.html'">
                    <svg fill="none" stroke="#667eea" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>Booking History
                </li>
                <li class="active">
                    <svg fill="none" stroke="#667eea" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>Profile
                </li>
                <li id="logout-nav" style="margin-top:auto; color:#e74c3c; cursor:pointer;">
                    <svg fill="none" stroke="#e74c3c" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M17 16l4-4m0 0l-4-4m4 4H7"/>
                        <path d="M3 12a9 9 0 0118 0 9 9 0 01-18 0z"/>
                    </svg>Logout
                </li>
            </ul>
        </nav>
        <div class="remoed-content">
            <div class="profile-container">
                <div class="profile-grid">
                    <!-- Profile Sidebar -->
                    <div class="profile-sidebar">
                        <div class="profile-avatar" id="profile-avatar">
                                <img id="profile-avatar-img" src="" alt="Profile Avatar" style="width:100%; height:100%; object-fit:cover; border-radius:50%; display:none;">
                                <span id="profile-avatar-text" style="font-size:1.5rem; font-weight:bold; color:#fff; display:inline-block; line-height:80px;">S</span>
                                <div class="upload-overlay">Click to upload</div>
                            </div>
                        <h3 class="profile-name" id="profile-name">Student Name</h3>
                        <p class="profile-email" id="profile-email">student@email.com</p>
                        <button class="back-btn" onclick="goBack()">Back to Dashboard</button>
                    </div>
            
            <!-- Profile Main Content -->
            <div class="profile-main">
                <div class="tab-container">
                    <div class="tab-buttons">
                        <button class="tab-btn active" onclick="showTab('personal')">Personal Information</button>
                        <button class="tab-btn" onclick="showTab('education')">Education</button>
                        <button class="tab-btn" onclick="showTab('documents')">Documents</button>
                        <button class="tab-btn" onclick="showTab('settings')">Settings</button>
                    </div>
                    
                    <!-- Personal Information Tab -->
                    <div id="personal" class="tab-content active">
                        <h3 class="section-title">Personal Information</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">First Name</label>
                                <input type="text" class="form-input" id="firstName" placeholder="First Name" disabled>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Middle Name</label>
                                <input type="text" class="form-input" id="middleName" placeholder="Middle Name" disabled>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Last Name</label>
                                <input type="text" class="form-input" id="lastName" placeholder="Last Name" disabled>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Gender</label>
                                <select class="form-input" id="gender" disabled>
                                    <option value="">Select Gender</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Birthday</label>
                                <input type="date" class="form-input" id="birthday" disabled>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Age</label>
                                <input type="number" class="form-input" id="age" placeholder="Age" min="1" max="100" disabled>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Contact Number</label>
                                <input type="tel" class="form-input" id="contact" placeholder="Contact Number" disabled>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-input" id="email" placeholder="Email" disabled>
                            </div>
                            <div class="form-group full-width">
                                <label class="form-label">Address</label>
                                <textarea class="form-textarea" id="address" placeholder="Complete Address" disabled></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Language</label>
                                <input type="text" class="form-input" id="language" placeholder="Primary Language" disabled>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Hobbies</label>
                                <input type="text" class="form-input" id="hobbies" placeholder="Hobbies" disabled>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Parent/Guardian Name</label>
                                <input type="text" class="form-input" id="parentName" placeholder="Parent/Guardian Name" disabled>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Parent/Guardian Contact</label>
                                <input type="tel" class="form-input" id="parentContact" placeholder="Parent/Guardian Contact" disabled>
                            </div>
                            <div class="form-group full-width">
                                <label class="form-label">Emergency Contact</label>
                                <textarea class="form-textarea" id="emergencyContact" placeholder="Emergency Contact Information" disabled></textarea>
                            </div>
                            <div class="form-group full-width">
                                <label class="form-label">About Me</label>
                                <textarea class="form-textarea" id="aboutMe" placeholder="Tell us about yourself, your interests, and learning goals" disabled></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Education Tab -->
                    <div id="education" class="tab-content">
                        <h3 class="section-title">Education Information</h3>
                        <div id="education-list">
                            <!-- Education items will be added here dynamically -->
                        </div>
                        <button class="add-btn" id="add-education-btn" onclick="addEducationItem()" disabled>Add Education</button>
                    </div>
                    
                    <!-- Documents Tab -->
                    <div id="documents" class="tab-content">
                        <h3 class="section-title">Documents & Certificates</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Profile Picture</label>
                                <div class="file-upload" id="profile-picture-upload">
                                    <input type="file" id="profilePicture" accept="image/*" onchange="previewImage(this, 'profile-preview')" disabled>
                                    <label class="file-upload-label">Upload Profile Picture</label>
                                </div>
                                <img id="profile-preview" class="document-preview">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Student ID</label>
                                <div class="file-upload" id="student-id-upload">
                                    <input type="file" id="studentId" accept="image/*,.pdf" onchange="previewImage(this, 'student-id-preview')" disabled>
                                    <label class="file-upload-label">Upload Student ID</label>
                                </div>
                                <img id="student-id-preview" class="document-preview">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Birth Certificate</label>
                                <div class="file-upload" id="birth-cert-upload">
                                    <input type="file" id="birthCertificate" accept="image/*,.pdf" onchange="previewImage(this, 'birth-cert-preview')" disabled>
                                    <label class="file-upload-label">Upload Birth Certificate</label>
                                </div>
                                <img id="birth-cert-preview" class="document-preview">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Academic Records</label>
                                <div class="file-upload" id="academic-upload">
                                    <input type="file" id="academicRecords" accept="image/*,.pdf" onchange="previewImage(this, 'academic-preview')" disabled>
                                    <label class="file-upload-label">Upload Academic Records</label>
                                </div>
                                <img id="academic-preview" class="document-preview">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Certificates</label>
                                <div class="file-upload" id="certificates-upload">
                                    <input type="file" id="certificates" accept="image/*,.pdf" onchange="previewImage(this, 'certificates-preview')" disabled>
                                    <label class="file-upload-label">Upload Certificates</label>
                                </div>
                                <img id="certificates-preview" class="document-preview">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Settings Tab -->
                    <div id="settings" class="tab-content">
                        <h3 class="section-title">Account Settings</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Current Email</label>
                                <input type="email" class="form-input" id="current-email" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">New Email</label>
                                <input type="email" class="form-input" id="new-email" placeholder="Enter new email address">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Current Username</label>
                                <input type="text" class="form-input" id="current-username" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">New Username</label>
                                <input type="text" class="form-input" id="new-username" placeholder="Enter new username">
                            </div>
                        </div>
                        
                        <h3 class="section-title" style="margin-top: 20px;">Change Password</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Current Password</label>
                                <input type="password" class="form-input" id="current-password" placeholder="Enter current password">
                            </div>
                            <div class="form-group">
                                <label class="form-label">New Password</label>
                                <input type="password" class="form-input" id="new-password" placeholder="Enter new password">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Confirm New Password</label>
                                <input type="password" class="form-input" id="confirm-password" placeholder="Confirm new password">
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 8px; margin-top: 15px;">
                            <button class="save-btn" onclick="updateSettings()">Update Settings</button>
                            <button class="cancel-btn" onclick="resetSettingsForm()">Reset Form</button>
                            <button class="edit-btn" onclick="goToForgotPassword()">Forgot Password</button>
                        </div>
                    </div>
                </div>
                
                <div class="success-message" id="success-message">
                    Profile updated successfully!
                </div>
                
                <div style="display: flex; gap: 8px; margin-top: 10px;">
                    <button class="edit-btn" id="edit-btn" onclick="enableEditing()">Edit Profile</button>
                    <button class="cancel-btn" id="cancel-btn" onclick="cancelEditing()" style="display: none;">Cancel</button>
                    <button class="save-btn" id="save-btn" onclick="saveProfile()" style="display: none;">Save Profile</button>
                </div>
            </div>
        </div>
        </div>

    <script src="avatar-helper.js"></script>
    <script>
        // Role-based access control
        const userType = localStorage.getItem('userType');
        if (userType !== 'student') {
            alert('Access denied. This page is for students only.');
            window.location.href = 'index.html';
        }

        // Initialize profile
        document.addEventListener('DOMContentLoaded', function() {
            // Set sidebar avatar and email
            const username = localStorage.getItem('remoedUsername') || 'Student';
            const studentId = localStorage.getItem('studentId');
            
            // Set sidebar avatar initial (keep img and text elements intact)
            const sidebarImg = document.getElementById('profile-image');
            const sidebarText = document.getElementById('avatar-text');
            if (sidebarImg && sidebarText) {
                sidebarImg.style.display = 'none';
                sidebarText.style.display = 'inline-block';
                sidebarText.textContent = username[0].toUpperCase();
            }
            document.getElementById('sidebar-email').textContent = username;
            
            // Load profile picture if available
            if (studentId) {
                loadProfilePicture(studentId);
            }
            
            // Logout functionality
            document.getElementById('logout-nav').onclick = function() {
                localStorage.clear();
                window.location.href = 'student-login.html';
            };
            
            updateProfileDisplay();
            loadProfile();
            loadSettingsData();
            setupProfilePictureUpload();
        });
        
    // Load profile picture from backend (uses shared setAvatar)
    async function loadProfilePicture(studentId) {
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                console.log('üîç No token found for profile picture');
                return;
            }

            const username = localStorage.getItem('remoedUsername') || 'Student';
            console.log('üîç Loading profile picture for studentId:', studentId);

            // Add timeout to prevent hanging
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout

            const response = await fetch(`/api/student/profile`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Cache-Control': 'no-cache',
                    'Pragma': 'no-cache'
                },
                signal: controller.signal
            });

            clearTimeout(timeoutId);

            if (response.ok) {
                const data = await response.json();
                const profilePic = data && data.profile && data.profile.profilePicture ? data.profile.profilePicture : '';
                // Use shared helper to set sidebar avatar
                try {
                    setAvatar({ imageUrl: profilePic, displayName: username, imgSelector: '#profile-image', textSelector: '#avatar-text' });
                } catch (e) {
                    console.error('setAvatar failed for sidebar', e);
                }
            } else {
                console.log('‚ùå Failed to load profile data for picture (status ' + response.status + ')');
                try {
                    setAvatar({ imageUrl: '', displayName: username, imgSelector: '#profile-image', textSelector: '#avatar-text' });
                } catch (e) {
                    console.error('setAvatar error', e);
                }
            }
        } catch (error) {
            console.error('‚ùå Error loading profile picture:', error);
            try {
                setAvatar({ imageUrl: '', displayName: localStorage.getItem('remoedUsername') || 'S', imgSelector: '#profile-image', textSelector: '#avatar-text' });
            } catch (e) {
                console.error('setAvatar error', e);
            }
        }
    }

        function updateProfileDisplay() {
            const username = localStorage.getItem('remoedUsername') || 'Student';
            document.getElementById('profile-name').textContent = username;
            document.getElementById('profile-email').textContent = username;
            
            // Main profile avatar: set initial text and hide image (use helper for consistency)
            try {
                setAvatar({ imageUrl: '', displayName: username, imgSelector: '#profile-avatar-img', textSelector: '#profile-avatar-text' });
            } catch (e) {
                console.error('setAvatar error for main avatar', e);
            }
        }

        function showTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.tab-btn');
            tabButtons.forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
        }

        function addEducationItem() {
            const educationList = document.getElementById('education-list');
            const educationItem = document.createElement('div');
            educationItem.className = 'education-item';
            
            // Check if editing is enabled
            const isEditing = document.getElementById('save-btn').style.display !== 'none';
            
            educationItem.innerHTML = `
                <div class="education-header">
                    <span style="font-weight: 600; font-size: 0.7rem;">Education ${educationList.children.length + 1}</span>
                    <button class="remove-btn" onclick="removeEducationItem(this)">√ó</button>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">School Name</label>
                        <input type="text" class="form-input" placeholder="School Name" ${!isEditing ? 'disabled' : ''}>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Level</label>
                        <select class="form-input" ${!isEditing ? 'disabled' : ''}>
                            <option value="">Select Level</option>
                            <option value="nursery">Nursery</option>
                            <option value="kindergarten">Kindergarten</option>
                            <option value="primary">Primary</option>
                            <option value="secondary">Secondary</option>
                            <option value="college">College</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Year Started</label>
                        <input type="number" class="form-input" placeholder="Year Started" min="1900" max="2030" ${!isEditing ? 'disabled' : ''}>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Year Ended</label>
                        <input type="number" class="form-input" placeholder="Year Ended" min="1900" max="2030" ${!isEditing ? 'disabled' : ''}>
                    </div>
                </div>
            `;
            educationList.appendChild(educationItem);
        }

        function removeEducationItem(button) {
            button.closest('.education-item').remove();
        }

        function setupProfilePictureUpload() {
            const avatar = document.getElementById('profile-avatar');
            const fileInput = document.getElementById('profilePicture');
            if (!avatar || !fileInput) return;

            // Only open the file picker when editing is enabled.
            avatar.addEventListener('click', () => {
                const isEditing = document.getElementById('save-btn').style.display !== 'none';
                if (!isEditing) {
                    alert('Click "Edit Profile" to upload a new profile picture.');
                    return;
                }
                // Ensure input is enabled before clicking
                fileInput.disabled = false;
                fileInput.click();
            });

            // When a file is selected, preview it immediately in the avatar and sidebar
            fileInput.addEventListener('change', function() {
                const file = this.files && this.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(e) {
                    const dataUrl = e.target.result;

                    // Main profile avatar
                    const mainImg = document.getElementById('profile-avatar-img');
                    const mainText = document.getElementById('profile-avatar-text');
                    if (mainImg) {
                        mainImg.src = dataUrl;
                        mainImg.style.display = 'block';
                    }
                    if (mainText) mainText.style.display = 'none';

                    // Sidebar avatar
                    const sidebarImg = document.getElementById('profile-image');
                    const sidebarText = document.getElementById('avatar-text');
                    if (sidebarImg) {
                        sidebarImg.src = dataUrl;
                        sidebarImg.style.display = 'block';
                    }
                    if (sidebarText) sidebarText.style.display = 'none';

                    // Document preview (if present)
                    const preview = document.getElementById('profile-preview');
                    if (preview) {
                        preview.src = dataUrl;
                        preview.style.display = 'block';
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        function previewImage(input, previewId) {
            const preview = document.getElementById(previewId);
            const file = input.files[0];
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

                async function loadProfile() {
            try {
                const token = localStorage.getItem('token');
                const username = localStorage.getItem('remoedUsername') || 'Student';
                const studentId = localStorage.getItem('studentId');
                
                console.log('üîç Loading profile with token:', token ? 'Token exists' : 'No token');
                console.log('üîç Username from localStorage:', username);
                console.log('üîç Student ID from localStorage:', studentId);
                
                if (!token) {
                    console.log('‚ùå No token found - cannot load profile');
                    showSuccessMessage('Please log in to view your profile.', 'error');
                    return;
                }
                
                // Add timeout to prevent hanging
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 second timeout
                
                // Try multiple API endpoints
                let response;
                let profileData;
                
                // First try: /api/student/profile
                try {
                    console.log('üîç Trying /api/student/profile endpoint...');
                    response = await fetch(`/api/student/profile`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json',
                            'Cache-Control': 'no-cache',
                            'Pragma': 'no-cache'
                        },
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    console.log('üîç Profile response status:', response.status);
                    
                    if (response.ok) {
                        profileData = await response.json();
                        console.log('‚úÖ Profile data received from /api/student/profile:', profileData);
                    } else {
                        console.log('‚ùå /api/student/profile failed with status:', response.status);
                    }
                } catch (error) {
                    console.log('‚ùå Error with /api/student/profile:', error.message);
                }
                
                // Second try: /api/students/profile (alternative endpoint)
                if (!profileData && response && response.status !== 200) {
                    try {
                        console.log('üîç Trying /api/students/profile endpoint...');
                        const controller2 = new AbortController();
                        const timeoutId2 = setTimeout(() => controller2.abort(), 10000);
                        
                        response = await fetch(`/api/students/profile`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json',
                                'Cache-Control': 'no-cache',
                                'Pragma': 'no-cache'
                            },
                            signal: controller2.signal
                        });
                        
                        clearTimeout(timeoutId2);
                        console.log('üîç Second attempt response status:', response.status);
                        
                        if (response.ok) {
                            profileData = await response.json();
                            console.log('‚úÖ Profile data received from /api/students/profile:', profileData);
                        }
                    } catch (error) {
                        console.log('‚ùå Error with /api/students/profile:', error.message);
                    }
                }
                
                // Third try: Direct student lookup by ID
                if (!profileData && studentId) {
                    try {
                        console.log('üîç Trying direct student lookup by ID...');
                        const controller3 = new AbortController();
                        const timeoutId3 = setTimeout(() => controller3.abort(), 10000);
                        
                        response = await fetch(`/api/students/${studentId}`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json',
                                'Cache-Control': 'no-cache',
                                'Pragma': 'no-cache'
                            },
                            signal: controller3.signal
                        });
                        
                        clearTimeout(timeoutId3);
                        console.log('üîç Direct lookup response status:', response.status);
                        
                        if (response.ok) {
                            profileData = await response.json();
                            console.log('‚úÖ Profile data received from direct lookup:', profileData);
                        }
                    } catch (error) {
                        console.log('‚ùå Error with direct student lookup:', error.message);
                    }
                }
                
                // Process the profile data
                if (profileData) {
                    // Handle different response structures
                    let profile;
                    if (profileData.profile) {
                        profile = profileData.profile;
                    } else if (profileData.student) {
                        profile = profileData.student;
                    } else {
                        profile = profileData;
                    }
                    
                    console.log('‚úÖ Final profile data to populate:', profile);
                    populateForm(profile);
                } else if (response && response.status === 401) {
                    console.log('‚ùå Unauthorized - token may be expired');
                    showSuccessMessage('Session expired. Please log in again.', 'error');
                    setTimeout(() => {
                        localStorage.clear();
                        window.location.href = 'student-login.html';
                    }, 2000);
                } else if (response && response.status === 404) {
                    console.log('‚ÑπÔ∏è No profile found - creating new profile');
                    // Create a basic profile structure for new users
                    const basicProfile = {
                        firstName: username.split('@')[0] || 'Student',
                        lastName: 'User',
                        email: username,
                        // Add other default fields
                    };
                    populateForm(basicProfile);
                } else {
                    console.log('‚ùå All API attempts failed');
                    showSuccessMessage('Failed to load profile data. Please check your connection and try again.', 'error');
                }
            } catch (error) {
                console.error('‚ùå Error loading profile:', error);
                if (error.name === 'AbortError') {
                    showSuccessMessage('Request timed out. Please check your connection and try again.', 'error');
                } else {
                    showSuccessMessage('Network error. Please check your connection and try again.', 'error');
                }
            }
        }

        function populateForm(profile) {
            console.log('üîç Populating form with profile data:', profile);
            
            // Personal Information
            document.getElementById('firstName').value = profile.firstName || '';
            document.getElementById('middleName').value = profile.middleName || '';
            document.getElementById('lastName').value = profile.lastName || '';
            document.getElementById('gender').value = profile.gender || '';
            
            // Handle birthday format (convert from Date object if needed)
            let birthdayValue = profile.birthday || '';
            if (birthdayValue && typeof birthdayValue === 'string' && birthdayValue.includes('T')) {
                // Convert ISO date string to YYYY-MM-DD format for input
                birthdayValue = birthdayValue.split('T')[0];
            }
            document.getElementById('birthday').value = birthdayValue;
            
            document.getElementById('age').value = profile.age || '';
            document.getElementById('contact').value = profile.contact || '';
            
            // Use profile email if available, otherwise use login email from localStorage
            const loginEmail = localStorage.getItem('remoedUsername') || '';
            document.getElementById('email').value = profile.email || profile.username || loginEmail;
            
            document.getElementById('address').value = profile.address || '';
            document.getElementById('language').value = profile.language || '';
            document.getElementById('hobbies').value = profile.hobbies || '';
            document.getElementById('parentName').value = profile.parentName || '';
            document.getElementById('parentContact').value = profile.parentContact || '';
            document.getElementById('emergencyContact').value = profile.emergencyContact || '';
            document.getElementById('aboutMe').value = profile.aboutMe || '';

            // Update profile display
            const displayName = profile.firstName || profile.username || 'Student';
            document.getElementById('profile-name').textContent = displayName;
            document.getElementById('profile-email').textContent = profile.email || profile.username || loginEmail;
            
            // Update avatar text
                const mainText = document.getElementById('profile-avatar-text');
                const mainImg = document.getElementById('profile-avatar-img');
                if (mainText) {
                    mainText.textContent = displayName[0].toUpperCase();
                    if (mainImg) mainImg.style.display = 'none';
                    mainText.style.display = 'inline-block';
                }

            // Profile Picture
            if (profile.profilePicture) {
                console.log('üîç Found profile picture, updating avatar...');
                const mainImg = document.getElementById('profile-avatar-img');
                const mainText = document.getElementById('profile-avatar-text');
                // Update sidebar elements too if present
                const sidebarImgEl = document.getElementById('profile-image');
                const sidebarTextEl = document.getElementById('avatar-text');

                // Create a new image to test if it loads
                const testImage = new Image();
                testImage.onload = function() {
                    if (mainImg && mainText) {
                        mainImg.src = profile.profilePicture;
                        mainImg.style.display = 'block';
                        mainText.style.display = 'none';
                    }
                    if (sidebarImgEl && sidebarTextEl) {
                        sidebarImgEl.src = profile.profilePicture;
                        sidebarImgEl.style.display = 'block';
                        sidebarTextEl.style.display = 'none';
                    }
                    console.log('‚úÖ Profile picture loaded successfully in form and sidebar');
                };
                testImage.onerror = function() {
                    console.log('‚ùå Profile picture failed to load in form');
                    if (mainImg && mainText) {
                        mainImg.style.display = 'none';
                        mainText.style.display = 'inline-block';
                        mainText.textContent = displayName[0].toUpperCase();
                    }
                    if (sidebarImgEl && sidebarTextEl) {
                        sidebarImgEl.style.display = 'none';
                        sidebarTextEl.style.display = 'inline-block';
                    }
                };
                testImage.src = profile.profilePicture;
            }

            // Education
            if (profile.education && profile.education.length > 0) {
                console.log('üîç Found education data:', profile.education);
                const educationList = document.getElementById('education-list');
                educationList.innerHTML = '';
                profile.education.forEach(edu => {
                    const educationItem = document.createElement('div');
                    educationItem.className = 'education-item';
                    educationItem.innerHTML = `
                        <div class="education-header">
                            <span style="font-weight: 600; font-size: 0.7rem;">Education ${educationList.children.length + 1}</span>
                            <button class="remove-btn" onclick="removeEducationItem(this)">√ó</button>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">School Name</label>
                                <input type="text" class="form-input" value="${edu.schoolName || ''}" placeholder="School Name" disabled>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Level</label>
                                <select class="form-input" disabled>
                                    <option value="">Select Level</option>
                                    <option value="nursery" ${edu.level === 'nursery' ? 'selected' : ''}>Nursery</option>
                                    <option value="kindergarten" ${edu.level === 'kindergarten' ? 'selected' : ''}>Kindergarten</option>
                                    <option value="primary" ${edu.level === 'primary' ? 'selected' : ''}>Primary</option>
                                    <option value="secondary" ${edu.level === 'secondary' ? 'selected' : ''}>Secondary</option>
                                    <option value="college" ${edu.level === 'college' ? 'selected' : ''}>College</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Year Started</label>
                                <input type="number" class="form-input" value="${edu.yearStarted || ''}" placeholder="Year Started" min="1900" max="2030" disabled>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Year Ended</label>
                                <input type="number" class="form-input" value="${edu.yearEnded || ''}" placeholder="Year Ended" min="1900" max="2030" disabled>
                            </div>
                        </div>
                    `;
                    educationList.appendChild(educationItem);
                });
            }

            // Documents
            if (profile.documents) {
                console.log('üîç Found documents data:', profile.documents);
                if (profile.documents.studentId) {
                    document.getElementById('student-id-preview').src = profile.documents.studentId;
                    document.getElementById('student-id-preview').style.display = 'block';
                }
                if (profile.documents.birthCertificate) {
                    document.getElementById('birth-cert-preview').src = profile.documents.birthCertificate;
                    document.getElementById('birth-cert-preview').style.display = 'block';
                }
                if (profile.documents.academicRecords) {
                    document.getElementById('academic-preview').src = profile.documents.academicRecords;
                    document.getElementById('academic-preview').style.display = 'block';
                }
                if (profile.documents.certificates) {
                    document.getElementById('certificates-preview').src = profile.documents.certificates;
                    document.getElementById('certificates-preview').style.display = 'block';
                }
            }
            
            console.log('‚úÖ Form populated successfully');
        }

        async function saveProfile() {
            const saveBtn = document.getElementById('save-btn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            try {
                // Get token from localStorage
                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('No authentication token found. Please login again.');
                }

                // Collect form data
                const profileData = {
                    firstName: document.getElementById('firstName').value,
                    middleName: document.getElementById('middleName').value,
                    lastName: document.getElementById('lastName').value,
                    gender: document.getElementById('gender').value,
                    birthday: document.getElementById('birthday').value,
                    age: document.getElementById('age').value,
                    contact: document.getElementById('contact').value,
                    email: document.getElementById('email').value || localStorage.getItem('remoedUsername') || '',
                    address: document.getElementById('address').value,
                    language: document.getElementById('language').value,
                    hobbies: document.getElementById('hobbies').value,
                    parentName: document.getElementById('parentName').value,
                    parentContact: document.getElementById('parentContact').value,
                    emergencyContact: document.getElementById('emergencyContact').value,
                    aboutMe: document.getElementById('aboutMe').value
                };

                // Collect education data
                const educationItems = document.querySelectorAll('.education-item');
                profileData.education = Array.from(educationItems).map(item => {
                    const inputs = item.querySelectorAll('input, select');
                    return {
                        schoolName: inputs[0].value,
                        level: inputs[1].value,
                        yearStarted: inputs[2].value,
                        yearEnded: inputs[3].value
                    };
                });

                // Validate required fields - make them optional for initial setup
                if (!profileData.email || profileData.email.trim() === '') {
                    // Use username as email if not provided
                    profileData.email = localStorage.getItem('remoedUsername') || '';
                }
                
                if (!profileData.firstName || profileData.firstName.trim() === '') {
                    profileData.firstName = 'Student'; // Default first name
                }
                
                if (!profileData.lastName || profileData.lastName.trim() === '') {
                    profileData.lastName = 'User'; // Default last name
                }

                console.log('Saving profile data:', profileData);
                console.log('Using token:', token ? 'Token exists' : 'No token');

                // Save profile data
                const response = await fetch('/api/student/profile', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(profileData)
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);

                if (response.ok) {
                    const result = await response.json();
                    console.log('Save result:', result);
                    showSuccessMessage('Profile saved successfully!');
                    
                    // Reload profile data to show updated information
                    await loadProfile();
                    
                    // Disable editing after successful save
                    const inputs = document.querySelectorAll('.form-input, .form-textarea');
                    inputs.forEach(input => input.disabled = true);
                    
                    const fileInputs = document.querySelectorAll('input[type="file"]');
                    fileInputs.forEach(input => input.disabled = true);
                    
                    document.getElementById('add-education-btn').disabled = true;
                    
                    const educationInputs = document.querySelectorAll('.education-item input, .education-item select');
                    educationInputs.forEach(input => input.disabled = true);
                    
                    // Show/hide buttons
                    document.getElementById('edit-btn').style.display = 'inline-block';
                    document.getElementById('cancel-btn').style.display = 'none';
                    document.getElementById('save-btn').style.display = 'none';
                } else {
                    const errorText = await response.text();
                    console.error('Server error response:', errorText);
                    let errorMessage = 'Failed to save profile';
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMessage = errorData.error || errorMessage;
                    } catch (e) {
                        errorMessage = errorText || errorMessage;
                    }
                    throw new Error(errorMessage);
                }

                // Handle file uploads
                await handleFileUploads();

            } catch (error) {
                console.error('Error saving profile:', error);
                showSuccessMessage('Error saving profile: ' + error.message, 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Profile';
            }
        }

        async function handleFileUploads() {
            const files = [
                { id: 'profilePicture', field: 'profilePicture' },
                { id: 'studentId', field: 'studentId' },
                { id: 'birthCertificate', field: 'birthCertificate' },
                { id: 'academicRecords', field: 'academicRecords' },
                { id: 'certificates', field: 'certificates' }
            ];

            for (const file of files) {
                const fileInput = document.getElementById(file.id);
                if (fileInput.files.length > 0) {
                    await uploadFile(fileInput.files[0], file.field);
                }
            }
        }

        async function uploadFile(file, documentType) {
            try {
                const token = localStorage.getItem('token');
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const fileData = {
                        documentType: documentType,
                        fileData: e.target.result,
                        fileName: file.name
                    };

                    const response = await fetch('/api/student/upload-document', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(fileData)
                    });

                    if (response.ok) {
                        console.log(`${documentType} uploaded successfully`);
                    } else {
                        console.error(`Failed to upload ${documentType}`);
                    }
                };
                reader.readAsDataURL(file);
            } catch (error) {
                console.error(`Error uploading ${documentType}:`, error);
            }
        }

        function showSuccessMessage(message, type = 'success') {
            const successMessage = document.getElementById('success-message');
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            
            // Set color based on message type
            if (type === 'error') {
                successMessage.style.color = '#dc3545';
                successMessage.style.backgroundColor = '#f8d7da';
                successMessage.style.borderColor = '#f5c6cb';
            } else {
                successMessage.style.color = '#155724';
                successMessage.style.backgroundColor = '#d4edda';
                successMessage.style.borderColor = '#c3e6cb';
            }
            
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 5000);
        }

        function enableEditing() {
            console.log('Enabling editing...');
            
            // Enable all form inputs
            const inputs = document.querySelectorAll('.form-input, .form-textarea');
            inputs.forEach(input => {
                input.disabled = false;
                console.log('Enabled input:', input.id || input.name);
            });
            
            // Enable file uploads
            const fileInputs = document.querySelectorAll('input[type="file"]');
            fileInputs.forEach(input => {
                input.disabled = false;
                console.log('Enabled file input:', input.id);
            });
            
            // Enable education add button
            const addEducationBtn = document.getElementById('add-education-btn');
            if (addEducationBtn) {
                addEducationBtn.disabled = false;
                console.log('Enabled add education button');
            }
            
            // Enable education inputs
            const educationInputs = document.querySelectorAll('.education-item input, .education-item select');
            educationInputs.forEach(input => {
                input.disabled = false;
                console.log('Enabled education input:', input.id || input.name);
            });
            
            // Show/hide buttons
            document.getElementById('edit-btn').style.display = 'none';
            document.getElementById('cancel-btn').style.display = 'inline-block';
            document.getElementById('save-btn').style.display = 'inline-block';
            
            console.log('Editing enabled successfully');
        }
        
        function cancelEditing() {
            // Disable all form inputs
            const inputs = document.querySelectorAll('.form-input, .form-textarea');
            inputs.forEach(input => input.disabled = true);
            
            // Disable file uploads
            const fileInputs = document.querySelectorAll('input[type="file"]');
            fileInputs.forEach(input => input.disabled = true);
            
            // Disable education add button
            document.getElementById('add-education-btn').disabled = true;
            
            // Disable education inputs
            const educationInputs = document.querySelectorAll('.education-item input, .education-item select');
            educationInputs.forEach(input => input.disabled = true);
            
            // Show/hide buttons
            document.getElementById('edit-btn').style.display = 'inline-block';
            document.getElementById('cancel-btn').style.display = 'none';
            document.getElementById('save-btn').style.display = 'none';
            
            // Reload profile data to restore original values
            loadProfile();
        }
        
        function goBack() {
            window.location.href = 'student-dashboard.html';
        }
        
        // Settings functions
        async function updateSettings() {
            const newEmail = document.getElementById('new-email').value.trim();
            const newUsername = document.getElementById('new-username').value.trim();
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            // Validate password match
            if (newPassword && newPassword !== confirmPassword) {
                showSuccessMessage('New passwords do not match!', 'error');
                return;
            }
            
            // Validate password length
            if (newPassword && newPassword.length < 6) {
                showSuccessMessage('New password must be at least 6 characters long!', 'error');
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const settingsData = {
                    newEmail: newEmail || undefined,
                    newUsername: newUsername || undefined,
                    currentPassword: currentPassword || undefined,
                    newPassword: newPassword || undefined
                };
                
                // Remove undefined values
                Object.keys(settingsData).forEach(key => {
                    if (settingsData[key] === undefined) {
                        delete settingsData[key];
                    }
                });
                
                if (Object.keys(settingsData).length === 0) {
                    showSuccessMessage('Please fill in at least one field to update!', 'error');
                    return;
                }
                
                const response = await fetch('/api/student/update-settings', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settingsData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showSuccessMessage('Settings updated successfully!');
                    
                    // Update localStorage if username was changed
                    if (newUsername) {
                        localStorage.setItem('remoedUsername', newUsername);
                        updateProfileDisplay();
                    }
                    
                    // Clear form
                    resetSettingsForm();
                    
                    // Reload profile data
                    await loadProfile();
                } else {
                    const errorData = await response.json();
                    showSuccessMessage(errorData.error || 'Failed to update settings', 'error');
                }
            } catch (error) {
                console.error('Error updating settings:', error);
                showSuccessMessage('Error updating settings. Please try again.', 'error');
            }
        }
        
        function resetSettingsForm() {
            document.getElementById('new-email').value = '';
            document.getElementById('new-username').value = '';
            document.getElementById('current-password').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
            
            // Reload current values
            loadSettingsData();
        }
        
        function loadSettingsData() {
            const username = localStorage.getItem('remoedUsername') || '';
            const email = localStorage.getItem('remoedUsername') || ''; // For students, username is often the email
            
            document.getElementById('current-email').value = email;
            document.getElementById('current-username').value = username;
        }
        
        function goToForgotPassword() {
            window.location.href = 'forgot-password.html';
        }
        
        // Debug function to test API connection
        async function testApiConnection() {
            console.log('üîç Testing API connection...');
            const token = localStorage.getItem('token');
            const studentId = localStorage.getItem('studentId');
            const username = localStorage.getItem('remoedUsername');
            
            console.log('üîç Token:', token ? 'Present' : 'Missing');
            console.log('üîç Student ID:', studentId);
            console.log('üîç Username:', username);
            
            if (!token) {
                alert('No authentication token found. Please log in again.');
                return;
            }
            
            try {
                // Test basic connectivity
                const response = await fetch('/api/student/profile', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('üîç Response status:', response.status);
                console.log('üîç Response headers:', response.headers);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ API test successful:', data);
                    alert('API connection successful! Check console for details.');
                } else {
                    const errorText = await response.text();
                    console.log('‚ùå API test failed:', errorText);
                    alert(`API test failed with status ${response.status}. Check console for details.`);
                }
            } catch (error) {
                console.error('‚ùå API test error:', error);
                alert('API test error: ' + error.message);
            }
        }
        

    </script>
</body>
</html> 